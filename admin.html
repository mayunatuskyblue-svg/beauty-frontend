<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Pay Admin</title>
  <style>
    :root{--ink:#1d1b1a;--teal:#246A73;--muted:#6b5e55;--brd:#eadfca;--bg:#faf6ef}
    *{box-sizing:border-box} body{margin:0;background:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;color:var(--ink)}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--brd);z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
    h1{font-size:20px;margin:0 0 6px}
    .grid{display:grid;gap:14px}
    @media(min-width:960px){.grid{grid-template-columns:2fr 1fr}}
    .card{background:#fff;border:1px solid var(--brd);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.06)}
    .card>.hd{padding:12px 14px;border-bottom:1px solid var(--brd);font-weight:800}
    .card>.bd{padding:12px 14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{display:block;font-weight:700;margin:8px 0 4px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--brd);border-radius:10px;background:#fff;font:inherit}
    input:read-only{background:#fafafa}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--brd);border-radius:999px}
    .btn{display:inline-flex;gap:.5em;align-items:center;justify-content:center;height:42px;padding:0 16px;border-radius:12px;font-weight:800;border:1px solid var(--brd);background:#fff;cursor:pointer}
    .btn.primary{background:var(--teal);border-color:var(--teal);color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .total{font-size:28px;font-weight:900}
    .warn{color:#7a2e13}
    .ok{color:#0b684e}
    .tbl{width:100%;border-collapse:collapse}
    .tbl td{padding:6px 4px}
    .tbl tr td:first-child{opacity:.8}
    .hr{height:1px;background:var(--brd);margin:8px 0}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid var(--brd);font-size:12px}
    .right{display:flex;flex-direction:column;gap:12px}
    .tag{padding:4px 8px;border:1px solid var(--brd);border-radius:8px;background:#fff}
    /* --- tabs --- */
    .tabs{display:flex;gap:8px;margin-bottom:8px}
    .tab{border:1px solid var(--brd);background:#fff;border-radius:999px;padding:8px 14px;cursor:pointer;font-weight:700}
    .tab.active{background:var(--teal);border-color:var(--teal);color:#fff}
    .tab-pane[hidden]{display:none}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Smart Pay — Admin</h1>
      <div class="row muted" id="ctx">Loading…</div>
    </div>
  </header>

  <main class="wrap grid" id="app" hidden>
    <!-- 左：コンポーザー -->
    <section class="card">
      <div class="hd">Bill Composer</div>
      <div class="bd">
        <div class="row">
          <div class="pill"><b>Booking</b> <span id="bkId">-</span></div>
          <div class="pill"><b>Salon</b> <span id="salonName">-</span></div>
          <div class="pill"><b>Customer</b> <span id="custName">-</span></div>
          <div class="pill"><b>Scheduled</b> <span id="scheduled">-</span></div>
        </div>

        <div class="hr"></div>

        <label>Menu</label>
        <div id="menuBox">Loading…</div>

        <label style="margin-top:10px">Add-ons</label>
        <div id="addonBox" class="row"></div>

        <div class="row" style="margin-top:10px">
          <div style="flex:1">
            <label>Discount</label>
            <select id="discountSel"></select>
          </div>
          <div style="width:180px">
            <label>Manual adjust (±)</label>
            <input id="manualAdj" type="number" step="1" value="0"/>
            <div class="muted" style="font-size:12px">Limit: <span id="adjLimit">±1500</span> LKR</div>
          </div>
        </div>
        <div>
          <label>Reason for manual adjust</label>
          <input id="manualReason" placeholder="ex: Oil upgrade / Extension 30m"/>
        </div>
      </div>
    </section>

    <!-- 右：サマリー＆アクション -->
    <aside class="right">
        <div class="tabs" id="tabs">
         <button class="tab active" data-tab="billing">Billing</button>
         <button class="tab" data-tab="schedule">Schedule</button>
        </div>
          
        <div class="tab-pane" id="pane-billing">
  <section class="card">
    <div class="hd">Summary</div>
    <div class="bd">
      <table class="tbl">
        <tr><td>Base</td><td id="sumBase" style="text-align:right">-</td></tr>
        <tr><td>Add-ons</td><td id="sumAdd" style="text-align:right">-</td></tr>
        <tr><td>Discount</td><td id="sumDis" style="text-align:right">-</td></tr>
        <tr><td>Manual</td><td id="sumMan" style="text-align:right">-</td></tr>
        <tr><td>Service</td><td id="sumSvc" style="text-align:right">-</td></tr>
        <tr><td>Tax</td><td id="sumTax" style="text-align:right">-</td></tr>
      </table>
      <div class="hr"></div>
      <div class="total" id="grand">Rs 0</div>
      <div class="muted" id="deltaInfo"></div>
    </div>
  </section>

      <section class="card">
        <div class="hd">Approval</div>
        <div class="bd">
          <div class="row">
            <div style="flex:1">
              <label>Customer phone (WhatsApp / SMS)</label>
              <input id="custPhone" placeholder="+94xxxxxxxxx"/>
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="sendLink" class="btn">Send approval link</button>
            <span id="apStatus" class="badge">Not sent</span>
          </div>
          <div id="apTips" class="muted" style="margin-top:6px;font-size:12px">
            We will send a short link to the customer. When the customer taps <b>Approve</b>,
            the status turns green and the Charge button unlocks.
          </div>
          <div id="shareBox" class="row" style="margin-top:8px;display:none"></div>
        </div>
      </section>

      <section class="card">
        <div class="hd">Charge</div>
        <div class="bd">
          <button id="btnCharge" class="btn primary" disabled>Charge saved card</button>
          <div id="chargeMsg" class="muted" style="margin-top:8px"></div>
      </div>
      </section>
      </div>
            <!-- ▼▼▼ ここから追加：Availability（営業時間・リードタイム） ▼▼▼ -->
      <div class="tab-pane" id="pane-schedule" hidden>
      <section class="card">
        <div class="hd">Availability</div>
        <div class="bd">
          <div class="row">
            <div style="flex:1">
              <label>Open start (HH:mm)</label>
              <input id="availOpenStart" placeholder="09:00" />
            </div>
            <div style="flex:1">
              <label>Open end (HH:mm)</label>
              <input id="availOpenEnd" placeholder="18:00" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div style="flex:1">
              <label>Lead time (minutes)</label>
              <input id="availLeadMin" type="number" step="5" min="0" placeholder="0" />
            </div>
            <div style="flex:1">
              <label>Capacity</label>
              <input id="availCapacity" readonly placeholder="(salons シートで管理)" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnAvailSave" class="btn">Save availability</button>
            <span id="availMsg" class="muted"></span>
          </div>
        </div>
      </section>
      <!-- ▲▲▲ ここまで Availability ▲▲▲ -->

      <!-- ▼▼▼ ここから追加：Blackouts（臨時休止/満枠） ▼▼▼ -->
      <section class="card">
        <div class="hd">Blackouts</div>
        <div class="bd">
          <div class="row">
            <div style="flex:1">
              <label>Date</label>
              <input id="blackDate" type="date" />
            </div>
            <div style="width:110px">
              <label>Start</label>
              <input id="blackStart" placeholder="09:00" />
            </div>
            <div style="width:110px">
              <label>End</label>
              <input id="blackEnd" placeholder="18:00" />
            </div>
          </div>
          <div>
            <label>Reason</label>
            <input id="blackReason" placeholder="Maintenance, Staff meeting, etc." />
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnBlackAdd" class="btn">Add blackout</button>
            <span id="blackMsg" class="muted"></span>
          </div>
          <div class="hr"></div>
          <div class="muted" style="margin-bottom:6px">Existing blackouts</div>
          <div id="blackList"></div>
        </div>
      </section>
      <!-- ▲▲▲ ここまで Blackouts ▲▲▲ -->

      <!-- ▼▼▼ ここから追加：Taken（当日の満枠） ▼▼▼ -->
      <section class="card">
        <div class="hd">Taken slots</div>
        <div class="bd">
          <div class="row">
            <div style="flex:1">
              <label>Date</label>
              <input id="dayYMD" type="date" />
            </div>
            <div style="align-self:flex-end">
              <button id="btnLoadTaken" class="btn">Load</button>
            </div>
          </div>
          <div class="hr"></div>
          <div id="takenMeta" class="muted" style="margin-bottom:8px"></div>
          <div id="takenGrid" class="row" style="flex-wrap:wrap;gap:8px"></div>
        </div>
      </section>
      <!-- ▲▲▲ ここまで Taken ▲▲▲ -->
      </div>
    </aside>
  </main>

  <script>
   // ====== CONFIG ======
  // ====== CONFIG ======
  const API_BASE = 'https://workers-playground-winter-field-18ec.mayunatu-skyblue.workers.dev/api';  // ← Worker経由に変更
  const GAS_KEY  = 'bl_gas_key_bR6ZXWwu6kM_nrK25geP97Cs5qCX3auxugX_IUGlg90';
  const MAX_MANUAL = 1500;
  const DELTA_WARN_RATE = 0.2;
  const MOCK = false;
  const APPROVE_FILE = 'https://beautylk.com/approve.html'; // 公開中のapprove.html URL
  // 為替レート（1 JPY = 2.15 LKR など固定値）
// あとで salons シートから取れるようにするのも可
const FX_RATE = 2.15;

    // ====== STATE ======
    const S = {
      salonId: '', bookingId: '', customerId: '', scheduledPrice: 0, tenantName: '',
      catalog: { menus: [], addons: [], discounts: [], taxRate: 0, serviceRate: 0 },
      sel: { menuId: '', addonIds: new Set(), discountId: '', manual: 0, reason: '' },
      approval: { id: '', ok: false }
    };
  // ====== GLOBAL ERROR HANDLER ======
window.addEventListener('unhandledrejection', e => {
  alert('Network or script error: ' + (e.reason?.message || e.reason || 'Unknown'));
});
window.addEventListener('error', e => {
  console.error(e);
  alert('Unexpected error: ' + (e.message || e.error));
});

    // ====== HELPERS ======
    const $ = (q) => document.querySelector(q);
        function toLKR(jpy){
  return Math.round(Number(jpy||0) * FX_RATE);
}
function fmtLKR(jpy){
  return `Rs ${Number(toLKR(jpy)).toLocaleString('en-US')}`;
}

    const qs = new URLSearchParams(location.search);
    // === Token helper: URL→localStorage保存、以後は保存済みを優先 ===
  function getToken() {
    // 1) URLにtokenがあれば保存してURLから消す
    const urlToken = qs.get('token');
    if (urlToken) {
      localStorage.setItem('bl_token', urlToken);
      // URLをクリーンに（tokenを見せない）
      const u = new URL(location.href);
      u.searchParams.delete('token');
      history.replaceState(null, '', u.toString());
    }
    // 2) 保存済み or 既にURLで来たtoken
    return localStorage.getItem('bl_token') || urlToken || '';
  }
    function normalizePhone(raw){
  // +94xxxxxxxxx を想定。先頭+がなければ付与、空白/ハイフン除去
  let p = String(raw||'').replace(/[\s-]/g,'');
  if (!p) return '';
  if (!p.startsWith('+')) {
    // 例：スリランカなら +94 を付与（必要に応じて運用国に合わせて調整）
    if (p.startsWith('0')) p = '+94' + p.slice(1);
    else p = '+94' + p;
  }
  return p;
}
function encodeMsg(s){ return encodeURIComponent(s).replace(/%20/g,'+'); }
async function copyToClipboard(text){
  try{ await navigator.clipboard.writeText(text); return true; }catch(e){ return false; }
}

    function readCtx(){
  S.token = getToken(); // ← URL/保存済みのどちらでもOKに
  S.salonId = qs.get('salonId')||'';
  S.bookingId = qs.get('bookingId')||'';
  S.customerId = qs.get('customerId')||'';
  S.scheduledPrice = Number(qs.get('scheduled')||0);
  S.tenantName = qs.get('salonName')||'';
  $('#ctx').innerHTML = `Salon <b>${S.tenantName||S.salonId}</b> · Booking <b>${S.bookingId||'-'}</b>`;
  $('#bkId').textContent = S.bookingId||'-';
  $('#salonName').textContent = S.tenantName||S.salonId||'-';
  $('#scheduled').textContent = fmtLKR(S.scheduledPrice);
  $('#adjLimit').textContent = `±${toLKR(MAX_MANUAL)}`;
}

async function fetchCatalog(){
  if(MOCK){
    S.catalog = {
      menus: [
        { id: "M_BASIC", name: "Basic Treatment", price: 5000 },
        { id: "M_PREMIUM", name: "Premium Treatment", price: 9000 }
      ],
      addons: [], // addons を使う場合は別途シート/エンドポイント用意
      discounts: [
        { id: "D_10P", type: "percent", value: 10, name: "10% OFF" },
        { id: "D_500", type: "flat", value: 500, name: "¥500 OFF" }
      ],
      taxRate: 10, serviceRate: 0
    };
  }else{
    // 1) メニュー取得
    const q1 = new URLSearchParams({ kind:'menus.list', key:GAS_KEY, salonId:S.salonId, token:S.token });
    const m = await fetch(`${API_BASE}?${q1}`).then(r=>r.json());
    const menus = (m.ok ? (m.items||[]) : []).map(x => ({
      id: (x.menu_id || x.name_en || x.name_ja || '').trim() || 'MENU',
      name: x.name_en || x.name_ja || x.desc || 'Menu',
      price: Number(x.price_jpy || 0) // 課金はJPYで統一
    }));

    // 2) クーポン（＝Discount）取得
    const q2 = new URLSearchParams({ kind:'coupons.list', key:GAS_KEY, salonId:S.salonId, token:S.token });
    const c = await fetch(`${API_BASE}?${q2}`).then(r=>r.json());
    const discounts = (c.ok ? (c.items||[]) : []).map(x => {
      // シートの持ち方に合わせて type/value を決める（ここでは簡易に flat を想定）
      const off = Number(x.value || x.off_jpy || 0);
      return { id: String(x.menu_id || x.code || x.name_en || x.name_ja || 'DISC'), type:'flat', value: off, name: (x.name_en||x.name_ja||'Discount') };
    });

    S.catalog = {
      menus,
      addons: [],                 // 使うなら別途
      discounts,
      taxRate: 10,                // 必要に応じて salons シート等から参照に変更可
      serviceRate: 0
    };
  }

  if(!S.sel.menuId && S.catalog.menus[0]) S.sel.menuId = S.catalog.menus[0].id;
  renderComposer(); calc();
}

function renderComposer(){
  const mbox = $('#menuBox');
  mbox.innerHTML = (S.catalog.menus||[]).map(m => `
    <label class="row" style="align-items:flex-start">
      <input type="radio" name="menu" value="${m.id}" ${S.sel.menuId===m.id?'checked':''} />
      <div style="margin-left:8px">
        <div><b>${m.name}</b></div>
        <div class="muted">${fmtLKR(m.price)}</div>
      </div>
    </label>
  `).join('') || '<div class="muted">No menus</div>';

  // メニュー選択
  mbox.querySelectorAll('input[name="menu"]').forEach(r=>{
    r.addEventListener('change', e => { S.sel.menuId = e.target.value; calc(); });
  });

  // Add-on
  const abox = $('#addonBox');
  abox.innerHTML = (S.catalog.addons||[]).map(a => {
    const on = S.sel.addonIds.has(a.id);
    return `<label class="tag"><input type="checkbox" value="${a.id}" ${on?'checked':''}/> ${a.name} (+${fmtLKR(a.price)})</label>`;
  }).join('') || '<div class="muted">No add-ons</div>';

  // Add-on トグル
  abox.querySelectorAll('input[type="checkbox"]').forEach(c=>{
    c.addEventListener('change', e => {
      const id = e.target.value;
      if (e.target.checked) S.sel.addonIds.add(id);
      else S.sel.addonIds.delete(id);
      calc();
    });
  });

  // Discount
  const dsel = $('#discountSel');
  dsel.innerHTML = `<option value="">None</option>` + (S.catalog.discounts||[]).map(d=>{
    const label = d.type==='percent'
  ? `${d.name} (-${d.value}% )`
  : `${d.name} (-${fmtLKR(d.value)})`;
    return `<option value="${d.id}">${label}</option>`;
  }).join('');
  dsel.value = S.sel.discountId||'';
  dsel.onchange = ()=>{ S.sel.discountId = dsel.value||''; calc(); };

  // Manual adjust
  const man = $('#manualAdj');
// 表示はLKR（内部はJPYで保持）
man.value = toLKR(S.sel.manual||0);
man.oninput = ()=>{
  const lkr = Number(man.value||0);
  S.sel.manual = Math.round(lkr / FX_RATE); // 内部JPYへ換算
  calc();
};

  const rea = $('#manualReason');
  rea.value = S.sel.reason||'';
  rea.oninput = ()=>{ S.sel.reason = rea.value.trim(); };

  document.getElementById('app').hidden = false;
}

    function currentAmounts(){
      const menu = (S.catalog.menus||[]).find(m=>m.id===S.sel.menuId);
      const base = menu? Number(menu.price||0):0;
      const add = [...S.sel.addonIds].map(id => (S.catalog.addons||[]).find(a=>a.id===id)?.price||0).reduce((a,b)=>a+b,0);
      const disc = (()=>{
        const d = (S.catalog.discounts||[]).find(x=>x.id===S.sel.discountId);
        if(!d) return 0; if(d.type==='percent') return - Math.round((base+add) * (d.value/100));
        return - Number(d.value||0);
      })();
      const man = Number(S.sel.manual||0);
      return { base, add, disc, man };
    }

    function calc(){
  const { base, add, disc, man } = currentAmounts();
  const limit = MAX_MANUAL; 
  const warnAdj = Math.abs(man) > limit; 
  const needReason = man!==0 && !S.sel.reason;

  // JPY計算（Stripe用）
  const subJPY = base + add + disc + man;
  const svcJPY = Math.round(subJPY * (Number(S.catalog.serviceRate||0)/100));
  const taxJPY = Math.round((subJPY+svcJPY) * (Number(S.catalog.taxRate||0)/100));
  const grandJPY = Math.max(0, subJPY + svcJPY + taxJPY);

  // LKR 表示用
  $('#sumBase').textContent = fmtLKR(base);
  $('#sumAdd').textContent  = fmtLKR(add);
  $('#sumDis').textContent  = fmtLKR(disc);
  $('#sumMan').textContent  = fmtLKR(man) + (warnAdj? ' ⚠ over limit':'' ) + (needReason? ' ⚠ reason required':'');

  $('#sumSvc').textContent = fmtLKR(svcJPY);
  $('#sumTax').textContent = fmtLKR(taxJPY);
  $('#grand').textContent  = fmtLKR(grandJPY);

  // Δ比較もLKR表記に揃える
  const diffJPY = grandJPY - Number(S.scheduledPrice||0);
  const rate = (S.scheduledPrice? diffJPY/ S.scheduledPrice : 0);
  const di = $('#deltaInfo');
  di.textContent = `Δ from scheduled: ${fmtLKR(diffJPY)} (${(rate*100).toFixed(1)}%)`;
  di.className = 'muted ' + (Math.abs(rate) > DELTA_WARN_RATE ? 'warn':'');

  const allow = !warnAdj && !needReason && S.approval.ok && grandJPY>0;
  $('#btnCharge').disabled = !allow;

  // ★ JPYとLKR両方返す
  return { grandJPY, grandLKR: toLKR(grandJPY) };
}


    // ====== Approval ======
function rid(){ return (Date.now().toString(36)+Math.random().toString(36).slice(2,8)).toUpperCase(); }

async function startApproval(){
  const phone = $('#custPhone').value.trim(); // いまはUIに保持だけ（送信は任意）
  const { grandJPY, grandLKR } = calc();

  // GAS: approval.start
  const res = await fetch(API_BASE, {
    method:'POST',
    body: JSON.stringify({
      key: GAS_KEY,
      kind: 'approval.start',
      data: {
  bookingId: S.bookingId,
  salonId: S.salonId,
  token: S.token, // ← 追加
  items: { menuId: S.sel.menuId, addonIds: [...S.sel.addonIds], discountId: S.sel.discountId, manual: S.sel.manual||0, reason: S.sel.reason||'' },
  amountJPY: grandJPY,
  ttlMin: 60
}
    })
  }).then(r=>r.json());

  if(!res.ok){ alert(res.error || 'approval start failed'); return; }

  // 顧客リンク（approve 側に必要情報を付与）
  // customerEmail / customerName が取れるなら付ける（カード保存時の upsertCustomer 用）
  // 顧客リンク生成（approve 側へ必要情報を付与）
let url = `${APPROVE_FILE}?aid=${encodeURIComponent(res.approvalId)}`;
url += `&customerId=${encodeURIComponent(S.customerId||'')}`;
url += `&customerEmail=${encodeURIComponent(qs.get('customerEmail')||'')}`;
url += `&customerName=${encodeURIComponent(qs.get('customerName')||'')}`;
url += `&salonId=${encodeURIComponent(S.salonId||'')}`;
url += `&bookingId=${encodeURIComponent(S.bookingId||'')}`;

// URL安全化
const safeURL = encodeURI(url);

  setApStatus('Link created');
  S.approval.id = res.approvalId;

   // 共有（開いて確認 or コピーして送る）
  window.open(safeURL, '_blank');
  // --- 共有UIを表示 ---
  const phoneNorm = normalizePhone($('#custPhone').value.trim());
  const msg = ['Please approve your bill:', url].join('\n');

const waHref  = phone ? `https://wa.me/${phone.replace('+','')}/?text=${encodeURIComponent(msg)}` : '';
const smsHref = phone ? `sms:${encodeURIComponent(phone)}?&body=${encodeURIComponent(msg)}` : '';

const box = document.getElementById('shareBox');
box.style.display = 'flex';
box.innerHTML = `
  <button class="btn" id="btnCopy">Copy link</button>
  ${waHref ? `<a class="btn" id="btnWA" href="${waHref}" target="_blank">Open WhatsApp</a>` : ''}
  ${smsHref ? `<a class="btn" id="btnSMS" href="${smsHref}" target="_blank">Open SMS</a>` : ''}
`;

document.getElementById('btnCopy').onclick = async ()=>{
  const ok = await copyToClipboard(url);
  setApStatus(ok ? 'Link copied' : 'Copy failed');
};


  // 承認ポーリング開始
  pollApproval();
}

function setApStatus(t, ok=false){
  const el = $('#apStatus');
  el.textContent = t;
  el.style.color = ok ? '#0b684e' : (t.includes('Error') ? '#7a2e13' : '#333');
}

// GAS からステータス取得
async function pollApproval(){
  if(!S.approval.id) return;
  let tries = 0;
  const tick = async ()=>{
    tries++; if(tries>600 || S.approval.ok) return; // 最大 ~50分
    const q = new URLSearchParams({ kind:'approval.status', key:GAS_KEY, approvalId:S.approval.id, salonId:S.salonId, token:S.token });
    const j = await fetch(`${API_BASE}?${q}`).then(r=>r.json());
    if (j.ok && j.status === 'approved') {
      S.approval.ok = true; setApStatus('Approved ✔', true); calc(); return;
    }
    setTimeout(tick, 5000);
  };
  tick();
}


    // ====== Charge ======
async function doCharge(){
  const { grandJPY, grandLKR } = calc();
  const btn = document.getElementById('btnCharge');
  const msg = document.getElementById('chargeMsg');
  btn.disabled = true; msg.textContent = 'Charging…';

  try{
    // ここでは paymentMethodId を送らず、code.gs 側で customerId から補完する運用
    const r = await fetch(API_BASE, {
      method: "POST",
      body: JSON.stringify({
        key: GAS_KEY,
        kind: "charge",
        data: {
  amountJPY: grandJPY,
  customerId: S.customerId || '',
  salonId: S.salonId,
  token: S.token
}
      })
    });
    const j = await r.json();
    if(j.ok){
      msg.textContent = `Success! PaymentIntent: ${j.paymentIntentId} (${j.status})`;
    }else{
      msg.textContent = `Error: ${j.error || 'charge failed'}`;
      btn.disabled = false;
    }
  }catch(e){
    msg.textContent = 'Request failed: ' + e.message;
    btn.disabled = false;
  }
}

    /* ～～（既存スクリプト）～～ */

    // ====== Availability / Blackouts / Taken ======
    async function fetchAvailabilityMeta(){
      // GET availability.get
      const q = new URLSearchParams({
        kind: 'availability.get',
        key: GAS_KEY,
        salonId: S.salonId,
        token: S.token
      });
      const j = await fetch(`${API_BASE}?${q}`).then(r=>r.json());
      if (!j.ok) throw new Error(j.error || 'availability.get failed');
      const meta = j.meta || { openStart:'09:00', openEnd:'18:00', leadMin:0 };
      // capacity は taken 呼び出しの meta から拾う（ここではいったん空）
      document.getElementById('availOpenStart').value = meta.openStart || '09:00';
      document.getElementById('availOpenEnd').value   = meta.openEnd   || '18:00';
      document.getElementById('availLeadMin').value   = Number(meta.leadMin||0);
    }

    async function saveAvailability(){
      const openStart = document.getElementById('availOpenStart').value.trim() || '09:00';
      const openEnd   = document.getElementById('availOpenEnd').value.trim()   || '18:00';
      const leadMin   = Number(document.getElementById('availLeadMin').value||0);
      const msg = document.getElementById('availMsg');
      msg.textContent = 'Saving…';

      const j = await fetch(API_BASE, {
        method: 'POST',
        body: JSON.stringify({
          key: GAS_KEY,
          kind: 'availability.setMeta',
          data: { salonId: S.salonId, token: S.token, openStart, openEnd, leadMin }
        })
      }).then(r=>r.json());

      msg.textContent = j.ok ? 'Saved' : ('Error: ' + (j.error||'failed'));
      if (j.ok) {
  msg.style.color = '#0b684e';
  setTimeout(() => { msg.textContent = ''; msg.style.color = ''; }, 2000);
} else {
  msg.style.color = '#7a2e13';
}
      if (j.ok) {
  await fetchAvailabilityMeta();
  await loadBlackouts();
}


    }

    // ---- Blackouts ----
    function renderBlackouts(items){
      const box = document.getElementById('blackList');
      if (!items || !items.length){
        box.innerHTML = '<div class="muted">No blackouts</div>'; return;
      }
      box.innerHTML = items.map(b => {
        const id = String(b.id||'');
        const ymd = String(b.date||'').slice(0,10);
        const st  = String(b.start||'');
        const en  = String(b.end||'');
        const rsn = String(b.reason||'');
        return `
          <div class="row" style="align-items:center;justify-content:space-between;border:1px solid var(--brd);border-radius:10px;padding:6px 10px">
            <div>
              <div><b>${ymd}</b> ${st} - ${en}</div>
              <div class="muted" style="font-size:12px">${rsn||'-'}</div>
            </div>
            <button class="btn" data-id="${id}">Remove</button>
          </div>`;
      }).join('');
      box.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.onclick = ()=> removeBlackout(btn.getAttribute('data-id'));
      });
    }

    async function loadBlackouts(){
      const msg = document.getElementById('blackMsg');
      msg.textContent = 'Loading…';
      const q = new URLSearchParams({
        kind: 'blackouts.list',
        key: GAS_KEY,
        salonId: S.salonId,
        token: S.token
      });
      const j = await fetch(`${API_BASE}?${q}`).then(r=>r.json());
      if (!j.ok){ msg.textContent = 'Error: ' + (j.error||'failed'); return; }
      renderBlackouts(j.items||[]);
      msg.textContent = '';
    }

    async function addBlackout(){
      const date = document.getElementById('blackDate').value;
      const start= document.getElementById('blackStart').value || '';
      const end  = document.getElementById('blackEnd').value   || '';
      const reason = document.getElementById('blackReason').value || '';
      const msg = document.getElementById('blackMsg');
      if (!date){ msg.textContent='Select date'; return; }
      msg.textContent = 'Saving…';
      const j = await fetch(API_BASE, {
        method:'POST',
        body: JSON.stringify({
          key: GAS_KEY,
          kind: 'blackouts.add',
          data: { salonId: S.salonId, token: S.token, date, start, end, reason }
        })
      }).then(r=>r.json());
      if (!j.ok){ msg.textContent = 'Error: ' + (j.error||'failed'); return; }
      msg.textContent = 'Added';
      await loadBlackouts();
    }

    async function removeBlackout(id){
      if (!confirm('Are you sure you want to remove this blackout?')) return;
      const msg = document.getElementById('blackMsg');
      msg.textContent = 'Removing…';
      const j = await fetch(API_BASE, {
        method:'POST',
        body: JSON.stringify({
          key: GAS_KEY,
          kind: 'blackouts.remove',
          data: { salonId: S.salonId, token: S.token, id }
        })
      }).then(r=>r.json());
      msg.textContent = j.ok ? 'Removed' : ('Error: ' + (j.error||'failed'));
      await loadBlackouts();
    }

    // ---- Taken（当日の満枠スロット）----
    function expandSlots(startHM, endHM, stepMin){
      const toMin = hm => { const [h,m]=hm.split(':').map(Number); return h*60+(m||0); };
      const toHM  = min => String(Math.floor(min/60)).padStart(2,'0')+':'+String(min%60).padStart(2,'0');
      const out=[]; for(let t=toMin(startHM); t<toMin(endHM); t+=stepMin) out.push(toHM(t)); return out;
    }

    function renderTaken(meta, takenArray){
      const grid = document.getElementById('takenGrid');
      const all = expandSlots(meta.openStart, meta.openEnd, 30);
      const setTaken = new Set(takenArray||[]);
      grid.innerHTML = all.map(hm=>{
        const full = setTaken.has(hm);
        return `<span class="tag" style="${full?'background:#ffecec;border-color:#ffb3b3':''}">${hm}${full?' ×':''}</span>`;
      }).join('');
      document.getElementById('takenMeta').textContent =
        `Open: ${meta.openStart}–${meta.openEnd} · Lead: ${meta.leadMin}m · Capacity: ${meta.capacity||1}`;
      // Availabilityカード側にも capacity 反映（read-only）
      const capEl = document.getElementById('availCapacity');
      if (capEl && meta.capacity) capEl.value = String(meta.capacity);
    }

    async function loadTaken(){
      const ymd = document.getElementById('dayYMD').value;
      if (!ymd){ alert('Pick a date'); return; }
      const q = new URLSearchParams({
        kind: 'taken', key: GAS_KEY, ymd, salonId: S.salonId, token: S.token
      });
      const j = await fetch(`${API_BASE}?${q}`).then(r=>r.json());
      if (!j.ok){ alert(j.error || 'load failed'); return; }
      renderTaken(j.meta||{openStart:'09:00',openEnd:'18:00',leadMin:0,capacity:1}, j.items||[]);
    }

        // ====== INIT ======
    (async function init(){
      try{
        readCtx();
        // ★ 未ログインなら案内して終了
      if (!S.token) {
         document.body.innerHTML = `
           <div style="padding:24px;font:14px/1.6 system-ui">
             You need to log in to use Admin.<br>
             <a href="/login.html">Go to login</a>
           </div>`;
         return;
       }
        await fetchCatalog();
        $('#custName').textContent = qs.get('customerName') || '-';
        $('#sendLink').onclick = startApproval;
        $('#btnCharge').onclick = doCharge;

        // ▼▼▼ ここから追記 ▼▼▼
        // Availability 初期値をロード
        await fetchAvailabilityMeta();
        // Blackouts 一覧をロード
        await loadBlackouts();
        // イベント
        document.getElementById('btnAvailSave').onclick = saveAvailability;
        document.getElementById('btnBlackAdd').onclick  = addBlackout;
        document.getElementById('btnLoadTaken').onclick = loadTaken;

        // 便利：本日の日付を既定セット
        const d = new Date(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
        const today = `${d.getFullYear()}-${mm}-${dd}`;
        const dayInput = document.getElementById('dayYMD');
        if (dayInput && !dayInput.value) dayInput.value = today;
        const blackDate = document.getElementById('blackDate');
        if (blackDate && !blackDate.value) blackDate.value = today;
        // ▲▲▲ 追記ここまで ▲▲▲

      }catch(e){
        document.body.innerHTML = `<div style="padding:30px">Init failed: ${e?.message||e}</div>`;
      }
       // ===== tabs =====
      const tabsEl = document.getElementById('tabs');
  const panes = {
    billing: document.getElementById('pane-billing'),
    schedule: document.getElementById('pane-schedule'),
  };

  // クリック1か所で拾う（ボタン増えてもOK）
  tabsEl.addEventListener('click', (e) => {
    const btn = e.target.closest('.tab');
    if (!btn) return;
    const name = btn.dataset.tab;

    // ボタンの見た目
    tabsEl.querySelectorAll('.tab').forEach(b => {
      b.classList.toggle('active', b === btn);
    });

    // パネルの表示/非表示
    Object.entries(panes).forEach(([key, el]) => {
      el.hidden = (key !== name);
    });
  });

  // 初期表示は billing
  Object.entries(panes).forEach(([key, el]) => {
    el.hidden = (key !== 'billing');
  });
  </script>
</body>
</html>


