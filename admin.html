<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Pay Admin</title>
  <style>
    :root{--ink:#1d1b1a;--teal:#246A73;--muted:#6b5e55;--brd:#eadfca;--bg:#faf6ef}
    *{box-sizing:border-box} body{margin:0;background:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif;color:var(--ink)}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--brd);z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
    h1{font-size:20px;margin:0 0 6px}
    .grid{display:grid;gap:14px}
    @media(min-width:960px){.grid{grid-template-columns:2fr 1fr}}
    .card{background:#fff;border:1px solid var(--brd);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.06)}
    .card>.hd{padding:12px 14px;border-bottom:1px solid var(--brd);font-weight:800}
    .card>.bd{padding:12px 14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{display:block;font-weight:700;margin:8px 0 4px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--brd);border-radius:10px;background:#fff;font:inherit}
    input:read-only{background:#fafafa}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--brd);border-radius:999px}
    .btn{display:inline-flex;gap:.5em;align-items:center;justify-content:center;height:42px;padding:0 16px;border-radius:12px;font-weight:800;border:1px solid var(--brd);background:#fff;cursor:pointer}
    .btn.primary{background:var(--teal);border-color:var(--teal);color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .total{font-size:28px;font-weight:900}
    .warn{color:#7a2e13}
    .ok{color:#0b684e}
    .tbl{width:100%;border-collapse:collapse}
    .tbl td{padding:6px 4px}
    .tbl tr td:first-child{opacity:.8}
    .hr{height:1px;background:var(--brd);margin:8px 0}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid var(--brd);font-size:12px}
    .right{display:flex;flex-direction:column;gap:12px}
    .tag{padding:4px 8px;border:1px solid var(--brd);border-radius:8px;background:#fff}
    /* --- tabs --- */
    .tabs{display:flex;gap:8px;margin-bottom:8px}
    .tab{border:1px solid var(--brd);background:#fff;border-radius:999px;padding:8px 14px;cursor:pointer;font-weight:700}
    .tab.active{background:var(--teal);border-color:var(--teal);color:#fff}
    .tab-pane[hidden]{display:none}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Smart Pay — Admin</h1>
      <div class="row muted" id="ctx">Loading…</div>
    </div>
  </header>

  <main class="wrap grid" id="app" hidden>
    <!-- 左：コンポーザー -->
    <section class="card">
      <div class="hd">Bill Composer</div>
      <div class="bd">
        <div class="row">
          <div class="pill"><b>Booking</b> <span id="bkId">-</span></div>
          <div class="pill"><b>Salon</b> <span id="salonName">-</span></div>
          <div class="pill"><b>Customer</b> <span id="custName">-</span></div>
          <div class="pill"><b>Scheduled</b> <span id="scheduled">-</span></div>
        </div>

        <div class="hr"></div>

        <label>Menu</label>
        <div id="menuBox">Loading…</div>

        <label style="margin-top:10px">Add-ons</label>
        <div id="addonBox" class="row"></div>

        <div class="row" style="margin-top:10px">
          <div style="flex:1">
            <label>Discount</label>
            <select id="discountSel"></select>
           <!-- Discount の直後に追記 -->
<div class="row" style="margin-top:6px">
  <div style="flex:1">
    <input id="couponCodeInput" placeholder="Enter coupon code"/>
  </div>
  <div>
    <button id="btnCouponApply" class="btn">Apply</button>
  </div>
  <div>
    <button id="btnCouponClear" class="btn" style="display:none">Clear</button>
  </div>
</div>
<div id="couponMsg" class="muted" style="font-size:12px;margin-top:4px"></div> 
          </div>
          <div style="width:180px">
            <label>Manual adjust (±)</label>
            <input id="manualAdj" type="number" step="1" value="0"/>
            <div class="muted" style="font-size:12px">Limit: <span id="adjLimit">±1500</span> LKR</div>
          </div>
        </div>
        <div>
          <label>Reason for manual adjust</label>
          <input id="manualReason" placeholder="ex: Oil upgrade / Extension 30m"/>
        </div>
      </div>
    </section>

    <!-- 右：サマリー＆アクション -->
    <aside class="right">
        <div class="tabs" id="tabs">
         <button class="tab active" data-tab="billing">Billing</button>
         <button class="tab" data-tab="schedule">Schedule</button>
         <button class="tab" data-tab="catalog">Catalog</button>
         <button class="tab" data-tab="profile">Profile</button>
        </div>
          
        <div class="tab-pane" id="pane-billing">
  <section class="card">
    <div class="hd">Summary</div>
    <div class="bd">
      <table class="tbl">
        <tr><td>Base</td><td id="sumBase" style="text-align:right">-</td></tr>
        <tr><td>Add-ons</td><td id="sumAdd" style="text-align:right">-</td></tr>
        <tr><td>Discount</td><td id="sumDis" style="text-align:right">-</td></tr>
        <tr><td>Manual</td><td id="sumMan" style="text-align:right">-</td></tr>
        <tr><td>Service</td><td id="sumSvc" style="text-align:right">-</td></tr>
        <tr><td>Tax</td><td id="sumTax" style="text-align:right">-</td></tr>
      </table>
      <div class="hr"></div>
      <div class="total" id="grand">Rs 0</div>
      <div class="muted" id="deltaInfo"></div>
    </div>
  </section>

      <section class="card">
        <div class="hd">Approval</div>
        <div class="bd">
          <div class="row">
            <div style="flex:1">
              <label>Customer phone (WhatsApp / SMS)</label>
              <input id="custPhone" placeholder="+94xxxxxxxxx"/>
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="sendLink" class="btn" disabled>Send approval link</button>
            <span id="apStatus" class="badge">Not sent</span>
          </div>
          <div id="apTips" class="muted" style="margin-top:6px;font-size:12px">
            We will send a short link to the customer. When the customer taps <b>Approve</b>,
            the status turns green and the Charge button unlocks.
          </div>
          <div id="shareBox" class="row" style="margin-top:8px;display:none"></div>
        </div>
      </section>

      <section class="card">
        <div class="hd">Charge</div>
        <div class="bd">
          <button id="btnCharge" class="btn primary" disabled>Charge saved card</button>
          <div id="chargeMsg" class="muted" style="margin-top:8px"></div>
      </div>
      </section>
      </div>
            <!-- ▼▼▼ ここから追加：Availability（営業時間・リードタイム） ▼▼▼ -->
      <div class="tab-pane" id="pane-schedule" hidden>
      <section class="card">
        <div class="hd">Availability</div>
        <div class="bd">
          <div class="row">
            <div style="flex:1">
              <label>Open start (HH:mm)</label>
              <input id="availOpenStart" placeholder="09:00" />
            </div>
            <div style="flex:1">
              <label>Open end (HH:mm)</label>
              <input id="availOpenEnd" placeholder="18:00" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div style="flex:1">
              <label>Lead time (minutes)</label>
              <input id="availLeadMin" type="number" step="5" min="0" placeholder="0" />
            </div>
            <div style="flex:1">
              <label>Capacity</label>
              <input id="availCapacity" readonly placeholder="(salons シートで管理)" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnAvailSave" class="btn">Save availability</button>
            <span id="availMsg" class="muted"></span>
          </div>
        </div>
      </section>
      <!-- ▲▲▲ ここまで Availability ▲▲▲ -->

      <!-- ▼▼▼ ここから追加：Blackouts（臨時休止/満枠） ▼▼▼ -->
      <section class="card">
        <div class="hd">Blackouts</div>
        <div class="bd">
          <div class="row">
            <div style="flex:1">
              <label>Date</label>
              <input id="blackDate" type="date" />
            </div>
            <div style="width:110px">
              <label>Start</label>
              <input id="blackStart" placeholder="09:00" />
            </div>
            <div style="width:110px">
              <label>End</label>
              <input id="blackEnd" placeholder="18:00" />
            </div>
          </div>
          <div>
            <label>Reason</label>
            <input id="blackReason" placeholder="Maintenance, Staff meeting, etc." />
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnBlackAdd" class="btn">Add blackout</button>
            <span id="blackMsg" class="muted"></span>
          </div>
          <div class="hr"></div>
          <div class="muted" style="margin-bottom:6px">Existing blackouts</div>
          <div id="blackList"></div>
        </div>
      </section>
      <!-- ▲▲▲ ここまで Blackouts ▲▲▲ -->

      <!-- ▼▼▼ ここから追加：Taken（当日の満枠） ▼▼▼ -->
      <section class="card">
        <div class="hd">Taken slots</div>
        <div class="bd">
          <div class="row">
            <div style="flex:1">
              <label>Date</label>
              <input id="dayYMD" type="date" />
            </div>
            <div style="align-self:flex-end">
              <button id="btnLoadTaken" class="btn">Load</button>
            </div>
          </div>
          <div class="hr"></div>
          <div id="takenMeta" class="muted" style="margin-bottom:8px"></div>
          <div id="takenGrid" class="row" style="flex-wrap:wrap;gap:8px"></div>
        </div>
      </section>
      </div>
      <!-- ▲▲▲ ここまで Taken ▲▲▲ -->
        <!-- ▼▼▼ Catalog（Menu & Coupons 管理） ▼▼▼ -->
<div class="tab-pane" id="pane-catalog" hidden>
  <section class="card">
    <div class="hd">Menus</div>
    <div class="bd">
      <div class="row">
        <div style="flex:2">
          <label>Menu name</label>
          <input id="menuName" placeholder="ex: Premium Facial"/>
        </div>
        <div style="flex:1">
          <label>Price (LKR)</label>
          <input id="menuPrice" type="number" step="1" min="0" placeholder="9000"/>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnMenuAdd" class="btn">Add menu</button>
        <span id="menuMsg" class="muted"></span>
      </div>
      <div class="hr"></div>
      <div class="muted" style="margin-bottom:6px">Existing menus</div>
      <div id="menuList"></div>
    </div>
  </section>

  <section class="card">
    <div class="hd">Coupons / Discounts</div>
    <div class="bd">
      <div class="row">
        <div style="flex:2">
          <label>Coupon name (optional)</label>
          <input id="cpnName" placeholder="ex: New Customer"/>
        </div>
        <div style="flex:1">
          <label>Type</label>
          <select id="cpnType">
            <option value="flat">Flat (LKR)</option>
            <option value="percent">Percent (%)</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Value</label>
          <input id="cpnValue" type="number" step="1" min="0" placeholder="1000 or 10"/>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnCpnAdd" class="btn">Add coupon</button>
        <span id="cpnMsg" class="muted"></span>
      </div>
      <div class="hr"></div>
      <div class="muted" style="margin-bottom:6px">Existing coupons</div>
      <div id="cpnList"></div>
    </div>
  </section>
    <!-- ▼▼▼ Coupon Codes（管理者専用コード登録） ▼▼▼ -->
  <section class="card" style="margin-top:20px">
    <div class="hd">Private Coupon Codes (for confirmation screen)</div>
    <div class="bd">
      <div class="row">
        <div style="flex:1">
          <label>Coupon Code</label>
          <input id="cpnCodeAdmin" placeholder="ex: WELCOME10"/>
        </div>
        <div style="flex:1">
          <label>Discount Type</label>
          <select id="cpnCodeType">
            <option value="flat">Flat (LKR)</option>
            <option value="percent">Percent (%)</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Value</label>
          <input id="cpnCodeValue" type="number" step="1" min="0" placeholder="e.g. 1000 or 10"/>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnCpnCodeAdd" class="btn">Add Code</button>
        <span id="cpnCodeMsg" class="muted"></span>
      </div>
      <div class="hr"></div>
      <div class="muted" style="margin-bottom:6px">Existing Codes</div>
      <div id="cpnCodeList"></div>
    </div>
  </section>
  <!-- ▲▲▲ Coupon Codes 終了 ▲▲▲ -->
</div>
<!-- ▲▲▲ Catalog 終了 ▲▲▲ -->
        <!-- ▼▼▼ Profile（Salon Photos 管理） ▼▼▼ -->
<div class="tab-pane" id="pane-profile" hidden>
  <!-- ▼▼▼ Salon Meta（Area & Categories） ▼▼▼ -->
<section class="card">
  <div class="hd">Salon Meta</div>
  <div class="bd">
    <div class="row">
      <div style="flex:1">
        <label>Area</label>
        <!-- 必要に応じて選択肢を増やす -->
        <select id="metaArea">
          <option value="">Select area…</option>
          <option>Colombo</option>
          <option>Kandy</option>
          <option>Galle</option>
          <option>Negombo</option>
          <option>Matara</option>
        </select>
      </div>
      <div style="flex:2">
        <label>Service categories (multi)</label>
        <!-- カンマ区切り or スペース区切りで入力。例: facial, haircut, spa -->
        <input id="metaCategories" placeholder="e.g. facial, haircut, spa" />
        <div class="muted" style="font-size:12px;margin-top:4px">
          Enter multiple categories separated by commas.
        </div>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnMetaSave" class="btn">Save meta</button>
      <span id="metaMsg" class="muted"></span>
    </div>
  </div>
</section>
<!-- ▲▲▲ Salon Meta 終了 ▲▲▲ -->

  <section class="card">
    <div class="hd">Salon Photos</div>
    <div class="bd">
      <div class="row">
        <div style="flex:1">
          <label>Upload photos (JPG/PNG, up to ~2MB each)</label>
          <input id="photoFiles" type="file" accept="image/*" multiple />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnPhotoUpload" class="btn">Upload</button>
        <span id="photoMsg" class="muted"></span>
      </div>
      <div class="hr"></div>
      <div class="muted" style="margin-bottom:6px">Current photos</div>
      <div id="photoGrid" class="row" style="gap:10px;flex-wrap:wrap"></div>
    </div>
  </section>
</div>
<!-- ▲▲▲ Profile 終了 ▲▲▲ -->
      </div>
    </aside>
  </main>

  <script>
   // ====== CONFIG ======
  // ====== CONFIG ======
  const API_BASE = 'https://workers-playground-winter-field-18ec.mayunatu-skyblue.workers.dev/api';  // ← Worker経由に変更
  const GAS_KEY  = 'bl_gas_key_bR6ZXWwu6kM_nrK25geP97Cs5qCX3auxugX_IUGlg90';
  const MAX_MANUAL_JPY = 1500;
  const DELTA_WARN_RATE = 0.2;
  const MOCK = false;
  const APPROVE_FILE = 'https://beautylk.com/approve.html'; // 公開中のapprove.html URL

    // ====== STATE ======
    const S = {
      salonId: '', bookingId: '', customerId: '', scheduledPrice: 0, tenantName: '',
      catalog: { menus: [], addons: [], discounts: [], taxRate: 0, serviceRate: 0 },
      sel: { menuId: '', addonIds: new Set(), discountId: '', manual: 0, reason: '' },
      approval: { id: '', ok: false },
      coupon: { code: '', discountType: '', discountValue: 0 },
      meta:{ area:'', categories:[] }
    };
  // ====== GLOBAL ERROR HANDLER ======
window.addEventListener('unhandledrejection', e => {
  alert('Network or script error: ' + (e.reason?.message || e.reason || 'Unknown'));
});
window.addEventListener('error', e => {
  console.error(e);
  alert('Unexpected error: ' + (e.message || e.error));
});
const FX_RATE = 2.15;
function toJPY(lkr){ return Math.round((Number(lkr)||0) / FX_RATE); }
function toLKR(jpy){ return Math.round((Number(jpy)||0) * FX_RATE); }
    // ====== HELPERS ======
    const $ = (q) => document.querySelector(q);
    function fmtLKR(lkr){
    return `Rs ${Number(lkr||0).toLocaleString('en-US')}`;
   }   

    const qs = new URLSearchParams(location.search);
    // === Token helper: URL→localStorage保存、以後は保存済みを優先 ===
  function getToken() {
    // 1) URLにtokenがあれば保存してURLから消す
    const urlToken = qs.get('token');
    if (urlToken) {
      localStorage.setItem('bl_token', urlToken);
      // URLをクリーンに（tokenを見せない）
      const u = new URL(location.href);
      u.searchParams.delete('token');
      history.replaceState(null, '', u.toString());
    }
    // 2) 保存済み or 既にURLで来たtoken
    return localStorage.getItem('bl_token') || urlToken || '';
  }
    function normalizePhone(raw){
  // +94xxxxxxxxx を想定。先頭+がなければ付与、空白/ハイフン除去
  let p = String(raw||'').replace(/[\s-]/g,'');
  if (!p) return '';
  if (!p.startsWith('+')) {
    // 例：スリランカなら +94 を付与（必要に応じて運用国に合わせて調整）
    if (p.startsWith('0')) p = '+94' + p.slice(1);
    else p = '+94' + p;
  }
  return p;
}
function encodeMsg(s){ return encodeURIComponent(s).replace(/%20/g,'+'); }
async function copyToClipboard(text){
  try{ await navigator.clipboard.writeText(text); return true; }catch(e){ return false; }
}
async function validateCouponAndApply(code){
  const msgEl = document.getElementById('couponMsg');
  msgEl.textContent = 'Validating…';

  // 現在の（クーポン適用前）小計（＝base+add+manual を含むが discount は除外して使う）
  // currentAmounts() は Discount を含むので、一旦 Discount を退避して計算します
  const prevDiscountId = S.sel.discountId;
  S.sel.discountId = '';
  const { base, add, man } = currentAmounts();
S.sel.discountId = prevDiscountId;
// currentAmounts() は LKR なので、API には JPY で渡す
const subtotalJPY = toJPY(base + add + man);

  try{
    const email = (new URLSearchParams(location.search)).get('customerEmail') || ''; // confirm側と同様にメールを添える
    const resp = await fetch(API_BASE, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({
        key: GAS_KEY,
        kind: 'coupons.validate',
        data: {
          salonId: S.salonId,
          token:   S.token,
          code:    String(code||'').trim(),
          email,                 // first-time 等の制約チェック用（confirm側の思想と合わせる）
          amountJPY: subtotalJPY // 現在の小計を渡してサーバで割引計算
        }
      })
    }).then(r=>r.json());

    if(!resp || !resp.ok){
      msgEl.textContent = 'Coupon invalid or not applicable.';
      return false;
    }

    // サーバ想定レスポンス例:
    // { ok:true, type:'flat'|'percent', value: number, appliedJPY: number, offJPY: number, name: 'New Customer' }
    const type = (resp.type === 'percent') ? 'percent' : 'flat';
    const value = Number(resp.value||0);
    const label = resp.name ? `${resp.name} (${code})` : `Coupon ${code}`;

    // 既存の discount セレクタに“仮想”クーポンを注入して選択
    const tempId = `COUPON:${code}`;
    // すでに同名がいるなら更新、いなければ追加
    const idx = (S.catalog.discounts||[]).findIndex(d=>d && d.id===tempId);
    const item = { id: tempId, type, value, name: label };
    if(idx >= 0) S.catalog.discounts[idx] = item; else S.catalog.discounts.push(item);
    S.sel.discountId = tempId;

    // 状態も保持
    S.coupon.code = code;
    S.coupon.discountType = type;
    S.coupon.discountValue = value;

    // UI反映
    const dsel = document.getElementById('discountSel');
    if (dsel) {
      // 再レンダ（安全のため）
      dsel.innerHTML = `<option value="">None</option>` + (S.catalog.discounts||[]).map(d=>{
        const label = d.type==='percent' ? `${d.name} (-${d.value}%)` : `${d.name} (-${fmtLKR(d.value)})`;
        return `<option value="${d.id}">${label}</option>`;
      }).join('');
      dsel.value = tempId;
    }
    document.getElementById('btnCouponClear').style.display = '';
    msgEl.textContent = 'Applied ✔';
    calc();
    return true;
  }catch(e){
    msgEl.textContent = 'Validate failed: ' + (e.message||'');
    return false;
  }
}

function clearCoupon(){
  const msgEl = document.getElementById('couponMsg');
  // セレクタから仮想クーポンを消して、Discount選択も解除
  if (S.coupon && S.coupon.code){
    const tempId = `COUPON:${S.coupon.code}`;
    S.catalog.discounts = (S.catalog.discounts||[]).filter(d => d.id !== tempId);
  }
  S.sel.discountId = '';
  S.coupon = { code:'', discountType:'', discountValue:0 };

  // UI 更新
  const dsel = document.getElementById('discountSel');
  if (dsel) {
    dsel.innerHTML = `<option value="">None</option>` + (S.catalog.discounts||[]).map(d=>{
      const label = d.type==='percent' ? `${d.name} (-${d.value}%)` : `${d.name} (-${fmtLKR(d.value)})`;
      return `<option value="${d.id}">${label}</option>`;
    }).join('');
    dsel.value = '';
  }
  document.getElementById('btnCouponClear').style.display = 'none';
  msgEl.textContent = 'Cleared';
  calc();
}

    function readCtx(){
  S.token = getToken(); // ← URL/保存済みのどちらでもOKに
  S.salonId = qs.get('salonId')||'';
  S.bookingId = qs.get('bookingId')||'';
  S.customerId = qs.get('customerId')||'';
  S.scheduledJPY = Number(qs.get('scheduled')||0);
  S.scheduledLKR = toLKR(S.scheduledJPY);
  S.tenantName = qs.get('salonName')||'';
  $('#ctx').innerHTML = `Salon <b>${S.tenantName||S.salonId}</b> · Booking <b>${S.bookingId||'-'}</b>`;
  $('#bkId').textContent = S.bookingId||'-';
  $('#salonName').textContent = S.tenantName||S.salonId||'-';
  $('#scheduled').textContent = fmtLKR(S.scheduledLKR);
  // 手動調整の上限は JPY を基準に設定 → 表示はLKR
  $('#adjLimit').textContent = `${toLKR(MAX_MANUAL_JPY).toLocaleString('en-US')}`;
}

async function fetchCatalog(){
  if (!S.token) S.token = getToken();
  if(MOCK){
    S.catalog = {
      menus: [
        { id: "M_BASIC", name: "Basic Treatment", price: 5000 },
        { id: "M_PREMIUM", name: "Premium Treatment", price: 9000 }
      ],
      addons: [], // addons を使う場合は別途シート/エンドポイント用意
      discounts: [
        { id: "D_10P", type: "percent", value: 10, name: "10% OFF" },
        { id: "D_500", type: "flat", value: 500, name: "¥500 OFF" }
      ],
      taxRate: 10, serviceRate: 0
    };
  }else{
    // 1) メニュー取得
    const q1 = new URLSearchParams({ kind:'menus.list', key:GAS_KEY, salonId:S.salonId, token:S.token });
    const m = await fetch(`${API_BASE}?${q1}`).then(r=>r.json());
    const menus = (m.ok ? (m.items||[]) : []).map(x => ({
    // まず x.id を優先。なければ既存互換の候補にフォールバック
    id: String(x.id || x.menu_id || x.name_en || x.name_ja || 'MENU'),
    name: x.name_en || x.name_ja || x.desc || 'Menu',
    price: toLKR(Number(x.price_jpy || x.price || 0)) 
  }));

    // 2) クーポン（＝Discount）取得
    const q2 = new URLSearchParams({ kind:'coupons.list', key:GAS_KEY, salonId:S.salonId, token:S.token });
    const c = await fetch(`${API_BASE}?${q2}`).then(r=>r.json());
    const discounts = (c.ok ? (c.items||[]) : []).map(x => {    const type = (String(x.type||'').toLowerCase() === 'percent') ? 'percent' : 'flat';
    const val  = Number(x.value_lkr || x.value || 0);
    return {
      // こちらも id を最優先。旧データとの互換も残す
      id: String(x.id || x.menu_id || x.code || x.name_en || x.name_ja || 'DISC'),
      type, value: val,
      name: (x.name_en || x.name_ja || (type==='percent'? `${val}% OFF` : `${val} OFF`))
    };
  });
    // 3) Private coupon codes（confirm 用コード）取得
const q3 = new URLSearchParams({ kind:'couponCodes.list', key:GAS_KEY, salonId:S.salonId, token:S.token });
const codesRes = await fetch(`${API_BASE}?${q3}`).then(r=>r.json());
const codes = (codesRes.ok ? (codesRes.items||[]) : []).map(x=>({
  id: String(x.id || x.code || 'CODE'),
  code: String(x.code||''),
  type: (String(x.type||'').toLowerCase()==='percent') ? 'percent' : 'flat',
  value: Number(x.value_lkr || x.value || 0)
}));

    S.catalog = {
      menus,
      addons: [],                 // 使うなら別途
      discounts,
      codes,
      taxRate: 10,                // 必要に応じて salons シート等から参照に変更可
      serviceRate: 0
    };
  }

  if(!S.sel.menuId && S.catalog.menus[0]) S.sel.menuId = S.catalog.menus[0].id;
  renderComposer(); calc();
}

function renderComposer(){
  const mbox = $('#menuBox');
  mbox.innerHTML = (S.catalog.menus||[]).map(m => `
    <label class="row" style="align-items:flex-start">
      <input type="radio" name="menu" value="${m.id}" ${S.sel.menuId===m.id?'checked':''} />
      <div style="margin-left:8px">
        <div><b>${m.name}</b></div>
        <div class="muted">${fmtLKR(m.price)}</div>
      </div>
    </label>
  `).join('') || '<div class="muted">No menus</div>';

  // メニュー選択
  mbox.querySelectorAll('input[name="menu"]').forEach(r=>{
    r.addEventListener('change', e => { S.sel.menuId = e.target.value; calc(); });
  });

  // Add-on
  const abox = $('#addonBox');
  abox.innerHTML = (S.catalog.addons||[]).map(a => {
    const on = S.sel.addonIds.has(a.id);
    return `<label class="tag"><input type="checkbox" value="${a.id}" ${on?'checked':''}/> ${a.name} (+${fmtLKR(a.price)})</label>`;
  }).join('') || '<div class="muted">No add-ons</div>';

  // Add-on トグル
  abox.querySelectorAll('input[type="checkbox"]').forEach(c=>{
    c.addEventListener('change', e => {
      const id = e.target.value;
      if (e.target.checked) S.sel.addonIds.add(id);
      else S.sel.addonIds.delete(id);
      calc();
    });
  });

  // Discount
  const dsel = $('#discountSel');
  dsel.innerHTML = `<option value="">None</option>` + (S.catalog.discounts||[]).map(d=>{
    const label = d.type==='percent'
  ? `${d.name} (-${d.value}% )`
  : `${d.name} (-${fmtLKR(d.value)})`;
    return `<option value="${d.id}">${label}</option>`;
  }).join('');
  dsel.value = S.sel.discountId||'';
  dsel.onchange = ()=>{ S.sel.discountId = dsel.value||''; calc(); };

  // Manual adjust
  const man = $('#manualAdj');
  // 表示はLKR（内部はJPYで保持）
  man.value = String(S.sel.manualLKR || 0);
  man.oninput = ()=>{
    S.sel.manualLKR = Math.round(Number(man.value||0));
    calc();
  };

  const rea = $('#manualReason');
  rea.value = S.sel.reason||'';
  rea.oninput = ()=>{ S.sel.reason = rea.value.trim(); };

  document.getElementById('app').hidden = false;
}
(function(){
  const tabs = document.getElementById('tabs');
  if(!tabs) return;
  tabs.addEventListener('click', (e)=>{
    const btn = e.target.closest('.tab');
    if(!btn) return;
    const to = btn.getAttribute('data-tab');
    document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t===btn));
    document.querySelectorAll('.tab-pane').forEach(p=> p.hidden = (p.id !== 'pane-'+to));
  });
})();
    function currentAmounts(){
      const menu = (S.catalog.menus||[]).find(m=>m.id===S.sel.menuId);
      const base = menu? Number(menu.price||0):0;
      const add = [...S.sel.addonIds]
     .map(id => (S.catalog.addons||[]).find(a=>a.id===id)?.price || 0)
     .reduce((a,b)=>a+b,0);      const disc = (()=>{
        const d = (S.catalog.discounts||[]).find(x=>x.id===S.sel.discountId);
        if(!d) return 0; if(d.type==='percent') return - Math.round((base+add) * (d.value/100));
        return - Number(d.value||0);
      })();
      const man = Number(S.sel.manualLKR||0);
      return { base, add, disc, man };
    }

    function calc(){
  const di = document.getElementById('deltaInfo');
  const { base, add, disc, man } = currentAmounts();
  const warnAdj = toJPY(Math.abs(man)) > MAX_MANUAL_JPY; 
  const needReason = man!==0 && !S.sel.reason;

  const subLKR = base + add + disc + man;
  const svcLKR = Math.round(subLKR * (Number(S.catalog.serviceRate||0)/100));
  const taxLKR = Math.round((subLKR+svcLKR) * (Number(S.catalog.taxRate||0)/100));
  const grandLKR = Math.max(0, subLKR + svcLKR + taxLKR);
  const grandJPY = toJPY(grandLKR);
      
  $('#sumBase').textContent = fmtLKR(base);
  $('#sumAdd').textContent  = fmtLKR(add);
  $('#sumDis').textContent  = fmtLKR(disc);
  $('#sumMan').textContent  = fmtLKR(man) + (warnAdj? ' ⚠ over limit':'' ) + (needReason? ' ⚠ reason required':'');

  $('#sumSvc').textContent = fmtLKR(svcLKR);
  $('#sumTax').textContent = fmtLKR(taxLKR);
  $('#grand').textContent  = fmtLKR(grandLKR);
      
  // Δ比較もLKR表記に揃える
      
  const diffJPY = grandJPY - Number(S.scheduledJPY||0);
  const diffLKR = toLKR(diffJPY);
  const rate = (S.scheduledJPY? diffJPY/ S.scheduledJPY : 0);
  di.textContent = `Δ from scheduled: ${fmtLKR(diffLKR)} (${(rate*100).toFixed(1)}%)`;
  di.className = 'muted ' + (Math.abs(rate) > DELTA_WARN_RATE ? 'warn':'');

  const allow = !warnAdj && !needReason && S.approval.ok && grandJPY>0;
  $('#btnCharge').disabled = !allow;
　// Send approval ボタンの有効/無効も同期
const sendBtn = document.getElementById('sendLink');
if (sendBtn) {
  const validToApprove =
    (base + add + disc + man) > 0 &&
    !!S.sel.menuId &&
    Math.abs(man) <= MAX_MANUAL_JPY &&
    (man === 0 || !!S.sel.reason);
  sendBtn.disabled = !validToApprove;
}

  // ★ JPYとLKR両方返す
  return { grandJPY, grandLKR };
}


    // ====== Approval ======
function rid(){ return (Date.now().toString(36)+Math.random().toString(36).slice(2,8)).toUpperCase(); }

async function startApproval(){
  const phone = $('#custPhone').value.trim(); // いまはUIに保持だけ（送信は任意）
  const { grandJPY, grandLKR } = calc();
  // guard: menu未選択／金額0／手動調整超過／理由欠落
  const { base, add, disc, man } = currentAmounts();
  if (!S.sel.menuId) { alert('Please select a menu.'); return; }
  if ((base + add + disc + man) <= 0) { alert('Amount must be greater than 0.'); return; }
  if (toJPY(Math.abs(man)) > MAX_MANUAL_JPY) { alert('Manual adjust exceeds limit.'); return; }  if (man !== 0 && !S.sel.reason) { alert('Please enter a reason for manual adjust.'); return; }

  // GAS: approval.start
  const res = await fetch(API_BASE, {
    method:'POST',
    body: JSON.stringify({
      key: GAS_KEY,
      kind: 'approval.start',
      data: {
   bookingId: S.bookingId,
         salonId:   S.salonId,
         token:     S.token,
         items: {
          menuId:    S.sel.menuId,
          addonIds:  Array.from(S.sel.addonIds || []),
          discountId: S.sel.discountId || '',
          manual:    toJPY(Number(S.sel.manualLKR||0)) // JPYで保持
        },
        amountJPY:  grandJPY,
        amountLKR:  grandLKR,
        phone:      phone || '',
        couponCode: (S.coupon?.code || ''),
        discountJPY: (()=>{
        const prev = S.sel.discountId;
        S.sel.discountId = '';
        const before = currentAmounts();
        S.sel.discountId = prev;
        const after  = currentAmounts();
        // disc は LKR の負値 → JPY の正値で送る
        return toJPY(Math.abs(after.disc||0));
      })(),
        ttlMin: 60
      }
    })
  }).then(r=>r.json());

  if(!res.ok){ alert(res.error || 'approval start failed'); return; }

  // 顧客リンク（approve 側に必要情報を付与）
  // customerEmail / customerName が取れるなら付ける（カード保存時の upsertCustomer 用）
  // 顧客リンク生成（approve 側へ必要情報を付与）
let url = `${APPROVE_FILE}?aid=${encodeURIComponent(res.approvalId)}`;
url += `&customerId=${encodeURIComponent(S.customerId||'')}`;
url += `&customerEmail=${encodeURIComponent(qs.get('customerEmail')||'')}`;
url += `&customerName=${encodeURIComponent(qs.get('customerName')||'')}`;
url += `&salonId=${encodeURIComponent(S.salonId||'')}`;
url += `&bookingId=${encodeURIComponent(S.bookingId||'')}`;

// URL安全化
const safeURL = encodeURI(url);

  setApStatus('Link created');
  S.approval.id = res.approvalId;

   // 共有（開いて確認 or コピーして送る）
  window.open(safeURL, '_blank');
  // --- 共有UIを表示 ---
  const phoneNorm = normalizePhone($('#custPhone').value.trim());
  const msg = ['Please approve your bill:', safeURL].join('\n');

const waHref  = phoneNorm ? `https://wa.me/${phoneNorm.replace('+','')}/?text=${encodeURIComponent(msg)}` : '';
const smsHref = phoneNorm ? `sms:${encodeURIComponent(phoneNorm)}?&body=${encodeURIComponent(msg)}` : '';

const box = document.getElementById('shareBox');
box.style.display = 'flex';
box.innerHTML = `
  <button class="btn" id="btnCopy">Copy link</button>
  ${waHref ? `<a class="btn" id="btnWA" href="${waHref}" target="_blank">Open WhatsApp</a>` : ''}
  ${smsHref ? `<a class="btn" id="btnSMS" href="${smsHref}" target="_blank">Open SMS</a>` : ''}
`;

document.getElementById('btnCopy').onclick = async ()=>{
  const ok = await copyToClipboard(safeURL);
  setApStatus(ok ? 'Link copied' : 'Copy failed');
};


  // 承認ポーリング開始
  pollApproval();
}

function setApStatus(t, ok=false){
  const el = $('#apStatus');
  el.textContent = t;
  el.style.color = ok ? '#0b684e' : (t.includes('Error') ? '#7a2e13' : '#333');
}

// GAS からステータス取得
async function pollApproval(){
  if(!S.approval.id) return;
  let tries = 0;
  const tick = async ()=>{
    tries++; if(tries>600 || S.approval.ok) return; // 最大 ~50分
    const q = new URLSearchParams({ kind:'approval.status', key:GAS_KEY, approvalId:S.approval.id, salonId:S.salonId, token:S.token });
    const j = await fetch(`${API_BASE}?${q}`).then(r=>r.json());
    if (j.ok && j.status === 'approved') {
      S.approval.ok = true; setApStatus('Approved ✔', true); calc(); return;
    }
    if (!j.ok) {
    if ((j.error||'').toLowerCase().includes('unauthorized')) {
      setApStatus('Login expired. Please login again.');
      alert('Your login has expired. Please login again.');
      location.href = '/login.html?redirect=' + encodeURIComponent(location.pathname + location.search);
      return;
    }
    setTimeout(tick, 5000);
   return;
}

    setTimeout(tick, 5000);
  };
  tick();
}


    // ====== Charge ======
async function doCharge(){
  const { grandJPY, grandLKR } = calc();
  const btn = document.getElementById('btnCharge');
  const msg = document.getElementById('chargeMsg');
  btn.disabled = true; msg.textContent = 'Charging…';

  try{
    // ここでは paymentMethodId を送らず、code.gs 側で customerId から補完する運用
    const r = await fetch(API_BASE, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        key: GAS_KEY,
        kind: "charge",
        data: {
  amountLKR: grandLKR,
  customerId: S.customerId || '',
  salonId: S.salonId,
  token: S.token
}
      })
    });
    const j = await r.json();
    if(j.ok){
      msg.textContent = `Success! PaymentIntent: ${j.paymentIntentId} (${j.status})`;
    }else{
      msg.textContent = `Error: ${j.error || 'charge failed'}`;
      btn.disabled = false;
    }
  }catch(e){
    msg.textContent = 'Request failed: ' + e.message;
    btn.disabled = false;
  }
}

    /* ～～（既存スクリプト）～～ */

    // ====== Availability / Blackouts / Taken ======
    async function fetchAvailabilityMeta(){
      // GET availability.get
      const q = new URLSearchParams({
        kind: 'availability.get',
        key: GAS_KEY,
        salonId: S.salonId,
        token: S.token
      });
      const j = await fetch(`${API_BASE}?${q}`).then(r=>r.json());
      if (!j.ok) throw new Error(j.error || 'availability.get failed');
      const meta = j.meta || { openStart:'09:00', openEnd:'18:00', leadMin:0 };
      // capacity は taken 呼び出しの meta から拾う（ここではいったん空）
      document.getElementById('availOpenStart').value = meta.openStart || '09:00';
      document.getElementById('availOpenEnd').value   = meta.openEnd   || '18:00';
      document.getElementById('availLeadMin').value   = Number(meta.leadMin||0);
    }

    async function saveAvailability(){
      const openStart = document.getElementById('availOpenStart').value.trim() || '09:00';
      const openEnd   = document.getElementById('availOpenEnd').value.trim()   || '18:00';
      const leadMin   = Number(document.getElementById('availLeadMin').value||0);
      const msg = document.getElementById('availMsg');
      msg.textContent = 'Saving…';

      const j = await fetch(API_BASE, {
        method: 'POST',
        body: JSON.stringify({
          key: GAS_KEY,
          kind: 'availability.setMeta',
          data: { salonId: S.salonId, token: S.token, openStart, openEnd, leadMin }
        })
      }).then(r=>r.json());

      msg.textContent = j.ok ? 'Saved' : ('Error: ' + (j.error||'failed'));
      if (j.ok) {
  msg.style.color = '#0b684e';
  setTimeout(() => { msg.textContent = ''; msg.style.color = ''; }, 2000);
} else {
  msg.style.color = '#7a2e13';
}
      if (j.ok) {
  await fetchAvailabilityMeta();
  await loadBlackouts();
}


    }

    // ---- Blackouts ----
    function renderBlackouts(items){
      const box = document.getElementById('blackList');
      if (!items || !items.length){
        box.innerHTML = '<div class="muted">No blackouts</div>'; return;
      }
      box.innerHTML = items.map(b => {
        const id = String(b.id||'');
        const ymd = String(b.date||'').slice(0,10);
        const st  = String(b.start||'');
        const en  = String(b.end||'');
        const rsn = String(b.reason||'');
        return `
          <div class="row" style="align-items:center;justify-content:space-between;border:1px solid var(--brd);border-radius:10px;padding:6px 10px">
            <div>
              <div><b>${ymd}</b> ${st} - ${en}</div>
              <div class="muted" style="font-size:12px">${rsn||'-'}</div>
            </div>
            <button class="btn" data-id="${id}">Remove</button>
          </div>`;
      }).join('');
      box.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.onclick = ()=> removeBlackout(btn.getAttribute('data-id'));
      });
    }

    async function loadBlackouts(){
      const msg = document.getElementById('blackMsg');
      msg.textContent = 'Loading…';
      const q = new URLSearchParams({
        kind: 'blackouts.list',
        key: GAS_KEY,
        salonId: S.salonId,
        token: S.token
      });
      const j = await fetch(`${API_BASE}?${q}`).then(r=>r.json());
      if (!j.ok){ msg.textContent = 'Error: ' + (j.error||'failed'); return; }
      renderBlackouts(j.items||[]);
      msg.textContent = '';
    }

    async function addBlackout(){
      const date = document.getElementById('blackDate').value;
      const start= document.getElementById('blackStart').value || '';
      const end  = document.getElementById('blackEnd').value   || '';
      const reason = document.getElementById('blackReason').value || '';
      const msg = document.getElementById('blackMsg');
      if (!date){ msg.textContent='Select date'; return; }
      msg.textContent = 'Saving…';
      const j = await fetch(API_BASE, {
        method:'POST',
        body: JSON.stringify({
          key: GAS_KEY,
          kind: 'blackouts.add',
          data: { salonId: S.salonId, token: S.token, date, start, end, reason }
        })
      }).then(r=>r.json());
      if (!j.ok){ msg.textContent = 'Error: ' + (j.error||'failed'); return; }
      msg.textContent = 'Added';
      await loadBlackouts();
    }

    async function removeBlackout(id){
      if (!confirm('Are you sure you want to remove this blackout?')) return;
      const msg = document.getElementById('blackMsg');
      msg.textContent = 'Removing…';
      const j = await fetch(API_BASE, {
        method:'POST',
        body: JSON.stringify({
          key: GAS_KEY,
          kind: 'blackouts.remove',
          data: { salonId: S.salonId, token: S.token, id }
        })
      }).then(r=>r.json());
      msg.textContent = j.ok ? 'Removed' : ('Error: ' + (j.error||'failed'));
      await loadBlackouts();
    }
   // ====== Catalog (Menus/Coupons) ======

// Menus
function renderMenuList() {
  const box = document.getElementById('menuList');
  const items = S.catalog.menus || [];
  if (!box) return;
  if (!items.length) { box.innerHTML = '<div class="muted">No menus</div>'; return; }
  box.innerHTML = items.map(m => `
    <div class="row" style="align-items:center;justify-content:space-between;border:1px solid var(--brd);border-radius:10px;padding:6px 10px">
      <div><b>${m.name}</b> · ${fmtLKR(m.price)}</div>
      <button class="btn" data-id="${m.id}">Remove</button>
    </div>
  `).join('');
  box.querySelectorAll('button[data-id]').forEach(b => {
    b.onclick = () => removeMenu(b.getAttribute('data-id'));
  });
}

async function addMenu(){
  const name = document.getElementById('menuName').value.trim();
  const price = Number(document.getElementById('menuPrice').value||0);
  const msg = document.getElementById('menuMsg');
  if (!name || price<=0){ msg.textContent = 'Enter name and price'; return; }
  msg.textContent = 'Saving…';
  const j = await fetch(API_BASE, {
    method:'POST',
    body: JSON.stringify({
      key: GAS_KEY,
      kind: 'menus.add',
      data: { salonId: S.salonId, token: S.token, name_en: name, price_lkr: price }
    })
  }).then(r=>r.json());
  msg.textContent = j.ok ? 'Added' : ('Error: ' + (j.error||'failed'));
  if (j.ok){
    document.getElementById('menuName').value = '';
    document.getElementById('menuPrice').value = '';
    await fetchCatalog();          // 最新を取得して
    renderMenuList();              // 再描画
  }
}

async function removeMenu(id){
  if (!confirm('Remove this menu?')) return;
  const msg = document.getElementById('menuMsg');
  msg.textContent = 'Removing…';
  const j = await fetch(API_BASE, {
    method:'POST',
    body: JSON.stringify({
      key: GAS_KEY,
      kind: 'menus.remove',
      data: { salonId: S.salonId, token: S.token, id }
    })
  }).then(r=>r.json());
  msg.textContent = j.ok ? 'Removed' : ('Error: ' + (j.error||'failed'));
  if (j.ok){ await fetchCatalog(); renderMenuList(); }
}

// Coupons
function renderCouponList(){
  const box = document.getElementById('cpnList');
  const items = S.catalog.discounts || [];
  if (!box) return;
  if (!items.length) { box.innerHTML = '<div class="muted">No coupons</div>'; return; }
  box.innerHTML = items.map(d => {
    const label = d.type==='percent' ? `${d.value}% OFF` : `${fmtLKR(d.value)} OFF`;
    return `
    <div class="row" style="align-items:center;justify-content:space-between;border:1px solid var(--brd);border-radius:10px;padding:6px 10px">
      <div><b>${d.name||'Coupon'}</b> · ${label}</div>
      <button class="btn" data-id="${d.id}">Remove</button>
    </div>`;
  }).join('');
  box.querySelectorAll('button[data-id]').forEach(b => {
    b.onclick = () => removeCoupon(b.getAttribute('data-id'));
  });
}

async function addCoupon(){
  const name = document.getElementById('cpnName').value.trim();
  const type = document.getElementById('cpnType').value;
  const value= Number(document.getElementById('cpnValue').value||0);
  const msg = document.getElementById('cpnMsg');
  if (value<=0){ msg.textContent='Enter value'; return; }
  msg.textContent = 'Saving…';
  const payload = { salonId: S.salonId, token: S.token, type, value };
  if (type === 'flat') payload.value_lkr = value;
  if (name) payload.name_en = name;
  const j = await fetch(API_BASE, {
    method:'POST',
    body: JSON.stringify({ key: GAS_KEY, kind:'coupons.add', data: payload })
  }).then(r=>r.json());
  msg.textContent = j.ok ? 'Added' : ('Error: ' + (j.error||'failed'));
  if (j.ok){
    document.getElementById('cpnName').value='';
    document.getElementById('cpnValue').value='';
    await fetchCatalog(); renderCouponList();
  }
}
// ====== Coupon Codes（confirm 用コード） ======
function renderCouponCodeList(){
  const box = document.getElementById('cpnCodeList');
  if (!box) return;
  const items = S.catalog.codes || [];
  if (!items.length){
    box.innerHTML = '<div class="muted">No private codes</div>';
    return;
  }
  box.innerHTML = items.map(c=>{
    const label = c.type==='percent' ? `${c.value}% OFF` : `${fmtLKR(c.value)} OFF`;
    return `
      <div class="row" style="align-items:center;justify-content:space-between;border:1px solid var(--brd);border-radius:10px;padding:6px 10px">
        <div><b>${c.code}</b> · ${label}</div>
        <button class="btn" data-id="${c.id}">Remove</button>
      </div>`;
  }).join('');
  box.querySelectorAll('button[data-id]').forEach(b=>{
    b.onclick = ()=> removeCouponCode(b.getAttribute('data-id'));
  });
}

async function addCouponCode(){
  const code = document.getElementById('cpnCodeAdmin').value.trim();
  const type = document.getElementById('cpnCodeType').value;
  const value= Number(document.getElementById('cpnCodeValue').value||0);
  const msg = document.getElementById('cpnCodeMsg');
  if (!code || value<=0){ msg.textContent='Enter code and value'; return; }
  msg.textContent = 'Saving…';
  const j = await fetch(API_BASE, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      key: GAS_KEY,
      kind: 'couponCodes.add', // confirm 側と連携する想定
      data: { salonId:S.salonId, token:S.token, code, type, value_lkr:value }
    })
  }).then(r=>r.json());
  msg.textContent = j.ok ? 'Added' : ('Error: '+(j.error||'failed'));
  if (j.ok){
    document.getElementById('cpnCodeAdmin').value='';
    document.getElementById('cpnCodeValue').value='';
    await fetchCatalog(); // ← 既存一覧に反映
    renderCouponCodeList();
  }
}

async function removeCouponCode(id){
  if (!confirm('Remove this code?')) return;
  const msg = document.getElementById('cpnCodeMsg');
  msg.textContent='Removing…';
  const j = await fetch(API_BASE, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ key:GAS_KEY, kind:'couponCodes.remove', data:{ salonId:S.salonId, token:S.token, id } })
  }).then(r=>r.json());
  msg.textContent = j.ok ? 'Removed' : ('Error: '+(j.error||'failed'));
  if (j.ok){ await fetchCatalog(); renderCouponCodeList(); }
}

async function removeCoupon(id){
  if (!confirm('Remove this coupon?')) return;
  const msg = document.getElementById('cpnMsg');
  msg.textContent = 'Removing…';
  const j = await fetch(API_BASE, {
    method:'POST',
    body: JSON.stringify({ key: GAS_KEY, kind:'coupons.remove', data:{ salonId:S.salonId, token:S.token, id } })
  }).then(r=>r.json());
  msg.textContent = j.ok ? 'Removed' : ('Error: ' + (j.error||'failed'));
  if (j.ok){ await fetchCatalog(); renderCouponList(); }
}

    // ---- Taken（当日の満枠スロット）----
    function expandSlots(startHM, endHM, stepMin){
      const toMin = hm => { const [h,m]=hm.split(':').map(Number); return h*60+(m||0); };
      const toHM  = min => String(Math.floor(min/60)).padStart(2,'0')+':'+String(min%60).padStart(2,'0');
      const out=[]; for(let t=toMin(startHM); t<toMin(endHM); t+=stepMin) out.push(toHM(t)); return out;
    }

    function renderTaken(meta, takenArray){
      const grid = document.getElementById('takenGrid');
      const all = expandSlots(meta.openStart, meta.openEnd, 30);
      const setTaken = new Set(takenArray||[]);
      grid.innerHTML = all.map(hm=>{
        const full = setTaken.has(hm);
        return `<span class="tag" style="${full?'background:#ffecec;border-color:#ffb3b3':''}">${hm}${full?' ×':''}</span>`;
      }).join('');
      document.getElementById('takenMeta').textContent =
        `Open: ${meta.openStart}–${meta.openEnd} · Lead: ${meta.leadMin}m · Capacity: ${meta.capacity||1}`;
      // Availabilityカード側にも capacity 反映（read-only）
      const capEl = document.getElementById('availCapacity');
      if (capEl && meta.capacity) capEl.value = String(meta.capacity);
    }

    async function loadTaken(){
      const ymd = document.getElementById('dayYMD').value;
      if (!ymd){ alert('Pick a date'); return; }
      const q = new URLSearchParams({
        kind: 'taken', key: GAS_KEY, ymd, salonId: S.salonId, token: S.token
      });
      const j = await fetch(`${API_BASE}?${q}`).then(r=>r.json());
      if (!j.ok){ alert(j.error || 'load failed'); return; }
      renderTaken(j.meta||{openStart:'09:00',openEnd:'18:00',leadMin:0,capacity:1}, j.items||[]);
    }
    // ====== Profile (Photos) ======
function imgItemHtml(p){
  const url = String(p.url||'');
  const id  = String(p.id||'');
  return `
    <div style="width:180px;border:1px solid var(--brd);border-radius:10px;overflow:hidden;display:flex;flex-direction:column">
      <div style="aspect-ratio:1/1;background:#f5f5f5">
        <img src="${url}" alt="" style="width:100%;height:100%;object-fit:cover" loading="lazy"/>
      </div>
      <button class="btn" data-id="${id}" style="border:0;border-top:1px solid var(--brd);border-radius:0">Remove</button>
    </div>`;
}

function renderPhotos(items){
  const grid = document.getElementById('photoGrid');
  if (!grid) return;
  if (!items || !items.length){
    grid.innerHTML = '<div class="muted">No photos</div>';
    return;
  }
  grid.innerHTML = items.map(imgItemHtml).join('');
  grid.querySelectorAll('button[data-id]').forEach(b=>{
    b.onclick = () => removePhoto(b.getAttribute('data-id'));
  });
}

async function loadPhotos(){
  const q = new URLSearchParams({ kind:'photos.list', key:GAS_KEY, salonId:S.salonId, token:S.token });
  const j = await fetch(`${API_BASE}?${q}`).then(r=>r.json());
  if (!j.ok){ document.getElementById('photoMsg').textContent = 'Error: '+(j.error||'failed'); return; }
  renderPhotos(j.items||[]);
}

// ファイルをCanvasでリサイズ（横1600px基準）してJPEGに
async function fileToDataURLResized(file, maxW=1600, quality=0.85){
  const img = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=URL.createObjectURL(file); });
  const scale = Math.min(1, maxW / img.width);
  const w = Math.round(img.width*scale), h = Math.round(img.height*scale);
  const cv = document.createElement('canvas'); cv.width=w; cv.height=h;
  const cx = cv.getContext('2d'); cx.drawImage(img, 0, 0, w, h);
  return await new Promise(r => cv.toBlob(b => {
    const fr = new FileReader();
    fr.onload = () => r(fr.result); // dataURL
    fr.readAsDataURL(b);
  }, file.type || 'image/jpeg', quality));
}

async function handlePhotoUpload(){
  const files = Array.from(document.getElementById('photoFiles').files||[]);
  const msg = document.getElementById('photoMsg');
  if (!files.length){ msg.textContent = 'Select files'; return; }
  msg.textContent = 'Uploading…';

  for (const f of files){
    try{
      // 画像をリサイズ＆JPEG化してBase64 dataURL化
      const dataURL = await fileToDataURLResized(f, 1600, 0.85);
      const j = await fetch(API_BASE, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
        body: JSON.stringify({
          key: GAS_KEY,
          kind: 'photos.upload',
          data: {
            salonId: S.salonId, token: S.token,
            filename: f.name.replace(/\s+/g,'_'),
            dataURL // "data:image/jpeg;base64,...."
          }
        })
      }).then(r=>r.json());
      if (!j.ok) throw new Error(j.error||'upload failed');
    }catch(e){
      console.error(e);
      msg.textContent = 'Error: '+(e.message||e);
      return;
    }
  }
  msg.textContent = 'Uploaded';
  (document.getElementById('photoFiles')||{}).value = '';
  await loadPhotos();
}

async function removePhoto(id){
  const msg = document.getElementById('photoMsg');
  if (!confirm('Remove this photo?')) return;
  msg.textContent = 'Removing…';
  const j = await fetch(API_BASE, {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
    body: JSON.stringify({ key:GAS_KEY, kind:'photos.remove', data:{ salonId:S.salonId, token:S.token, id } })
  }).then(r=>r.json());
  msg.textContent = j.ok ? 'Removed' : ('Error: '+(j.error||'failed'));
  if (j.ok) await loadPhotos();
}

        // ====== INIT ======
    (async function init(){
      try{
        readCtx();
        // ★ 未ログインなら案内して終了
      if (!S.token) {
         document.body.innerHTML = `
           <div style="padding:24px;font:14px/1.6 system-ui">
             You need to log in to use Admin.<br>
             <a href="/login.html?redirect=${encodeURIComponent(location.pathname + location.search)}">Go to login</a>
           </div>`;
         return;
       }
        await fetchCatalog();
        $('#custName').textContent = qs.get('customerName') || '-';
        $('#sendLink').onclick = startApproval;
        $('#btnCharge').onclick = doCharge;
        // Catalog handlers
const btnMenuAdd = document.getElementById('btnMenuAdd');
if (btnMenuAdd) btnMenuAdd.onclick = addMenu;
const btnCpnAdd  = document.getElementById('btnCpnAdd');
if (btnCpnAdd) btnCpnAdd.onclick = addCoupon;
// ★ Profile: Upload button
const btnPhotoUpload = document.getElementById('btnPhotoUpload');
if (btnPhotoUpload) btnPhotoUpload.onclick = handlePhotoUpload;
// Private coupon codes
const btnCpnCodeAdd = document.getElementById('btnCpnCodeAdd');
if (btnCpnCodeAdd) btnCpnCodeAdd.onclick = addCouponCode;

// Profile: Salon Meta を先読み（タブ切替前に値が入ると安心）
await loadSalonMeta().catch(()=>{});
const btnMetaSave = document.getElementById('btnMetaSave');
if (btnMetaSave) btnMetaSave.onclick = saveSalonMeta;

// 初回レンダリング
renderMenuList();
renderCouponList();

        // ▼▼▼ ここから追記 ▼▼▼
        // Availability 初期値をロード
        await fetchAvailabilityMeta();
        // Blackouts 一覧をロード
        await loadBlackouts();
        // イベント
        document.getElementById('btnAvailSave').onclick = saveAvailability;
        document.getElementById('btnBlackAdd').onclick  = addBlackout;
        document.getElementById('btnLoadTaken').onclick = loadTaken;

        // 便利：本日の日付を既定セット
        const d = new Date(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
        const today = `${d.getFullYear()}-${mm}-${dd}`;
        const dayInput = document.getElementById('dayYMD');
        if (dayInput && !dayInput.value) dayInput.value = today;
        const blackDate = document.getElementById('blackDate');
        if (blackDate && !blackDate.value) blackDate.value = today;
        // ▲▲▲ 追記ここまで ▲▲▲

      }catch(e){
        const msg = String(e?.message || e || '');
    if (msg.toLowerCase().includes('unauthorized')) {
      // トークン壊れてる/期限切れ → 破棄してログインへ
      try { localStorage.removeItem('bl_token'); } catch(_){}
      location.href = '/login.html?redirect=' + encodeURIComponent(location.pathname + location.search);
      return;
    }
    document.body.innerHTML = `<div style="padding:30px">Init failed: ${msg}</div>`;
    return; // ← ここで終了（下のタブ初期化を走らせない）
      }
   <!-- tabs 修正版 -->
const tabsEl = document.getElementById('tabs');
if (!tabsEl) return;

const panes = {
  billing:  document.getElementById('pane-billing'),
  schedule: document.getElementById('pane-schedule'),
  catalog:  document.getElementById('pane-catalog'),
  profile:  document.getElementById('pane-profile'),
};

async function activateTab(name){
  // 見た目
  tabsEl.querySelectorAll('.tab').forEach(b=>{
    b.classList.toggle('active', b.dataset.tab === name);
  });
  // パネル切替
  Object.entries(panes).forEach(([key, el])=>{
    el.hidden = (key !== name);
  });

  // タブ固有の初期化
  if (name === 'profile') {
    // 画像一覧の初回ロード
    try { await loadPhotos(); } catch(_){}
    // エリア/カテゴリの反映
    if (typeof loadSalonMeta === 'function') {
      try { await loadSalonMeta(); } catch(_){}
    }
    const btn = document.getElementById('btnMetaSave');
    if (btn && !btn._wired) { btn.onclick = saveSalonMeta; btn._wired = true; }
  }

  if (name === 'catalog') {
    renderMenuList();
    renderCouponList();
    renderCouponCodeList();
  }
}

tabsEl.addEventListener('click', (e)=>{
  const btn = e.target.closest('.tab');
  if (!btn) return;
  activateTab(btn.dataset.tab);
});
    
// 初期表示
activateTab('billing');
})(); 
// Coupon Apply / Clear
const btnCpnApply = document.getElementById('btnCouponApply');
const btnCpnClear = document.getElementById('btnCouponClear');
if (btnCpnApply) {
  btnCpnApply.onclick = async ()=>{
    const code = (document.getElementById('couponCodeInput')?.value||'').trim();
    if(!code){ document.getElementById('couponMsg').textContent = 'Enter code'; return; }
    await validateCouponAndApply(code);
  };
}
if (btnCpnClear) {
  btnCpnClear.onclick = clearCoupon;
}

    // --- Salon Meta: load & save ---
async function loadSalonMeta(){
  try{
    const q = new URLSearchParams({ kind:'salon.meta.get', key:GAS_KEY, salonId:S.salonId, token:S.token });
    const resp = await fetch(`${API_BASE}?${q}`).then(r=>r.json());
    if(resp && resp.ok){
      S.meta.area = resp.area || '';
      S.meta.categories = Array.isArray(resp.categories) ? resp.categories : String(resp.categories||'').split(',').map(s=>s.trim()).filter(Boolean);
    }
    // UI 反映
    const areaSel = document.getElementById('metaArea');
    const catInp  = document.getElementById('metaCategories');
    if(areaSel) areaSel.value = S.meta.area || '';
    if(catInp)  catInp.value  = (S.meta.categories||[]).join(', ');
  }catch(e){
    console.warn('loadSalonMeta error', e);
  }
}

async function saveSalonMeta(){
  const areaSel = document.getElementById('metaArea');
  const catInp  = document.getElementById('metaCategories');
  const msg     = document.getElementById('metaMsg');

  const area = String(areaSel?.value||'').trim();
  const categories = String(catInp?.value||'')
    .split(',')
    .map(s=>s.trim())
    .filter(Boolean);

  msg.textContent = 'Saving…';
  try{
    const resp = await fetch(API_BASE, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        key: GAS_KEY,
        kind: 'salon.meta.save',
        data: { salonId: S.salonId, token:S.token, area, categories }
      })
    }).then(r=>r.json());

    if(resp && resp.ok){
      S.meta.area = area;
      S.meta.categories = categories;
      msg.textContent = 'Saved ✔';
    }else{
      msg.textContent = 'Save failed';
    }
  }catch(e){
    msg.textContent = 'Save error';
  }
}
</script>
</body>
</html>



