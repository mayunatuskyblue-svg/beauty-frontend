<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>カード情報の保存（後払い用）</title>
  <link rel="preconnect" href="https://js.stripe.com" />
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:#f6eddc; color:#222; margin:0}
    .wrap{max-width:1024px; margin:0 auto; padding:24px}
    h1{font-size:28px; margin:8px 0 16px}
    .card{background:#fff; border-radius:16px; padding:20px; box-shadow:0 6px 20px rgba(0,0,0,.06); margin:0 0 20px}
    .grid{display:grid; grid-template-columns:140px 1fr; row-gap:10px; column-gap:20px}
    .muted{color:#666}
    label{font-size:14px; color:#555}
    input[type="text"],input[type="email"]{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #ddd; outline:0}
    .btn{display:inline-flex; align-items:center; gap:.5rem; padding:12px 20px; border:0; border-radius:999px; cursor:pointer; font-weight:700}
    .btn-primary{background:#2c7e78; color:#fff}
    .btn-ghost{background:#eef2ef; color:#2c7e78}
    .row{display:flex; gap:12px; align-items:center}
    .right{margin-left:auto}
    .stripe-frame{border:1px solid #e4e4e4; border-radius:10px; padding:12px}
    .center{display:flex; justify-content:center; align-items:center}
    .note{font-size:12px; color:#777}
    .hidden{display:none}
    .ok{color:#2a7f62; font-weight:700}
    .err{color:#b42318; font-weight:700; white-space:pre-wrap}
    .pill{display:inline-flex; align-items:center; gap:.35rem; padding:.15rem .6rem; border-radius:999px; background:#eef2ef; color:#2c7e78; font-weight:700; font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
    @media (max-width:640px){ .grid{grid-template-columns:1fr} }
  </style>

  <script>
    /***** ★ ここだけ設定してください（必要に応じて） ★ *****/
    // Stripe publishable key
    const STRIPE_PK = window.STRIPE_PK || 'pk_test_51S59dhHFHLP5RXi1qkW9cuPEJAlJPuSaFeWFb5GuYhsXs9vkX6RJYfVYwQEdK8TwN3eKF7wEctQftyhYxb2rRIZN00146bOW8U';

    // Google Apps Script の WebApp URL（書き込みを使わないなら '' でOK）
    const GAS_URL   = window.GAS_URL || 'https://script.google.com/macros/s/AKfycbxQHByDLRu-QlfAyRRMdM0-pGskH9Ka7IcFs9NeV2NB3DyDWhaLgvv8Hain_l9nZGvk/exec';

    // GAS の簡易キー（GAS 側の検証用。使っていなければ空でOK）
    const GAS_KEY   = window.GAS_KEY || 'bl_gas_key_crUS1RnVC07WqAkdtzLfemDla3MBNxvTKsiJFOh5';

    // （既定値）Render 側の pay-server（?pay= がない時に使われる）
    window.PAY_SERVER = window.PAY_SERVER || 'https://pay-server-uis7.onrender.com';
    /*****************************************************/
  </script>
</head>
<body>
  <div class="wrap">
    <h1>カード情報の保存（後払い用）</h1>

    <!-- 予約概要 -->
    <section class="card" id="summary">
      <div class="grid">
        <div class="muted">サロン</div><div id="s_salon" class="mono">-</div>
        <div class="muted">メニュー</div><div id="s_menu" class="mono">-</div>
        <div class="muted">施術者</div><div id="s_staff" class="mono">-</div>
        <div class="muted">日時</div><div id="s_date" class="mono">-</div>
        <div class="muted">お支払い目安</div><div id="s_price" class="mono">-</div>
      </div>
    </section>

    <!-- 同意と次へ -->
    <section class="card">
      <p class="muted">以下に同意いただける場合、「カード情報の入力へ」を押してください。</p>
      <div class="row">
        <label class="row" style="gap:8px;">
          <input type="checkbox" id="agree1" checked />
          I agree to the Terms
        </label>
        <button class="btn btn-primary right" id="toFormBtn">カード情報の入力へ</button>
        <a class="btn btn-ghost" href="javascript:history.back()">← 戻る</a>
      </div>
      <div id="warnAgree" class="err hidden">同意チェックを入れてください。</div>
    </section>

    <!-- カード入力 -->
    <section class="card hidden" id="formSec">
      <div class="grid" style="margin-bottom:12px">
        <div class="muted">メール</div>
        <div><input id="email" type="email" placeholder="you@example.com" /></div>
        <div class="muted">お名前</div>
        <div><input id="holder" type="text" placeholder="Taro Yamada" /></div>
      </div>

      <label class="muted">カード番号</label>
      <div id="card-element" class="stripe-frame"></div>
      <div class="note">テストカード例: 4242 4242 4242 4242 / 任意の有効期限 / 任意のCVC</div>

      <div class="row" style="margin-top:14px">
        <label class="row" style="gap:8px;"><input type="checkbox" id="agree2" checked /> I agree to the Terms</label>
        <button class="btn btn-primary right" id="saveBtn">カードを保存する</button>
        <a class="btn btn-ghost" href="javascript:history.back()">← 戻る</a>
      </div>

      <div id="msg" class="ok hidden">カード情報を保存登録が完了しました。</div>
      <div id="errmsg" class="err hidden"></div>
    </section>

    <footer class="center" style="gap:16px; color:#666; margin:24px 0 6px">
      <a class="muted" href="#">Terms</a>・
      <a class="muted" href="#">Privacy</a>・
      <a class="muted" href="#">Cancel Policy</a>・
      <a class="muted" href="#">Contact</a>
    </footer>
  </div>

  <script>
    // -------------------- 予約クエリの展開 --------------------
    const q = new URLSearchParams(location.search);
    const salonId   = q.get('salonId')   || '';
    const salonName = q.get('salonName') || '-';
    const itemName  = q.get('item')      || '-';
    const staffId   = q.get('staffId')   || '';
    const staffName = q.get('staffName') || '指名なし';
    const iso       = q.get('iso')       || '';
    const price     = Number(q.get('price') || 0);
    const cur       = (q.get('cur')||'JPY').toUpperCase();

    // 表示
    document.getElementById('s_salon').textContent = salonName;
    document.getElementById('s_menu' ).textContent = itemName;
    document.getElementById('s_staff').textContent = staffName;
    const d = iso ? new Date(iso) : null;
    document.getElementById('s_date' ).textContent = d ? d.toLocaleString() : '-';
    const fmtPrice = new Intl.NumberFormat(cur==='JPY'?'ja-JP':'en-US',
                       {style:'currency',currency:cur}).format(price||0);
    document.getElementById('s_price').textContent = price ? fmtPrice : '現地支払い';

    // -------------------- 「次へ」ボタン --------------------
    document.getElementById('toFormBtn').addEventListener('click', () => {
      if(!document.getElementById('agree1').checked){
        document.getElementById('warnAgree').classList.remove('hidden');
        return;
      }
      document.getElementById('warnAgree').classList.add('hidden');
      document.getElementById('formSec').classList.remove('hidden');
      initStripeOnce(); // 初回だけ Elements 準備
    });

    // -------------------- Stripe Elements 初期化 --------------------
    let stripe, elements, cardEl, inited = false;
    function initStripeOnce(){
      if(inited) return;
      stripe = Stripe(STRIPE_PK);
      elements = stripe.elements();
      cardEl = elements.create('card', {hidePostalCode:true});
      cardEl.mount('#card-element');
      inited = true;
    }

    // -------------------- 保存ボタンクリック --------------------
    document.getElementById('saveBtn').addEventListener('click', onSave);

    async function onSave(){
      document.getElementById('msg').classList.add('hidden');
      const em = (document.getElementById('email').value || '').trim();
      const nm = (document.getElementById('holder').value|| '').trim() || staffName || 'Guest';
      if(!document.getElementById('agree2').checked){
        return showErr('同意チェックを入れてください。');
      }
      // PAY server 決定（?pay= ＞ window.PAY_SERVER）
      const PAY = (q.get('pay') || window.PAY_SERVER || '').replace(/\/+$/,'');

      // 候補（表記ゆれ吸収）。最初に成功したURLを採用
      const endpoints = [
        `${PAY}/api/create_setup_intent`,
        `${PAY}/api/setup_intent`,
        `${PAY}/setup_intent`,
        `${PAY}/create_setup_intent`,
        `${PAY}/create-setup-intent`,
        `${PAY}/api/setup_intents/create`
      ];

      // SetupIntent 作成
      let clientSecret = '';
      let lastStatus = 0, lastBody = '';
      for (const url of endpoints){
        try{
          const res = await fetch(url, {
            method:'POST',
            headers:{'content-type':'application/json'},
            body: JSON.stringify({ email: em || 'test@example.com', name: nm })
          });
          lastStatus = res.status;
          lastBody   = await res.text();
          if(res.ok){
            // JSON/HTML どちらでも client_secret を拾う
            try{
              const j = JSON.parse(lastBody);
              clientSecret = j.client_secret || j.clientSecret || (j.data && (j.data.client_secret || j.data.clientSecret)) || '';
            }catch(_){/* HTML の場合はスルー */}
            if(clientSecret) break;
          }
        }catch(_e){}
      }
      if(!clientSecret){
        console.error('[card-save] endpoints tried:', endpoints);
        return showErr(`エラーが発生しました。\nSetupIntent API not found (last=${lastStatus}).\nPAY=${(q.get('pay')||window.PAY_SERVER||'')}`);
      }

      // カード確定
      const r = await stripe.confirmCardSetup(clientSecret, {
        payment_method: {
          card: cardEl,
          billing_details: { email: em || undefined, name: nm || undefined }
        }
      });

      if(r.error){
        return showErr(`カードの確定に失敗しました。\n${r.error.message||r.error.code||'unknown'}`);
      }

      // 成功
      document.getElementById('msg').classList.remove('hidden');
      alert('カード保存が完了しました。');

      // GAS へログ（任意）
      if(GAS_URL){
        try{
          const payload = {
            key: GAS_KEY,
            kind: 'customer',
            email: em,
            name: nm,
            customerId: r.setupIntent?.customer || '',
            paymentMethodId: r.setupIntent?.payment_method || '',
            // 予約に紐づける場合の情報
            salonId, salonName, staffId, staffName, itemName,
            iso, price, cur
          };
          await fetch(GAS_URL, { method:'POST', body: JSON.stringify(payload) });
          // booking 側に書くならこちらも送る
          const payload2 = {
            key: GAS_KEY, kind:'booking',
            email: em, bookingId: r.setupIntent?.id || '',
            status: 'card_saved', reviewed: 'no',
            salonId, salonName, staffId, staffName, itemName, iso, price, cur
          };
          await fetch(GAS_URL, { method:'POST', body: JSON.stringify(payload2) });
        }catch(_){}
      }
    }

    function showErr(msg){
      const el = document.getElementById('errmsg');
      el.textContent = msg;
      el.classList.remove('hidden');
      return false;
    }
  </script>
</body>
</html>
