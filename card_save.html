<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>カード情報の保存（後払い用）</title>
<link rel="preconnect" href="https://js.stripe.com" crossorigin>
<script src="https://js.stripe.com/v3/"></script>
<!-- Google Apps Script WebApp URL（customers シート upsert 用） -->
<meta name="bl-sheet-hook" content="https://script.google.com/macros/s/AKfycbwWRpfcZMsGxNqGJ5aNjRT1Y1PChDTqtQE3e0S7sUDAMei8s1wOr6lpKMnOaI1Z-6o/exec">
<style>
  :root{--bg:#f6f1e6;--panel:#fff;--text:#222;--muted:#6b7280;--brand:#115e59;--stroke:#e5e7eb}
  body{margin:0;background:var(--bg);color:var(--text);font-family:"Inter","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.6}
  .wrap{max-width:960px;margin:28px auto;padding:0 16px}
  .card{background:var(--panel);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:18px 20px;margin:14px 0;border:1px solid var(--stroke)}
  h1{font-size:28px;margin:6px 0 12px}
  dt{color:var(--muted);font-size:13px;margin-top:8px}
  dd{margin:0 0 8px 0}
  .row{display:grid;grid-template-columns:160px 1fr;gap:6px 14px}
  input[type="email"],input[type="text"]{height:40px;border-radius:12px;border:1px solid var(--stroke);padding:0 12px;width:100%}
  .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{height:44px;border-radius:999px;padding:0 18px;font-weight:800;cursor:pointer;border:1px solid var(--stroke);background:#fff}
  .btn.brand{background:var(--brand);color:#fff;border-color:var(--brand)}
  .hidden{display:none}
  #msg{white-space:pre-line}
  #card{border:1px solid var(--stroke);border-radius:12px;padding:12px}
  footer a{color:#334155;text-decoration:none;margin-right:10px}
  footer a:hover{text-decoration:underline}
  /* modal */
  #ftModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999}
  #ftBackdrop{position:absolute;inset:0;background:rgba(0,0,0,.4)}
  #ftDlg{position:relative;background:#fff;border:1px solid var(--stroke);border-radius:14px;box-shadow:0 16px 40px rgba(0,0,0,.18);width:min(92vw,720px);max-height:80vh;overflow:auto;padding:18px}
  #ftDlg header{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:8px}
  #ftDlg header h3{margin:0;font-size:18px}
  #ftClose{border:1px solid var(--stroke);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}

  .ft-transparent{background:transparent;border:none;box-shadow:none;padding:12px 10px;margin-top:10px;text-align:left}
  .ft-transparent a{color:#374151;text-decoration:none;margin-right:14px;opacity:.9}
  .ft-transparent a:hover{text-decoration:underline;opacity:1}
</style>
  <script src="lang.js" defer></script>
<script>document.addEventListener('DOMContentLoaded',()=>BL_I18N.i18nApply());</script>
</head>
<body>
<div class="wrap">
  <a class="btn" href="index.html" data-i18n="ui.back">← 戻る</a>
  <h1 data-i18n="card.title">カード情報の保存（後払い用）</h1>

  <div class="card">
    <dl class="row">
      <div><dt data-i18n="card.shop">サロン</dt><dd id="v_salon">-</dd></div>
      <div><dt data-i18n="card.menu">メニュー</dt><dd id="v_menu">-</dd></div>
      <div><dt data-i18n="card.staff">施術者</dt><dd id="v_staff">-</dd></div>
      <div><dt data-i18n="card.when">日時</dt><dd id="v_date">-</dd></div>
      <div><dt data-i18n="card.price">目安金額</dt><dd id="v_price">-</dd></div>
    </dl>
  </div>

  <div class="card" id="stepAgree">
    <div class="inline">
      <label class="chk"><input type="checkbox" id="agree"><span data-i18n="card.i_agree">利用規約に同意します</span></label>
      <button class="btn" type="button" id="openTerms" data-i18n="footer.terms">Terms</button>
      <button class="btn brand" type="button" id="goForm" data-i18n="card.go_input">カード情報の入力へ</button>
    </div>
    <p class="inline" style="color:var(--muted);font-size:12px" data-i18n="card.check_then_go">チェックしてから「カード情報の入力へ」を押してください。</p>
  </div>

  <div class="card hidden" id="stepForm">
    <div class="row">
      <dt data-i18n="card.email">メール</dt><dd><input type="email" id="email" data-i18n-ph="ui.email" placeholder="you@example.com"></dd>
      <dt data-i18n="card.name">お名前</dt><dd><input type="text" id="name" data-i18n-ph="ui.name" placeholder="TARO YAMADA"></dd>
      <dt data-i18n="card.card_no">カード番号</dt><dd><div id="card"></div></dd>
    </div>
    <div class="inline" style="margin-top:8px">
      <button id="saveBtn" class="btn brand" data-i18n="card.save_btn">カードを保存する</button>
      <span id="spin" class="hidden" data-i18n="ui.process">処理中…</span>
    </div>
  </div>

  <div id="msg"></div>

  <footer class="ft-transparent">
    <a href="#" class="ft-link" data-ft="terms" data-i18n="footer.terms">Terms</a>
    <a href="#" class="ft-link" data-ft="privacy" data-i18n="footer.privacy">Privacy</a>
    <a href="#" class="ft-link" data-ft="cancel" data-i18n="footer.cancel">Cancel Policy</a>
    <a href="#" class="ft-link" data-ft="contact" data-i18n="footer.contact">Contact</a>
  </footer>
</div>

<!-- modal -->
<div id="ftModal">
  <div id="ftBackdrop"></div>
  <div id="ftDlg" role="dialog" aria-modal="true" aria-labelledby="ftTitle">
    <header><h3 id="ftTitle" data-i18n="footer.terms">Terms</h3><button id="ftClose" data-i18n="ui.close">Close</button></header>
    <div id="ftBody">Loading…</div>
  </div>
</div>

<script>
// ===== 通貨ユーティリティ =====
const RATES = { JPY:1, USD:0.0067, EUR:0.0061, LKR:2.05 };
function getCurrency(){ try{ return localStorage.getItem('bl_currency') || 'JPY'; }catch(e){ return 'JPY'; } }
function fmtCurrencyFromJPY(jpy, cur){
  const n = Math.max(0, Number(jpy)||0);
  const converted = Math.round(n * (RATES[cur] || 1));
  try{
    // before: new Intl.NumberFormat(getLang()==='ja'?'ja-JP':'en-US', ...
return new Intl.NumberFormat(
  BL_I18N.getLang()==='ja' ? 'ja-JP' : 'en-US',
  { style:'currency', currency: cur, maximumFractionDigits:0 }
).format(converted);
  }catch(e){
    const symbols = {JPY:'¥', USD:'$', EUR:'€', LKR:'Rs '};
    return (symbols[cur]||'') + converted.toLocaleString();
  }
}

// ===== 画面パラメータ → 表示
const p = new URLSearchParams(location.search);
const salon   = p.get('salonName') || p.get('salon') || '-';
const menu    = p.get('item') || p.get('menu') || '-';
const staff   = p.get('staffName') || p.get('staff') || '指名なし';
const when    = p.get('date') || p.get('dt') || '-';
const priceJP = Number(p.get('price_jpy') || 0);

document.getElementById('v_salon').textContent = salon;
document.getElementById('v_menu').textContent  = menu;
document.getElementById('v_staff').textContent = staff;
document.getElementById('v_date').textContent  = when || '-';
document.getElementById('v_price').textContent = priceJP ? fmtCurrencyFromJPY(priceJP, getCurrency()) : '—';

// ===== Pay サーバーと Stripe の設定
const DEFAULT_PAY_SERVER = 'https://api.beautylk.com';
const PAY_SERVER = (p.get('payServer') || DEFAULT_PAY_SERVER).replace(/\/$/,'');
const STRIPE_PK  = p.get('pk') || localStorage.getItem('bl_stripe_pk') || 'pk_test_51S59dhHFHLP5RXi1qkW9cuPEJAlJPuSaFeWFb5GuYhsXs9vkX6RJYfVYwQEdK8TwN3eKF7wEctQftyhYxb2rRIZN00146bOW8U';

// ===== エンドポイント候補（フォールバック対応）
const endpoints = ['/api/setup-intent'].map(path => PAY_SERVER + path);

// ===== GAS への upsert 設定
const GAS_URL = document.querySelector('meta[name=bl-sheet-hook]')?.content || p.get('gas') || '';
const GAS_KEY = p.get('key') || localStorage.getItem('bl_gas_key') || '';

const $ = s => document.querySelector(s);
const show = (el, on=true)=>el.classList[on?'remove':'add']('hidden');
const setMsg = (t, isErr=false)=>{ const m=$('#msg'); m.textContent=t||''; m.style.color=isErr?'#b91c1c':'#374151' };

// ===== Footer modal (i18n)
(function(){
  const modal = document.getElementById('ftModal'), body=document.getElementById('ftBody'), title=document.getElementById('ftTitle');
  const L = (k)=> k.split('.').reduce((o,p)=>o&&o[p], (window.BL_I18N?.T||{})[window.BL_I18N?.getLang?.()||'ja']) || k;

  function open(kind){ title.textContent = L(`footer.${kind}`); body.innerHTML = L(`legal.${kind}_html`); modal.style.display='flex'; }
  function close(){ modal.style.display='none'; }

  document.addEventListener('click', (e)=>{
    const a = e.target.closest && e.target.closest('.ft-link');
    if(a){ e.preventDefault(); open(a.dataset.ft); }
  });
  document.getElementById('openTerms')?.addEventListener('click', ()=>open('terms'));
  document.getElementById('ftClose')?.setAttribute('data-i18n','ui.close');
  document.getElementById('ftClose')?.addEventListener('click', close);
  document.getElementById('ftBackdrop')?.addEventListener('click', close);
})();
</script>
<script>
// ===== Stripe 初期化（同意前は表示しない） =====
let stripe, elements, cardElement, inited=false;
function initStripe(){
  if(inited) return;
  stripe = Stripe(STRIPE_PK);
  elements = stripe.elements();
  cardElement = elements.create('card', { hidePostalCode: true });
  cardElement.mount('#card');
  inited = true;
}

// 同意 → 入力フォーム表示
$('#goForm').addEventListener('click', () => {
  if (!$('#agree').checked) { setMsg('利用規約への同意が必要です。', true); return; }
  initStripe();
  show($('#stepAgree'), false);
  show($('#stepForm'), true);
  setMsg('カード番号を入力し「カードを保存する」を押してください。');
});

// ===== SetupIntent を複数エンドポイントで順に試す =====
async function getClientSecret(email, name){
  const body = JSON.stringify({ email, name });
  let lastStatus = 0, lastUrl = '';
  for (const url of endpoints){
    try{
      lastUrl = url;
      const res = await fetch(url, { method:'POST', headers:{'content-type':'application/json'}, body });
      lastStatus = res.status;
      if ((res.headers.get('content-type')||'').includes('application/json')){
        const j = await res.json().catch(()=>({}));
        if (j && j.ok && j.clientSecret) return {secret:j.clientSecret, customerId:j.customerId||''};
        if (j && (j.client_secret||j.clientSecret)) return { secret:(j.client_secret||j.clientSecret), customerId:j.customerId||'' };
      }
      const tx = await res.text();
      const m = tx.match(/(?:clientSecret|client_secret)["']?\s*[:=]\s*["']([^"']+)["']/i);
      if (m) return {secret:m[1], customerId:''};
    }catch(e){ /* try next */ }
  }
  throw new Error('SetupIntent を作成できませんでした。最後のURL: '+lastUrl+' (status='+lastStatus+')');
}


// ===== bookings シートへ追記 =====
async function recordBookingToSheet({ bookingId, email }){
  if(!GAS_URL){ console.warn('GAS_URL not set'); return; }
  if(!bookingId) return;
  const res = await fetch(GAS_URL, {
    method:'POST',
    headers:{'Content-Type': 'text/plain;charset=utf-8'},
      body: JSON.stringify({
    key: GAS_KEY,
    kind: 'booking',
    data: { bookingId, email: email || '' }
  })
});

const j = await res.json().catch(()=>({}));
if(!j || !j.ok) throw new Error((j&&j.error)||'booking_create failed');

}

// ===== bookingId の決定（URLにあれば採用。なければ生成） =====
function genBookingIdFromParams(){
  const idFromUrl = p.get('bookingId') || p.get('bid');
  if (idFromUrl) return idFromUrl;
  const salonId = p.get('salonId') || p.get('salon') || 'S';
  const dt = p.get('date') || p.get('dt') || new Date().toISOString();
  const base = String(dt).replace(/[^0-9]/g,'').slice(0,12);
  const rand = (()=>{ const s='23456789ABCDEFGHJKLMNPQRSTUVWXYZ'; return Array.from(crypto.getRandomValues(new Uint8Array(4))).map(b=>s[b%s.length]).join(''); })();
  return [salonId, base, rand].filter(Boolean).join('-');
}
const BOOKING_ID = genBookingIdFromParams();

// ===== customers シートへ upsert =====
async function upsertCustomerRow({ email, name, customerId, paymentMethodId }){
  if(!GAS_URL){ console.warn('GAS_URL not set'); return; }
  const res = await fetch(GAS_URL, {
  method: 'POST',
  headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // ★ここだけ変更
  body: JSON.stringify({
    key: GAS_KEY,
    kind: 'customer',
    data: { email, name, customerId, paymentMethodId }
  })
　});

  const j = await res.json().catch(()=>({}));
  if(!j || !j.ok) throw new Error((j&&j.error)||'customer_upsert failed');
}

// ===== Save card flow =====
$('#saveBtn').addEventListener('click', async () => {
  const email = ($('#email').value||'').trim();
  const name  = ($('#name').value||'').trim() || 'Guest';
  if (!email || !email.includes('@')) { setMsg('メールアドレスを入力してください。', true); return; }

  $('#saveBtn').disabled = true; show($('#spin'), true); setMsg('通信中…');
  try{
    // getClientSecret の返り値を検査する
const resp = await getClientSecret(email, name);
if (!resp || typeof resp.secret === 'undefined') {
  console.error('getClientSecret returned invalid response:', resp && JSON.stringify(resp).slice(0,200));
  throw new Error('サーバから client_secret が取得できませんでした（開発者へ）');
}
const { secret, customerId } = resp;

// 確認呼び出し
const { setupIntent, error } = await stripe.confirmCardSetup(secret, {
  payment_method: { card: cardElement, billing_details: { email, name } }
});
if (error) {
  // Stripe からのエラーはそのまま投げる（UI側で捕まえる前提）
  throw new Error(error.message || String(error));
}
if (!setupIntent || setupIntent.status !== 'succeeded') {
  console.error('setupIntent invalid or not succeeded:', setupIntent && { id: setupIntent.id, status: setupIntent.status });
  throw new Error('カード保存に失敗しました（status:' + (setupIntent && setupIntent.status) + ')');
}

    }
   if (!customerId) {
   throw new Error('顧客IDの取得に失敗しました（serverのレスポンスを確認してください）。');
   }
    // 念のため保険：confirm 後に customer に手動で attach（必要なときだけ）
try {
  const needsAttach = !setupIntent.customer; // Stripe.js の戻りには customer が載らない場合あり
  if (needsAttach && setupIntent.payment_method && customerId) {
    await fetch(PAY_SERVER + '/api/attach-payment-method', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ paymentMethodId: setupIntent.payment_method, customerId })
    });
  }
} catch (e) {
  console.warn('attach fallback failed', e);
}

    await upsertCustomerRow({
      email, name, customerId, paymentMethodId: setupIntent.payment_method
    });

    // 予約IDがあれば bookings へも追記
    try{ await recordBookingToSheet({ bookingId: BOOKING_ID, email }); }catch(e){ console.warn('booking_create failed', e); }

    // 置き換え（L285）
　　setMsg('カード情報を保存しました。後払いに利用できます（顧客に紐づき確認済み）。');

  }catch(e){
    setMsg('エラー: ' + (e.message || String(e)), true);
  }finally{
    $('#saveBtn').disabled = false; show($('#spin'), false);
  }
});
</script>
  <script>
  const dataRaw = sessionStorage.getItem('pendingReservation');
  const reservation = dataRaw ? JSON.parse(dataRaw) : null;

  if (!reservation) {
    // 直接アクセスされた場合などは予約画面へ戻す
    window.location.replace('reservation.html');
  } else {
    // 例：画面に反映（あなたの要素IDに合わせて置き換え）
    // document.getElementById('confirmName').textContent = reservation.name;
    // document.getElementById('confirmMenu').textContent = reservation.menu;
    // …必要に応じて表示

    // ここからStripeやカード登録フローへ進める処理を呼ぶ
    // saveCard(reservation) みたいな関数を実行してOK
  }
</script>

</body>
</html>

