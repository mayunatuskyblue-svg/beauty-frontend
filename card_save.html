<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>カード情報の保存（後払い用）</title>
<link rel="preconnect" href="https://js.stripe.com" crossorigin>
<script src="https://js.stripe.com/v3/"></script>
<style>
  :root{--bg:#f6f1e6;--panel:#fff;--text:#222;--muted:#6b7280;--brand:#115e59}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;line-height:1.6}
  .wrap{max-width:960px;margin:28px auto;padding:0 16px}
  .card{background:var(--panel);border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:18px 20px;margin:14px 0}
  h1{font-size:28px;margin:6px 0 12px}
  dt{color:var(--muted);font-size:13px;margin-top:8px}
  dd{margin:0 0 8px 0}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .btn{appearance:none;border:0;border-radius:12px;background:#c5e3dd;color:#10302c;padding:12px 18px;font-weight:700;cursor:pointer}
  .btn.brand{background:var(--brand);color:#fff}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  label.chk{display:flex;align-items:center;gap:8px;font-weight:600}
  .inline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .help{color:var(--muted);font-size:12px}
  #msg{white-space:pre-wrap}
  .hidden{display:none}
  .field{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>カード情報の保存（後払い用）</h1>

  <div class="card">
    <dl class="row">
      <div><dt>サロン</dt><dd id="v_salon">-</dd></div>
      <div><dt>メニュー</dt><dd id="v_menu">-</dd></div>
      <div><dt>施術者</dt><dd id="v_staff">-</dd></div>
      <div><dt>日時</dt><dd id="v_date">-</dd></div>
      <div><dt>お支払い目安</dt><dd id="v_price">-</dd></div>
    </dl>
  </div>

  <div class="card" id="stepAgree">
    <div class="inline">
      <label class="chk"><input type="checkbox" id="agree" checked> I agree to the Terms</label>
      <button class="btn" id="goForm">カード情報の入力へ</button>
      <a class="help" href="javascript:history.back()">← 戻る</a>
    </div>
    <p class="help">同意にチェックして「カード情報の入力へ」を押してください。</p>
  </div>

  <div class="card hidden" id="stepForm">
    <div class="row">
      <div>
        <dt>メール</dt>
        <dd><input id="email" class="field" placeholder="you@example.com" value=""></dd>
      </div>
      <div>
        <dt>お名前</dt>
        <dd><input id="name" class="field" placeholder="Taro Yamada" value=""></dd>
      </div>
    </div>
    <dt>カード番号</dt>
    <div id="card" class="field"></div>
    <div class="inline" style="margin-top:12px">
      <button class="btn brand" id="saveBtn">カードを保存する</button>
      <span id="spin" class="help hidden">処理中…</span>
    </div>
    <p id="msg" class="help"></p>
  </div>

  <p class="help">Terms ・ Privacy ・ Cancel Policy ・ Contact</p>
</div>

<script>
// ====== 可変設定（必要に応じて上書きできます） ======
const STRIPE_PK = (window.STRIPE_PK || '').trim() || 'pk_test_12345'; // あなたの公開鍵に差し替え可
const DEFAULT_PAY = 'https://pay-server-uis7.onrender.com';           // 既定の Pay Server

// ====== URL パラメータ ======
const P = new URLSearchParams(location.search);
const salonId = P.get('salonId') || '';
const salonName = P.get('salonName') || '-';
const item = decodeURIComponent(P.get('item') || '-');
const staffName = decodeURIComponent(P.get('staffName') || '-');
const iso = P.get('iso') || '';
const price = Number(P.get('price') || 0);
const cur = (P.get('cur') || 'JPY').toUpperCase();
const PAY_SERVER = (window.PAY_SERVER || P.get('pay') || DEFAULT_PAY).replace(/\/+$/,'');

// ====== 画面表示 ======
document.getElementById('v_salon').textContent = salonName || '-';
document.getElementById('v_menu').textContent  = item || '-';
document.getElementById('v_staff').textContent = staffName || '-';
document.getElementById('v_date').textContent  = iso ? new Date(iso).toLocaleString() : '-';
document.getElementById('v_price').textContent = price ? `${cur} ${price.toLocaleString('ja-JP')}` : '現地支払い';

// ====== エンドポイント候補（互換フォールバック） ======
const endpoints = [
  '/api/create_setup_intent',
  '/api/setup_intent',
  '/create_setup_intent',
  '/create-setup-intent',
  '/api/setup_intents/create',
  '/setup_intent',
  '/setup-intent'
].map(p => PAY_SERVER + p);

// ====== ユーティリティ ======
const $ = s => document.querySelector(s);
const show = (el, on=true)=>el.classList[on?'remove':'add']('hidden');
const setMsg = (t, isErr=false)=>{ const m=$('#msg'); m.textContent=t||''; m.style.color=isErr?'#b91c1c':'#374151' };

// ====== Stripe 初期化 ======
let stripe, elements, cardElement, inited = false;
function initStripe(){
  if(inited) return;
  stripe = Stripe(STRIPE_PK);
  elements = stripe.elements();
  cardElement = elements.create('card', { hidePostalCode: true });
  cardElement.mount('#card');
  inited = true;
}

// ====== SetupIntent を複数エンドポイントで順に試す ======
async function getClientSecret(email, name){
  const body = JSON.stringify({ email, name });
  let lastStatus = 0, lastUrl = '';

  for (const url of endpoints){
    try{
      lastUrl = url;
      const res = await fetch(url, { method:'POST', headers:{'content-type':'application/json'}, body });
      lastStatus = res.status;

      // JSON で来る場合
      if ((res.headers.get('content-type')||'').includes('application/json')){
        const j = await res.json().catch(()=>({}));
        if (j && j.ok && j.clientSecret) return j.clientSecret;
        if (j && j.client_secret) return j.client_secret;
      }

      // HTMLでclient_secretを含む場合（簡易抽出）
      const tx = await res.text();
      const m = tx.match(/(?:clientSecret|client_secret)["']?\s*[:=]\s*["']([^"']+)["']/i);
      if (m) return m[1];
    }catch(e){
      // 続行
    }
  }
  throw new Error(`SetupIntent API not found (last=${lastStatus}).\nPAY=${PAY_SERVER}\nlastUrl=${lastUrl}`);
}

// ====== イベント ======
$('#goForm').addEventListener('click', () => {
  if (!$('#agree').checked) {
    setMsg('利用規約への同意が必要です。', true);
    return;
  }
  initStripe();
  show($('#stepAgree'), false);
  show($('#stepForm'), true);
  setMsg('カード番号を入力し「カードを保存する」を押してください。');
});

$('#saveBtn').addEventListener('click', async () => {
  const email = ($('#email').value || '').trim();
  const name = ($('#name').value || '').trim() || 'Guest';

  if (!email || !email.includes('@')) { setMsg('メールアドレスを入力してください。', true); return; }

  $('#saveBtn').disabled = true;
  show($('#spin'), true);
  setMsg('通信中…');

  try{
    const clientSecret = await getClientSecret(email, name);
    const {setupIntent, error} = await stripe.confirmCardSetup(clientSecret, {
      payment_method: { card: cardElement, billing_details: { email, name } }
    });

    if (error) throw new Error(error.message || 'カード保存に失敗しました。');

    setMsg(`カード保存が完了しました。 (status=${setupIntent.status})`);
  }catch(e){
    setMsg(`エラーが発生しました。\n${e.message || e}`, true);
  }finally{
    $('#saveBtn').disabled = false;
    show($('#spin'), false);
  }
});
</script>
</body>
</html>
