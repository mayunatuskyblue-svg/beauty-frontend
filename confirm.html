<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <!-- ★CSP: 外部接続/Stripe/iframe を許可 --><meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'unsafe-inline' https://js.stripe.com;
  style-src  'self' 'unsafe-inline' https://fonts.googleapis.com;
  img-src    'self' data: https://*.stripe.com;
  font-src   'self' https://fonts.gstatic.com;
  connect-src 'self'
               https://api.stripe.com
               https://m.stripe.network
               https://r.stripe.com
               https://api.beautylk.com
               https://script.google.com
               https://script.googleapis.com
               https://script.googleusercontent.com
               https://pay-server-uis7.onrender.com
               https://api.pay-server-uis7.onrender.com
               https://workers-playground-winter-field-18ec.mayunatu-skyblue.workers.dev;                       
  frame-src  https://js.stripe.com https://hooks.stripe.com https://hooks.stripe.com/three_d_secure;
  base-uri 'self';
  form-action 'self';
  upgrade-insecure-requests;
">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ▼ 先読みしてTLSハンドシェイクを前倒し -->
  <link rel="preconnect" href="https://js.stripe.com">
  <link rel="preconnect" href="https://api.stripe.com">
  <link rel="preconnect" href="https://m.stripe.com">
  <link rel="preconnect" href="https://pay-server-uis7.onrender.com">
  <meta name="bl-sheet-hook" content="https://script.google.com/macros/s/AKfycbwlpW6ZQ-sOMfWCr_DWbNf27ezZb1ul6Cia9M7kMX4CSL-rRecpIWvh1qCbkVjA2xk/exec">
<!-- head内に置く（おすすめ） -->
<script>
  window.__GAS_URL = "https://script.google.com/macros/s/AKfycbwWRpfcZMsGxNqGJ5aNjRT1Y1PChDTqtQE3e0S7sUDAMei8s1wOr6lpKMnOaI1Z-6o/exec"; // 最新の /exec
  window.__GAS_KEY = "bl_gas_key_bR6ZXWwu6kM_nrK25geP97Cs5qCX3auxugX_IUGlg90";           // code.gs と同じ
</script>
<script>
  window.API_BASE = 'https://workers-playground-winter-field-18ec.mayunatu-skyblue.workers.dev/api';
  window.GAS_KEY  = 'bl_gas_key_bR6ZXWwu6kM_nrK25geP97Cs5qCX3auxugX_IUGlg90';
</script>

  <title>予約内容の確認</title>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700;900&family=Shippori+Mincho:wght@600;700&display=swap" rel="stylesheet">
  <link rel="manifest" href="./manifest.json">
  <link rel="stylesheet" href="assets/css/theme.css"/>
  <style>
    :root{ --base:#F7F1E1; --ink:#310E10; --stroke:#eadfca; --teal:#246A73; --danger:#74070E; --good:#0B7F5F; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--base);color:#111;font-family:'Zen Kaku Gothic New', system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, 'Noto Sans JP', sans-serif}
    .wrap{max-width:1200px;margin:28px auto;padding:0 20px}
    .hrow{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .back{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:999px;border:1px solid var(--stroke);background:#fff;color:#513;text-decoration:none}
    .h1{font-size:42px;font-family:'Shippori Mincho', serif;font-weight:700;color:#310E10;margin:0 0 8px;letter-spacing:.02em}
    .card{background:#fff;border:1px solid var(--stroke);border-radius:18px;padding:24px;box-shadow:0 12px 32px rgba(49,14,16,.08);margin:0 0 18px}
    .title{font-size:28px;font-weight:800;margin:0 0 8px}
    .meta{opacity:.9;line-height:1.9}
    .btn{border-radius:999px;padding:14px 22px;font-size:18px;font-weight:800;cursor:pointer;border:1px solid transparent;transition:.15s}
    .btn-primary{background:#246A73;color:#fff;border-color:#246A73;box-shadow:0 10px 24px rgba(36,106,115,.20)}
    .btn-outline{background:#fff;color:#246A73;border:1px solid color-mix(in oklab, #246A73 35%, white)}
    .input{height:48px;border-radius:12px;border:1px solid var(--stroke);padding:0 14px;background:#fff;width:100%;font-size:16px}
    .input:focus{outline:none;border-color:color-mix(in oklab,#246A73 55%,white);box-shadow:0 0 0 3px color-mix(in oklab,#246A73 20%, transparent)}
    textarea.input{height:110px;padding:12px;resize:vertical}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:10px}
    @media (max-width:900px){.form-row{grid-template-columns:1fr}}
    .sec-title{font-weight:900;font-size:22px;color:#310E10;margin:8px 0}
    .sec-desc{color:#444;opacity:.85;margin-bottom:8px}

    /* Toast */
    .toast{
      position: fixed; left: 50%; bottom: 22px; transform: translateX(-50%) translateY(12px);
      background: #fff; color:#513; border:1px solid #f2d09c;
      box-shadow: 0 16px 40px rgba(49,14,16,.14);
      padding: 12px 16px; border-radius:14px; z-index:9999; width: min(92vw, 640px);
      display:flex; align-items:center; gap:10px; opacity:0; pointer-events:none;
      transition: transform .2s ease, opacity .2s ease;
    }
    .toast.warn{ background:#fff8e6; }
    .toast.ok{   background:#e9fbf3; border-color:#bde9d7; color:#0b5138; }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(0); pointer-events:auto; }
    .toast .badge{font-weight:900}
    .toast .close{margin-left:auto;border:none;background:transparent;font-size:18px;cursor:pointer;opacity:.6}
    .toast .close:hover{opacity:1}
  
/* confirm-page staff row */
#confirmStaffRow { margin-top: 6px; }

</style>
  <style>
/* confirm-page balanced size override */
body.confirm-page .card {
  max-width: 720px !important;
  margin-left: auto !important;
  margin-right: auto !important;
  padding: 16px 20px !important;
}
body.confirm-page h1 {
  font-size: 30px !important;
}
@media (max-width: 720px) {
  body.confirm-page .card { max-width: 100% !important; }
}
</style>
<style>
#blModal::backdrop{ background: rgba(0,0,0,.35); }
#blModal{
  border:none; padding:0; width: min(920px, 92vw); height: min(80vh, 720px);
  border-radius:16px; overflow:hidden; box-shadow: 0 20px 50px rgba(0,0,0,.25);
}
#blModal header{
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 14px; background:#fff; border-bottom:1px solid #eadfca;
  font-weight:800;
}
#blModal header .title{ font-size:14px }
#blModal button.close{
  border:none; background:#fff; cursor:pointer; font-weight:800; padding:6px 10px; border-radius:10px;
}
#blModal iframe{ width:100%; height: calc(100% - 48px); border:0; display:block; background:#fff }
</style>

<style id="fixed-footer-style">
#ft{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:#faf6ef;
  padding:10px 0;
  text-align:center;
  color:#6b5e55;
  font-size:13px;
  border-top:1px solid #eadfca;
  z-index:999;
}
#ft a{ color:#6b5e55; text-decoration:none; margin:0 10px; }
#ft a:hover{ text-decoration:underline; }
body{ padding-bottom:60px; } /* avoid overlap */
</style>
  <script src="lang.js" defer></script>
  <script>
// --- Force English & disable JA temporarily ---
window.BL_I18N = window.BL_I18N || {};
BL_I18N.getLang = () => 'en';                      // 常に英語を返す
try{ document.documentElement.setAttribute('lang','en'); }catch(e){}
// /ja/ で開かれたら / に戻す（念のためブクマ対策）
(function(){
  var p = location.pathname || '';
  if (p.startsWith('/ja/')) location.replace('/');
})();
</script>
<style>
/* 言語セレクタがある場合は一律非表示 */
#langSelect { display: none !important; }
</style>

<script>document.addEventListener('DOMContentLoaded',()=>BL_I18N.i18nApply());</script>
  <style>
/* --- BeautyLanka UI Booster (non-breaking) --- */
:root{
  --base:#F7F1E1; --ink:#2E1A16; --stroke:#eadfca; --teal:#246A73; --muted:#6f5a54; --blue:#0A66FF;
  --accent-1:#8AD5CD; --accent-2:#F9C6B8; --accent-3:#E9D7A5; --accent-4:#B6E3FF;
  --glass-bg:rgba(255,255,255,.72); --glass-brd:rgba(0,0,0,.06);
}
body{background:var(--base);color:var(--ink)}
/* 背景の装飾（描画のみ。レイアウトに影響なし） */
.bg-radials:before,.bg-radials:after{content:"";position:fixed;inset:auto;z-index:-2;pointer-events:none;filter:blur(40px);opacity:.38}
.bg-radials:before{left:-120px;top:-120px;width:420px;height:420px;background:
  radial-gradient(120px 120px at 40% 40%, var(--accent-1), transparent 70%),
  radial-gradient(160px 160px at 70% 60%, var(--accent-2), transparent 72%)}
.bg-radials:after{right:-120px;bottom:-120px;width:460px;height:460px;background:
  radial-gradient(140px 140px at 30% 40%, var(--accent-4), transparent 70%),
  radial-gradient(180px 180px at 70% 60%, var(--accent-3), transparent 72%)}
.grain{position:fixed;inset:0;z-index:-1;pointer-events:none;opacity:.07;mix-blend-mode:multiply;
  background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140" viewBox="0 0 140 140"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/><feColorMatrix type="saturate" values="0"/><feComponentTransfer><feFuncA type="table" tableValues="0 0 0 .55 .15 0"/></feComponentTransfer></filter><rect width="100%" height="100%" filter="url(%23n)"/></svg>');
  background-size:160px 160px}

/* ボタン/入力：既存 .btn や button に上書き“しすぎない”控えめ装飾 */
.btn, button, a.btn, input[type="button"].btn, input[type="submit"].btn{
  display:inline-flex;align-items:center;justify-content:center;gap:.4em;
  height:40px;border-radius:12px;border:1px solid var(--stroke);
  background:#fff;padding:0 12px;font-weight:800;cursor:pointer;
  box-shadow:0 6px 14px rgba(0,0,0,.06); transition:.15s ease-in-out;
}
.btn.primary{background:var(--teal);border-color:var(--teal);color:#fff;box-shadow:0 10px 24px rgba(36,106,115,.18)}
.btn:hover{transform:translateY(-1px)}
/* カード風の箱（既存の .card があるページはそちら優先。無いページ用の汎用クラス） */
.bl-card{background:#fff;border:1px solid var(--stroke);border-radius:16px;box-shadow:0 12px 28px rgba(0,0,0,.08);padding:16px}

/* 入力類の小綺麗化（既存の幅やIDは触らない） */
input[type="text"],input[type="email"],input[type="tel"],input[type="password"],select,textarea{
  border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;background:#fff;font:inherit
}
input:focus,select:focus,textarea:focus{outline:none;border-color:color-mix(in oklab,var(--teal) 55%,white);
  box-shadow:0 0 0 3px color-mix(in oklab,var(--teal) 20%, transparent)}

/* テーブルの視認性（ゼブラは .zebra を付けた時だけ有効） */
table.zebra tbody tr:nth-child(even){background:#faf6ef}
table.zebra th, table.zebra td{border-bottom:1px solid var(--stroke)}

/* 小さめのタグチップ（表示用。機能なし） */
.tag{padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);font-size:12px;background:#fff}

/* ステップ風パンくず（必要なページだけHTMLを足せば見栄えUP） */
.bl-steps{display:flex;gap:8px;align-items:center;color:var(--muted);font-weight:700}
.bl-steps .dot{width:8px;height:8px;border-radius:50%;background:var(--teal);opacity:.35}
.bl-steps .on{opacity:1}
</style>

</head>
<body>
  <div class="wrap">
    <div class="hrow">
      <a class="back" href="./reservation.html" data-i18n="ui.back">← Back</a>
      <h1 class="h1" data-i18n="confirm.title">Reservation details</h1>
    </div>

    <div class="card" id="sum">
      <div class="title" id="s_item">Menu</div>
      <div class="meta" id="s_salon">#1 / Salon</div>
      <div class="meta" id="s_time" data-i18n="confirm.time_prefix">Time : 2025/01/01 10:00</div>
      <div class="meta" id="s_price" data-i18n="confirm.pay_prefix">Payment : Rs 0</div>
      <div class="meta" id="s_staff">Staff : <span id="s_staff_name" data-i18n="confirm.staff_default">No preference</span></div>
    </div>

    <div class="card" id="userForm">
      <!-- ▼ スマート支払い（カード保存のみ） ▼ -->
<div class="card" id="paySmart">
  <div class="sec-title">Payment method</div>
  <div class="sec-desc" style="opacity:.85">
    We support <b>Smart payment</b>: Your card is saved now, and a single charge is made after the service with the final amount.  </div>
  <!-- Stripe Elements マウント先 -->
  <div id="bl-card-box" style="margin-top:12px"></div>
  <p class="muted" id="bl-card-note" style="margin:8px 0 0">
    Your card is securely saved with Stripe. You will be charged once after the service is completed.  </p>
</div>
<!-- ▲ /スマート支払い ▲ -->
      <!-- ▼ ここから追加：カード保存ボタン -->
<div class="row" style="margin-top:10px">
  <button id="btnSaveCard" class="btn btn-primary">Save card</button>
  <span id="cardSaveMsg" class="muted"></span>
</div>
<!-- ▲ 追加終わり -->
      <div class="sec-title" id="uf_title" data-i18n="ui.yourInfo">Your information</div>
<div class="sec-desc"  id="uf_desc"  data-i18n="confirm.uf_desc">
  Please enter an email and phone number we can reach you at.
</div>

<!-- placeholders -->
<input id="uf_name"  class="input" data-i18n-ph="ui.name"  placeholder="Name">
<input id="uf_email" class="input" data-i18n-ph="ui.email" placeholder="Email">
<input id="uf_phone" class="input" data-i18n-ph="ui.phone" placeholder="Phone (e.g., +94 7X XXX XXXX)" type="tel" required pattern="[\+0-9 ][0-9 \-]{6,}"/>
<textarea id="uf_note" class="input" data-i18n-ph="ui.notes" placeholder="Notes (optional)"></textarea>

<div class="sec-title">Coupon</div>
<input id="cp_code" class="input" placeholder="Enter coupon code"/>
<button id="cp_apply" type="button" class="btn btn-outline">Apply</button>

<!-- toast -->
<span id="toastMsgInline" data-i18n="confirm.toast_missing">Some required fields are missing.</span>
<button class="close" aria-label="Close" data-i18n="confirm.close">×</button>

</div>
<p id="cp_msg" style="margin:6px 0 0; color:#6f5a54; font-size:14px"></p>

    </div>

    <div class="row" style="gap:18px;flex-wrap:wrap;margin-top:24px">
        <a href="./index.html" class="btn btn-outline" data-i18n="ui.toTop">Back to top</a>
    </div>
  </div>

  <div id="toast" class="toast warn" role="status" aria-live="polite" style="display:none">
    <span class="badge">⚠️</span>
    <span id="toastMsg" data-i18n="confirm.toast_missing">Some required fields are missing.</span>
    <button class="close" aria-label="閉じる" onclick="hideToast()" data-i18n="confirm.close">×</button>
  </div>

  <script>
  (function(){
    const nameEl = document.getElementById('uf_name');
    const mailEl = document.getElementById('uf_email');
    const telEl  = document.getElementById('uf_phone');
    const toast  = document.getElementById('toast');
    const toastMsg = document.getElementById('toastMsg');
    let toastTimer = null;

    function emailOK(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }
    function phoneOK(v){ return String(v).replace(/[^0-9+]/g,'').length >= 6; }

    function showToast(message, ok){
      toast.style.display = 'flex';
      toast.classList.remove('ok','warn','show');
      toast.classList.add(ok ? 'ok':'warn');
      toastMsg.textContent = message;
      requestAnimationFrame(()=> toast.classList.add('show'));
      if(toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> hideToast(), 3600);
    }
    window.showToast = showToast;
    window.hideToast = function(){
      toast.classList.remove('show');
      setTimeout(()=>{ toast.style.display='none'; }, 200);
    }

    function validate(){
  const name = nameEl.value.trim();
  const email= mailEl.value.trim();
  const phone= telEl.value.trim();
  const miss = [];
  if(!name) miss.push(BL_I18N.T[BL_I18N.getLang()].confirm.field_name);
  if(!email || !emailOK(email)) miss.push(BL_I18N.T[BL_I18N.getLang()].confirm.field_email);
  if(!phone || !phoneOK(phone)) miss.push(BL_I18N.T[BL_I18N.getLang()].confirm.field_phone);
  return {ok: miss.length===0, miss};
}
    function promptText(fields){
    const { confirm } = BL_I18N.T[BL_I18N.getLang()];
    return confirm.toast_prompt.replace('{fields}', fields.join('・'));
  }
})();
</script>
    
<footer id="ft" style="margin:18px 0 40px;text-align:center;color:#6b5e55;font-size:12px">
  <a href="terms.html"  style="margin:0 10px">Terms</a> ·
  <a href="privacy.html" style="margin:0 10px">Privacy</a> ·
  <a href="cancel.html"  style="margin:0 10px">Cancel Policy</a> ·
  <a href="contact.html" style="margin:0 10px">Contact</a>

  <!-- login式のモーダルを同梱 -->
  <dialog id="blModal">
    <header>
      <span class="title">Loading…</span>
      <button class="close" type="button" aria-label="Close">✕</button>
    </header>
    <iframe id="blModalFrame" src="about:blank" loading="lazy"></iframe>
  </dialog>
</footer>

<div id="ftModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9999">
  <div id="ftBackdrop" style="position:absolute;inset:0;background:rgba(0,0,0,.4)"></div>
  <div role="dialog" aria-modal="true" aria-labelledby="ftTitle"
       style="position:relative;background:#fff;border:1px solid #eadfca;border-radius:14px;box-shadow:0 16px 40px rgba(0,0,0,.18);
              width:min(92vw,720px);max-height:80vh;overflow:auto;padding:18px">
    <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:8px">
      <div id="ftTitle" data-i18n="footer.terms" style="font-weight:900">Terms</div>
      <button id="ftClose" data-i18n="ui.close" style="border:none;background:#fff;border:1px solid #eadfca;border-radius:10px;padding:6px 10px;cursor:pointer">Close</button>
      </div>
    <div id="ftBody" style="line-height:1.7;color:#2E1A16;font-size:14px">
      <p>Loading…</p>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async ()=>{
  try{
    const staffId = localStorage.getItem('bl_reservation_staff')||'';
    if(!staffId) return;
    if(window.BL_API && window.BL_API.listStaff){
      const list = await window.BL_API.listStaff();
      const found = (list||[]).find(x=> String(x.id)===String(staffId));
      if(found?.name){
        const span = document.getElementById('s_staff_name');
        if(span) span.textContent = found.name;
      }
    }
  }catch(e){}
});
</script>
<!-- ★ これを <script id="confirm-fill-from-query"> の直前に追加 -->
<script>
(function ensureBookingIdInURL(){
  try{
    var u = new URL(location.href);
    if(!u.searchParams.get('bookingId')){
      // 既に発行済みがあれば再利用、なければ新規発行
      var existing = localStorage.getItem('bl_current_booking_id') || '';
      var id = existing || (crypto.randomUUID ? crypto.randomUUID()
                : (Date.now().toString(36)+Math.random().toString(36).slice(2,10)));
      u.searchParams.set('bookingId', id);
      history.replaceState(null, '', u.toString()); // 履歴を汚さずURLを書き換え
      localStorage.setItem('bl_current_booking_id', id);
    }
  }catch(e){}
})();
</script>

<script id="confirm-fill-from-query">
(function(){
  function onReady(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  onReady(function(){
    const qs = new URLSearchParams(location.search);

    // 受け取り（新：dt/dateText/price_lkr/price_jpy、旧：time/price にも対応）
    const salonName = qs.get('salonName') || '';
    const itemName  = qs.get('item')      || qs.get('menu') || '';
    const staffName = qs.get('staffName') || '';
    const coupon    = qs.get('coupon')    || '';
    const dtIso     = qs.get('dt')        || '';                // ISO
    const dateText  = qs.get('dateText')  || qs.get('time') || '';// 表示用
    const priceLKR  = qs.get('price_lkr') || '';
    const priceJPY  = qs.get('price_jpy') || qs.get('price') || '';

    // 表示要素
    const elItem  = document.getElementById('s_item');
    const elSalon = document.getElementById('s_salon');
    const elTime  = document.getElementById('s_time');
    const elPrice = document.getElementById('s_price');
    const elStaff = document.getElementById('s_staff_name') || document.getElementById('confirmStaffName');

    // 値の整形
    const timeLabel = dateText || (dtIso ? new Date(dtIso).toLocaleString() : '');
    const priceLabel = priceLKR
       ? `Rs ${Number(priceLKR||0).toLocaleString('en-US')}` 
       : '';

    // 反映（見出しの「時間:」「支払い:」は元テキストを活かす）
    if(elItem)  elItem.textContent  = itemName || elItem.textContent;
    if(elSalon) elSalon.textContent = salonName ? salonName : elSalon.textContent;
    if(elTime && timeLabel){
      elTime.textContent = ( (elTime.textContent.split(':')[0] || '時間') + ' : ' + timeLabel );
    }
    if(elPrice && priceLabel){
      elPrice.textContent = ( (elPrice.textContent.split(':')[0] || '支払い') + ' : ' + priceLabel );
    }
    if(elStaff && staffName){ elStaff.textContent = staffName; }

    // 以降の処理でも使えるよう、必要なら localStorage に保険保存
    try{
      if(dtIso)     localStorage.setItem('reserve_selected', dtIso);
      const priceEl = document.getElementById('s_price');
      if(priceLKR)  priceEl?.setAttribute('data-lkr', String(priceLKR));
      if(priceJPY)  priceEl?.setAttribute('data-jpy', String(priceJPY));
      // URLにも無く data-* も無い時は、テキストからRsを拾って暫定セット
      if(priceEl && !priceEl.getAttribute('data-lkr') && !priceEl.getAttribute('data-jpy')){
        const m = priceEl.textContent.match(/Rs\s*([\d,]+)/i);
        if(m){ priceEl.setAttribute('data-lkr', m[1].replace(/,/g,'')); }
      }
    }catch(_){}
  });
})();
</script>

  <script src="https://js.stripe.com/v3"></script>
  <script>
  // ==== Smart Pay: Save Card via SetupIntent ====
(async function(){
  if(!window.Stripe || !window.BL_PAY || !BL_PAY.pk || !BL_PAY.base) return;

  const stripe = Stripe(BL_PAY.pk);
  const elements = stripe.elements();
  const card = elements.create('card', { hidePostalCode:true });
  card.mount('#bl-card-box');

  const saveBtn = document.getElementById('btnSaveCard');
  const nameEl  = document.getElementById('uf_name');
  const mailEl  = document.getElementById('uf_email');
  const telEl   = document.getElementById('uf_phone');

  async function createSetupIntent(){
    // ★サーバ側（pay-server）に用意してある「SetupIntent発行」エンドポイントを叩く
    // 例: POST ${BL_PAY.base}/setup-intent { bookingId }
    const qs = new URLSearchParams(location.search);
    const bookingId = qs.get('bookingId') || localStorage.getItem('bl_current_booking_id') || '';
    const res = await fetch(`${BL_PAY.base}/api/setup-intent`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ bookingId })
    }).then(r=>r.json());
    if(!res || !res.clientSecret) throw new Error('SetupIntent failed');
　  return res.clientSecret;
  }

  async function saveCard(){
    if(!saveBtn) return;
    saveBtn.disabled = true;
    try{
      const clientSecret = await createSetupIntent();

      const {setupIntent, error} = await stripe.confirmCardSetup(clientSecret, {
        payment_method: {
          card,
          billing_details: {
            name:  nameEl?.value || '',
            email: mailEl?.value || '',
            phone: telEl?.value  || ''
          }
        }
      });

      if(error) throw error;
      // 成功：PMとCustomerがサーバ側で紐付け済み想定。フロントは記念トークンを保存するだけ。
      const saved = { customerId: setupIntent?.metadata?.customerId || '', pm: setupIntent?.payment_method };
      localStorage.setItem('bl_saved_card', JSON.stringify(saved));

      // 見た目のトースト（既存の showToast を利用）
      if(typeof showToast === 'function') showToast('Card saved', true);
      // ボタンの文言更新など
      saveBtn.textContent = 'Saved ✔';
    }catch(e){
      if(typeof showToast === 'function') showToast(e?.message || 'Failed to save card', false);
      saveBtn.disabled = false;
    }
  }

  if(saveBtn){ saveBtn.addEventListener('click', saveCard); }
})();
  </script>
  <script>
  window.BL_PAY = {
    pk: 'pk_live_51S59dFHdBVQmE5fF7PDsSNxtL0mVlv4jOp6TBiC87kmpJEKSfCJZCYOXJzcM2BFiT2nXMLsiOJ3boivba2UNhVjl00gNGKgJS4',
    base: 'https://pay-server-uis7.onrender.com' // まだDNS未設定なら Render の onrender URL
  };
</script>
  
<!-- decorative background (purely visual) -->
<div class="bg-radials"></div>
<div class="grain"></div>

<!-- Footer内リンクをモーダルで開く -->
<script>
(function(){
  const footer = document.querySelector('footer');
  if(!footer) return;

  const dlg   = document.getElementById('blModal');
  const frame = document.getElementById('blModalFrame');
  const title = dlg?.querySelector('.title');
  const btnX  = dlg?.querySelector('button.close');

  footer.addEventListener('click', (ev)=>{
    const a = ev.target.closest('a');
    if(!a) return;
    const href = a.getAttribute('href');
    if(!href || !/\.html?$/i.test(href)) return; // htmlだけモーダル
    ev.preventDefault();

    if(title) title.textContent = (a.textContent||'').trim() || 'Info';
    if(frame) frame.src = href;

    if(typeof dlg?.showModal === 'function') dlg.showModal();

    const onLoad = ()=>{
      try{
        const doc = frame.contentDocument || frame.contentWindow?.document;
        const t = doc?.title?.trim();
        if(t && title) title.textContent = t;
      }catch(_){}
      frame.removeEventListener('load', onLoad);
    };
    frame.addEventListener('load', onLoad);
  });

  btnX?.addEventListener('click', ()=> dlg.close());
})();
</script>


<!-- ここからは機能系スクリプト（入れ子にしない） -->
<script>
// === GAS 接続情報（window -> meta -> URL -> localStorage の順で解決） ===
const q = new URLSearchParams(location.search);

const GAS_URL = (
  window.__GAS_URL ||
  document.querySelector('meta[name="bl-sheet-hook"]')?.content ||
  q.get('gas') ||
  localStorage.getItem('bl_gas_url') ||
  ''
).trim();

const GAS_KEY = (
  window.__GAS_KEY ||
  q.get('key') ||
  localStorage.getItem('bl_gas_key') ||
  ''
).trim();

if (!GAS_URL) console.error('GAS_URL missing');
if (!GAS_KEY) console.error('GAS_KEY missing');

async function postBookingToSheet({
  bookingId, date, time, minutes,
  salonId, shopName, menu, menuName,
  amountJPY, email, name,
  whatsappToCustomer, whatsappToSalon,
  status = 'reserved'
}) {
  let customerId = '';
  try { customerId = JSON.parse(localStorage.getItem('bl_saved_card')||'null')?.customerId || ''; } catch {}
  if(!GAS_URL || !GAS_KEY) { console.warn('GAS_URL/GAS_KEY missing'); return false; }

const qs2 = new URLSearchParams(location.search);
const couponCode = qs2.get('coupon') || '';
const discountedJPY = Number(qs2.get('price_jpy') || 0) || 0; // URL 上はすでに割引後を反映

const payload = {
  key: GAS_KEY,
  kind: 'booking',
  data: {
    bookingId, date, time, minutes,
    salonId, shopName, menu, menuName,
    amountJPY,             // 元の基準価格（保持）
    email, name, customerId,
    whatsappToCustomer, whatsappToSalon,
    status,
    couponCode,            // ← 追加
    discountedJPY: discountedJPY          // ← 追加（サーバ側で再計算＆上書きもされる）
  }
};

const res = await fetch(GAS_URL, {
  method: 'POST',
  headers: { 'Content-Type': 'text/plain;charset=utf-8' },
  body: JSON.stringify(payload)
});


  const txt = await res.text();
  let j; try { j = JSON.parse(txt); } catch { j = { ok:false, error:'Invalid JSON from GAS' }; }
  if (!j.ok) console.warn('GAS booking write failed:', j.error, payload);
  return !!j.ok;
}


function readBookingFromPage() {
  const qs = new URLSearchParams(location.search);

  // 予約ID（先行スクリプトでURLに埋め込み済み）
  const bookingId = qs.get('bookingId') || (localStorage.getItem('bl_current_booking_id') || '');

  // reservation.html から渡ってくる想定の値たち
  const salonId   = qs.get('salonId')   || qs.get('salon') || '';
  const shopName  = qs.get('salonName') || qs.get('salon_name') || '';
  const menuName  = qs.get('item')      || qs.get('menu')  || '';
  const minutes   = Number(qs.get('minutes') || 0) || 0;

  // 金額（日本円基準で bookings に保持）
  const amountJPY = Number(qs.get('price_jpy') || 0) || 0;

  // 連絡先（URLに無ければ後で上書きできる）
  const email = qs.get('email') || '';
  const name  = qs.get('name')  || '';

  // 日時：localStorage('reserve_selected') に ISO が入っている前提
  let iso = (localStorage.getItem('reserve_selected') || '').trim();
  if (!iso) iso = qs.get('dt') || ''; // 念のため URL の dt も確認
  const d  = iso ? new Date(iso) : new Date();

  const date = d.toISOString().slice(0,10); // 'YYYY-MM-DD'
  const time = String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0'); // 'HH:MM'

  // WhatsApp 通知先（あれば渡す。無ければ空でOK）
  const whatsappToCustomer = qs.get('wa_customer') || ''; // +国番号付き '81...', '94...'
  const whatsappToSalon    = qs.get('wa_salon')    || '';

  return {
    bookingId,
    date, time, minutes,
    salonId, shopName,
    menu: menuName,   // 互換フィールド
    menuName,         // 新フィールド
    amountJPY, email, name,
    whatsappToCustomer, whatsappToSalon,
    status: 'reserved'
  };
}

/* ====== カード保存フォーム（Stripe Elements） ====== */
(() => {
  const holder = document.getElementById('bl-card-box');
  if(!holder) return;

  const saved = (()=>{ try{return JSON.parse(localStorage.getItem('bl_saved_card')||'null')}catch(e){return null} })();
  if(saved){
    holder.innerHTML = `
      <div class="notice" style="padding:10px;border:1px solid #eadfca;border-radius:10px">
        Your card has been securely saved. ✅<br>
        <small>（customerId: ${saved.customerId} / pm: ${saved.paymentMethodId}）</small><br>
        <button id="bl-change" class="btn" style="margin-top:8px">Use a different card</button>
      </div>`;
    document.getElementById('bl-change').onclick = mountForm;
  }else{
    mountForm();
  }

// ===== Coupon apply (confirm page) =====
(function(){
  const $ = s => document.querySelector(s);
  const btn = $('#cp_apply');
  const msg = $('#cp_msg');
  const input = $('#cp_code');
  const elPrice = document.getElementById('s_price'); // data-jpy / data-lkr を持たせる

  if(!btn || !input || !elPrice) return;

  // 初期: s_price に data-jpy / data-lkr が無ければ URL から付与
  try{
    const qs = new URLSearchParams(location.search);
    if(!elPrice.getAttribute('data-jpy') && qs.get('price_jpy'))
      elPrice.setAttribute('data-jpy', String(qs.get('price_jpy')));
    if(!elPrice.getAttribute('data-lkr') && qs.get('price_lkr'))
      elPrice.setAttribute('data-lkr', String(qs.get('price_lkr')));
  }catch(_){}

  async function applyCoupon(){
    msg.textContent = '';
    const code = (input.value||'').trim();
    if(!code){ msg.textContent = 'クーポンコードを入力してください'; return; }

    // 予約者メールが未入力だと「初回限定」の判定ができない
    const email = (document.getElementById('uf_email')?.value||'').trim();
    if(!email){ msg.textContent = '初回限定判定のためメールを先に入力してください'; return; }

    // salonId は URL から
    const qs = new URLSearchParams(location.search);
    const salonId = qs.get('salonId') || qs.get('salon') || '';
    if(!salonId){ msg.textContent = 'サロン情報が見つかりません'; return; }

    // GAS へ検証依頼
    if(!GAS_URL || !GAS_KEY){
      msg.textContent = 'サーバ設定が未完了のため、適用できません';
      return;
    }
    const res = await fetch(GAS_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        key: GAS_KEY,
        kind: 'coupon.validate',
        data: { salonId, code, email }
      })
    });
    const j = await res.json().catch(()=>({ok:false,error:'bad_json'}));
    if(!j.ok){
      const reason = String(j.error||'invalid');
      if(reason==='not_first_time') msg.textContent = 'このクーポンは“初回限定”です（過去ご利用があるため適用できません）';
      else if(reason==='email_required_for_first_time') msg.textContent = '初回限定判定のためメール入力が必要です';
      else if(reason==='not_found') msg.textContent = '無効なクーポンです';
      else msg.textContent = 'クーポンの適用に失敗しました';
      return;
    }

    // 割引後金額を計算（安全のためサーバ側でも再計算済みだが、UI用にここでも計算）
    const pct = Number(j.coupon?.pct||0);
    const off = Number(j.coupon?.offJPY||0);
    const baseJPY = Number(elPrice.getAttribute('data-jpy')||0);
    let discounted = baseJPY;
    if(pct>0) discounted = Math.round(discounted * (100 - pct) / 100);
    if(off>0) discounted = Math.max(0, discounted - off);

    // 割引後金額を保持＆表示を更新
  elPrice.setAttribute('data-jpy', String(discounted));
  const FX = 2.15; // 管理側に合わせる
  const lkr = Math.max(0, Math.round(discounted * FX));
  elPrice.setAttribute('data-lkr', String(lkr));
  const label = (elPrice.textContent.split(':')[0] || 'Payment');
  elPrice.textContent = `${label} : Rs ${lkr.toLocaleString('en-US')}`;
    // URL にも `coupon` と `price_jpy` を反映（postBookingToSheet は URL から読むため）
    try{
      const u = new URL(location.href);
      u.searchParams.set('coupon', code);
      u.searchParams.set('price_jpy', String(discounted));
      history.replaceState(null, '', u.toString());
    }catch(_){}

    msg.style.color = '#0B7F5F';
    msg.textContent = 'クーポンを適用しました';
  }

  btn.addEventListener('click', applyCoupon);
})();

  function mountForm(){
    const base = (window.BL_PAY?.base||'').replace(/\/$/,'');
    const pk   = window.BL_PAY?.pk || 'pk_test_...';
    if(!pk || !base){ holder.textContent='設定不足（pk/base）'; return; }

    holder.innerHTML = `
      <div style="max-width:520px">
        <label>Mail address<input id="sp_email" placeholder="you@example.com" style="width:100%"></label>
        <label>Name<input id="sp_name"  placeholder="Taro Yamada" style="width:100%"></label>
        <div id="sp_card" style="border:1px solid #eadfca;border-radius:10px;padding:12px;margin:10px 0"></div>
        <button id="sp_save" class="btn primary">Save card</button>
        <div id="sp_msg" class="notice" style="margin-top:8px"></div>
      </div>`;

    const stripe   = Stripe(pk);
    const elements = stripe.elements();
    const cardEl   = elements.create('card', { hidePostalCode:true });
    cardEl.mount('#sp_card');

    const $ = id => document.getElementById(id);
    const msg = (t, ok=false) => { $('sp_msg').textContent = t; $('sp_msg').style.color = ok ? '#246A73' : '#6f5a54'; };

    // 自動補完
    const val = s => {const el=document.querySelector(s); return el && el.value ? el.value.trim() : ''};
    $('sp_email').value = val('#uf_email') || val('[name="email"]');
    $('sp_name').value  = val('#uf_name')  || val('[name="name"]');

    $('sp_save').addEventListener('click', async () => {
      try{
        const email = ($('sp_email').value||'').trim();
        const name  = ($('sp_name').value||'').trim();
        if(!email || !name) return msg('メールとお名前を入力してください');

        msg('カード保存の準備中…');

        const siRes = await fetch(base + '/api/setup-intent', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ email, name })
});
const raw = await siRes.text();

// --- helper: mask clientSecret in raw string for safe logging ---
function _maskSecrets(str) {
  try {
    return str.replace(/("clientSecret"\s*:\s*")([^"]+)(")/g, (m, p1, p2, p3) => {
      // マスクは先頭以外を*にする（最後6文字は残す）
      const masked = p2.replace(/.(?=.{6})/g, '*');
      return p1 + masked + p3;
    });
  } catch (e) {
    return '***masked***';
  }
}

let si;
try {
  si = JSON.parse(raw);
} catch (e) {
  // 生の client_secret を UI に出さない（console はマスクして出す）
  console.error('Invalid JSON from setup-intent (masked):', _maskSecrets(raw));
  throw new Error('サーバからの応答が不正です（開発者へ確認して下さい）');
}

if (!siRes.ok || !si?.ok) {
  console.error('setup-intent error response (masked):', _maskSecrets(raw));
  throw new Error(si?.error || `setup-intent failed (${siRes.status})`);
}

// ← 重要：変数名のtypo修正。serverが返すキー名が "clientSecret" の場合はそのまま取得
 const clientSecret = si.clientSecret || si.client_secret;
 const customerId = si.customerId;
 const livemode = si.livemode;
// （任意）console に livemode を安全に出す（デバッグ用）
if (typeof livemode !== 'undefined') console.log('setup-intent livemode:', livemode);

// 実際の Stripe 確認呼び出し
const { setupIntent, error } = await stripe.confirmCardSetup(clientSecret, {
  payment_method: { card: cardEl, billing_details: { email, name } },
});
if (error) throw error;
const payload = {
  email, name,
  customerId,
  paymentMethodId: setupIntent.payment_method,
  ts: Date.now()
};
localStorage.setItem('bl_saved_card', JSON.stringify(payload));
        // customers シートを upsert（GAS）
try {
  await fetch(GAS_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify({ key: GAS_KEY, kind: 'customer', data: payload })
  });
} catch (_) {}

// 画面へ「カード保存できた」イベント（bookings 再上書き用）
document.dispatchEvent(new CustomEvent('bl:card-saved', { detail: payload }));

        msg('Your card has been saved.', true);
        holder.innerHTML = `
          <div class="notice" style="padding:10px;border:1px solid #eadfca;border-radius:10px">
            Your card information is already saved.<br>
            <small>（customerId: ${payload.customerId} / pm: ${payload.paymentMethodId}）</small><br>
            <button id="bl-change" class="btn" style="margin-top:8px">Use a different card</button>
          </div>`;
        document.getElementById('bl-change').onclick = mountForm;

        const WEBHOOK = (document.querySelector('meta[name="bl-sheet-hook"]')?.content)||'';
        if(WEBHOOK){
          try{ await fetch(WEBHOOK, { method:'POST', headers:{ 'Content-Type':'text/plain;charset=utf-8' }, body: JSON.stringify({ kind:'card_saved', ...payload }) }); }catch(_){}
        }
      }catch(e){
        console.error(e);
        msg('Failed to save：' + (e.message||e));
      }
    });
  }
})();

function composeBooking(overrides = {}) {
  const b = readBookingFromPage();
  const name  = (document.getElementById('uf_name') ?.value || '').trim();
  const email = (document.getElementById('uf_email')?.value || '').trim();
  const phone = (document.getElementById('uf_phone')?.value || '').trim();

  if (name)  b.name  = name;
  if (email) b.email = email;
  if (phone) b.phone = phone;

  // WhatsApp先が未指定なら、電話を使って自動補完（先頭に+が無ければそのまま）
  if (!b.whatsappToCustomer && phone) {
    const p = phone.replace(/[^\d+]/g,''); // 数字と+だけ残す
    b.whatsappToCustomer = p.startsWith('+') ? p.slice(1) : p; // Gas側では“81…”のような数字列でもOK
  }

  Object.assign(b, overrides);
  return b;
}

// 初回だけは「空でも」1行作っておく（行の土台づくり）
function writeBookingOnce() {
  const b = composeBooking();
  if (!b.bookingId) return;
  const sentKey = `bl_booking_sent_${b.bookingId}`;
  if (localStorage.getItem(sentKey)) return;
  postBookingToSheet(b).then(ok => {
    if (ok) localStorage.setItem(sentKey, '1');
  });
}

// 入力が変わったら同じ bookingId に対して upsert（上書き更新）
let _saveTimer = null;
function updateBookingDebounced() {
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(() => {
    const b = composeBooking();
    if (!b.bookingId) return;
    postBookingToSheet(b); // 同じ bookingId だから GAS 側 upsert で上書き
  }, 400);
}

document.addEventListener('DOMContentLoaded', () => {
  writeBookingOnce(); // 土台行を作る

  // 入力が進むたびに上書き
  const ufMail = document.getElementById('uf_email');
  const ufName = document.getElementById('uf_name');
  ['input','change','blur'].forEach(ev => {
    ufMail?.addEventListener(ev, updateBookingDebounced);
    ufName?.addEventListener(ev, updateBookingDebounced);
  });

  // Stripeの簡易フォームと双方向に同期（あれば）
  document.addEventListener('input', (e) => {
    if (e.target?.id === 'sp_email') {
      const v = e.target.value || '';
      const t = document.getElementById('uf_email'); if (t && !t.value) t.value = v;
    }
    if (e.target?.id === 'sp_name') {
      const v = e.target.value || '';
      const t = document.getElementById('uf_name');  if (t && !t.value) t.value = v;
    }
  });

  // カード保存成功時にも上書きしておく（下の 2) のイベントを受ける）
  document.addEventListener('bl:card-saved', updateBookingDebounced);
});
</script>
</body>
</html>
