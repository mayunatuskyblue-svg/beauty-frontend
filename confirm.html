  // ② URL（?bookingId=...）から予約情報を拾う or 事前に保存しておいたデータを拾う
  function readBookingFromPage() {
    const qs = new URLSearchParams(location.search);
    let booking = {
      bookingId:  qs.get('bookingId') || '',
      date:       qs.get('date') || new Date().toISOString(),
      menu:       qs.get('menu') || '',
      minutes:    Number(qs.get('minutes') || 0) || 0,
      amountJPY:  Number(qs.get('amountJPY') || 0) || 0,
      email:      qs.get('email') || '',
      name:       qs.get('name') || ''
    };
    if (!booking.bookingId) {
      try {
        const saved = JSON.parse(sessionStorage.getItem('bl_pending_booking') || localStorage.getItem('bl_pending_booking') || 'null');
        if (saved && saved.bookingId) booking = Object.assign(booking, saved);
      } catch {}
    }
    return booking;
  }

  // ③ 1回だけ送る（同じ bookingId での二重送信防止）
  document.addEventListener('DOMContentLoaded', async () => {
    const b = readBookingFromPage();
    if (!b.bookingId) { console.warn('bookingId が無いので送信しません'); return; }

    const sentKey = `bl_booking_sent_${b.bookingId}`;
    if (localStorage.getItem(sentKey)) return;

    const ok = await postBookingToSheet({
      bookingId: b.bookingId,
      date:      b.date || new Date().toISOString(),
      menu:      b.menu,
      minutes:   b.minutes,
      amountJPY: b.amountJPY,
      email:     b.email,
      name:      b.name
    });

    if (ok) localStorage.setItem(sentKey, '1');
  });
</script>
