<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BeautyLanka | 詳細</title>
<link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@600;700&family=Zen+Kaku+Gothic+New:wght@400;500;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --base:#F7F1E1; --ink:#2E1A16; --stroke:#eadfca; --teal:#246A73; --muted:#6f5a54; --blue:#0A66FF; --danger:#74070E;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--base);color:var(--ink);
  font-family:"Inter","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
.container{max-width:1100px;margin:0 auto;padding:0 16px}
a{color:inherit;text-decoration:none}

/* header */
header{position:sticky;top:0;z-index:40;background:rgba(247,241,225,.92);backdrop-filter:blur(6px);border-bottom:1px solid var(--stroke)}
.hwrap{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:12px 0}
.brand-left{display:flex;align-items:center;gap:10px;text-decoration:none}
.logo-img{width:110px;height:auto;border-radius:14px;box-shadow:0 10px 24px rgba(36,106,115,.18)}
.header-controls { display:flex; gap:.5rem; align-items:center; padding:8px 16px; }
.header-controls label.small{font-size:12px;color:var(--muted) }
.header-controls select{ border:1px solid var(--stroke); background:#fff; padding:.4rem .6rem; border-radius:10px; font-size:.95rem; }

/* main grid */
.main{display:grid;grid-template-columns:1.25fr .75fr;gap:16px;margin:14px 0}
@media(max-width:960px){ .main{grid-template-columns:1fr} }

/* media */
.media{position:relative;background:#000;border-radius:14px;overflow:hidden}
.carousel{display:flex;overflow-x:hidden;scroll-snap-type:x mandatory}
.carousel img{height:420px;width:100%;object-fit:cover;flex:0 0 100%;scroll-snap-align:center}
.nav{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;pointer-events:none}
.nav button{pointer-events:auto;border:none;background:rgba(0,0,0,.35);width:44px;height:44px;border-radius:999px;color:#fff;font-size:18px;cursor:pointer}
.thumbs{display:flex;gap:6px;overflow-x:auto;padding:8px}
.thumbs img{width:96px;height:64px;object-fit:cover;border-radius:6px;opacity:.8;cursor:pointer;border:1px solid #eee}
.thumbs img.active{opacity:1;outline:2px solid var(--teal)}

/* sections */
.section{background:#fff;border:1px solid var(--stroke);border-radius:16px;box-shadow:0 10px 24px rgba(49,14,16,.08);padding:14px;margin:12px 0}
.section h2{margin:0 0 8px;font-size:18px}

/* shop header block */
.title{font-size:26px;font-weight:900;margin:8px 0 4px}
.meta{color:#6b5e55}
.tags{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
.tag{padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);font-size:12px;background:#fff}
.price{font-weight:900;font-size:20px;margin:4px 0 10px}

/* map */
.mapwrap iframe{width:100%;height:260px;border:0;border-radius:12px}

/* menu + coupon */
.menu{border:1px solid var(--stroke);border-radius:12px;padding:10px;margin:8px 0;display:flex;justify-content:space-between;align-items:center;gap:10px}
.menu .name{font-weight:900}
.menu .meta{font-size:12px;color:#6b5e55}
.menu .price{font-weight:900}
.btn{height:40px;border-radius:12px;border:1px solid var(--stroke);background:#fff;padding:0 14px;font-weight:700;cursor:pointer}
.btn.primary{background:var(--teal);border-color:var(--teal);color:#fff;box-shadow:0 6px 14px rgba(36,106,115,.18)}
.reserve-btn { font-size:1.05rem; padding:.7rem 1.1rem; border-radius:14px; }

/* reviews */
.notice{font-size:12px;color:var(--muted)}
.reviews{display:grid;gap:12px;margin:8px 0 12px}
.review{background:#fff;border:1px solid var(--stroke);border-radius:14px;padding:12px 14px}
.review .meta{font-size:.9rem;opacity:.9;margin-bottom:4px}
.rev input,.rev textarea,.rev select{width:100%;border:1px solid var(--stroke);border-radius:10px;padding:8px 10px;font:inherit}
.row2{display:flex;gap:8px;flex-wrap:wrap}
.actions{display:flex;gap:8px;align-items:center}

/* policies section (footer-like) */
.policies { margin:30px auto 40px; padding:16px 0; border-top:1px solid var(--stroke); }
.policies .small { font-size:12px; color:#6b5e55; }
.policies .links { display:flex; gap:18px; flex-wrap:wrap; justify-content:center; }

/* lightweight modal (same style as index) */
#policyModal { display:none; position:fixed; inset:0; z-index:10000; align-items:center; justify-content:center; background:rgba(0,0,0,.45) }
#policyModal .sheet { max-width:780px; width:92%; background:#fff; border-radius:14px; border:1px solid #eadfca; box-shadow:0 18px 40px rgba(0,0,0,.25); }
#policyModal header { display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid #eadfca }
#policyModal #policyBody { padding:14px 16px; line-height:1.7; color:#2E1A16 }

footer{color:#6b5e55;text-align:center;font-size:12px;margin:12px 0}
</style>
</head>
<body>
<header>
  <div class="container hwrap">
    <a class="brand-left" href="./index.html?nosplash=1" aria-label="BeautyLanka">
      <img class="logo-img" src="/assets/img/logo_mark.png" alt="BeautyLanka logo">
    </a>
    <div></div>
  </div>
  <div class="header-controls">
    <label class="small" style="opacity:.7">Lang</label>
    <select id="langSelect">
      <option value="auto">Auto</option>
      <option value="ja">日本語</option>
      <option value="en">English</option>
    </select>
    <label class="small" style="opacity:.7">Currency</label>
    <select id="currencySelect">
      <option value="USD">USD</option>
      <option value="JPY">JPY</option>
      <option value="LKR">LKR</option>
      <option value="EUR">EUR</option>
    </select>
  </div>
</header>

<div class="container">
  <nav class="breadcrumbs" aria-label="Breadcrumb"></nav>
</div>

<div class="container">
  <div class="main">
    <div>
      <div class="media">
        <div class="carousel" id="carousel"></div>
        <div class="nav">
          <button id="prev" aria-label="Previous">‹</button>
          <button id="next" aria-label="Next">›</button>
        </div>
      </div>
      <div class="thumbs" id="thumbs"></div>

      <div class="section" id="shopInfoSection">
        <h2 data-i18n="shop_info">店舗情報</h2>
        <div class="tags" id="tags"></div>
        <div class="price" id="price"></div>
        <p id="points" style="margin:.4em 0 0"></p>
      </div>

      <div class="section">
        <h2 data-i18n="menu">メニュー</h2>
        <!-- セレクト＋上部CTAは廃止。行ボタンのみで予約 -->
        <div id="menuList"></div>
      </div>

      <div class="section">
        <h2 data-i18n="coupons">クーポン</h2>
        <div id="couponList"></div>
      </div>

      <div class="section">
        <h2 data-i18n="map">地図・道順</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <button class="btn reserve-btn" id="route">Googleで道順</button>
        </div>
        <div class="mapwrap"><iframe id="map" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe></div>
      </div>
    </div>

    <aside>
      <div class="section">
        <h2 id="name">店舗名</h2>
        <div class="meta" id="meta"></div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn reserve-btn" id="backToList">一覧に戻る</button>
          <button class="btn primary reserve-btn" id="reserve">予約へ進む</button>
        </div>
      </div>

      <div class="section" id="reviewsSection">
        <h2 data-i18n="reviews">口コミ</h2>
        <div class="notice" id="gateMsg">※投稿は予約済みの方のみ（Thank You 到達で自動開放）</div>

        <!-- 外部 API の口コミ（一覧表示、折りたたみ） -->
        <div id="reviewList" class="reviews" aria-live="polite"></div>
        <div style="display:flex;justify-content:center">
          <button class="btn reserve-btn" id="viewAllReviews" style="display:none">もっと見る</button>
        </div>

        <!-- ユーザー投稿領域（ゲート） -->
        <div id="revform" class="rev">
          <div class="row2" style="margin-top:6px">
            <input id="revName" placeholder="お名前">
            <select id="revCountry">
              <option value="">国籍を選択</option>
              <option>日本</option><option>Sri Lanka</option><option>USA</option><option>UK</option>
              <option>India</option><option>China</option><option>Korea</option><option>France</option><option>Germany</option>
            </select>
          </div>
          <textarea id="revText" rows="3" placeholder="体験を教えてください" style="margin-top:6px"></textarea>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:6px">
            <button class="btn reserve-btn" id="revSubmit">投稿</button>
          </div>
        </div>

        <!-- このページで投稿した分（即時表示） -->
        <div id="revlist" class="reviews"></div>
      </div>
    </aside>
  </div>
</div>

<!-- Policies (same UX as index: links open modal) -->
<section class="policies container">
  <div class="links">
    <a href="terms.html" class="small">Terms</a>
    <a href="privacy.html" class="small">Privacy</a>
    <a href="cancel.html" class="small">Cancel Policy</a>
    <a href="contact.html" class="small">Contact</a>
  </div>
</section>

<!-- lightweight modal (same DOM as index) -->
<div id="policyModal" class="modal" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="policyTitle">
    <header>
      <h3 id="policyTitle" style="margin:0;font-size:18px">Title</h3>
      <button id="policyClose" class="btn reserve-btn" style="height:32px">Close</button>
    </header>
    <div id="policyBody"></div>
  </div>
</div>

<footer>Build v2025-09-15e</footer>

<script>
/* -----------------------
   Helpers (Lang / i18n)
----------------------- */
function getLangPref(){
  const pref = localStorage.getItem('bl_lang') || 'auto';
  if(pref==='auto'){
    const ja = (navigator.language||'en').toLowerCase().startsWith('ja');
    return ja ? 'ja' : 'en';
  }
  return pref;
}
function setLangSelect(){
  const sel = document.getElementById('langSelect');
  if(!sel) return;
  sel.value = localStorage.getItem('bl_lang') || 'auto';
  sel.onchange = ()=>{ localStorage.setItem('bl_lang', sel.value); location.reload(); };
}
const T = {
  ja: {
    shop_info:'店舗情報', menu:'メニュー', coupons:'クーポン', map:'地図・道順', reviews:'口コミ',
    back:'一覧に戻る', book:'予約へ進む', route:'Googleで道順', price_from:'料金目安：',
    see_more:'もっと見る',
    review_gate:'※投稿は予約済みの方のみ（Thank You 到達で自動開放）',
    your_name:'お名前', your_experience:'体験を教えてください', select_country:'国籍を選択',
    submit:'投稿', not_available:'この店舗では準備中です'
  },
  en: {
    shop_info:'Shop info', menu:'Menu', coupons:'Coupons', map:'Map & Directions', reviews:'Reviews',
    back:'Back to list', book:'Book', route:'Directions on Google', price_from:'From ',
    see_more:'View all',
    review_gate:'* Review posting is limited to completed bookings.',
    your_name:'Your name', your_experience:'Share your experience', select_country:'Select nationality',
    submit:'Submit', not_available:'Not available at this shop'
  }
};
function t(k){ const L=getLangPref(); return (T[L]&&T[L][k])||k; }

/* -----------------------
   English mappings
----------------------- */
function enTag(s){
  const map = {
    'マツエク':'Lashes','まつげ':'Lashes','スパ':'Spa','ハーブ':'Herbs','ヘア':'Hair','ネイル':'Nails',
    'アーユルヴェーダ':'Ayurveda','リラク':'Relaxation','日本語対応':'Japanese support'
  };
  return map[s]||s;
}
function enType(s){ return enTag(s); }
function enPoints(s){
  if(!s) return '';
  let x = String(s);
  const repl = new Map([
    ['自然で長持ち。?丁寧なカウンセリング。?','Naturally long-lasting with attentive consultation.'],
    ['本格(的な)?アーユルヴェーダと静かな個室。?','Authentic Ayurveda in a tranquil private room.'],
    ['自社?ブレンドのハーブでリラックス。?','Relax with our original blended herbs.'],
    ['落ち着いた(雰囲気|空間)。?','Calm, relaxing atmosphere.'],
    ['丁寧(な)?施術。?','Meticulous, high-care treatment.']
  ]);
  repl.forEach((en,ja)=>{ x = x.replace(new RegExp(ja,'g'), en); });
  x = x.replace(/。/g,'. ').replace(/\s+/g,' ').trim();
  if(x) x = x[0].toUpperCase()+x.slice(1);
  return x;
}
function enMenuName(s){
  const map = {
    'フルセット 120本':'Full set (120 lashes)',
    'フルセット（120本）':'Full set (120 lashes)',
    'フルセット(120本)':'Full set (120 lashes)',
    'ボリュームラッシュ':'Volume lashes',
    'ハーブ蒸し':'Herbal steam',
    'ボディスクラブ':'Body scrub',
    '全身アーユルヴェーダ':'Full-body Ayurveda',
    'オイルトリートメント':'Oil treatment',
    'ラッシュリフト':'Lash lift',
    'ヘッドスパ':'Head spa',
    'フェイシャル':'Facial'
  };
  return map[s]||s;
}

/* -----------------------
   Currency (match index)
----------------------- */
const RATES = { JPY:1, USD:0.0067, EUR:0.0061, LKR:2.05 }; // JPY -> target
function getCurrency(){ return (localStorage.getItem('bl_currency') || 'JPY'); }
function setCurrencySelectAndWire(){
  const sel = document.getElementById('currencySelect');
  if(!sel) return;
  sel.value = getCurrency();
  sel.onchange = ()=>{ localStorage.setItem('bl_currency', sel.value); updateCurrencies(); };
}
function fmtCurrencyFromJPY(jpy, cur){
  const n = Math.max(0, Number(jpy)||0);
  const rate = RATES[cur] || 1;
  const converted = Math.round(n * rate);
  try{
    return new Intl.NumberFormat((getLangPref()==='ja'?'ja-JP':'en-US'), {
      style:'currency', currency: cur, maximumFractionDigits:(cur==='USD'||cur==='EUR'?0:0)
    }).format(converted);
  }catch(e){
    const symbols = {JPY:'¥', USD:'$', EUR:'€', LKR:'Rs '};
    return (symbols[cur]||'') + converted.toLocaleString();
  }
}

/* -----------------------
   Static data
----------------------- */
const DATA=[
  {id:"S1", name:"Silky Lashes Colombo", type:"マツエク", place:"コロンボ", lat:6.933, lng:79.85, price:4250, rating:4.6, tags:["マツエク","日本語対応"], points:"自然で長持ち。丁寧なカウンセリング。", photos:["/assets/img/lashes_a.webp","/assets/img/lashes_b.webp","/assets/img/lashes_c.webp"]},
  {id:"S2", name:"Ayur Luxe Spa", type:"スパ", place:"ゴール", lat:6.025, lng:80.217, price:6630, rating:4.7, tags:["アーユルヴェーダ","リラク"], points:"本格アーユルヴェーダと静かな個室。", photos:["/assets/img/spa_massage.webp","/assets/img/herbs_flatlay.webp","/assets/img/lashes_a.webp"]},
  {id:"S3", name:"Cinnamon Grow", type:"ハーブ", place:"キャンディ", lat:7.293, lng:80.641, price:5610, rating:4.5, tags:["ハーブ","リラク"], points:"自社ブレンドのハーブでリラックス。", photos:["/assets/img/herbs_flatlay.webp","/assets/img/spa_massage.webp","/assets/img/lashes_b.webp"]}
];
const MENUS={
  "S1":[{id:"m1", name:"フルセット 120本", minutes:90, price:4250},{id:"m2", name:"ボリュームラッシュ", minutes:120, price:5200}],
  "S2":[{id:"m1", name:"全身アーユルヴェーダ", minutes:90, price:6630},{id:"m2", name:"オイルトリートメント", minutes:60, price:4200}],
  "S3":[{id:"m1", name:"ハーブ蒸し", minutes:45, price:3500},{id:"m2", name:"ボディスクラブ", minutes:60, price:4800}]
};
const COUPONS={
  "S1":[{id:"c1", name:"初回10%OFF", minutes:90, price:3825}],
  "S2":[{id:"c1", name:"セット割", minutes:120, price:9800}],
  "S3":[{id:"c1", name:"平日割", minutes:60, price:3200}]
};

/* -----------------------
   Page init
----------------------- */
const p = new URLSearchParams(location.search);
const salonId = p.get('salonId') || 'S1';
const shop = DATA.find(x=>x.id===salonId) || DATA[0];
document.title = shop.name + " | BeautyLanka";

const LANG = getLangPref();
setLangSelect();
setCurrencySelectAndWire();

// Headings & buttons
document.querySelectorAll('[data-i18n]').forEach(el=>{ el.textContent = t(el.dataset.i18n); });
document.getElementById('backToList').textContent = t('back');
document.getElementById('reserve').textContent    = t('book');
document.getElementById('route').textContent      = t('route');
document.getElementById('gateMsg').textContent    = t('review_gate');
document.getElementById('viewAllReviews').textContent = t('see_more');

// Shop header
document.getElementById('name').textContent = shop.name;
document.getElementById('meta').textContent = (LANG==='en'
  ? `${shop.place} · ${enType(shop.type)} / ★${shop.rating.toFixed(1)}`
  : `${shop.place}・${shop.type}／★${shop.rating.toFixed(1)}`);
document.getElementById('price').dataset.jpy = String(shop.price);
document.getElementById('points').textContent = (LANG==='en' ? enPoints(shop.points) : shop.points);

// Tags
document.getElementById('tags').innerHTML = (shop.tags||[]).map(tg => {
  const label = (LANG==='en'? enTag(tg): tg);
  return `<span class="tag">${label}</span>`;
}).join('');

// Map & route
document.getElementById('route').onclick=()=>window.open(`https://www.google.com/maps/dir/?api=1&destination=${shop.lat},${shop.lng}&travelmode=driving&hl=${LANG}`,'_blank');
document.getElementById('map').src = `https://www.google.com/maps?q=${shop.lat},${shop.lng}&z=15&hl=${LANG}&output=embed`;

// Back / Reserve buttons
document.getElementById('backToList').onclick = ()=>{
  if(history.length>1){ history.back(); } else { location.href='index.html?nosplash=1'; }
};
document.getElementById('reserve').onclick = ()=>{
  // メニュー行の先頭ボタンへスクロール＆フォーカス
  const firstBtn = document.querySelector('#menuList .menu [data-go]');
  if(firstBtn){
    firstBtn.closest('.menu').scrollIntoView({behavior:'smooth', block:'center'});
    firstBtn.focus();
  }else{
    // fallback: 直接予約ページへ
    const q = new URLSearchParams({salonId:shop.id, salonName:shop.name});
    if(LANG==='en') q.set('lang','en');
    location.href = 'reservation.html?'+q.toString();
  }
};

// Carousel
const car = document.getElementById('carousel');
const thumbs = document.getElementById('thumbs');
car.innerHTML = (shop.photos||[]).map((src,i)=>`<img src="${src}" alt="${shop.name} photo ${i+1}">`).join('');
thumbs.innerHTML = (shop.photos||[]).map((src,i)=>`<img data-idx="${i}" src="${src}" alt="thumb ${i+1}">`).join('');
let cidx=0; const imgs=car.querySelectorAll('img'); const timgs=thumbs.querySelectorAll('img');
function go(i){ cidx=(i+imgs.length)%imgs.length; car.scrollTo({left:car.clientWidth*cidx,behavior:'smooth'}); timgs.forEach(x=>x.classList.remove('active')); if(timgs[cidx]) timgs[cidx].classList.add('active'); }
document.getElementById('prev').onclick=()=>go(cidx-1);
document.getElementById('next').onclick=()=>go(cidx+1);
timgs.forEach(t=>t.onclick=()=>go(parseInt(t.dataset.idx||'0',10)));
if(timgs[0]) timgs[0].classList.add('active');

// Menu & coupon lists
function renderList(elId, items, type){
  const el=document.getElementById(elId);
  if(!items || !items.length){ el.innerHTML=`<div class="meta">${t('not_available')}</div>`; return; }
  el.innerHTML = items.map(it=>{
    const name = (LANG==='en'? enMenuName(it.name) : it.name);
    const dur  = it.minutes ? (LANG==='en'? `${it.minutes} min` : `${it.minutes}分`) : '';
    const price= fmtCurrencyFromJPY(it.price, getCurrency());
    return `<div class="menu" data-item="${it.id}">
      <div><div class="name">${name}</div><div class="meta">${dur}</div></div>
      <div class="actions"><span class="price" data-jpy="${it.price}">${price}</span>
        <button class="btn primary reserve-btn" data-go data-type="${type}" data-id="${it.id}">${t('book')}</button></div>
    </div>`;
  }).join('');
  el.querySelectorAll('[data-go]').forEach(b=>b.onclick=()=>{
    const q=new URLSearchParams({salonId:shop.id, salonName:shop.name, type:b.dataset.type, itemId:b.dataset.id});
    if(LANG==='en') q.set('lang','en');
    location.href='reservation.html?'+q.toString();
  });
}
renderList('menuList', MENUS[shop.id], 'menu');
renderList('couponList', COUPONS[shop.id], 'coupon');

// Currency update across page
function updateCurrencies(){
  // Top "From" price
  const priceEl = document.getElementById('price');
  const jpy = Number(priceEl.dataset.jpy||shop.price||0);
  priceEl.textContent = (LANG==='en' ? (t('price_from') + fmtCurrencyFromJPY(jpy, getCurrency()))
                                     : (t('price_from') + fmtCurrencyFromJPY(jpy, getCurrency()) + (getCurrency()==='JPY'?'〜':'')));
  // Items
  document.querySelectorAll('.price[data-jpy]').forEach(span=>{
    const base = Number(span.dataset.jpy||'0');
    span.textContent = fmtCurrencyFromJPY(base, getCurrency());
  });
}
updateCurrencies();

/* -----------------------
   Reviews: gate + local post
----------------------- */
function booked(id){ try{return (JSON.parse(localStorage.getItem('bl_completed_bookings')||'[]')).includes(id)}catch(e){return false} }
const form=document.getElementById('revform'); const gate=document.getElementById('gateMsg');
if(!booked(shop.id)){ form.style.opacity=".6"; form.style.pointerEvents="none"; gate.style.color="#a06"; }

document.getElementById('revSubmit').onclick=()=>{
  if(!booked(shop.id)) return alert(getLangPref()==='en'?'Only completed bookings can post a review.':'予約済みの方のみ投稿可です。');
  const name=document.getElementById('revName').value|| (LANG==='en'?'Guest':'ゲスト');
  const nat =document.getElementById('revCountry').value||'-';
  const text=document.getElementById('revText').value.trim();
  if(!text) return alert(LANG==='en'?'Please enter your review.':'口コミを入力してください');
  const div=document.createElement('div'); div.className='review';
  const meta = `${name} ${nat!=='-'? '（'+nat+'）':''}`;
  div.innerHTML=`<div class="meta">${meta}</div><div>${text}</div>`;
  document.getElementById('revlist').prepend(div);
  document.getElementById('revText').value='';
};

// Placeholders i18n
if(LANG==='en'){
  document.getElementById('revName').placeholder = t('your_name');
  document.getElementById('revText').placeholder = t('your_experience');
  const selNat = document.querySelector('#revCountry option[value=""]');
  if(selNat) selNat.textContent = t('select_country');
}

/* -----------------------
   External reviews via window.BL_API
----------------------- */
(async function externalReviews(){
  const listEl = document.getElementById('reviewList');
  const btn = document.getElementById('viewAllReviews');
  if(!listEl) return;

  let items = [];
  try{
    if(window.BL_API && typeof window.BL_API.listReviews === 'function'){
      const res = await window.BL_API.listReviews({ salonId: shop.id });
      items = Array.isArray(res) ? res : [];
    }
  }catch(e){ /* ignore */ }

  if(items.length===0){ btn.style.display='none'; return; }

  function card(r){
    const user = r.user || (LANG==='en'?'Guest':'ゲスト');
    const rating = (r.rating!=null ? `・ ★${Number(r.rating).toFixed(1)}` : '');
    const text = (r.text || '').toString();
    const nat  = r.country ? `（${r.country}）` : '';
    return `<div class="review"><div class="meta">${user}${nat} ${rating}</div><div>${text}</div></div>`;
  }
  function render(n){
    const slice = items.slice(0, n);
    listEl.innerHTML = slice.map(card).join('');
    btn.style.display = (n < items.length) ? 'inline-flex' : 'none';
  }

  render(3);
  btn.addEventListener('click', ()=> render(items.length));
})();

/* -----------------------
   Policies modal (same as index)
----------------------- */
(function policiesModal(){
  function bind(){
    const modal = document.getElementById('policyModal');
    if(!modal) return;
    const body  = document.getElementById('policyBody');
    const title = document.getElementById('policyTitle');
    const close = document.getElementById('policyClose');

    function show(){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
    function hide(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); if(body) body.innerHTML=''; if(title) title.textContent=''; }

    if(close){ close.onclick = (ev)=>{ ev.preventDefault(); hide(); }; }
    modal.addEventListener('click', (e)=>{ if(e.target===modal) hide(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hide(); });

    function openSheet(t, href){
      const abs = new URL(href, location.href).href;
      if(title) title.textContent = t||'Info';
      const iframe = document.createElement('iframe');
      iframe.src = abs;
      iframe.style.width='100%'; iframe.style.height='70vh'; iframe.style.border='0';
      iframe.setAttribute('sandbox','allow-same-origin allow-scripts allow-forms');
      if(body){ body.innerHTML=''; body.appendChild(iframe); }
      show();
    }
    document.querySelectorAll('section.policies a').forEach(a=>{
      a.addEventListener('click', (ev)=>{
        ev.preventDefault(); ev.stopImmediatePropagation();
        openSheet((a.textContent||'').trim(), a.getAttribute('href'));
      }, true);
    });
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', bind); } else { bind(); }
})();
</script>
</body>
</html>
