<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BeautyLanka – サロン詳細</title>
<style>
  :root{ --bg:#f5efe6; --card:#fff; --bd:#e9e1d7; --ink:#2b2b2b; --muted:#6b5e55; --brand:#2f776c; --gap:16px; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .layout{display:grid;grid-template-columns:2fr 1fr;gap:var(--gap)}
  @media (max-width:900px){ .layout{grid-template-columns:1fr} }
  .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:14px}
  .section-title{font-size:18px;font-weight:800;margin:0 0 8px}
  .muted{color:var(--muted)}
  .btn{display:inline-block;background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 14px;
       text-decoration:none;font-weight:700;cursor:pointer}
  /* 予約ボタンだけ少し大きく */
#btnBook{
  height:48px;
  padding:0 18px;
  font-size:16px;
  font-weight:800;
}
  .btn.secondary{background:#ddd;color:#333}
  .space{height:12px}

  /* ギャラリー */
  .gallery{display:flex;flex-direction:column;gap:10px}
  .gallery-main{width:100%;aspect-ratio:16/9;background:#f1f1f1;border-radius:12px;overflow:hidden;border:1px solid #eee}
  .gallery-main img{width:100%;height:100%;object-fit:cover;display:block}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px}
  .thumbs img{width:100%;height:70px;object-fit:cover;border-radius:8px;border:1px solid #eee;cursor:pointer}

  /* 情報 */
  .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kv{background:#faf7f2;border:1px solid #eee;border-radius:10px;padding:10px}
  .kv .k{font-size:12px;color:var(--muted)}
  .kv .v{font-weight:700;margin-top:3px}

  /* リスト（メニュー/クーポン） */
  .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
  .chip{display:inline-block;background:#efe5d9;color:#6b5e55;border-radius:999px;padding:4px 10px;margin-right:6px;font-size:12px}
/* 価格チップを強調 */
.chip-price{
  font-size:14px;
  font-weight:900;
}

  iframe.map{width:100%;height:220px;border:0;border-radius:12px}
  .notice{padding:.75em 1em;margin:.5em 0;background:#fff7e6;border:1px solid #ffd18a;border-radius:8px;color:#6b5e55}

  /* レビュー表示 */
  .stars { position:relative; display:inline-block; font-size:16px; line-height:1; }
  .stars .bg{ color:#ddd; }
  .stars .fg{ position:absolute; top:0; left:0; white-space:nowrap; overflow:hidden; color:#f2b01e; }
  .rv-item{border-top:1px dashed #e1d7cb; padding:10px 0}
  .rv-head{display:flex;gap:8px;align-items:center}
  .rv-name{font-weight:700}
  .rv-ts{color:#8a7f75; font-size:12px}

  /* Verified 投稿フォーム */
  .rv-form .row{margin:8px 0}
  .rv-form input[type="text"], .rv-form textarea {width:100%; padding:10px; border:1px solid #ddd; border-radius:8px}
  .rv-form .stars-input {display:flex; gap:8px; align-items:center}
  .rv-form .stars-input input {accent-color:#f2b01e}
</style>
<script src="lang.js" defer></script>
<script>document.addEventListener('DOMContentLoaded',()=>BL_I18N.i18nApply());</script>
  <style>
/* --- BeautyLanka UI Booster (non-breaking) --- */
:root{
  --base:#F7F1E1; --ink:#2E1A16; --stroke:#eadfca; --teal:#246A73; --muted:#6f5a54; --blue:#0A66FF;
  --accent-1:#8AD5CD; --accent-2:#F9C6B8; --accent-3:#E9D7A5; --accent-4:#B6E3FF;
  --glass-bg:rgba(255,255,255,.72); --glass-brd:rgba(0,0,0,.06);
}
body{background:var(--base);color:var(--ink)}
/* 背景の装飾（描画のみ。レイアウトに影響なし） */
.bg-radials:before,.bg-radials:after{content:"";position:fixed;inset:auto;z-index:-2;pointer-events:none;filter:blur(40px);opacity:.38}
.bg-radials:before{left:-120px;top:-120px;width:420px;height:420px;background:
  radial-gradient(120px 120px at 40% 40%, var(--accent-1), transparent 70%),
  radial-gradient(160px 160px at 70% 60%, var(--accent-2), transparent 72%)}
.bg-radials:after{right:-120px;bottom:-120px;width:460px;height:460px;background:
  radial-gradient(140px 140px at 30% 40%, var(--accent-4), transparent 70%),
  radial-gradient(180px 180px at 70% 60%, var(--accent-3), transparent 72%)}
.grain{position:fixed;inset:0;z-index:-1;pointer-events:none;opacity:.07;mix-blend-mode:multiply;
  background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140" viewBox="0 0 140 140"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/><feColorMatrix type="saturate" values="0"/><feComponentTransfer><feFuncA type="table" tableValues="0 0 0 .55 .15 0"/></feComponentTransfer></filter><rect width="100%" height="100%" filter="url(%23n)"/></svg>');
  background-size:160px 160px}

/* ボタン/入力：既存 .btn や button に上書き“しすぎない”控えめ装飾 */
.btn, button, a.btn, input[type="button"].btn, input[type="submit"].btn{
  display:inline-flex;align-items:center;justify-content:center;gap:.4em;
  height:40px;border-radius:12px;border:1px solid var(--stroke);
  background:#fff;padding:0 12px;font-weight:800;cursor:pointer;
  box-shadow:0 6px 14px rgba(0,0,0,.06); transition:.15s ease-in-out;
}
.btn.primary{background:var(--teal);border-color:var(--teal);color:#fff;box-shadow:0 10px 24px rgba(36,106,115,.18)}
.btn:hover{transform:translateY(-1px)}
/* カード風の箱（既存の .card があるページはそちら優先。無いページ用の汎用クラス） */
.bl-card{background:#fff;border:1px solid var(--stroke);border-radius:16px;box-shadow:0 12px 28px rgba(0,0,0,.08);padding:16px}

/* 入力類の小綺麗化（既存の幅やIDは触らない） */
input[type="text"],input[type="email"],input[type="tel"],input[type="password"],select,textarea{
  border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;background:#fff;font:inherit
}
input:focus,select:focus,textarea:focus{outline:none;border-color:color-mix(in oklab,var(--teal) 55%,white);
  box-shadow:0 0 0 3px color-mix(in oklab,var(--teal) 20%, transparent)}

/* テーブルの視認性（ゼブラは .zebra を付けた時だけ有効） */
table.zebra tbody tr:nth-child(even){background:#faf6ef}
table.zebra th, table.zebra td{border-bottom:1px solid var(--stroke)}

/* 小さめのタグチップ（表示用。機能なし） */
.tag{padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);font-size:12px;background:#fff}

/* 文化タグの見た目（既存 .tag を流用して軽くアクセント） */
.tag.culture { font-weight: 800; border-color: #d2c3a4; }
.tag.suggested { outline: 2px dashed rgba(36,106,115,.35); }
.rv-tags { margin-top:6px; display:flex; flex-wrap:wrap; gap:6px; }
.rv-tags .tag { user-select:none; cursor:pointer; }</style>

<style>
/* ステップ風パンくず（必要なページだけHTMLを足せば見栄えUP） */
.bl-steps{display:flex;gap:8px;align-items:center;color:var(--muted);font-weight:700}
.bl-steps .dot{width:8px;height:8px;border-radius:50%;background:var(--teal);opacity:.35}
.bl-steps .on{opacity:1}
</style>
<style>
.gallery-main img{transition:transform 1.2s ease}
.gallery-main:hover img{transform:scale(1.03)}
.thumbs img{transition:transform .12s ease, box-shadow .2s}
.thumbs img:hover{transform:translateY(-2px); box-shadow:0 8px 18px rgba(0,0,0,.12)}
</style>
<style>
/* ensure button label visible */
.btn{ color: var(--ink); }
.btn.primary{ color:#fff; }
</style>
<script>
// details.html 用の簡易言語ヘルパー（index と同じ挙動）
function getLang(){
  const pref = localStorage.getItem('bl_lang') || 'auto';
  if(pref === 'auto'){
    const ja = (navigator.language||'en').toLowerCase().startsWith('ja');
    return ja ? 'ja' : 'en';
  }
  return pref;
}
  const CULTURE_TAGS = [
  { id:'#localfamily', ja:'ローカル家庭', en:'Local family', kw:['home','family','local family','母','家庭','家族','homestay','home-cooked','kitchen'] },
  { id:'#traditional', ja:'伝統', en:'Traditional', kw:['traditional','伝統','ritual','古典','heritage','本場','authentic'] },
  { id:'#ayurveda', ja:'アーユルヴェーダ', en:'Ayurveda', kw:['ayurveda','アーユル','shirodhara','シロダーラ','herbal','薬草','steam','発汗'] },
  { id:'#threading', ja:'スレッディング', en:'Threading', kw:['threading','スレッディング','糸','眉','eyebrow'] },
  { id:'#henna', ja:'ヘナ', en:'Henna', kw:['henna','メヘンディ','mehndi','ヘナ'] },
  { id:'#templearea', ja:'寺院エリア', en:'Temple area', kw:['temple','寺','仏','stupa','bo tree','kandy'] },
  { id:'#marketside', ja:'マーケット横', en:'Market side', kw:['market','バザール','ペター','pettah','bazaar'] },
  { id:'#beachside', ja:'ビーチサイド', en:'Beachside', kw:['beach','海','shore','mirissa','unawatuna','trincomalee'] },
  { id:'#villagesalon', ja:'村サロン', en:'Village salon', kw:['village','田舎','rural','村'] },
  { id:'#colombomodern', ja:'コロンボ・モダン', en:'Colombo modern', kw:['colombo','モダン','modern','city','capital'] },
];

function pickLangStr(obj){
  const L = getLang();
  return L==='en' ? (obj.en || obj.ja) : (obj.ja || obj.en);
}

function buildTagChip(tagId, suggested=false){
  const el = document.createElement('span');
  el.className = 'tag culture' + (suggested?' suggested':'');
  el.textContent = tagId;
  el.dataset.value = tagId;
  el.onclick = ()=> el.classList.toggle('on');
  return el;
}

function initCultureTagUI(context){
  const box = document.getElementById('rvTagBox');
  if (!box) return;
  box.innerHTML = '';
  // 基本タグを並べる
  CULTURE_TAGS.forEach(t=>{
    box.appendChild(buildTagChip(t.id, false));
  });
  // サジェスト
  if (document.getElementById('rvTagAuto')?.checked){
    const guesses = suggestCultureTags(context);
    [...box.children].forEach(chip=>{
      if (guesses.has(chip.dataset.value)) chip.classList.add('suggested','on');
    });
  }
}

function collectSelectedTags(){
  const box = document.getElementById('rvTagBox');
  if (!box) return [];
  const arr = [...box.querySelectorAll('.tag.on')].map(x=>x.dataset.value);
  const custom = (document.getElementById('rvTagCustom')?.value || '').trim();
  if (custom){
    // ensure starts with '#'
    const tag = custom.startsWith('#') ? custom : ('#'+custom.replace(/\s+/g,''));
    arr.push(tag);
  }
  // 重複除去
  return [...new Set(arr)];
}

// かなり単純な「含まれてたら提案」ルール。
// テキスト/メニュー名/ジャンル/エリア/国籍などを小文字化して keyword に当てる。
function suggestCultureTags(ctx){
  const hay = [
    ctx.text||'',
    ctx.menu||'',
    ctx.type||'',
    ctx.place||'',
    ctx.nation||'',
  ].join(' ').toLowerCase();
  const out = new Set();
  CULTURE_TAGS.forEach(t=>{
    if ((t.kw||[]).some(k=>hay.includes(k.toLowerCase()))) out.add(t.id);
  });
  // 補助ルール：placeに海っぽい地名が出たら#beachside、Kandy系は#templearea
  if (/(mirissa|unawatuna|trincomalee|arugam|hikkaduwa|galle)/i.test(hay)) out.add('#beachside');
  if (/(kandy|temple|stupa|bo tree)/i.test(hay)) out.add('#templearea');
  if (/(colombo)/i.test(hay)) out.add('#colombomodern');
  return out;
}
</script>

</head>
<body>
<div class="wrap">
  <div class="layout">
    <!-- 左カラム：写真 / メニュー / クーポン -->
    <div class="stackL">
      <!-- 写真 -->
      <section class="card">
        <div class="section-title" data-i18n="details.photos">写真</div>
        <div class="gallery">
          <div class="gallery-main" id="gMain"></div>
          <div class="thumbs" id="gThumbs"></div>
        </div>
      </section>

      <div class="space"></div>

      <!-- メニュー -->
      <section class="card">
        <div class="section-title" data-i18n="details.menu">メニュー</div>
        <div id="menuList" class="list"></div>
        <div id="menuEmpty" class="muted" data-i18n="details.menu_empty">（準備中です。スプレッドシートにメニューを追加したら自動表示されます）</div>
      </section>

      <div class="space"></div>

      <!-- クーポン -->
      <section class="card">
        <div class="section-title" data-i18n="details.coupons">クーポン</div>
        <div id="couponList" class="list"></div>
        <div id="couponEmpty" class="muted" data-i18n="details.coupon_empty">（準備中です）</div>
      </section>
    </div>

    <!-- 右カラム：店舗情報 / 地図 / レビュー -->
    <div class="stackR">
      <!-- 店舗情報 -->
      <section class="card" id="infoCard">
        <div class="section-title" data-i18n="details.info">店舗情報</div>
        <div class="notice" id="pickNote" style="display:none" data-i18n="details.fallback">対象が見つからなかったので先頭のサロンを表示しています</div>

        <h2 id="salonTitle" style="margin:6px 0 10px"></h2>
        <div class="info-grid">
          <div class="kv"><div class="k" data-i18n="details.genre">ジャンル</div><div class="v" id="vType"></div></div>
          <div class="kv"><div class="k" data-i18n="details.area">エリア</div><div class="v" id="vPlace"></div></div>
          <div class="kv"><div class="k" data-i18n="details.price">目安価格</div><div class="v" id="vPrice"></div></div>
          <div class="kv"><div class="k" data-i18n="details.rating">★評価</div><div class="v" id="vRating"></div></div>
        </div>

        <div class="space"></div>
        <div>
          <a href="#" class="btn secondary" id="btnBack"
   data-i18n="details.back_to_list" data-i18n-fallback="一覧に戻る">一覧に戻る</a>
<a href="#" class="btn" id="btnBook"
   data-i18n="details.go_reserve" data-i18n-fallback="予約へ進む">予約へ進む</a>
 </div>

        <div class="space"></div>
        <div id="points" class="muted"></div>
      </section>

      <div class="space"></div>

      <!-- 地図 -->
      <section class="card" id="mapSection">
        <div class="section-title" data-i18n="details.map">地図・道順</div>
        <button class="btn secondary" id="route" disabled data-i18n="details.route_google">Googleで道順</button>
        <div class="space"></div>
        <iframe id="map" class="map" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </section>

      <div class="space"></div>

      <!-- レビュー -->
      <section class="card" id="reviewsSection">
        <div class="section-title" data-i18n="details.reviews">レビュー</div>
        <div id="reviewsSummary" class="muted" data-i18n="details.loading">（読み込み中…）</div>
        <div id="reviewsList"></div>
        <div id="tag-filters">
  <button class="chip chip-filter" data-tag="">All</button>
  <button class="chip chip-filter" data-tag="#traditional">#traditional</button>
  <button class="chip chip-filter" data-tag="#localfamily">#localfamily</button>
  <button class="chip chip-filter" data-tag="#ayurveda">#ayurveda</button>
  <button class="chip chip-filter" data-tag="#localmarket">#localmarket</button>
</div>

        <!-- Verifiedレビュー投稿：rid/token/exp がURLにある時だけ表示 -->
        <div id="verifiedBox" style="display:none;margin-top:12px">
          <div class="notice" data-i18n="details.verified_note">施術後に配布される専用リンクからの投稿フォームです。</div>
          <form class="rv-form" id="verifiedForm">
            <!-- ▼ 文化タグ（自動サジェスト＋手動選択＋自由入力） -->
<div class="row" id="rvCultureRow">
  <label class="muted">文化タグ / Culture tags</label>
  <div class="rv-tags" id="rvTagBox"></div>
  <div style="display:flex; gap:8px; margin-top:6px; align-items:center">
    <input type="text" id="rvTagCustom" placeholder="#custom (任意)" style="flex:1 1 auto">
    <label style="display:flex; gap:4px; align-items:center; white-space:nowrap;">
      <input type="checkbox" id="rvTagAuto" checked>
      自動提案を使う / Auto-suggest
    </label>
  </div>
  <div class="muted" style="font-size:12px; margin-top:4px">
    例: #localfamily #traditional #ayurveda #herbal #beachside #templearea #marketside #homestyle
  </div>
</div>
<!-- ▲ 文化タグ -->

                        <!-- ▼ ここから追加：国籍 / 年代 / 来店時期 / （隠し）メニュー名 -->
            <div class="row">
              <label class="muted">国籍（任意） / Nationality (optional)</label>
              <select id="rvNation">
                <option value="">選択しない / Prefer not to say</option>
                <option>Japan</option>
                <option>Sri Lanka</option>
                <option>United States</option>
                <option>United Kingdom</option>
                <option>Australia</option>
                <option>Germany</option>
                <option>France</option>
                <option>China</option>
                <option>Korea</option>
                <option>India</option>
                <option>Other</option>
              </select>
            </div>

            <div class="row">
              <label class="muted">年代（任意） / Age group (optional)</label>
              <select id="rvAge">
                <option value="">選択しない / Prefer not to say</option>
                <option>10s</option>
                <option>20s</option>
                <option>30s</option>
                <option>40s</option>
                <option>50s</option>
                <option>60+</option>
              </select>
            </div>

            <div class="row">
              <label class="muted">来店時期（任意） / Visited (optional)</label>
              <input type="month" id="rvVisit" />
            </div>

            <!-- hidden: メニュー名（URLや予約情報から拾えた場合だけ） -->
            <input type="hidden" id="rvMenu" />
            <!-- ▲ 追加ここまで -->

            <div class="row">
              <label class="muted" data-i18n="details.name_opt">お名前（任意）</label>
              <input type="text" id="rvName" data-i18n-ph="details.rv_name_ph" placeholder="例：M*** さん">
            </div>
            <div class="row">
              <label class="muted" data-i18n="details.rating_lbl">評価</label>
              <div class="stars-input">
                <label><input type="radio" name="rvStar" value="5" checked> 5</label>
                <label><input type="radio" name="rvStar" value="4"> 4</label>
                <label><input type="radio" name="rvStar" value="3"> 3</label>
                <label><input type="radio" name="rvStar" value="2"> 2</label>
                <label><input type="radio" name="rvStar" value="1"> 1</label>
              </div>
            </div>
            <div class="row">
              <label class="muted" data-i18n="details.comment_lbl">コメント</label>
              <textarea id="rvText" rows="4" data-i18n-ph="details.rv_text_ph" placeholder="施術の感想を書いてください"></textarea>
            </div>
            <div class="row">
              <button class="btn" id="rvSubmit" data-i18n="details.submit_review">この内容で投稿</button>
            </div>
            <div class="row muted" id="rvMsg"></div>
          </form>
        </div>
      </section>
    </div>
  </div>
</div>

<!-- ▼▼ 必ずあなたの /exec とキーに置換してください ▼▼ -->
<script>
  window.__GAS_URL = 'https://script.google.com/macros/s/AKfycbwWRpfcZMsGxNqGJ5aNjRT1Y1PChDTqtQE3e0S7sUDAMei8s1wOr6lpKMnOaI1Z-6o/exec';
  window.__GAS_KEY = 'bl_gas_key_bR6ZXWwu6kM_nrK25geP97Cs5qCX3auxugX_IUGlg90';
</script>
<!-- ▲▲ ここまで ▲▲ -->

<script>
(function(){
  const GAS = { url: window.__GAS_URL, key: window.__GAS_KEY };
  const $  = s => document.querySelector(s);

  const fmtJPY = v => v ? '¥'+Number(v).toLocaleString('ja-JP') : '-';
  const setText = (sel, v) => { const el=$(sel); if(el) el.textContent = v||''; };

  function parsePhotos(v){
  const IS_FILE = location.protocol === 'file:';
  const IMG_BASE     = IS_FILE ? './assets/img/'     : '/assets/img/';
  const IMAGES_BASE  = IS_FILE ? './assets/images/'  : '/assets/images/';

  // 1) 文字列→配列、改行/全角カンマにも対応
  let arr = Array.isArray(v) ? v : String(v||'')
    .replace(/[\r\n]+/g, ',').replace(/，/g, ',').split(',');
  arr = arr.map(s => String(s||'').trim()).filter(Boolean);

  // 2) 裸ファイル名 → images を優先で補完
  arr = arr.map(p => {
    // 先頭にスラッシュが付いてたら、file:// の場合は './' に変換
    if (IS_FILE && p.startsWith('/')) p = '.' + p;
    // パス区切りが無い＝ファイル名だけ → images で補完
    if (!p.includes('/')) p = IMAGES_BASE + p;
    return p;
  });

  // 3) img / images の両候補を用意（images優先）
  const out = [];
  arr.forEach(p => {
    const pImg    = p.replace(/\/assets\/images\//, IMG_BASE).replace(/(^|[^.])\.\//, './');      // images → img
    const pImages = p.replace(/\/assets\/img\//,    IMAGES_BASE).replace(/(^|[^.])\.\//, './');    // img → images
    // 既に相対ならそのまま、絶対なら file:// では './' に
    const a = IS_FILE && pImages.startsWith('/assets/') ? '.'+pImages : pImages;
    const b = IS_FILE && pImg.startsWith('/assets/')    ? '.'+pImg    : pImg;
    out.push(a, b);
  });

  // 重複除去
  return [...new Set(out)];
}

  async function fetchJSON(u){
    const r = await fetch(u,{cache:'no-store'});
    return r.json();
  }

  // ---- Data fetchers ----
  async function getCatalog(){
    const u = `${GAS.url}?kind=catalog&key=${encodeURIComponent(GAS.key)}&t=${Date.now()}`;
    const j = await fetchJSON(u);
    if (!j.ok) throw new Error(j.error||'catalog not ok');
    return j.items||[];
  }
  async function getMenus(salonId){
    const u = `${GAS.url}?kind=menus.list&salonId=${encodeURIComponent(salonId)}&key=${encodeURIComponent(GAS.key)}&t=${Date.now()}`;
    const j = await fetchJSON(u);
    return (j.ok && j.items)||[];
  }
  async function getCoupons(salonId){
    const u = `${GAS.url}?kind=coupons.list&salonId=${encodeURIComponent(salonId)}&key=${encodeURIComponent(GAS.key)}&t=${Date.now()}`;
    const j = await fetchJSON(u);
    return (j.ok && j.items)||[];
  }
  async function getReviews(salonId){
    const u = `${GAS.url}?kind=reviews&salonId=${encodeURIComponent(salonId)}&key=${encodeURIComponent(GAS.key)}&t=${Date.now()}`;
    const j = await fetchJSON(u);
    return (j.ok && j.items) ? j : {ok:false, items:[], summary:{}};
  }

  // ---- helpers ----
  function pickItem(items){
    const q = new URLSearchParams(location.search);
    const target = q.get('salonId') || q.get('id') || (location.hash||'').replace(/^#/, '');
    let it = items.find(x=>String(x.id)===String(target));
    if (!it){
      $('#pickNote').style.display = '';
      it = items.find(x => (x.name_ja || x.name_en || String(x.photos||'').trim())) || items[0];
    }
    return it;
  }
  function starsEl(score){
    const pct = Math.max(0, Math.min(5, Number(score||0))) / 5 * 100;
    const root = document.createElement('span');
    root.className = 'stars';
    root.innerHTML = `<span class="bg">★★★★★</span><span class="fg" style="width:${pct}%">★★★★★</span>`;
    return root;
  }
  //フィルタ用スクリプトからも使えるように公開
  window.starsEl = starsEl;

  function renderInfo(it){
  const L = getLang();
  const pick = (ja, en) => (L === 'en' ? (en || ja) : (ja || en));

  // タイトル
  setText('#salonTitle', pick(it.name_ja, it.name_en) || it.id);

  // 基本KV
  setText('#vType',  pick(it.type_ja,  it.type_en)  || '-');
  setText('#vPlace', pick(it.place_ja, it.place_en) || '-');
  setText('#vPrice', it.price_jpy ? fmtJPY(it.price_jpy) : '-');

  // レーティング：数値ではなく星＋数値に
  const v = $('#vRating');
  v.innerHTML = '';
  const score = Number(it.rating || 0);
  v.appendChild(starsEl(score));
  const n = document.createElement('span');
  n.className = 'muted';
  n.style.marginLeft = '6px';
  n.textContent = score ? score.toFixed(1) : '-';
  v.appendChild(n);

  // ハイライト文：言語別
  setText('#points', pick(it.points_ja, it.points_en) || '');

  // 予約ボタン（既存導線は残す）
  $('#btnBook').onclick = (e)=>{
    e.preventDefault();
    alert('予約導線は後で差し替え');
  };
}


  function renderGallery(it){
  const main = document.querySelector('#gMain');
  const thumbs = document.querySelector('#gThumbs');
  main.innerHTML = ''; thumbs.innerHTML = '';

  // 1) 値のゆらぎ吸収 + 代替候補を作る
  let raw = Array.isArray(it.photos) ? it.photos : String(it.photos||'')
    .replace(/[\r\n]+/g, ',').replace(/，/g, ',').split(',');
  raw = raw.map(s => String(s||'').trim()).filter(Boolean);

  // 裸ファイル名は /assets/images/ を補完（実ファイルが images にある前提）
  raw = raw.map(p => {
    if (!p.includes('/')) p = '/assets/images/' + p;
    if (!p.startsWith('/')) p = '/' + p;
    return p;
  });

  // 各エントリに img / images の両方の候補を用意
  const pairs = raw.map(p => {
    const a = p.replace('/assets/images/','/assets/img/');
    const b = p.replace('/assets/img/','/assets/images/');
    // どちらが元でも [images版, img版] の順にしておく（images優先）
    return p.includes('/assets/images/') ? [p, a] : [b, p];
  });

  if (!pairs.length){
    main.innerHTML = '<div class="notice">写真が未登録です（catalog の photos 列）</div>';
    return;
  }

  // 2) 最初の1枚は“ロード成功するまで”順番に試す
  (function showFirstAvailable(list){
    const img = new Image();
    let i = 0;
    img.onload = () => { main.innerHTML = ''; main.appendChild(img); };
    img.onerror = () => { if (++i < list.length) img.src = list[i]; else main.innerHTML = '<div class="notice">画像が見つかりません</div>'; };
    img.src = list[i];
  })(pairs[0]);

  // 3) サムネは“成功したものだけ”並べる
  pairs.forEach(alts => {
    const t = new Image();
    t.loading = 'lazy';
    let i = 0;
    t.onerror = () => { if (++i < alts.length) t.src = alts[i]; else t.remove(); };
    t.onload  = () => { t.onclick = () => {
      // クリックでメインも同じ候補順で再試行
      (function show(list){
        const big = new Image();
        let j = 0;
        big.onload = () => { main.innerHTML=''; main.appendChild(big); };
        big.onerror= () => { if (++j < list.length) big.src = list[j]; else main.innerHTML='<div class="notice">画像が見つかりません</div>'; };
        big.src = list[j];
      })(alts);
    }; };
    t.src = alts[i];
    thumbs.appendChild(t);
  });
}


  function renderMap(it){
    const lat = Number(it.lat), lng = Number(it.lng);
    const map = $('#map'), route = $('#route');
    if (Number.isFinite(lat)&&Number.isFinite(lng)&&!(lat===0&&lng===0)){
      map.src = `https://www.google.com/maps?q=${lat},${lng}&z=15&hl=ja&output=embed`;
      route.disabled = false;
      route.onclick = ()=> window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving&hl=ja`,'_blank');
    }else{
      map.remove(); route.disabled = true;
      $('#mapSection').insertAdjacentHTML('beforeend','<div class="notice">地図は未設定です。catalog の lat / lng を入れてね。</div>');
    }
  }

  function renderMenus(items){
  const box = document.querySelector('#menuList');
  const empty = document.querySelector('#menuEmpty');
  box.innerHTML = '';

  if (!items.length){ empty.style.display=''; return; }
  empty.style.display='none';

  // サロン情報（予約に渡す）
  const salonId   = (window.__currentSalon && window.__currentSalon.id) || '';
  const salonName = (window.__currentSalon && (window.__currentSalon.name_ja || window.__currentSalon.name_en)) || salonId;

  items.forEach(m=>{
    const name = m.name_ja || m.name_en || '-';
    const desc = m.desc_ja || m.desc_en || '';
    const dur  = m.duration_min || '';
    const price= m.price_jpy ? '¥' + Number(m.price_jpy).toLocaleString('ja-JP') : '';

    const el = document.createElement('div');
    el.className='card';
    el.innerHTML = `
      <div style="display:flex;gap:12px;align-items:flex-start;justify-content:space-between">
        <div style="flex:1 1 auto;min-width:0">
          <div class="section-title" style="font-size:16px;margin:0 0 6px">${name}</div>
          <div class="muted" style="white-space:pre-wrap">${desc||''}</div>
          <div class="space"></div>
          <div>
            ${dur?`<span class="chip">${dur}分</span>`:''}
           ${price?`<span class="chip chip-price">${price}</span>`:''}
          </div>
        </div>
        <div style="flex:0 0 auto;display:flex;align-items:center">
          <a class="btn" style="white-space:nowrap"
             href="reservation.html?${new URLSearchParams({
               salonId,
               salonName,
               item: name,
               price: String(m.price_jpy||0)
             }).toString()}">
             予約へ
          </a>
        </div>
      </div>`;
    box.appendChild(el);
  });

  // 予約導線でも使えるように現在のサロンを覚えておく（上で利用）
}


  function renderCoupons(items){
    const box = $('#couponList'); const empty = $('#couponEmpty');
    box.innerHTML = '';
    if (!items.length){ empty.style.display=''; return; }
    empty.style.display='none';
    items.forEach(c=>{
      const el = document.createElement('div'); el.className='card';
      el.innerHTML = `<div class="section-title" style="font-size:16px">${c.name_ja||c.name_en||'-'}</div>
        <div class="muted">${c.desc_ja||c.desc_en||''}</div>`;
      box.appendChild(el);
    });
  }

/* これ、IIFEの中（GAS と starsEl が見えるスコープ）に置いてOK */
function renderReviews(it, res){
  const box = document.querySelector('#reviewsList');
  const sum = (res.summary && res.summary[it.id]) || { avg:0, count:0 };

  // サマリ行（平均★ / 件数）
  const sumLine = document.createElement('div');
  sumLine.innerHTML = '';
  const s = starsEl(sum.avg);
  const meta = document.createElement('span');
  meta.className = 'muted';
  meta.style.marginLeft = '8px';
  meta.textContent = `平均 ${sum.avg || 0} / 5（${sum.count || 0}件）`;
  sumLine.appendChild(s);
  sumLine.appendChild(meta);
  document.querySelector('#reviewsSummary').innerHTML = '';
  document.querySelector('#reviewsSummary').appendChild(sumLine);

  // 最新5件
  box.innerHTML = '';
  const items = (res.items || [])
    .filter(x => String(x.salonId) === String(it.id))
    .sort((a,b) => String(b.ts).localeCompare(String(a.ts)))
    .slice(0,5);

  if (!items.length){
    box.innerHTML = '<div class="muted">まだレビューはありません。施術完了後に届く専用リンクから投稿できます。</div>';
    return;
  }

  // フィルタ用に保持
  window.__allReviews = items;

  items.forEach(r => {
    const el = document.createElement('div');
    el.className = 'rv-item';

    // ヘッダ：星・名前・日付
    const head = document.createElement('div');
    head.className = 'rv-head';
    head.appendChild(starsEl(r.rating));
    const nm = document.createElement('div');
    nm.className = 'rv-name';
    nm.textContent = r.name || '匿名';
    const ts = document.createElement('div');
    ts.className = 'rv-ts';
    ts.textContent = (r.ts || '').slice(0,10);
    head.appendChild(nm);
    head.appendChild(ts);

    // 本文
    const body = document.createElement('div');
    const original = String(r.text || '');
    body.textContent = original;

    // 翻訳トグルボタン
    const btn = document.createElement('button');
    btn.className = 'btn secondary';
    btn.style.margin = '6px 0';
    const L = (localStorage.getItem('bl_lang') || 'auto');
    const isJa = (L === 'ja') || (L === 'auto' && (navigator.language||'').toLowerCase().startsWith('ja'));
    const target = isJa ? 'en' : 'ja';
    const TXT_TO = isJa ? '英語に自動翻訳' : 'Translate to Japanese';
    const TXT_BACK = isJa ? '原文に戻す' : 'Show original';
    btn.textContent = TXT_TO;

    let showingTranslated = false;
    const cacheKey = `${target}:${original.slice(0,200)}`;
    window.__bl_tr_cache = window.__bl_tr_cache || {};

    btn.onclick = async () => {
      if (!showingTranslated) {
        try {
          if (!window.__bl_tr_cache[cacheKey]) {
            const u = `${GAS.url}?kind=translate&key=${encodeURIComponent(GAS.key)}&target=${encodeURIComponent(target)}&text=${encodeURIComponent(original)}`;
            const j = await fetch(u, {cache:'no-store'}).then(r => r.json());
            if (!j || !j.ok) throw new Error('translate failed');
            window.__bl_tr_cache[cacheKey] = j.text || original;
          }
          body.textContent = window.__bl_tr_cache[cacheKey];
          btn.textContent = TXT_BACK;
          showingTranslated = true;
        } catch (e) {
          alert(isJa ? '翻訳に失敗しました' : 'Translation failed');
        }
      } else {
        body.textContent = original;
        btn.textContent = TXT_TO;
        showingTranslated = false;
      }
    };

    el.appendChild(head);
    el.appendChild(body);
    el.appendChild(btn);

    // 文化タグ（chip表示）
    const tags = Array.isArray(r.cultureTags) ? r.cultureTags : [];
    if (tags.length){
      const tagBox = document.createElement('div');
      tagBox.className = 'rv-tags';
      tags.forEach(t => {
        const sp = document.createElement('span');
        sp.className = 'tag culture';
        sp.textContent = t;
        tagBox.appendChild(sp);
      });
      el.appendChild(tagBox);
    }

    box.appendChild(el);
  });

  // 右上の「評価」もサマリで上書き（★＋平均＋件数）
  const topRating = document.getElementById('vRating');
  if (topRating) {
    topRating.innerHTML = '';
    topRating.appendChild(starsEl(sum.avg || 0));
    const m = document.createElement('span');
    m.className = 'muted';
    m.style.marginLeft = '6px';
    m.textContent = (sum.avg ? Number(sum.avg).toFixed(1) : '-') + (sum.count ? ` (${sum.count})` : '');
    topRating.appendChild(m);
  }
}
</script>

<script>
async function translateText(text, target='en'){
  const url = `${window._GAS_url}?key=${encodeURIComponent(window._GAS_key)}&kind=translate&text=${encodeURIComponent(text)}&target=${encodeURIComponent(target)}`;
  const res = await fetch(url);
  const j = await res.json();
  if (!j.ok) throw new Error(j.error||'translate failed');
  return j.text || '';
}
</script>
  <script>
  function setupBack(){
    $('#btnBack').addEventListener('click', (e)=>{
      e.preventDefault();
      try{
        if (document.referrer && new URL(document.referrer).origin===location.origin) history.back();
        else location.href='index.html';
      }catch(e){ location.href='index.html'; }
    });
  }

  function setupVerifiedForm(it){
    const q = new URLSearchParams(location.search);
    const rid = q.get('rid');        // bookingId
    const token = q.get('token');
    const exp = q.get('exp');
    if (!rid || !token || !exp) return; // 表示しない

    $('#verifiedBox').style.display = '';

    const form = $('#verifiedForm');
    const msg  = $('#rvMsg');
    // ▼ 初期化：文化タグUI
const tagAuto = document.getElementById('rvTagAuto');
const tagCustom = document.getElementById('rvTagCustom');
const tagBox = document.getElementById('rvTagBox');

function refreshTagSuggest(){
  initCultureTagUI({
    text: document.getElementById('rvText')?.value || '',
    nation: document.getElementById('rvNation')?.value || '',
    menu: document.getElementById('rvMenu')?.value || '',
    type: (window.__currentSalon && (window.__currentSalon.type_ja || window.__currentSalon.type_en)) || '',
    place:(window.__currentSalon && (window.__currentSalon.place_ja|| window.__currentSalon.place_en)) || ''
  });
}

if (tagAuto) tagAuto.addEventListener('change', refreshTagSuggest);
if (tagCustom) tagCustom.addEventListener('input', ()=>{/* 手動入力はそのまま */});
const rvText = document.getElementById('rvText');
if (rvText) rvText.addEventListener('input', ()=>{ if (tagAuto?.checked) refreshTagSuggest(); });

// 現在サロン情報を覚えていれば context 使える
if (!window.__currentSalon) window.__currentSalon = it;
// 初期描画
refreshTagSuggest();
// ▲ 初期化

    form.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      msg.textContent = '送信中…';
            const rating = Number((new FormData(form).get('rvStar'))||5);

      // ▼ 追加：国籍/年代/来店時期/メニュー名の取得
      const nation = ($('#rvNation') && $('#rvNation').value) || '';
      const ageGroup = ($('#rvAge') && $('#rvAge').value) || '';
      const visitedYM = ($('#rvVisit') && $('#rvVisit').value) || ''; // 例: "2025-09"

      // メニュー名：予約リンクから item パラメータが来ている場合に拾う（無ければ空のまま）
      // ※ 今回の「施術後リンク」には普通は含まれていない想定なので、空で送ってGAS側で予約IDから補完するのが本線
      const qs2 = new URLSearchParams(location.search);
      const menuFromQS = qs2.get('item') || '';
      if ($('#rvMenu')) $('#rvMenu').value = menuFromQS;

      const payload = {
  bookingId: rid,
  token, exp,
  rating,
  comment: $('#rvText').value || '',
  salonId: it.id,
  name: $('#rvName').value || '',
  nation,
  ageGroup,
  visitedYM,
  menuName: ($('#rvMenu') && $('#rvMenu').value) || '',
  // ここで同時に入れる
  cultureTags: collectSelectedTags()
};


      
      try{
        const res = await fetch(GAS.url, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ key:GAS.key, kind:'reviews.addVerified', data: payload })
        }).then(r=>r.json());
        if (res && res.ok){
          msg.textContent = 'ありがとうございました。レビューを受け付けました。';
          form.querySelectorAll('input,textarea,button').forEach(x=>x.disabled=true);
        }else{
          msg.textContent = '投稿に失敗しました（リンク期限切れ/無効の可能性）。';
        }
      }catch(e){
        msg.textContent = '通信に失敗しました。時間をおいて再度お試しください。';
      }
    });
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    setupBack();
    try{
      const items = await getCatalog();
      if (!items.length){ $('#infoCard').insertAdjacentHTML('afterbegin','<div class="notice">カタログが空です</div>'); return; }
      const it = pickItem(items);
      renderInfo(it);
      renderGallery(it);
      renderMap(it);
      // メニュー / クーポン
      Promise.all([getMenus(it.id), getCoupons(it.id)])
        .then(([ms,cs])=>{ renderMenus(ms); renderCoupons(cs); })
        .catch(()=>{});
      // レビュー表示
      getReviews(it.id).then(res=>renderReviews(it,res)).catch(()=>{ $('#reviewsSummary').textContent='（読み込みに失敗しました）'; });
      // Verifiedフォーム
      setupVerifiedForm(it);
    }catch(e){
      console.error(e);
      $('#infoCard').insertAdjacentHTML('afterbegin','<div class="notice">読み込みに失敗しました</div>');
    }
  });
})();
</script>
  <script>
document.addEventListener('click', (e)=>{
  const f = e.target.closest('.chip-filter');
  if (!f) return;
  const tag = f.dataset.tag || '';
  const base = window.__allReviews || [];
  const list = (!tag) ? base : base.filter(r => (r.cultureTags||[]).includes(tag));

  // 直近に取得したサロンID/サマリを再利用するには、直前の res を保持するか、
  // 手軽に「見た目だけ」更新したいなら一覧部分だけ描き直す関数を分けてもOK。
  // ここでは“簡易”に一覧だけ作り直します。
  const box = document.querySelector('#reviewsList');
  box.innerHTML = '';
  list.forEach(r => {
    const el = document.createElement('div');
    el.className = 'rv-item';
    const head = document.createElement('div');
    head.className = 'rv-head';
    head.appendChild(starsEl(r.rating));
    const nm = document.createElement('div'); nm.className='rv-name'; nm.textContent = r.name || '匿名';
    const ts = document.createElement('div'); ts.className='rv-ts'; ts.textContent = (r.ts||'').slice(0,10);
    head.appendChild(nm); head.appendChild(ts);

    const body = document.createElement('div'); body.textContent = r.text || '';

    el.appendChild(head);
    el.appendChild(body);

    const tags = Array.isArray(r.cultureTags) ? r.cultureTags : [];
    if (tags.length){
      const tagBox = document.createElement('div'); tagBox.className='rv-tags';
      tags.forEach(t => { const sp=document.createElement('span'); sp.className='tag culture'; sp.textContent=t; tagBox.appendChild(sp); });
      el.appendChild(tagBox);
    }
    box.appendChild(el);
  });
});
</script>

  <script>
document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('.btn-translate');
  if (btn){
    const item = btn.closest('.review-item');
    const p = item.querySelector('.text');
    const orig = p.getAttribute('data-original') || p.textContent;
    try{
      p.textContent = '…translating';
      const target = btn.dataset.target || 'en';
      const t = await translateText(orig, target);
      p.textContent = t || orig;
    }catch(err){ p.textContent = orig; alert('翻訳に失敗しました'); }
  }
  if (e.target.matches('.btn-restore')){
    const item = e.target.closest('.review-item');
    const p = item.querySelector('.text');
    const orig = p.getAttribute('data-original');
    if (orig) p.textContent = orig;
  }
});
</script>

  <!-- decorative background (purely visual) -->
<div class="bg-radials"></div>
<div class="grain"></div>
<script>
/* i18nの保険：翻訳が空なら、元のテキスト or data-i18n-fallback を維持 */
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    if((el.textContent||'').trim()===''){
      const fb = el.getAttribute('data-i18n-fallback');
      if(fb && fb.trim()!=='') el.textContent = fb;
    }
  });
});
</script>

</body>
</html>
