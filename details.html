<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BeautyLanka – サロン詳細</title>
<style>
  :root{ --bg:#f5efe6; --card:#fff; --bd:#e9e1d7; --ink:#2b2b2b; --muted:#6b5e55; --brand:#2f776c; --gap:16px; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .layout{display:grid;grid-template-columns:2fr 1fr;gap:var(--gap)}
  @media (max-width:900px){ .layout{grid-template-columns:1fr} }
  .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:14px}
  .section-title{font-size:18px;font-weight:800;margin:0 0 8px}
  .muted{color:var(--muted)}
  .btn{display:inline-block;background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 14px;
       text-decoration:none;font-weight:700;cursor:pointer}
  /* 予約ボタンだけ少し大きく */
#btnBook{
  height:48px;
  padding:0 18px;
  font-size:16px;
  font-weight:800;
}
  .btn.secondary{background:#ddd;color:#333}
  .space{height:12px}

  /* ギャラリー */
  .gallery{display:flex;flex-direction:column;gap:10px}
  .gallery-main{width:100%;aspect-ratio:16/9;background:#f1f1f1;border-radius:12px;overflow:hidden;border:1px solid #eee}
  .gallery-main img{width:100%;height:100%;object-fit:cover;display:block}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px}
  .thumbs img{width:100%;height:70px;object-fit:cover;border-radius:8px;border:1px solid #eee;cursor:pointer}

  /* 情報 */
  .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kv{background:#faf7f2;border:1px solid #eee;border-radius:10px;padding:10px}
  .kv .k{font-size:12px;color:var(--muted)}
  .kv .v{font-weight:700;margin-top:3px}

  /* リスト（メニュー/クーポン） */
  .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
  .chip{display:inline-block;background:#efe5d9;color:#6b5e55;border-radius:999px;padding:4px 10px;margin-right:6px;font-size:12px}
/* 価格チップを強調 */
.chip-price{
  font-size:14px;
  font-weight:900;
}

  iframe.map{width:100%;height:220px;border:0;border-radius:12px}
  .notice{padding:.75em 1em;margin:.5em 0;background:#fff7e6;border:1px solid #ffd18a;border-radius:8px;color:#6b5e55}

  /* レビュー表示 */
  .stars { position:relative; display:inline-block; font-size:16px; line-height:1; }
  .stars .bg{ color:#ddd; }
  .stars .fg{ position:absolute; top:0; left:0; white-space:nowrap; overflow:hidden; color:#f2b01e; }
  .rv-item{border-top:1px dashed #e1d7cb; padding:10px 0}
  .rv-head{display:flex;gap:8px;align-items:center}
  .rv-name{font-weight:700}
  .rv-ts{color:#8a7f75; font-size:12px}

  /* Verified 投稿フォーム */
  .rv-form .row{margin:8px 0}
  .rv-form input[type="text"], .rv-form textarea {width:100%; padding:10px; border:1px solid #ddd; border-radius:8px}
  .rv-form .stars-input {display:flex; gap:8px; align-items:center}
  .rv-form .stars-input input {accent-color:#f2b01e}
</style>
<script src="./lang.js" defer></script>
<!-- i18n が無くても落ちない保険 -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    (window.BL_I18N && typeof window.BL_I18N.i18nApply === 'function') && BL_I18N.i18nApply();
  });
</script>
  <style>
/* --- BeautyLanka UI Booster (non-breaking) --- */
:root{
  --base:#F7F1E1; --ink:#2E1A16; --stroke:#eadfca; --teal:#246A73; --muted:#6f5a54; --blue:#0A66FF;
  --accent-1:#8AD5CD; --accent-2:#F9C6B8; --accent-3:#E9D7A5; --accent-4:#B6E3FF;
  --glass-bg:rgba(255,255,255,.72); --glass-brd:rgba(0,0,0,.06);
}
body{background:var(--base);color:var(--ink)}
/* 背景の装飾（描画のみ。レイアウトに影響なし） */
.bg-radials:before,.bg-radials:after{content:"";position:fixed;inset:auto;z-index:-2;pointer-events:none;filter:blur(40px);opacity:.38}
.bg-radials:before{left:-120px;top:-120px;width:420px;height:420px;background:
  radial-gradient(120px 120px at 40% 40%, var(--accent-1), transparent 70%),
  radial-gradient(160px 160px at 70% 60%, var(--accent-2), transparent 72%)}
.bg-radials:after{right:-120px;bottom:-120px;width:460px;height:460px;background:
  radial-gradient(140px 140px at 30% 40%, var(--accent-4), transparent 70%),
  radial-gradient(180px 180px at 70% 60%, var(--accent-3), transparent 72%)}
.grain{position:fixed;inset:0;z-index:-1;pointer-events:none;opacity:.07;mix-blend-mode:multiply;
  background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140" viewBox="0 0 140 140"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/><feColorMatrix type="saturate" values="0"/><feComponentTransfer><feFuncA type="table" tableValues="0 0 0 .55 .15 0"/></feComponentTransfer></filter><rect width="100%" height="100%" filter="url(%23n)"/></svg>');
  background-size:160px 160px}

/* ボタン/入力：既存 .btn や button に上書き“しすぎない”控えめ装飾 */
.btn, button, a.btn, input[type="button"].btn, input[type="submit"].btn{
  display:inline-flex;align-items:center;justify-content:center;gap:.4em;
  height:40px;border-radius:12px;border:1px solid var(--stroke);
  background:#fff;padding:0 12px;font-weight:800;cursor:pointer;
  box-shadow:0 6px 14px rgba(0,0,0,.06); transition:.15s ease-in-out;
}
.btn.primary{background:var(--teal);border-color:var(--teal);color:#fff;box-shadow:0 10px 24px rgba(36,106,115,.18)}
.btn:hover{transform:translateY(-1px)}
/* カード風の箱（既存の .card があるページはそちら優先。無いページ用の汎用クラス） */
.bl-card{background:#fff;border:1px solid var(--stroke);border-radius:16px;box-shadow:0 12px 28px rgba(0,0,0,.08);padding:16px}

/* 入力類の小綺麗化（既存の幅やIDは触らない） */
input[type="text"],input[type="email"],input[type="tel"],input[type="password"],select,textarea{
  border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;background:#fff;font:inherit
}
input:focus,select:focus,textarea:focus{outline:none;border-color:color-mix(in oklab,var(--teal) 55%,white);
  box-shadow:0 0 0 3px color-mix(in oklab,var(--teal) 20%, transparent)}

/* テーブルの視認性（ゼブラは .zebra を付けた時だけ有効） */
table.zebra tbody tr:nth-child(even){background:#faf6ef}
table.zebra th, table.zebra td{border-bottom:1px solid var(--stroke)}

/* 小さめのタグチップ（表示用。機能なし） */
.tag{padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);font-size:12px;background:#fff}

/* 文化タグの見た目（既存 .tag を流用して軽くアクセント） */
.tag.culture { font-weight: 800; border-color: #d2c3a4; }
.tag.suggested { outline: 2px dashed rgba(36,106,115,.35); }
.rv-tags { margin-top:6px; display:flex; flex-wrap:wrap; gap:6px; }
.rv-tags .tag { user-select:none; cursor:pointer; }</style>

<style>
/* ステップ風パンくず（必要なページだけHTMLを足せば見栄えUP） */
.bl-steps{display:flex;gap:8px;align-items:center;color:var(--muted);font-weight:700}
.bl-steps .dot{width:8px;height:8px;border-radius:50%;background:var(--teal);opacity:.35}
.bl-steps .on{opacity:1}
</style>
<style>
.gallery-main img{transition:transform 1.2s ease}
.gallery-main:hover img{transform:scale(1.03)}
.thumbs img{transition:transform .12s ease, box-shadow .2s}
.thumbs img:hover{transform:translateY(-2px); box-shadow:0 8px 18px rgba(0,0,0,.12)}
</style>
<style>
/* ensure button label visible */
.btn{ color: var(--ink); }
.btn.primary{ color:#fff; }
</style>
<script>
  const ASSET_BASE = 'https://beauty-frontend.onrender.com';
const toAbs = (u) => { try { return new URL(u, ASSET_BASE).href; } catch(e){ return u || ''; } };

// details.html 用の簡易言語ヘルパー（index と同じ挙動）
function getLang(){
  const pref = localStorage.getItem('bl_lang') || 'auto';
  if(pref === 'auto'){
    const ja = (navigator.language||'en').toLowerCase().startsWith('ja');
    return ja ? 'ja' : 'en';
  }
  return pref;
}
  const CULTURE_TAGS = [
  { id:'#localfamily', ja:'ローカル家庭', en:'Local family', kw:['home','family','local family','母','家庭','家族','homestay','home-cooked','kitchen'] },
  { id:'#traditional', ja:'伝統', en:'Traditional', kw:['traditional','伝統','ritual','古典','heritage','本場','authentic'] },
  { id:'#ayurveda', ja:'アーユルヴェーダ', en:'Ayurveda', kw:['ayurveda','アーユル','shirodhara','シロダーラ','herbal','薬草','steam','発汗'] },
  { id:'#threading', ja:'スレッディング', en:'Threading', kw:['threading','スレッディング','糸','眉','eyebrow'] },
  { id:'#henna', ja:'ヘナ', en:'Henna', kw:['henna','メヘンディ','mehndi','ヘナ'] },
  { id:'#templearea', ja:'寺院エリア', en:'Temple area', kw:['temple','寺','仏','stupa','bo tree','kandy'] },
  { id:'#marketside', ja:'マーケット横', en:'Market side', kw:['market','バザール','ペター','pettah','bazaar'] },
  { id:'#beachside', ja:'ビーチサイド', en:'Beachside', kw:['beach','海','shore','mirissa','unawatuna','trincomalee'] },
  { id:'#villagesalon', ja:'村サロン', en:'Village salon', kw:['village','田舎','rural','村'] },
  { id:'#colombomodern', ja:'コロンボ・モダン', en:'Colombo modern', kw:['colombo','モダン','modern','city','capital'] },
];

function pickLangStr(obj){
  const L = getLang();
  return L==='en' ? (obj.en || obj.ja) : (obj.ja || obj.en);
}

function buildTagChip(tagId, suggested=false){
  const el = document.createElement('span');
  el.className = 'tag culture' + (suggested?' suggested':'');
  el.textContent = tagId;
  el.dataset.value = tagId;
  el.onclick = ()=> el.classList.toggle('on');
  return el;
}

function initCultureTagUI(context){
  const box = document.getElementById('rvTagBox');
  if (!box) return;
  box.innerHTML = '';
  // 基本タグを並べる
  CULTURE_TAGS.forEach(t=>{
    box.appendChild(buildTagChip(t.id, false));
  });
  // サジェスト
  if (document.getElementById('rvTagAuto')?.checked){
    const guesses = suggestCultureTags(context);
    [...box.children].forEach(chip=>{
      if (guesses.has(chip.dataset.value)) chip.classList.add('suggested','on');
    });
  }
}

function collectSelectedTags(){
  const box = document.getElementById('rvTagBox');
  if (!box) return [];
  const arr = [...box.querySelectorAll('.tag.on')].map(x=>x.dataset.value);
  const custom = (document.getElementById('rvTagCustom')?.value || '').trim();
  if (custom){
    // ensure starts with '#'
    const tag = custom.startsWith('#') ? custom : ('#'+custom.replace(/\s+/g,''));
    arr.push(tag);
  }
  // 重複除去
  return [...new Set(arr)];
}

// かなり単純な「含まれてたら提案」ルール。
// テキスト/メニュー名/ジャンル/エリア/国籍などを小文字化して keyword に当てる。
function suggestCultureTags(ctx){
  const hay = [
    ctx.text||'',
    ctx.menu||'',
    ctx.type||'',
    ctx.place||'',
    ctx.nation||'',
  ].join(' ').toLowerCase();
  const out = new Set();
  CULTURE_TAGS.forEach(t=>{
    if ((t.kw||[]).some(k=>hay.includes(k.toLowerCase()))) out.add(t.id);
  });
  // 補助ルール：placeに海っぽい地名が出たら#beachside、Kandy系は#templearea
  if (/(mirissa|unawatuna|trincomalee|arugam|hikkaduwa|galle)/i.test(hay)) out.add('#beachside');
  if (/(kandy|temple|stupa|bo tree)/i.test(hay)) out.add('#templearea');
  if (/(colombo)/i.test(hay)) out.add('#colombomodern');
  return out;
}
</script>
<script>window.BL_I18N = window.BL_I18N || { i18nApply(){/* no-op */} };</script>
  <style>
/* keep brand color for the main reserve buttons */
#btnBook,
.list .bl-card .btn.primary{
  background: var(--brand) !important;
  color:#fff !important;
}
</style>
<script>
// ==== Verifiedレビューの「施術後のみ投稿可」ガード ====
// 仕様：URLに rid & token がある場合のみ #verifiedBox を表示し、
//       GAS(reviews.verify)で「投稿解放時刻 unlockAt」を取得。
//       いまが unlockAt より前なら：送信ボタンを無効化し、カウントダウン表示。
//       過ぎたら：自動でボタン解放＆文言切り替え（日本語/英語対応）。

(function() {
  const $ = (sel) => document.querySelector(sel);

  // ----- 言語判定（html lang / window.__lang / ブラウザ言語の順） -----
  function getLang() {
    const attr = (document.documentElement.getAttribute('lang') || '').toLowerCase();
    if (attr.startsWith('ja')) return 'ja';
    if (window.__lang && String(window.__lang).toLowerCase().startsWith('ja')) return 'ja';
    const nav = (navigator.language || '').toLowerCase();
    return (nav.startsWith('ja') ? 'ja' : 'en');
  }
  const LANG = getLang();

  const t = (ja, en) => (LANG === 'ja' ? ja : en);

  // ----- 日時ヘルパ（サーバーはUTCで返すことを想定） -----
  function parseISO(s) { return s ? new Date(s) : null; }
  function fmtCountdown(ms) {
    if (ms < 0) ms = 0;
    const sec = Math.floor(ms / 1000);
    const h = Math.floor(sec / 3600);
    const m = Math.floor((sec % 3600) / 60);
    const s = sec % 60;
    if (LANG === 'ja') {
      return `${h}時間${m}分${s}秒`;
    } else {
      const pad = (n)=>String(n).padStart(2,'0');
      return `${h}:${pad(m)}:${pad(s)}`;
    }
  }

  // ----- UIの参照 -----
  const verifiedBox = $('#verifiedBox');     // 既存フォームのコンテナ
  const gate = $('#rvGate');                 // 追加したメッセージ枠
  const btn  = $('#rvSubmit');               // 既存：送信ボタン
  const msg  = $('#rvMsg');                  // 既存：結果メッセージ

  // ----- URLパラメータ取得 -----
  const qs = new URLSearchParams(location.search);
  const rid   = qs.get('rid');               // 予約ID
  const token = qs.get('token');             // 一回限りトークン
  const salonId = (window.__currentSalon && window.__currentSalon.id) ? String(window.__currentSalon.id) : (qs.get('salonId') || '');

  // rid & token があるときだけフォームを出す（無ければ従来どおり非表示のまま）
  if (!verifiedBox || !rid || !token) return;
  verifiedBox.style.display = '';  // フォーム表示

  // まずは「検証中」表示
  if (gate) {
    gate.style.display = '';
    gate.textContent = t('投稿可能時刻を確認しています…', 'Checking when review becomes available…');
  }

  // ----- サーバー(GAS)で投稿可否と解放時刻を確認 -----
  // GAS側 期待レスポンス例：
  // { ok:true, canPost:true, unlockAtISO:"2025-09-25T07:30:00Z", nowISO:"2025-09-25T07:35:10Z" }
  // 施術時間はGASで計算（予約開始＋施術メニュー所要時間）
  async function verifyGate() {
    try {
      const resp = await fetch(window.__GAS_URL, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          key: window.__GAS_KEY,
          kind: 'reviews.verify',
          data: { rid, token, salonId }
        })
      }).then(r => r.json());

      if (!resp || !resp.ok) throw new Error(resp && resp.error ? resp.error : 'verify failed');

      const unlockAt = parseISO(resp.unlockAtISO); // UTC想定
      const serverNow = parseISO(resp.nowISO) || new Date();

      if (!unlockAt) {
        // unlockAt が無い = すぐ投稿OK（例：検証スキップ運用）
        allowPost();
        return;
      }
      const gap = unlockAt.getTime() - serverNow.getTime();
      if (gap <= 0 || resp.canPost === true) {
        allowPost();
      } else {
        blockUntil(unlockAt, serverNow);
      }
    } catch (e) {
      // 失敗時は安全側でブロック（不正投稿防止）
      if (gate) {
        gate.textContent = t(
          '現在レビュー投稿を開始できません（検証エラー）。時間をおいて再度お試しください。',
          'You can’t post a review yet (verification error). Please try again later.'
        );
      }
      if (btn) btn.disabled = true;
    }
  }

  function allowPost() {
    if (gate) {
      gate.style.display = '';
      gate.textContent = t('投稿できます。施術の感想をお聞かせください。', 'You can post your review now.');
    }
    if (btn) btn.disabled = false;
  }

  function blockUntil(unlockAt, serverNow) {
    if (btn) btn.disabled = true;
    const tick = () => {
      const now = new Date(); // クライアント時間。多少のズレは数十秒レベルなら許容
      const remain = unlockAt.getTime() - now.getTime();
      if (remain <= 0) {
        allowPost();
        clearInterval(timer);
      } else {
        if (gate) {
          gate.innerHTML = `
            <strong>${t('施術後に投稿可能になります。', 'Reviews open after your service ends.')}</strong><br>
            ${t('投稿までの残り時間：', 'Time remaining: ')}${fmtCountdown(remain)}
          `;
        }
      }
    };
    tick();
    const timer = setInterval(tick, 1000);
  }

  // スタート
  verifyGate();

})();
</script>

</head>
<body>
<div class="wrap">
  <div class="layout">
    <!-- 左カラム：写真 / メニュー / クーポン -->
    <div class="stackL">
      <!-- 写真 -->
      <section class="card">
        <div class="section-title" data-i18n="details.photos">写真</div>
        <div class="gallery">
          <div class="gallery-main" id="gMain"></div>
          <div class="thumbs" id="gThumbs"></div>
        </div>
      </section>

      <div class="space"></div>

      <!-- メニュー -->
      <section class="card">
        <div class="section-title" data-i18n="details.menu">メニュー</div>
        <div id="menuList" class="list"></div>
        <div id="menuEmpty" class="muted" data-i18n="details.menu_empty">（準備中です。スプレッドシートにメニューを追加したら自動表示されます）</div>
      </section>

      <div class="space"></div>

      <!-- クーポン -->
      <section class="card">
        <div class="section-title" data-i18n="details.coupons">クーポン</div>
        <div id="couponList" class="list"></div>
        <div id="couponEmpty" class="muted" data-i18n="details.coupon_empty">（準備中です）</div>
      </section>
    </div>

    <!-- 右カラム：店舗情報 / 地図 / レビュー -->
    <div class="stackR">
      <!-- 店舗情報 -->
      <section class="card" id="infoCard">
        <div class="section-title" data-i18n="details.info">店舗情報</div>
        <div class="notice" id="pickNote" style="display:none" data-i18n="details.fallback">対象が見つからなかったので先頭のサロンを表示しています</div>

        <h2 id="salonTitle" style="margin:6px 0 10px"></h2>
        <div class="info-grid">
          <div class="kv"><div class="k" data-i18n="details.genre">ジャンル</div><div class="v" id="vType"></div></div>
          <div class="kv"><div class="k" data-i18n="details.area">エリア</div><div class="v" id="vPlace"></div></div>
          <div class="kv"><div class="k" data-i18n="details.price">目安価格</div><div class="v" id="vPrice"></div></div>
          <div class="kv"><div class="k" data-i18n="details.rating">★評価</div><div class="v" id="vRating"></div></div>
        </div>

        <div class="space"></div>
        <div>
          <a href="#" class="btn secondary" id="btnBack"
   data-i18n="details.back_to_list" data-i18n-fallback="一覧に戻る">一覧に戻る</a>
<a href="#" class="btn" id="btnBook"
   data-i18n="details.go_reserve" data-i18n-fallback="予約へ進む">予約へ進む</a>
 </div>

        <div class="space"></div>
        <div id="points" class="muted"></div>
      </section>

      <div class="space"></div>

      <!-- 地図 -->
      <section class="card" id="mapSection">
        <div class="section-title" data-i18n="details.map">地図・道順</div>
        <button class="btn secondary" id="route" disabled data-i18n="details.route_google">Googleで道順</button>
        <div class="space"></div>
        <iframe id="map" class="map" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </section>

      <div class="space"></div>

      <!-- レビュー -->
      <section class="card" id="reviewsSection">
        <div class="section-title" data-i18n="details.reviews">レビュー</div>
        <div id="reviewsSummary" class="muted" data-i18n="details.loading">（読み込み中…）</div>
        <div id="reviewsList"></div>
        <div id="tag-filters">
  <button class="chip chip-filter" data-tag="">All</button>
  <button class="chip chip-filter" data-tag="#traditional">#traditional</button>
  <button class="chip chip-filter" data-tag="#localfamily">#localfamily</button>
  <button class="chip chip-filter" data-tag="#ayurveda">#ayurveda</button>
  <button class="chip chip-filter" data-tag="#localmarket">#localmarket</button>
</div>

        <!-- Verifiedレビュー投稿：rid/token/exp がURLにある時だけ表示 -->
        <!-- ▼ 追加：投稿解放メッセージ／カウントダウン表示用 -->
<div id="rvGate" class="rv-gate" style="display:none;margin:12px 0;padding:10px;border:1px dashed #bbb;border-radius:8px;font-size:.95rem;"></div>
        <div id="verifiedBox" style="display:none;margin-top:12px">
          <div class="notice" data-i18n="details.verified_note">施術後に配布される専用リンクからの投稿フォームです。</div>
          <form class="rv-form" id="verifiedForm">
            <!-- ▼ 文化タグ（自動サジェスト＋手動選択＋自由入力） -->
<div class="row" id="rvCultureRow">
  <label class="muted">文化タグ / Culture tags</label>
  <div class="rv-tags" id="rvTagBox"></div>
  <div style="display:flex; gap:8px; margin-top:6px; align-items:center">
    <input type="text" id="rvTagCustom" placeholder="#custom (任意)" style="flex:1 1 auto">
    <label style="display:flex; gap:4px; align-items:center; white-space:nowrap;">
      <input type="checkbox" id="rvTagAuto" checked>
      自動提案を使う / Auto-suggest
    </label>
  </div>
  <div class="muted" style="font-size:12px; margin-top:4px">
    例: #localfamily #traditional #ayurveda #herbal #beachside #templearea #marketside #homestyle
  </div>
</div>
<!-- ▲ 文化タグ -->

                        <!-- ▼ ここから追加：国籍 / 年代 / 来店時期 / （隠し）メニュー名 -->
            <div class="row">
              <label class="muted">国籍（任意） / Nationality (optional)</label>
              <select id="rvNation">
                <option value="">選択しない / Prefer not to say</option>
                <option>Japan</option>
                <option>Sri Lanka</option>
                <option>United States</option>
                <option>United Kingdom</option>
                <option>Australia</option>
                <option>Germany</option>
                <option>France</option>
                <option>China</option>
                <option>Korea</option>
                <option>India</option>
                <option>Other</option>
              </select>
            </div>

            <div class="row">
              <label class="muted">年代（任意） / Age group (optional)</label>
              <select id="rvAge">
                <option value="">選択しない / Prefer not to say</option>
                <option>10s</option>
                <option>20s</option>
                <option>30s</option>
                <option>40s</option>
                <option>50s</option>
                <option>60+</option>
              </select>
            </div>

            <div class="row">
              <label class="muted">来店時期（任意） / Visited (optional)</label>
              <input type="month" id="rvVisit" />
            </div>

            <!-- hidden: メニュー名（URLや予約情報から拾えた場合だけ） -->
            <input type="hidden" id="rvMenu" />
            <!-- ▲ 追加ここまで -->

            <div class="row">
              <label class="muted" data-i18n="details.name_opt">お名前（任意）</label>
              <input type="text" id="rvName" data-i18n-ph="details.rv_name_ph" placeholder="例：M*** さん">
            </div>
            <div class="row">
              <label class="muted" data-i18n="details.rating_lbl">評価</label>
              <div class="stars-input">
                <label><input type="radio" name="rvStar" value="5" checked> 5</label>
                <label><input type="radio" name="rvStar" value="4"> 4</label>
                <label><input type="radio" name="rvStar" value="3"> 3</label>
                <label><input type="radio" name="rvStar" value="2"> 2</label>
                <label><input type="radio" name="rvStar" value="1"> 1</label>
              </div>
            </div>
            <div class="row">
              <label class="muted" data-i18n="details.comment_lbl">コメント</label>
              <textarea id="rvText" rows="4" data-i18n-ph="details.rv_text_ph" placeholder="施術の感想を書いてください"></textarea>
            </div>
            <div class="row">
              <button class="btn" id="rvSubmit" data-i18n="details.submit_review">この内容で投稿</button>
            </div>
            <div class="row muted" id="rvMsg"></div>
          </form>
        </div>
      </section>
    </div>
  </div>
</div>

<!-- ▼▼ 必ずあなたの /exec とキーに置換してください ▼▼ -->
<script>
  window.__GAS_URL = 'https://script.google.com/macros/s/AKfycbwWRpfcZMsGxNqGJ5aNjRT1Y1PChDTqtQE3e0S7sUDAMei8s1wOr6lpKMnOaI1Z-6o/exec';
  window.__GAS_KEY = 'bl_gas_key_bR6ZXWwu6kM_nrK25geP97Cs5qCX3auxugX_IUGlg90';
</script>
<!-- ▲▲ ここまで ▲▲ -->

<script>
(function(){
  // ====== 設定 / ヘルパ ======
  const GAS = { url: window.__GAS_URL, key: window.__GAS_KEY };
  const $  = s => document.querySelector(s);

  // i18n保険: BL_I18N が無い/読み込めない時でも落ちない
  window.BL_I18N = window.BL_I18N || { i18nApply(){/* no-op */} };

  const JPY_TO_LKR = 2.05; // 運用値に合わせて
  const fmtLKR = v => v ? ('Rs ' + Math.round(Number(v) * JPY_TO_LKR).toLocaleString('en-US')) : '-';

  function getLang(){
    const pref = localStorage.getItem('bl_lang') || 'auto';
    if (pref === 'auto') return ((navigator.language||'en').toLowerCase().startsWith('ja') ? 'ja':'en');
    return pref;
  }
  function setText(sel, v){ const el=$(sel); if(el) el.textContent=v||''; }
  function starsEl(score){
    const pct = Math.max(0, Math.min(5, Number(score||0))) / 5 * 100;
    const root = document.createElement('span');
    root.className='stars';
    root.innerHTML = `<span class="bg">★★★★★</span><span class="fg" style="width:${pct}%">★★★★★</span>`;
    return root;
  }
  window.starsEl = starsEl; // フィルタ用にも使う

// robust版: /assets/images と /assets/img を相互にフォールバック & 拡張子も試行
function parsePhotos(v){
  // 文字列/配列どちらでも受ける
  let names = Array.isArray(v) ? v
    : String(v||'').replace(/[\r\n]+/g, ',').replace(/，/g, ',').split(',');
  names = names.map(s => String(s||'').trim()).filter(Boolean);

  const HOSTS   = ['https://beauty-frontend.onrender.com', location.origin];
  const TRY_EXT = ['.webp','.jpg','.jpeg','.png'];

  const out = [];

  names.forEach(raw => {
    // すでに http(s) 完全URLならそのまま
    if (/^https?:\/\//i.test(raw)) { out.push(raw); return; }

    // 先頭スラッシュは消す → 'assets/...'
    const bare = String(raw).replace(/^\//, '');
    const relCandidates = new Set();

    if (bare.includes('/')) {
      // 例: 'assets/images/x.webp' / 'assets/img/x.webp' を相互に追加
      relCandidates.add(bare);
      if (bare.startsWith('assets/images/')) {
        relCandidates.add(bare.replace(/^assets\/images\//, 'assets/img/'));
      }
      if (bare.startsWith('assets/img/')) {
        relCandidates.add(bare.replace(/^assets\/img\//, 'assets/images/'));
      }
    } else {
      // ファイル名だけのときは両方のディレクトリを試す
      relCandidates.add(`assets/img/${bare}`);
      relCandidates.add(`assets/images/${bare}`);
    }

    // 拡張子の有無で分岐
    const hasExt = /\.\w{3,5}$/.test(bare);

    [...relCandidates].forEach(rel => {
      if (hasExt) {
        HOSTS.forEach(h => out.push(`${h}/${rel}`));
      } else {
        TRY_EXT.forEach(ext => { HOSTS.forEach(h => out.push(`${h}/${rel}${ext}`)); });
      }
    });
  });

  // 重複除去
  return [...new Set(out)];
}




  async function fetchJSON(u){ const r=await fetch(u,{cache:'no-store'}); return r.json(); }
  async function getCatalog(){
    const u=`${GAS.url}?kind=catalog&key=${encodeURIComponent(GAS.key)}&t=${Date.now()}`;
    const j=await fetchJSON(u); if(!j.ok) throw new Error(j.error||'catalog not ok'); return j.items||[];
  }
  async function getMenus(id){
    const u=`${GAS.url}?kind=menus.list&salonId=${encodeURIComponent(id)}&key=${encodeURIComponent(GAS.key)}&t=${Date.now()}`;
    const j=await fetchJSON(u); return (j.ok && j.items)||[];
  }
  async function getCoupons(id){
    const u=`${GAS.url}?kind=coupons.list&salonId=${encodeURIComponent(id)}&key=${encodeURIComponent(GAS.key)}&t=${Date.now()}`;
    const j=await fetchJSON(u); return (j.ok && j.items)||[];
  }
  async function getReviews(id){
    const u=`${GAS.url}?kind=reviews&salonId=${encodeURIComponent(id)}&key=${encodeURIComponent(GAS.key)}&t=${Date.now()}`;
    const j=await fetchJSON(u); return (j.ok && j.items) ? j : {ok:false,items:[],summary:{}};
  }

  function pickItem(items){
    const q=new URLSearchParams(location.search);
    const target=q.get('salonId')||q.get('id')||(location.hash||'').replace(/^#/,'');
    let it=items.find(x=>String(x.id)===String(target));
    if(!it){ $('#pickNote').style.display=''; it = items.find(x => (x.name_ja||x.name_en||String(x.photos||'').trim())) || items[0]; }
    return it;
  }

  // ====== Renderer: 店舗情報 ======
  function renderInfo(it){
    const L=getLang(), pick=(ja,en)=>(L==='en'?(en||ja):(ja||en));
    setText('#salonTitle', pick(it.name_ja,it.name_en)||it.id);
    document.getElementById('vType').textContent   = BL_I18N.pick(rec,'type');
    document.getElementById('vPlace').textContent  = BL_I18N.pick(rec,'place');
    document.getElementById('vPrice').textContent  = (BL_I18N.getLang()==='ja')
      ? `${Number(rec.price_jpy||0).toLocaleString('ja-JP')} 円~`
      : `LKR ${Number(rec.price_lkr||rec.price||0).toLocaleString('en-US')}~`;

    const v=$('#vRating'); v.innerHTML='';
    const score=Number(it.rating||0);
    v.appendChild(starsEl(score));
    const n=document.createElement('span'); n.className='muted'; n.style.marginLeft='6px';
    n.textContent = score ? score.toFixed(1) : '-'; v.appendChild(n);

    document.getElementById('points').textContent  = BL_I18N.pick(rec,'points');
    // タグ欄（配列化してチップにする例）
    const tags = (BL_I18N.pick(rec,'tags')||'').split('|').map(s=>s.trim()).filter(Boolean);
// 右上の「予約へ進む」
$('#btnBook').onclick = (e)=>{
  e.preventDefault();
  const it = window.__currentSalon || {};
  const q  = new URLSearchParams({ salonId: String(it.id||'') });
  location.href = `reservation.html?${q.toString()}`;
};


  }

  // ====== Renderer: ギャラリー ======
  function renderGallery(it){
    const main=$('#gMain'), thumbs=$('#gThumbs');
    main.innerHTML=''; thumbs.innerHTML='';
    const raw=parsePhotos(it.photos);
    if(!raw.length){ main.innerHTML='<div class="notice">写真が未登録です（catalog の photos 列）</div>'; return; }

    // 2本1組でフォールバック
    const groups=[]; for(let i=0;i<raw.length;i+=2) groups.push([raw[i], raw[i+1]||raw[i]]);
    const show=(alts)=>
      { const img=new Image(); let k=0;
      img.onload=()=>{ main.innerHTML=''; main.appendChild(img); };
      img.onerror=()=>{ if(++k<alts.length) img.src=alts[k]; else throw new Error('all alts failed'); };
      img.src=alts[k];
    };
    // 先頭から順に「読めた組」をメインに採用
   (function tryShow(i=0){
     if(i>=groups.length){ main.innerHTML='<div class="notice">画像が見つかりません</div>'; return; }
     try{
       show(groups[i]);
     }catch(_){
       tryShow(i+1);
     }
   })();
    show(groups[0]);
    groups.forEach(alts=>{
      const t=new Image(); let k=0; t.loading='lazy';
      t.onerror=()=>{ if(++k<alts.length) t.src=alts[k]; else t.remove(); };
      t.onload =()=>{ t.onclick=()=>show(alts); };
      t.src=alts[k]; thumbs.appendChild(t);
    });
  }

  // ====== Renderer: 地図 ======
  function renderMap(it){
    const lat=Number(it.lat), lng=Number(it.lng);
    const iframe=$('#map'), route=$('#route'), section=$('#mapSection');
    if(Number.isFinite(lat)&&Number.isFinite(lng)&&!(lat===0&&lng===0)){
      const hl=(getLang()==='ja'?'ja':'en');
      iframe.src=`https://www.google.com/maps?q=${lat},${lng}&z=15&hl=${hl}&output=embed`;
      route.disabled=false;
      route.onclick=()=>window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&hl=${hl}`,'_blank');
    }else{
      iframe.remove(); route.disabled=true;
      section.insertAdjacentHTML('beforeend','<div class="notice">地図は未設定です。catalog の lat / lng を入れてください</div>');
    }
  }

  // ====== Renderer: メニュー / クーポン ======
  function renderMenus(list){
    const box=$('#menuList'), empty=$('#menuEmpty');
    if(!Array.isArray(list)||!list.length){ box.innerHTML=''; empty.style.display=''; return; }
    empty.style.display='none';

// 置換：renderMenus の map() 部分
box.innerHTML=list.map((m, i)=>{
  const name  = m.name_ja || m.name_en || m.name || '';
  const desc  = m.desc || '';
  const price = (m.price_jpy||m.price) ? `<span class="chip chip-price">${fmtLKR(m.price_jpy||m.price)}</span>` : '';
  const dur   = m.minutes ? `<span class="chip">${m.minutes}min</span>` : '';

  const sid   = (window.__currentSalon && window.__currentSalon.id) ? window.__currentSalon.id : '';
  const mid   = m.id || m.menu_id || String(i+1); // 安全側フォールバック
  const q     = new URLSearchParams({ salonId: String(sid), menuId: String(mid), menuName: name });

  return `<div class="bl-card">
    <div style="font-weight:800;margin-bottom:6px">${name}</div>
    ${desc ? `<div class="muted" style="margin-bottom:8px">${desc}</div>` : ''}
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:6px">
      ${price} ${dur}
      <a class="btn primary" href="reservation.html?${q.toString()}" style="margin-left:auto">予約へ</a>
    </div>
  </div>`;
}).join('');
  }

  function renderCoupons(list){
    const box=$('#couponList'), empty=$('#couponEmpty');
    if(!Array.isArray(list)||!list.length){ box.innerHTML=''; empty.style.display=''; return; }
    empty.style.display='none';
    box.innerHTML=list.map(c=>{
      const exp=c.exp?`<div class="muted" style="font-size:12px">有効期限: ${c.exp}</div>`:'';
      return `<div class="bl-card">
        <div style="font-weight:800;margin-bottom:6px">${c.title||''}</div>
        ${c.body?`<div class="muted" style="margin-bottom:8px">${c.body}</div>`:''}
        ${exp}
      </div>`;
    }).join('');
  }

  // ====== Renderer: レビュー ======
  function renderReviews(it,res){
    const box=$('#reviewsList'), sumEl=$('#reviewsSummary');
    const items=(res&&res.items)||[]; const sum=(res&&res.summary)||{};
    window.__allReviews = items; // フィルタ用

    sumEl.innerHTML=''; sumEl.appendChild(starsEl(sum.avg||0));
    const meta=document.createElement('span'); meta.className='muted'; meta.style.marginLeft='6px';
    meta.textContent=(sum.avg?Number(sum.avg).toFixed(1):'-') + (sum.count?` (${sum.count})`:''); sumEl.appendChild(meta);

    box.innerHTML='';
    items.forEach(r=>{
      const el=document.createElement('div'); el.className='rv-item';
      const head=document.createElement('div'); head.className='rv-head';
      head.appendChild(starsEl(r.rating));
      const nm=document.createElement('div'); nm.className='rv-name'; nm.textContent=r.name||'匿名';
      const ts=document.createElement('div'); ts.className='rv-ts'; ts.textContent=(r.ts||'').slice(0,10);
      head.appendChild(nm); head.appendChild(ts);

      const body=document.createElement('div'); const original=String(r.text||''); body.textContent=original;

      // 翻訳トグル（強化版：ローディング＋詳細エラー＋POST fallback）
const btn=document.createElement('button'); btn.className='btn secondary'; btn.style.margin='6px 0';
const L=(localStorage.getItem('bl_lang')||'auto');
const isJa=(L==='ja')||(L==='auto' && (navigator.language||'').toLowerCase().startsWith('ja'));
const target=isJa?'en':'ja';
const TXT_TO=isJa?'英語に自動翻訳':'Translate to Japanese';
const TXT_BACK=isJa?'原文に戻す':'Show original';
const TXT_WAIT=isJa?'翻訳中…':'Translating…';
btn.textContent=TXT_TO;

let showing=false;
const cacheKey=`${target}:${original.slice(0,200)}`;
window.__bl_tr_cache=window.__bl_tr_cache||{};

btn.onclick=async()=>{
  if(!showing){
    btn.disabled=true; btn.textContent=TXT_WAIT;
    try{
      if(!window.__bl_tr_cache[cacheKey]){
        // ① GET を試す
        let j;
        try{
          const u=`${GAS.url}?kind=translate&key=${encodeURIComponent(GAS.key)}&target=${encodeURIComponent(target)}&text=${encodeURIComponent(original)}`;
          j = await fetch(u,{cache:'no-store'}).then(r=>r.json());
        }catch(_){}
        // ② 失敗なら POST で再試行（GAS 側 doPost で kind=translate に対応させていれば通る）
        if(!j || !j.ok){
          const resp = await fetch(GAS.url, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ key:GAS.key, kind:'translate', data:{ target, text: original } })
          }).then(r=>r.json()).catch(()=>null);
          j = resp;
        }
        if(!j || !j.ok) throw new Error(j && j.error ? j.error : 'translate failed');
        window.__bl_tr_cache[cacheKey]= j.text || original;
      }
      body.textContent=window.__bl_tr_cache[cacheKey];
      btn.textContent=TXT_BACK; showing=true;
    }catch(e){
      console.error('[translate failed]', e);
      alert((isJa?'翻訳に失敗しました: ':'Translation failed: ') + (e && e.message ? e.message : ''));
      btn.textContent=TXT_TO;
    }finally{
      btn.disabled=false;
    }
  }else{
    body.textContent=original; btn.textContent=TXT_TO; showing=false;
  }
};


      el.appendChild(head); el.appendChild(body); el.appendChild(btn);

      const tags=Array.isArray(r.cultureTags)?r.cultureTags:[]; if(tags.length){
        const tbox=document.createElement('div'); tbox.className='rv-tags';
        tags.forEach(t=>{ const sp=document.createElement('span'); sp.className='tag culture'; sp.textContent=t; tbox.appendChild(sp); });
        el.appendChild(tbox);
      }
      box.appendChild(el);
    });
  }

  // ====== UI: 戻る・フィルタ ======
  function setupBack(){
    $('#btnBack').addEventListener('click',(e)=>{
      e.preventDefault();
      try{ if(document.referrer && new URL(document.referrer).origin===location.origin) history.back();
           else location.href='index.html'; }
      catch(_){ location.href='index.html'; }
    });
  }
  document.addEventListener('click',(e)=>{
    const f=e.target.closest('.chip-filter'); if(!f) return;
    const tag=f.dataset.tag||''; const base=window.__allReviews||[];
    const list=(!tag)?base:base.filter(r=>(r.cultureTags||[]).includes(tag));
    const box=$('#reviewsList'); box.innerHTML='';
    list.forEach(r=>{
      const el=document.createElement('div'); el.className='rv-item';
      const head=document.createElement('div'); head.className='rv-head';
      head.appendChild(starsEl(r.rating));
      const nm=document.createElement('div'); nm.className='rv-name'; nm.textContent=r.name||'匿名';
      const ts=document.createElement('div'); ts.className='rv-ts'; ts.textContent=(r.ts||'').slice(0,10);
      head.appendChild(nm); head.appendChild(ts);
      const body=document.createElement('div'); body.textContent=r.text||'';
      el.appendChild(head); el.appendChild(body);
      const tags=Array.isArray(r.cultureTags)?r.cultureTags:[]; if(tags.length){
        const tbox=document.createElement('div'); tbox.className='rv-tags';
        tags.forEach(t=>{ const sp=document.createElement('span'); sp.className='tag culture'; sp.textContent=t; tbox.appendChild(sp); });
        el.appendChild(tbox);
      }
      box.appendChild(el);
    });
  });

  // ====== 起動 ======
  document.addEventListener('DOMContentLoaded', async ()=>{
    setupBack();
    try{
      const items=await getCatalog();
      if(!items.length){ $('#infoCard').insertAdjacentHTML('afterbegin','<div class="notice">カタログが空です</div>'); return; }
      const it=pickItem(items);
      window.__currentSalon = it;
      renderInfo(it);
      renderGallery(it);
      renderMap(it);
      Promise.all([getMenus(it.id), getCoupons(it.id)]).then(([ms,cs])=>{ renderMenus(ms); renderCoupons(cs); }).catch(()=>{});
      getReviews(it.id).then(res=>renderReviews(it,res)).catch(()=>{ $('#reviewsSummary').textContent='（読み込みに失敗しました）'; });
    }catch(e){
      console.error(e);
      $('#infoCard').insertAdjacentHTML('afterbegin','<div class="notice">読み込みに失敗しました</div>');
    }
  });
})();
</script>

  <!-- decorative background (purely visual) -->
<div class="bg-radials"></div>
<div class="grain"></div>
<script>
/* i18nの保険：翻訳が空なら、元のテキスト or data-i18n-fallback を維持 */
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    if((el.textContent||'').trim()===''){
      const fb = el.getAttribute('data-i18n-fallback');
      if(fb && fb.trim()!=='') el.textContent = fb;
    }
  });
});
</script>

</body>
</html>
