<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BeautyLanka – サロン詳細</title>
<style>
  :root{ --bg:#f5efe6; --card:#fff; --bd:#e9e1d7; --ink:#2b2b2b; --muted:#6b5e55; --brand:#2f776c; --gap:16px; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .layout{display:grid;grid-template-columns:2fr 1fr;gap:var(--gap)}
  @media (max-width:900px){ .layout{grid-template-columns:1fr} }
  .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:14px}
  .section-title{font-size:18px;font-weight:800;margin:0 0 8px}
  .muted{color:var(--muted)}
  .btn{display:inline-block;background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 14px;
       text-decoration:none;font-weight:700;cursor:pointer}
  .btn.secondary{background:#ddd;color:#333}
  .space{height:12px}

  /* ギャラリー */
  .gallery{display:flex;flex-direction:column;gap:10px}
  .gallery-main{width:100%;aspect-ratio:16/9;background:#f1f1f1;border-radius:12px;overflow:hidden;border:1px solid #eee}
  .gallery-main img{width:100%;height:100%;object-fit:cover;display:block}
  .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px}
  .thumbs img{width:100%;height:70px;object-fit:cover;border-radius:8px;border:1px solid #eee;cursor:pointer}

  /* 情報 */
  .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kv{background:#faf7f2;border:1px solid #eee;border-radius:10px;padding:10px}
  .kv .k{font-size:12px;color:var(--muted)}
  .kv .v{font-weight:700;margin-top:3px}

  /* リスト（メニュー/クーポン） */
  .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
  .chip{display:inline-block;background:#efe5d9;color:#6b5e55;border-radius:999px;padding:4px 10px;margin-right:6px;font-size:12px}

  iframe.map{width:100%;height:300px;border:0;border-radius:12px}
  .notice{padding:.75em 1em;margin:.5em 0;background:#fff7e6;border:1px solid #ffd18a;border-radius:8px;color:#6b5e55}

  /* レビュー表示 */
  .stars { position:relative; display:inline-block; font-size:16px; line-height:1; }
  .stars .bg{ color:#ddd; }
  .stars .fg{ position:absolute; top:0; left:0; white-space:nowrap; overflow:hidden; color:#f2b01e; }
  .rv-item{border-top:1px dashed #e1d7cb; padding:10px 0}
  .rv-head{display:flex;gap:8px;align-items:center}
  .rv-name{font-weight:700}
  .rv-ts{color:#8a7f75; font-size:12px}

  /* Verified 投稿フォーム */
  .rv-form .row{margin:8px 0}
  .rv-form input[type="text"], .rv-form textarea {width:100%; padding:10px; border:1px solid #ddd; border-radius:8px}
  .rv-form .stars-input {display:flex; gap:8px; align-items:center}
  .rv-form .stars-input input {accent-color:#f2b01e}
</style>
</head>
<body>
<div class="wrap">
  <div class="layout">
    <!-- 左カラム：写真 / メニュー / クーポン -->
    <div class="stackL">
      <!-- 写真 -->
      <section class="card">
        <div class="section-title">写真</div>
        <div class="gallery">
          <div class="gallery-main" id="gMain"></div>
          <div class="thumbs" id="gThumbs"></div>
        </div>
      </section>

      <div class="space"></div>

      <!-- メニュー -->
      <section class="card">
        <div class="section-title">メニュー</div>
        <div id="menuList" class="list"></div>
        <div id="menuEmpty" class="muted">（準備中です。スプレッドシートにメニューを追加したら自動表示されます）</div>
      </section>

      <div class="space"></div>

      <!-- クーポン -->
      <section class="card">
        <div class="section-title">クーポン</div>
        <div id="couponList" class="list"></div>
        <div id="couponEmpty" class="muted">（準備中です）</div>
      </section>
    </div>

    <!-- 右カラム：店舗情報 / 地図 / レビュー -->
    <div class="stackR">
      <!-- 店舗情報 -->
      <section class="card" id="infoCard">
        <div class="section-title">店舗情報</div>
        <div class="notice" id="pickNote" style="display:none">対象が見つからなかったので先頭のサロンを表示しています</div>

        <h2 id="salonTitle" style="margin:6px 0 10px"></h2>
        <div class="info-grid">
          <div class="kv"><div class="k">ジャンル</div><div class="v" id="vType"></div></div>
          <div class="kv"><div class="k">エリア</div><div class="v" id="vPlace"></div></div>
          <div class="kv"><div class="k">目安価格</div><div class="v" id="vPrice"></div></div>
          <div class="kv"><div class="k">★評価</div><div class="v" id="vRating"></div></div>
        </div>

        <div class="space"></div>
        <div>
          <a href="#" class="btn secondary" id="btnBack">一覧に戻る</a>
          <a href="#" class="btn" id="btnBook">予約へ進む</a>
        </div>

        <div class="space"></div>
        <div id="points" class="muted"></div>
      </section>

      <div class="space"></div>

      <!-- 地図 -->
      <section class="card" id="mapSection">
        <div class="section-title">地図・道順</div>
        <button class="btn secondary" id="route" disabled>Googleで道順</button>
        <div class="space"></div>
        <iframe id="map" class="map" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </section>

      <div class="space"></div>

      <!-- レビュー -->
      <section class="card" id="reviewsSection">
        <div class="section-title">レビュー</div>
        <div id="reviewsSummary" class="muted">（読み込み中…）</div>
        <div id="reviewsList"></div>

        <!-- Verifiedレビュー投稿：rid/token/exp がURLにある時だけ表示 -->
        <div id="verifiedBox" style="display:none;margin-top:12px">
          <div class="notice">施術後に配布される専用リンクからの投稿フォームです。</div>
          <form class="rv-form" id="verifiedForm">
            <div class="row">
              <label class="muted">お名前（任意）</label>
              <input type="text" id="rvName" placeholder="例：M*** さん">
            </div>
            <div class="row">
              <label class="muted">評価</label>
              <div class="stars-input">
                <label><input type="radio" name="rvStar" value="5" checked> 5</label>
                <label><input type="radio" name="rvStar" value="4"> 4</label>
                <label><input type="radio" name="rvStar" value="3"> 3</label>
                <label><input type="radio" name="rvStar" value="2"> 2</label>
                <label><input type="radio" name="rvStar" value="1"> 1</label>
              </div>
            </div>
            <div class="row">
              <label class="muted">コメント</label>
              <textarea id="rvText" rows="4" placeholder="施術の感想を書いてください"></textarea>
            </div>
            <div class="row">
              <button class="btn" id="rvSubmit">この内容で投稿</button>
            </div>
            <div class="row muted" id="rvMsg"></div>
          </form>
        </div>
      </section>
    </div>
  </div>
</div>

<!-- ▼▼ 必ずあなたの /exec とキーに置換してください ▼▼ -->
<script>
  window.__GAS_URL = 'https://script.google.com/macros/s/AKfycbxQHByDLRu-QlfAyRRMdM0-pGskH9Ka7IcFs9NeV2NB3DyDWhaLgvv8Hain_l9nZGvk/exec';
  window.__GAS_KEY = 'bl_gas_key_crUS1RnVC07WqAkdtzLfemDla3MBNxvTKsiJFOh5';
</script>
<!-- ▲▲ ここまで ▲▲ -->

<script>
(function(){
  const GAS = { url: window.__GAS_URL, key: window.__GAS_KEY };
  const $  = s => document.querySelector(s);

  const fmtJPY = v => v ? '¥'+Number(v).toLocaleString('ja-JP') : '-';
  const setText = (sel, v) => { const el=$(sel); if(el) el.textContent = v||''; };

  function parsePhotos(v){
    let a = Array.isArray(v) ? v : String(v||'')
      .replace(/[\r\n]+/g, ',')   // 改行→カンマ
      .replace(/，/g, ',')        // 全角カンマ→半角
      .split(',');
    a = a.map(s=>String(s||'').trim())
         .filter(Boolean)
         .map(p=> p.startsWith('/') ? p : '/'+p);
    // /assets/img と /assets/images の両方を試す
    const alt=[]; 
    a.forEach(p=>{
      alt.push(p);
      if (p.startsWith('/assets/img/'))    alt.push(p.replace('/assets/img/','/assets/images/'));
      if (p.startsWith('/assets/images/')) alt.push(p.replace('/assets/images/','/assets/img/'));
    });
    return [...new Set(alt)];
  }

  async function fetchJSON(u){
    const r = await fetch(u,{cache:'no-store'});
    return r.json();
  }

  // ---- Data fetchers ----
  async function getCatalog(){
    const u = `${GAS.url}?kind=catalog&key=${encodeURIComponent(GAS.key)}&t=${Date.now()}`;
    const j = await fetchJSON(u);
    if (!j.ok) throw new Error(j.error||'catalog not ok');
    return j.items||[];
  }
  async function getMenus(salonId){
    const u = `${GAS.url}?kind=menus.list&salonId=${encodeURIComponent(salonId)}&key=${encodeURIComponent(GAS.key)}&t=${Date.now()}`;
    const j = await fetchJSON(u);
    return (j.ok && j.items)||[];
  }
  async function getCoupons(salonId){
    const u = `${GAS.url}?kind=coupons.list&salonId=${encodeURIComponent(salonId)}&key=${encodeURIComponent(GAS.key)}&t=${Date.now()}`;
    const j = await fetchJSON(u);
    return (j.ok && j.items)||[];
  }
  async function getReviews(salonId){
    const u = `${GAS.url}?kind=reviews&salonId=${encodeURIComponent(salonId)}&key=${encodeURIComponent(GAS.key)}&t=${Date.now()}`;
    const j = await fetchJSON(u);
    return (j.ok && j.items) ? j : {ok:false, items:[], summary:{}};
  }

  // ---- helpers ----
  function pickItem(items){
    const q = new URLSearchParams(location.search);
    const target = q.get('salonId') || q.get('id') || (location.hash||'').replace(/^#/, '');
    let it = items.find(x=>String(x.id)===String(target));
    if (!it){
      $('#pickNote').style.display = '';
      it = items.find(x => (x.name_ja || x.name_en || String(x.photos||'').trim())) || items[0];
    }
    return it;
  }
  function starsEl(score){
    const pct = Math.max(0, Math.min(5, Number(score||0))) / 5 * 100;
    const root = document.createElement('span');
    root.className = 'stars';
    root.innerHTML = `<span class="bg">★★★★★</span><span class="fg" style="width:${pct}%">★★★★★</span>`;
    return root;
  }

  // ---- renderers ----
  function renderInfo(it){
    setText('#salonTitle', it.name_ja || it.name_en || it.id);
    setText('#vType', it.type_ja || it.type_en || '-');
    setText('#vPlace', it.place_ja || it.place_en || '-');
    setText('#vPrice', it.price_jpy ? fmtJPY(it.price_jpy) : '-');
    setText('#vRating', it.rating ? String(it.rating) : '-');
    setText('#points', it.points_ja || it.points_en || '');
    $('#btnBook').onclick = (e)=>{e.preventDefault(); /* 予約導線は後で差し替え */ alert('予約導線は後で差し替え');};
  }

  function renderGallery(it){
    const photos = parsePhotos(it.photos);
    const main = $('#gMain'); const thumbs = $('#gThumbs');
    main.innerHTML = ''; thumbs.innerHTML = '';
    if (!photos.length){ main.innerHTML = '<div class="notice">写真が未登録です（catalog の photos 列）</div>'; return; }
    const show = (src)=> main.innerHTML = `<img src="${src}" alt="photo" onerror="this.remove()">`;
    show(photos[0]);
    photos.forEach((src)=>{
      const img = new Image(); img.src = src; img.loading='lazy';
      img.onclick=()=>show(src);
      thumbs.appendChild(img);
    });
  }

  function renderMap(it){
    const lat = Number(it.lat), lng = Number(it.lng);
    const map = $('#map'), route = $('#route');
    if (Number.isFinite(lat)&&Number.isFinite(lng)&&!(lat===0&&lng===0)){
      map.src = `https://www.google.com/maps?q=${lat},${lng}&z=15&hl=ja&output=embed`;
      route.disabled = false;
      route.onclick = ()=> window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving&hl=ja`,'_blank');
    }else{
      map.remove(); route.disabled = true;
      $('#mapSection').insertAdjacentHTML('beforeend','<div class="notice">地図は未設定です。catalog の lat / lng を入れてね。</div>');
    }
  }

  function renderMenus(items){
    const box = $('#menuList'); const empty = $('#menuEmpty');
    box.innerHTML = '';
    if (!items.length){ empty.style.display=''; return; }
    empty.style.display='none';
    items.forEach(m=>{
      const el = document.createElement('div'); el.className='card';
      el.innerHTML = `<div class="section-title" style="font-size:16px">${m.name_ja||m.name_en||'-'}</div>
        <div class="muted">${m.desc_ja||m.desc_en||''}</div>
        <div class="space"></div>
        <div><span class="chip">${m.duration_min||'-'}分</span> <span class="chip">${m.price_jpy?fmtJPY(m.price_jpy):'-'}</span></div>`;
      box.appendChild(el);
    });
  }

  function renderCoupons(items){
    const box = $('#couponList'); const empty = $('#couponEmpty');
    box.innerHTML = '';
    if (!items.length){ empty.style.display=''; return; }
    empty.style.display='none';
    items.forEach(c=>{
      const el = document.createElement('div'); el.className='card';
      el.innerHTML = `<div class="section-title" style="font-size:16px">${c.name_ja||c.name_en||'-'}</div>
        <div class="muted">${c.desc_ja||c.desc_en||''}</div>`;
      box.appendChild(el);
    });
  }

  function renderReviews(it, res){
    const box = $('#reviewsList');
    const sum = (res.summary && res.summary[it.id]) || {avg:0, count:0};
    // Summary line
    const sumLine = document.createElement('div');
    sumLine.innerHTML = '';
    const s = starsEl(sum.avg);
    const meta = document.createElement('span');
    meta.className='muted';
    meta.style.marginLeft = '8px';
    meta.textContent = `平均 ${sum.avg||0} / 5（${sum.count||0}件）`;
    sumLine.appendChild(s); sumLine.appendChild(meta);
    $('#reviewsSummary').innerHTML = '';
    $('#reviewsSummary').appendChild(sumLine);

    // Items (最新5件)
    box.innerHTML = '';
    const items = (res.items||[]).filter(x=>String(x.salonId)===String(it.id))
                                  .sort((a,b)=>String(b.ts).localeCompare(String(a.ts)))
                                  .slice(0,5);
    if (!items.length){
      box.innerHTML = '<div class="muted">まだレビューはありません。施術完了後に届く専用リンクから投稿できます。</div>';
      return;
    }
    items.forEach(o=>{
      const el = document.createElement('div'); el.className='rv-item';
      const head = document.createElement('div'); head.className='rv-head';
      const nm = document.createElement('div'); nm.className='rv-name'; nm.textContent = o.name || '匿名';
      const ts = document.createElement('div'); ts.className='rv-ts'; ts.textContent = (o.ts||'').slice(0,10);
      head.appendChild(starsEl(o.rating)); head.appendChild(nm); head.appendChild(ts);
      const body = document.createElement('div'); body.textContent = o.text || '';
      el.appendChild(head); el.appendChild(body);
      box.appendChild(el);
    });
  }

  function setupBack(){
    $('#btnBack').addEventListener('click', (e)=>{
      e.preventDefault();
      try{
        if (document.referrer && new URL(document.referrer).origin===location.origin) history.back();
        else location.href='index.html';
      }catch(e){ location.href='index.html'; }
    });
  }

  function setupVerifiedForm(it){
    const q = new URLSearchParams(location.search);
    const rid = q.get('rid');        // bookingId
    const token = q.get('token');
    const exp = q.get('exp');
    if (!rid || !token || !exp) return; // 表示しない

    $('#verifiedBox').style.display = '';

    const form = $('#verifiedForm');
    const msg  = $('#rvMsg');
    form.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      msg.textContent = '送信中…';
      const rating = Number((new FormData(form).get('rvStar'))||5);
      const payload = {
        bookingId: rid,
        token, exp,
        rating,
        comment: $('#rvText').value || '',
        salonId: it.id,
        name: $('#rvName').value || ''
      };
      try{
        const res = await fetch(GAS.url, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ key:GAS.key, kind:'reviews.addVerified', data: payload })
        }).then(r=>r.json());
        if (res && res.ok){
          msg.textContent = 'ありがとうございました。レビューを受け付けました。';
          form.querySelectorAll('input,textarea,button').forEach(x=>x.disabled=true);
        }else{
          msg.textContent = '投稿に失敗しました（リンク期限切れ/無効の可能性）。';
        }
      }catch(e){
        msg.textContent = '通信に失敗しました。時間をおいて再度お試しください。';
      }
    });
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    setupBack();
    try{
      const items = await getCatalog();
      if (!items.length){ $('#infoCard').insertAdjacentHTML('afterbegin','<div class="notice">カタログが空です</div>'); return; }
      const it = pickItem(items);
      renderInfo(it);
      renderGallery(it);
      renderMap(it);
      // メニュー / クーポン
      Promise.all([getMenus(it.id), getCoupons(it.id)])
        .then(([ms,cs])=>{ renderMenus(ms); renderCoupons(cs); })
        .catch(()=>{});
      // レビュー表示
      getReviews(it.id).then(res=>renderReviews(it,res)).catch(()=>{ $('#reviewsSummary').textContent='（読み込みに失敗しました）'; });
      // Verifiedフォーム
      setupVerifiedForm(it);
    }catch(e){
      console.error(e);
      $('#infoCard').insertAdjacentHTML('afterbegin','<div class="notice">読み込みに失敗しました</div>');
    }
  });
})();
</script>
</body>
</html>
