<!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BeautyLanka | 検索</title>
<link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@600;700&family=Zen+Kaku+Gothic+New:wght@400;500;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@800&family=Zen+Kaku+Gothic+New:wght@700;900&family=RocknRoll+One&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --base:#F7F1E1; --ink:#2E1A16; --stroke:#eadfca; --teal:#246A73; --muted:#6f5a54; --blue:#0A66FF;
  --chip:#fff8ef; --danger:#74070E;
  --space-1:8px; --space-2:12px; --space-3:16px; --space-4:20px; --space-5:24px;
  /* New accent tokens */
  --accent-1:#8AD5CD; --accent-2:#F9C6B8; --accent-3:#E9D7A5; --accent-4:#B6E3FF;
  --glass-bg:rgba(255,255,255,.72); --glass-brd:rgba(0,0,0,.06);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--base);color:var(--ink);
  font-family:"Inter","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
.container{max-width:1200px;margin:0 auto;padding:0 16px}
a{color:inherit;text-decoration:none}

/* ===== Decorative background layers (non-blocking) ===== */
.bg-radials:before, .bg-radials:after{content:"";position:fixed;inset:auto;z-index:-2;pointer-events:none;filter:blur(40px);opacity:.38}
.bg-radials:before{left:-120px;top:-120px;width:420px;height:420px;background:radial-gradient(120px 120px at 40% 40%, var(--accent-1), transparent 70%),radial-gradient(160px 160px at 70% 60%, var(--accent-2), transparent 72%)}
.bg-radials:after{right:-120px;bottom:-120px;width:460px;height:460px;background:radial-gradient(140px 140px at 30% 40%, var(--accent-4), transparent 70%),radial-gradient(180px 180px at 70% 60%, var(--accent-3), transparent 72%)}
.grain{position:fixed;inset:0;z-index:-1;pointer-events:none;opacity:.07;mix-blend-mode:multiply;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140" viewBox="0 0 140 140"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/><feColorMatrix type="saturate" values="0"/><feComponentTransfer><feFuncA type="table" tableValues="0 0 0 .55 .15 0"/></feComponentTransfer></filter><rect width="100%" height="100%" filter="url(%23n)"/></svg>');background-size:160px 160px}

body.no-scroll{ overflow:hidden; }

/* header */
header{position:sticky;top:0;z-index:40;background:rgba(247,241,225,.72);backdrop-filter:blur(8px);border-bottom:1px solid var(--stroke)}
.hwrap{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:10px 0}
.brand-left{display:flex;align-items:center;gap:10px;text-decoration:none}
.logo-img{width:140px;height:auto;border-radius:14px;box-shadow:0 10px 24px rgba(36,106,115,.18)}
.nav-right{display:flex;gap:8px;align-items:center}
.btn{height:38px;border-radius:12px;border:1px solid var(--stroke);background:#fff;padding:0 12px;font-weight:700;cursor:pointer}
.btn.primary{background:var(--teal);border-color:var(--teal);color:#fff;box-shadow:0 6px 14px rgba(36,106,115,.18)}
.sel{height:38px;border-radius:12px;border:1px solid var(--stroke);padding:0 10px;background:#fff;font-weight:700}

/* hero header */
.hero-visual{position:relative;margin:0 0 8px}
.hero-head{background:linear-gradient(180deg,#b8e7e0, #e1f3f0 60%, transparent); padding:72px 0 20px; position:relative; overflow:hidden}
.hero-head h1{font-family:"Shippori Mincho",serif;font-weight:800;font-size:44px;letter-spacing:.02em;text-align:center;margin:0 0 6px;color:#17353a;text-shadow:0 1px 0 rgba(255,255,255,.6)}
.hero-head p{opacity:.9;text-align:center;margin:18px 0 0}
.hero-head h1{ font-size:44px; font-weight:800 }
.hero-head p{ margin:16px 0 6px; font-size:16px; opacity:.92 }
.container{ max-width:1200px; margin:0 auto; padding:0 20px }
.grid{ gap:26px } /* カード間を少し広げる */
.body{ padding:16px 18px 16px } /* カード内余白を少し増やす */
.title{ font-size:19px; font-weight:900 }
.rowmeta{ font-size:13px }
.points{ font-size:14px; line-height:1.7 }
@media(max-width:820px){ .hero-head h1{font-size:32px} }
/* Sri outline floating behind title */
.hero-sri{position:absolute;left:50%;top:60%;transform:translate(-50%,-50%) rotate(-6deg);width:min(28vw,260px);opacity:.16;pointer-events:none;filter:drop-shadow(0 12px 24px rgba(0,0,0,.18))}

/* search bar with animated border */
.searchbar{margin:-28px auto 8px;background:#fff;border:1px solid var(--stroke);border-radius:16px;box-shadow:0 10px 24px rgba(49,14,16,.08);padding:12px;max-width:960px;position:relative;overflow:hidden}
.searchbar:before{content:"";position:absolute;inset:-2px;border-radius:18px;background:conic-gradient(from 180deg, var(--accent-1), var(--accent-4), var(--accent-2), var(--accent-3), var(--accent-1));filter:blur(8px);opacity:.45;z-index:0;animation:spin 12s linear infinite}
.searchbar > *{position:relative;z-index:1}
@keyframes spin{to{transform:rotate(1turn)}}
.searchbar form{display:grid;grid-template-columns:2fr 1.3fr 1.3fr auto;gap:8px;align-items:center}
.searchbar input,.searchbar select{height:40px;border-radius:10px;border:1px solid var(--stroke);padding:0 10px;font:inherit;background:#fff}
@media(max-width:980px){.searchbar form{grid-template-columns:1fr 1fr 1fr} .searchbar button{grid-column:span 3;}}
@media(max-width:640px){.searchbar form{grid-template-columns:1fr 1fr} .searchbar button{grid-column:span 2;}}

/* grid cards */
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:22px;margin:12px 0 26px;align-items:stretch}
@media(max-width:1020px){ .grid{grid-template-columns:repeat(2,1fr)} }
@media(max-width:680px){ .grid{grid-template-columns:1fr} }
.card{background:#fff;border:1px solid var(--stroke);border-radius:18px;overflow:hidden;box-shadow:0 10px 24px rgba(49,14,16,.08);display:flex;flex-direction:column;transition:transform .3s ease, box-shadow .3s ease}
.card:hover{transform:translateY(-6px) scale(1.02);box-shadow:0 16px 28px rgba(0,0,0,.18)}
.media{position:relative;overflow:hidden;background:#000}
.media .carousel{display:flex;overflow-x:hidden;scroll-snap-type:x mandatory}
.media .carousel img{height:240px;width:100%;object-fit:cover;flex:0 0 100%;scroll-snap-align:center;transition:transform 7s ease}
.card:hover .media .carousel img{transform:scale(1.08)}
.media .nav{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;pointer-events:none}
.media .nav button{pointer-events:auto;border:none;background:rgba(0,0,0,.35);width:40px;height:40px;border-radius:999px;color:#fff;font-size:18px;cursor:pointer}
.body{padding:12px 18px 14px;display:flex;flex-direction:column;gap:6px}
.title{font-weight:900;font-size:18px;margin:0 0 4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rowmeta{display:flex;align-items:center;gap:8px;color:#6b5e55;font-size:13px;flex-wrap:wrap}
.star{color:#C08B1B;font-weight:900;text-shadow:0 1px 0 rgba(255,255,255,.6)}
.tags{display:flex;gap:6px;flex-wrap:wrap;margin:4px 0 2px}
.tag{padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);font-size:12px;background:#fff;cursor:pointer;transition: transform .06s ease, background-color .2s ease, box-shadow .2s ease}
.tag:hover{box-shadow:0 6px 14px rgba(0,0,0,.08)}
.tag.pressed { transform: translateY(1px) scale(0.98); box-shadow: inset 0 2px 6px rgba(0,0,0,.08) }
.points{color:#3f342f;font-size:13px;line-height:1.6;margin:2px 0 6px;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.foot{display:flex;justify-content:space-between;align-items:center;margin-top:auto}
.actions{display:flex;gap:10px;align-items:center}
.heart{width:40px;height:40px;border:1px solid var(--stroke);border-radius:999px;background:#fff;display:grid;place-items:center;cursor:pointer;margin-right:4px}
.heart .ico{font-size:18px;line-height:1}
.heart.active{outline:3px solid color-mix(in oklab, var(--teal) 45%, white)}

/* map preview */
.mapwrap{display:none}
.mapwrap.show{display:block}
.map{position:relative;height:180px;border-top:1px solid var(--stroke);background:#eef2f3}
.map iframe{width:100%;height:100%;border:0;border-bottom-left-radius:18px;border-bottom-right-radius:18px}
.map .overlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%)}
.map .map-btn{background:var(--blue);color:#fff;border:none;border-radius:12px;padding:12px 18px;font-weight:900;cursor:pointer;box-shadow:0 10px 18px rgba(10,102,255,.22)}
.map-toggle{margin:0 14px 10px 14px}
.small{font-size:12px;color:var(--muted)}
footer{color:#6b5e55;text-align:center;font-size:12px;margin:12px 0}

/* fullscreen intro splash */
.splash{position:fixed;inset:0;background:#000;display:none;align-items:center;justify-content:center;z-index:9999;color:#fff}
.splash.show{display:flex}
.splash video{position:absolute;inset:0;width:100vw;height:100vh;object-fit:cover;filter:brightness(.55)}
.splash .skip{position:absolute;right:16px;bottom:16px;background:rgba(255,255,255,.92);border:0;border-radius:999px;padding:10px 14px;font-weight:900;cursor:pointer;color:#17353a}
.splash .headline{position:relative;text-align:center}
.splash .headline h1{font-family:"Shippori Mincho",serif;font-size:64px;letter-spacing:.02em;margin:0 0 12px}
.splash .headline .cap{opacity:.9}
.splash .sri-between-splash{display:flex;justify-content:center;margin:10px 0 12px}
.splash .sri-between-splash img{width:120px;opacity:.9;filter:drop-shadow(0 4px 8px rgba(0,0,0,.4))}
@media(max-width:820px){.splash .sri-between-splash img{width:72px}}
@media(max-width:820px){ .splash .headline h1{font-size:40px} }
  /* make headline (line art + title) always appear above the video */
.splash .headline { position: relative; z-index: 1; }
/* the inline image class actually used in HTML is .sri-center */
.splash .sri-center { display:block; width:120px; margin:10px auto 12px; opacity:.9;
  filter:drop-shadow(0 4px 8px rgba(0,0,0,.4));
}

/* second Sri outline (page decoration) */
.sri2{position:fixed;left:3%;bottom:3%;width:140px;opacity:.12;pointer-events:none;filter:drop-shadow(0 6px 10px rgba(0,0,0,.2));animation:floaty 10s ease-in-out infinite}
@keyframes floaty{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.sri2{ display:none !important }

/* breadcrumbs & header controls */
.breadcrumbs { display:flex; gap:.5rem; align-items:center; font-size:.9rem; color: var(--muted); margin: .5rem 0 1rem }
.breadcrumbs a { color: inherit; text-decoration: none }
.breadcrumbs a[aria-current="page"] { color: var(--ink); font-weight: 600 }
.breadcrumbs .sep { opacity:.6 }
.header-controls { display:flex; gap:.5rem; align-items:center }
.header-controls select { border:1px solid var(--stroke); background:white; padding:.4rem .6rem; border-radius:10px; font-size:.95rem }

/* Keep button content centered */
.btn, button, a.btn, input[type="button"].btn, input[type="submit"].btn { display:inline-flex; align-items:center; justify-content:center; line-height:1; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.btn .ico, button .ico { display:inline-flex; align-items:center; gap:.4em }

/* Fixed card sizing */
.card{ height: 520px }
.card.show-map{ height: auto }
.points{ -webkit-line-clamp: 3 }

/* Glass chips for header controls */
body.hero-header .header-controls, body.hero-header #langSelect{ background:var(--glass-bg); border:1px solid var(--glass-brd); box-shadow:0 2px 10px rgba(0,0,0,.06) }

/* sticky header over hero */
body.hero-header header{ position:absolute; top:8px; left:0; right:0; background:transparent; border:0; backdrop-filter:none; box-shadow:none }
body.hero-header .hwrap{ padding:0 0 }
body.hero-header .logo-img{ width:120px; border-radius:12px; box-shadow:none }
body.hero-header .nav-right .btn.primary{ background:var(--teal)!important; border-color:var(--teal)!important; color:#fff!important }
body.hero-header .nav-right{ position:absolute; right:16px; top:16px; z-index:9 }
body.hero-header .logo-img{ position:absolute; top:16px; left:16px; width:120px; height:auto; z-index:10 }
body.hero-header #langSelect{ position:absolute; left:16px; top:108px; z-index:9 }
body.hero-header .header-controls{ position:absolute; left:16px; top:158px; z-index:8 }
@media (max-width:820px){
  body.hero-header .nav-right{ position:static }
  body.hero-header #langSelect{ left:auto; right:12px; top:76px }
  body.hero-header .header-controls{ left:auto; right:12px; top:120px }
}

/* Shimmer skeletons */
.skeleton-card{background:#fff;border:1px solid var(--stroke);border-radius:18px;overflow:hidden;box-shadow:0 10px 24px rgba(49,14,16,.08)}
.skel-media{height:240px;background:linear-gradient(90deg,#eee,#f6f6f6,#eee);background-size:200% 100%;animation:shimmer 1.5s infinite}
.skel-lines{padding:14px 16px 18px}
.skel-line{height:12px;background:linear-gradient(90deg,#eee,#f6f6f6,#eee);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:8px;margin:10px 0}
.skel-line.w60{width:60%}.skel-line.w40{width:40%}.skel-line.w80{width:80%}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* Back-to-top */
#toTop{position:fixed;right:16px;bottom:16px;width:44px;height:44px;border-radius:999px;border:1px solid var(--stroke);background:#fff;box-shadow:0 10px 18px rgba(0,0,0,.12);display:grid;place-items:center;font-weight:900;cursor:pointer;opacity:0;transform:translateY(8px);transition:.25s}
#toTop.show{opacity:1;transform:none}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce){
  .card:hover, .media .carousel img, .sri2{animation:none;transition:none}
  .searchbar:before{animation:none}
}
  /* === Hero visual: right-side image like the mock === */
.hero-head {
  position: relative;
  padding: 88px 0 32px; /* 既存より少し余白を増やす */
  background: linear-gradient(180deg,#b8e7e0, #e1f3f0 60%, transparent);
}
.hero-head::after{
  /* 右側の人物ビジュアル。適宜パス変更OK */
  content:"";
  position:absolute; inset:0 0 0 auto;
  width:min(42%,520px);
  background-image:url("/assets/img/hero_model.webp");
  background-size:cover; background-position:center;
  filter: drop-shadow(0 8px 24px rgba(0,0,0,.18));
  border-bottom-left-radius:24px;
  opacity:.98;
}
@media(max-width:980px){
  .hero-head::after{ display:none; } /* モバイルは隠す（既存優先で読みやすく） */
}

/* Title block spacing */
.hero-head .container { position:relative; z-index:1 }
.hero-head h1{ margin:0 0 10px }
.hero-head p{ margin:0 0 18px }

/* === Chip bar (category quick filters) === */
.chipbar{
  display:flex; flex-wrap:wrap; gap:10px;
  margin:10px auto 10px; max-width:960px;
  justify-content:center;
}
.chip{
  background:var(--chip);
  border:1px solid var(--stroke);
  padding:10px 14px;
  border-radius:999px;
  font-weight:700; cursor:pointer;
  box-shadow:0 6px 14px rgba(0,0,0,.06);
  transition:transform .08s ease, box-shadow .2s ease, background-color .2s ease;
  user-select:none;
}
.chip:hover{ box-shadow:0 10px 18px rgba(0,0,0,.12) }
.chip:active{ transform:translateY(1px) scale(.98) }
.chip.active{ outline:3px solid color-mix(in oklab, var(--teal) 50%, white) }

/* Search card look: chipbar + searchbarを一体化っぽく */
.searchwrap{
  margin: -20px auto 8px;
  max-width:960px;
}
.searchwrap .searchbar{
  margin: 8px 0 0;
}
  /* 追加：スマホ幅ではchipbarを隠す */
@media (max-width: 680px){
  .chipbar{ display:none; }
}

/* ==== Hero/chip/search spacing fix ==== */
.hero-head{ padding: 96px 0 40px; }         /* 下方向の余白を増やす */
.chipbar{ margin: 10px auto 8px; }          /* チップ列 */
.searchwrap{ margin: 12px auto 8px; }       /* もう重ならない値に */

/* ==== New search layout (two rows like the mock) ==== */
.searchbar{ padding:16px; }
.searchgrid{
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  gap:10px;
}
.searchrow2{
  display:grid;
  grid-template-columns: 1fr 200px;
  gap:10px;
  margin-top:10px;
}
@media (max-width: 980px){
  .searchgrid{ grid-template-columns: repeat(2, 1fr); }
  .searchrow2{ grid-template-columns: 1fr; }
  .searchrow2 .searchbtn{ height:48px; }
}
.pill{
  display:flex; align-items:center; gap:8px;
  height:48px; padding:0 14px; border:1px solid var(--stroke);
  border-radius:16px; background:#fff;
}
  /* --- Fix: pill内テキストが下に寄る現象（Win/Chrome対策） --- */
.pill select,
.pill input[type="date"],
.pill input[type="search"]{
  line-height: 1.2;        /* 文字の上下センタリングを安定させる */
  padding-block: 0;        /* UAの上下パディングをリセット */
  padding-top: 2px;        /* 少しだけ上へ（必要なら 1–4px で微調整） */
}

/* date入力の内側余白（Chrome系）をさらに抑える */
.pill input[type="date"]::-webkit-datetime-edit {
  padding: 0;
  line-height: 1.2;
}
.pill input[type="date"]::-webkit-datetime-edit-fields-wrapper {
  line-height: 1.2;
}

.pill select,.pill input{ border:0; outline:0; width:100%; height:100%; background:transparent; font:inherit }
.pill svg{ flex:0 0 auto; width:20px; height:20px; opacity:.65 }
.pill.big{ height:56px; border-radius:999px; padding:0 18px; }
.searchbtn{
  height:56px; border-radius:16px; font-weight:900;
}
/* Keep code but hide currency picker (LKR fixed) */
#currencySelect{ display:none; }
/* --- Header new look --- */
.nav-right{ display:flex; align-items:center; gap:14px }

/* テキストリンク風 */
.nav-link{
  font-weight:800; letter-spacing:.01em;
  color:#17353a; text-decoration:none; padding:4px 0;
}
.nav-link:hover{ text-decoration:underline }
.nav-link:active{ opacity:.8 }

/* ここから差し替え */
.icon-btn{
  --avatar-size: 44px;           /* ←好きなサイズに一括調整できる変数 */
  width: var(--avatar-size);
  height: var(--avatar-size);
  border-radius: 999px;
  border: 1.5px solid color-mix(in oklab, var(--ink) 35%, white);
  background: #fff;
  display: grid;
  place-items: center;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0,0,0,.06);
  position: relative;            /* ←中のimgを四隅0でフィットさせるため */
  overflow: hidden;              /* ←ボタンの丸でトリミング */
  padding: 0;                    /* 念のため */
}

.icon-btn > .avatar{
  position: absolute;
  inset: 0;                      /* 上下左右ぜんぶ0＝ボタンと同サイズ */
  width: 100%;
  height: 100%;
  object-fit: cover;             /* 写真のはみ出しはトリミングして埋める */
  display: block;
  border-radius: 0;              /* 切り抜きは親のoverflowでやる */
}
/* ここまで差し替え */

/* 旗付きの言語ピル */
.lang-pill{
  display:inline-flex; align-items:center; gap:8px;
  height:38px; padding:0 10px; border-radius:12px;
  background:#fff; border:1px solid var(--stroke);
  box-shadow:0 2px 8px rgba(0,0,0,.04);
}
.lang-pill .flag{ font-size:18px; line-height:1 }
.langSel{
  border:0; background:transparent; font:inherit; font-weight:800;
  padding:0; outline:0; appearance:none;
}
.lang-pill .caret{ width:16px; height:16px; opacity:.6 }

/* ヒーロー上配置時の微調整：旧ボタン依存を無効化 */
body.hero-header .nav-right .btn,
body.hero-header .nav-right .btn.primary{ background:transparent; border:0; box-shadow:none }

/* レスポンシブ（狭い幅） */
@media (max-width:560px){
  .nav-right{ gap:10px }
  .nav-link{ font-weight:700 }
  .icon-btn{ width:40px; height:40px }
}
/* === Auth nav typography (Signup / Login だけ) === */
#navSignup, #navLogin{
  /* 日本語を“しっかり太く・綺麗に”見せる組み合わせ */
  font-family: "Zen Kaku Gothic New","M PLUS Rounded 1c","Inter","Noto Sans JP",system-ui,sans-serif;
  font-weight: 900;                 /* しっかり太く */
  letter-spacing: .03em;            /* ほんの少しだけ字間を広げる */
  font-feature-settings: "palt" 1;  /* かなのプロポーショナル詰め（対応フォントで効く） */
  text-underline-offset: 4px;       /* hover時の下線位置をおしゃれに */
  text-decoration-thickness: 2px;
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
}

/* ほんのり効かせるだけ（色・レイアウトは変えない） */
#navSignup:hover, #navLogin:hover{
  text-decoration: underline;
  opacity: .95;
}

/* モバイルは少し軽めに */
@media (max-width: 560px){
  #navSignup, #navLogin{ font-weight: 800; letter-spacing: .02em; }
}

.topbar{
  background: transparent !important;
  border: 0 !important;
  box-shadow: none !important;
  height: auto;            /* 帯の高さ固定を解除 */
  padding: 0;              /* 余白を最小に */
}
  /* === PC幅では検索バーを1列に並べ、均等配置にする === */
@media (min-width: 981px){
  /* 親フォームを6カラム（ピル×5 + ボタン）に */
  .searchbar form{
    display: grid;
    grid-template-columns: repeat(5, minmax(0, 1fr)) 220px; /* 最後は検索ボタンの幅 */
    gap: 10px;
    align-items: center;
  }
  /* 子ラッパーを“透過”させて、中の要素を親グリッドに直接参加させる */
  .searchgrid,
  .searchrow2{
    display: contents;  /* 中の label.pill や .searchbtn を同じ列に流し込む */
  }
  /* ボタンの高さをピルに合わせる（見た目揃え） */
  .searchrow2 .searchbtn{
    height: 56px;      /* .pill.big と同じ高さ */
  }
}
/* === FIX: 旧4カラム指定を無効化して、新レイアウトを素直に効かせる === */
.searchbar form{
  display: block;         /* ← これで内側 .searchgrid / .searchrow2 が主役になる */
}

/* （オプション）PC幅での見た目だけ少し整える：ボタン高さ合わせ */
@media (min-width: 980px){
  .searchrow2 .searchbtn{ height:56px; }
}
/* === FIX: 旧4カラム指定を無効化して、新レイアウトを素直に効かせる === */
.searchbar form{
  display: block;         /* ← これで内側 .searchgrid / .searchrow2 が主役になる */
}

/* （オプション）PC幅での見た目だけ少し整える：ボタン高さ合わせ */
@media (min-width: 980px){
  .searchrow2 .searchbtn{ height:56px; }
}
/* === PC幅では 6 等分（ピル×5 + 検索ボタン）にして完全に均等化 === */
@media (min-width: 980px){
  /* 既存の4カラム指定を上書き */
  .searchwrap .searchbar form{
    display: grid;
    grid-template-columns: repeat(6, 1fr); /* 6等分 */
    gap: 10px;
    align-items: center;
  }
  /* 中の2つのラッパーを“透過”させて、子要素を親グリッドに直接流し込む */
  .searchwrap .searchgrid,
  .searchwrap .searchrow2{
    display: contents;
  }
  /* ボタン高さをピルに合わせる（見た目揃え） */
  .searchwrap .searchrow2 .searchbtn{
    height: 56px;
  }
}
/* === Cute round "US" language pill === */
.lang-pill{
  position:relative;
  display:inline-flex; align-items:center; gap:10px;
  height:44px; padding:0 14px 0 12px;
  border-radius:999px;
  background:#fff; border:1px solid var(--stroke);
  box-shadow:0 8px 20px rgba(0,0,0,.08);
  font-weight:800;
}
.lang-pill .flag{ font-size:18px; line-height:1 }
.lang-pill .abbr{ font-size:16px; letter-spacing:.02em }
.lang-pill .caret{ width:16px; height:16px; opacity:.6 }

/* ネイティブselectは pill 全体に透明で被せて操作だけ担当 */
.langSel{
  position:absolute; inset:0; width:100%; height:100%;
  opacity:0; appearance:none; border:0; background:transparent; cursor:pointer;
}
/* === Lang pill fixes === */
/* ヒーローレイアウト時は“ピル本体”を配置し、selectはピルの中で全面透明 */
body.hero-header .lang-pill{
  position:absolute; left:16px; top:108px; z-index:9;
}
/* 既存の body.hero-header #langSelect の位置指定を無効化して、ピル内に広げる */
body.hero-header #langSelect{
  position:absolute; inset:0;       /* ピルの内側いっぱい */
  left:auto; top:auto; right:auto; bottom:auto;
  width:100%; height:100%;
  opacity:0; appearance:none; border:0; background:transparent; cursor:pointer;
}
/* モバイル位置（既存ルールの上書き） */
@media (max-width:820px){
  body.hero-header .lang-pill{ left:auto; right:12px; top:76px }
}
/* ===== Language pill: complete override ===== */

/* ピルの見た目（白い丸・影・太字） */
.lang-pill{
  position:relative;
  display:inline-flex; align-items:center; gap:10px;
  height:44px; padding:0 14px 0 12px;
  border-radius:9999px;
  background:#fff;
  border:1px solid var(--stroke, #E7E7E7);
  box-shadow:0 8px 22px rgba(0,0,0,.08);
  color:#2B2B2B;
  font-weight:800;
  line-height:1;
}

/* 中の要素サイズ */
.lang-pill .flag{ font-size:18px }
.lang-pill .abbr{ font-size:16px; letter-spacing:.02em }
.lang-pill .caret{ width:16px; height:16px; opacity:.6 }

/* ネイティブ <select> は“透明で全面に被せる”だけ（操作担当） */
.langSel{
  position:absolute; inset:0;
  width:100%; height:100%;
  opacity:0; appearance:none !important;
  border:0; background:transparent; cursor:pointer;
}

/* 位置：通常ヘッダーでは右上。ヒーローヘッダー時は既存デザイン通り左上寄り */
header .lang-pill{ position:absolute; right:16px; top:14px; z-index:9; }
body.hero-header .lang-pill{ left:16px; right:auto; top:108px; }

/* 既存の “#langSelect を単独で動かす” ルールを打ち消す（重要） */
#langSelect{ position:absolute; inset:0; left:auto; top:auto; right:auto; bottom:auto; }

/* モバイル時の位置（必要なら） */
@media (max-width:820px){
  body.hero-header .lang-pill{ left:auto; right:12px; top:76px; }
}
.hero-head p{
  margin-bottom: 8px;       /* ← まず 8px。もっと詰めるなら 4–6px */
}
  .icon-btn img.avatar{
  width:100%; height:100%;
  border-radius:999px; object-fit:cover; display:block;
}
/* --- inline search history dropdown --- */
.history-pop{
  position: relative;
  grid-column: 1 / -1;            /* PCでは検索行の下に横断表示 */
  margin-top: -6px;
}
@media (min-width: 980px){
  .history-pop{ grid-column: 1 / span 6; }  /* いまの6分割レイアウトに沿う */
}
.history-pop[data-open="1"]::before{
  /* ほんのり境界線 */
  content:"";
  display:block;
  height:6px;
}
.history-pop .hlist{
  position:absolute; left:0; right:0; z-index:20;
  background:#fff; border:1px solid var(--stroke); border-radius:12px;
  box-shadow:0 10px 24px rgba(0,0,0,.12); overflow:hidden;
}
.history-pop .hitem{
  display:flex; gap:8px; align-items:center;
  width:100%; padding:10px 12px; border:0; background:#fff; text-align:left; cursor:pointer;
}
.history-pop .hitem:hover{ background:#f7f3ea; }
.history-pop .hitem .meta{ font-size:12px; color:#6b5e55 }
/* === Fix: search history dropdown is clipped === */
.searchbar{
  overflow: visible;            /* 親のクリッピングを解除 */
}

/* 見やすさ向上：余白・行間・最大高さ・スクロール */
.history-pop .hlist{
  top: 6px;                     /* ピルと少し離す（position:absolute） */
  z-index: 1000;                /* カードの上に出す */
  max-height: 260px;            /* はみ出しは内部スクロール */
  overflow: auto;
}

.history-pop .hitem{
  padding: 12px 14px;
}

.history-pop .hitem > div{
  line-height: 1.4;             /* 行間を確保して“割れ”防止 */
  word-break: break-word;       /* 長い語でのはみ出しを抑制 */
}

.history-pop .hitem .meta{
  margin-top: 2px;
  opacity: .8;
}
  /* === History list: use the same font as the hero title === */
.history-pop .hlist,
.history-pop .hitem .title{
  font-family: "Shippori Mincho","Playfair Display", serif; /* 見出しと同系 */
  font-weight: 700;
  letter-spacing: .01em;
}

/* 行の右端に × ボタン */
.history-pop .hitem{
  position: relative;
}
.history-pop .hitem .del{
  margin-left: auto;
  flex: 0 0 auto;
  width: 28px;
  height: 28px;
  border: 0;
  border-radius: 999px;
  background: transparent;
  cursor: pointer;
  font-size: 18px;
  line-height: 1;
  opacity: .5;
}
.history-pop .hitem .del:hover{ opacity: .9; background: #f2efe8; }

</style>
  <script src="lang.js" defer></script>
<script>document.addEventListener('DOMContentLoaded',()=>BL_I18N.i18nApply());</script>
</head>
<body class="hero-header bg-radials">

<header>
  <div class="container hwrap">
    <a class="brand-left" href="./index.html" aria-label="BeautyLanka">
      <img class="logo-img" src="/assets/img/logo_mark.png" alt="BeautyLanka logo">
    </a>
    <nav class="nav-right">
  <!-- 旗付きの言語ピル -->
  <div class="lang-pill">
    <span class="flag" id="langFlag">🇯🇵</span>
    <select id="langSelect" class="langSel" title="Language">
      <option value="auto">Auto</option>
      <option value="ja">日本語</option>
      <option value="en">English</option>
    </select>
     <span class="abbr" id="langAbbr">US</span>
    <svg class="caret" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 9l6 6 6-6" fill="currentColor"/></svg>
  </div>

  <!-- テキストリンク風（IDは維持：既存JSが動く） -->
  <a class="nav-link" id="navSignup" data-i18n="auth.signup">新規登録</a>
  <a class="nav-link" id="navLogin"  data-i18n="auth.login">ログイン</a>

  <!-- 丸アイコンのマイページ（ID維持） -->
  <button class="icon-btn" id="navMypage" aria-label="マイページ">
    <img class="avatar" src="/assets/img/mypage_avatar.png" alt="" />
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <circle cx="12" cy="8" r="3" fill="currentColor"/>
      <path d="M4 20c1.5-4 6.5-5 8-5s6.5 1 8 5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>
</nav>

  </div>
</header>

<div class="container"><nav class="breadcrumbs" aria-label="Breadcrumb"></nav></div>

<section class="hero-visual">
  <div class="hero-head">
    <div class="container">
      <img class="hero-sri" src="/assets/img/sri-outline.svg" alt="Sri Lanka outline decorative" />
      <h1 data-i18n="hero_title">スリランカで叶える、私だけの美しさ。</h1>
      <p data-i18n="hero_sub">ヘア・ネイル・まつ毛・アーユルヴェーダ・マッサージ/スパ。口コミと予約。</p>
    </div>
  </div>
  <!-- Category quick chips (UI only; #type を連動させる) -->
<div class="chipbar" id="chipbar">
  <!-- テキストは言語切替でJS側が上書きします -->
  <button class="chip" data-cat-ja="アーユルヴェーダ">アーユルヴェーダ</button>
  <button class="chip" data-cat-ja="マッサージ/スパ">マッサージ/スパ</button>
  <button class="chip" data-cat-ja="ヘア">ヘア</button>
  <button class="chip" data-cat-ja="まつ毛">まつ毛</button>
  <button class="chip" data-cat-ja="ネイル">ネイル</button>
</div>
</section>

<div class="grain" aria-hidden="true"></div>

<div class="container">
  <div class="searchwrap">
  <section class="searchbar" aria-label="検索">
    <form id="searchForm">
  <!-- 上段：場所 / メニュー / 日時 / 金額 -->
  <div class="searchgrid">
    <label class="pill" aria-label="場所">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 22s8-7.16 8-12a8 8 0 1 0-16 0c0 4.84 8 12 8 12Zm0-9a3 3 0 1 1 0-6 3 3 0 0 1 0 6Z"/></svg>
      <select id="place">
        <option value="" data-i18n="search.place">場所</option>
      </select>
    </label>

    <label class="pill" aria-label="メニュー">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 6h16M4 12h16M4 18h10" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
      <select id="type">
        <option value="" data-i18n="search.type">メニュー</option>
      </select>
    </label>

    <label class="pill" aria-label="日時">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 3v4M17 3v4M3 9h18M5 7h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
      <input id="date" type="date" placeholder="">
    </label>

    <label class="pill" aria-label="金額">
      <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" fill="none"/><path d="M9 9h6m-6 3h6m-6 3h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      <select id="budget">
        <option value="">金額</option>
        <option value="0-5000">〜 Rs 5,000</option>
        <option value="5000-10000">Rs 5,000–10,000</option>
        <option value="10000-20000">Rs 10,000–20,000</option>
        <option value="20000-999999">Rs 20,000+</option>
      </select>
    </label>
  </div>

  <!-- 下段：キーワード + 検索ボタン -->
  <div class="searchrow2">
    <label class="pill big" aria-label="キーワード">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
      <input id="kw" type="search" data-i18n="search.ph_kw" placeholder="サロン名・メニュー名など">
    </label>
    <!-- キーワードピルの直後に追加 -->
<div id="searchHistoryInline" class="history-pop" role="listbox" aria-label="検索履歴"></div>
    <button class="btn primary searchbtn reserve-btn" type="submit" data-i18n="search_btn">検索する</button>
  </div>
</form>

  </section>
</div>
  
  <!-- results -->
<section class="container">
  <div id="list" class="grid" aria-live="polite"></div>
</section>

<!-- fullscreen intro splash (first visit per session) -->
<div id="splash" class="splash" role="dialog" aria-label="Intro video">
  <video id="splashVid" playsinline autoplay muted>
    <source id="splashSrc" src="/assets/video/hero.mp4" type="video/mp4" />
  </video>
  <div class="headline">
    <img class="sri-center" src="/assets/img/sri-outline.svg" alt="Sri Lanka line art">
    <h1>Beauty Lanka</h1>
    <div class="cap">Salons &amp; Spas in Sri Lanka</div>
  </div>
  <button class="skip" id="skipSplash">Skip</button>
</div>
<img class="sri2" src="/assets/img/sri-outline.svg" alt="">

<button id="toTop" aria-label="Back to top" title="Back to top">↑</button>

<script>
// ---------- auth helpers ----------
function getAuth(){ try{ return JSON.parse(localStorage.getItem('bl_auth')||'null'); }catch(e){ return null; } }
function requireAuth(redirectUrl){
  const auth = getAuth();
  if(auth) return true;
  if(confirm('お気に入りや予約を行うにはログインが必要です。ログインしますか？')){
    const url = 'login.html?redirect=' + encodeURIComponent(redirectUrl||location.href);
    location.href = url;
  }
  return false;
}
// ---------- i18n ----------
function enPoints(s){
  if(!s) return '';
  let x = String(s);
  x = x.replace(/自然で長持ち。?丁寧なカウンセリング。?/g, 'Naturally long‑lasting with attentive consultation.');
  x = x.replace(/本格アーユルヴェーダと静かな個室。?/g, 'Authentic Ayurveda in a tranquil private room.');
  x = x.replace(/自社?ブレンドのハーブでリラックス。?/g, 'Relax with our original blended herbs.');
  x = x.replace(/日本語対応/g, 'Japanese support available');
  x = x.replace(/落ち着いた(雰囲気|空間)。?/g, 'Calm, relaxing atmosphere.');
  x = x.replace(/丁寧(な)?施術。?/g, 'Meticulous, high‑care treatment.');
  x = x.replace(/。/g, '. ').replace(/\s+/g,' ').trim();
  if(x) x = x.charAt(0).toUpperCase() + x.slice(1);
  return x;
}
function enTag(t){const map={'マツエク':'Lashes','スパ':'Spa','ハーブ':'Herbs','日本語対応':'Japanese support'};return map[t]||t;}
function getLang(){
  const pref = localStorage.getItem('bl_lang') || 'auto';
  if(pref==='auto'){
    const ja = (navigator.language||'en').toLowerCase().startsWith('ja');
    return ja ? 'ja' : 'en';
  }
  return pref;
}

// ---------- Currency helpers (JPY -> target) ----------
const RATES = { JPY:1, USD:0.0067, EUR:0.0061, LKR:2.05 };
function getCurrency(){ return (localStorage.getItem('bl_currency') || 'JPY'); }
function fmtCurrencyFromJPY(jpy, cur){
  const n = Math.max(0, Number(jpy)||0);
  const rate = RATES[cur] || 1;
  const converted = Math.round(n * rate);
  try{
    return new Intl.NumberFormat(getLang()==='ja' ? 'ja-JP':'en-US', {
      style:'currency', currency: cur, maximumFractionDigits:0
    }).format(converted);
  }catch(e){
    const symbols = {JPY:'¥', USD:'$', EUR:'€', LKR:'Rs '};
    return (symbols[cur]||'') + converted.toLocaleString();
  }
}

// Robust photo resolver
function resolvePhoto(src){
  if(!src) return "/assets/img/placeholder.webp";
  if(/^https?:\/\//i.test(src)) return src;
  let s = String(src).replace(/\\/g,'/').replace(/\/{2,}/g,'/');
  if(!s.startsWith('/')) s = '/' + s;
  return s;
}
function altCandidates(src){
  const list = [src];
  if(src.includes('/assets/img/')) list.push(src.replace('/assets/img/','/assets/images/'));
  if(src.includes('/assets/images/')) list.push(src.replace('/assets/images/','/assets/img/'));
  return Array.from(new Set(list));
}

const T = {
  ja: {
    hero_title: 'スリランカで叶える、私だけの美しさ。',
    hero_sub: 'ヘア・ネイル・まつ毛・アーユルヴェーダ・マッサージ/スパ。口コミと予約。',
    ph_kw: 'キーワード（例：まつ毛、スパ）',
    search_btn: '検索',
    login: 'ログイン', signup:'新規登録', mypage:'マイページ',
    place: '場所', type: '種類',
    price_hint: '料金目安', details:'詳細', book:'予約へ進む', view_map:'地図で見る', only_this_store:'（この店舗だけ）', recommend_points:'おすすめポイント：'
  },
  en: {
    hero_title: 'Unveiling My True Beauty in Sri Lanka',
    hero_sub: 'Hair, nails, lashes, Ayurveda, massage/spa. Reviews and booking.',
    ph_kw: 'Keywords (e.g., lashes, spa)',
    search_btn: 'Search',
    login:'Log in', signup:'Sign up', mypage:'My Page',
    place: 'Area', type: 'Category',
    price_hint: 'From', details:'Details', book:'Book', view_map:'View map', only_this_store:'(this shop only)', recommend_points:'Highlights: '
  }
};
function t(k){ const L=getLang(); return (T[L]&&T[L][k])||k; }
function applyI18N(){
  const L = getLang();
  document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.dataset.i18n; if(T[L][k]) el.textContent=T[L][k]; });
  document.querySelectorAll('[data-ph]').forEach(el=>{ const k=el.dataset.ph; if(T[L][k]) el.setAttribute('placeholder', T[L][k]); });
  document.getElementById('navLogin').textContent = T[L].login;
  document.getElementById('navSignup').textContent= T[L].signup;
  document.getElementById('navMypage').setAttribute('area-label', T[L].mypage);
  const placeOpt=document.querySelector('#place option[value=""]'); if(placeOpt) placeOpt.textContent=T[L].place;
  const typeOpt=document.querySelector('#type option[value=""]'); if(typeOpt) typeOpt.textContent=T[L].type;
}
function updateLangFlag(){
  var f  = document.getElementById('langFlag');
  var ab = document.getElementById('langAbbr');
  var pref = (localStorage.getItem('bl_lang') || 'auto');
  var isJa = (navigator.language||'en').toLowerCase().startsWith('ja');

  if(pref === 'auto'){
    if(f)  f.textContent  = isJa ? '🇯🇵' : '🇺🇸';
    if(ab) ab.textContent = isJa ? 'JP'  : 'US';
  }else{
    var ja = (pref === 'ja');
    if(f)  f.textContent  = ja ? '🇯🇵' : '🇺🇸';
    if(ab) ab.textContent = ja ? 'JP'  : 'US';
  }
}

document.addEventListener('DOMContentLoaded', updateLangFlag);
(function(){
  const sel = document.getElementById('langSelect');
  const pref = localStorage.getItem('bl_lang') || 'auto';
  sel.value = pref;
  sel.onchange = ()=>{ localStorage.setItem('bl_lang', sel.value); location.reload(); };
  applyI18N();
})();
</script>
  <script>
// header nav + user pill
(function navInit(){
  const auth = getAuth();
  const loginBtn = document.getElementById('navLogin');
  const signupBtn= document.getElementById('navSignup');
  const myBtn    = document.getElementById('navMypage');
  if(auth && auth.email){
    loginBtn.style.display='none'; signupBtn.style.display='none';
    const pill = document.createElement('span');
    pill.className='btn'; pill.style.background='#fff'; pill.style.cursor='default';
    pill.textContent = auth.email;
    const logout = document.createElement('button'); logout.className='btn'; logout.textContent=(getLang()==='ja'?'ログアウト':'Logout');
    logout.onclick=()=>{ localStorage.removeItem('bl_auth'); location.reload(); };
    myBtn.parentNode.insertBefore(pill, myBtn);
    myBtn.onclick=()=>location.href='mypage.html';
    myBtn.parentNode.insertBefore(logout, myBtn.nextSibling);
  }else{
    loginBtn.onclick=()=>location.href='login.html?redirect='+encodeURIComponent(location.href);
    signupBtn.onclick=()=>location.href='signup.html?redirect='+encodeURIComponent(location.href);
    myBtn.onclick=()=>location.href='mypage.html';
  }
})();

(function(){
  const sel = document.getElementById('currencySelect');
  if(!sel) return; // ← 無ければ何もしない（ここが重要）
  sel.value = (localStorage.getItem('bl_currency') || 'JPY');
  sel.onchange = () => {
    localStorage.setItem('bl_currency', sel.value);
    updateCardCurrencies();
  };
})();

// ---------- Card rendering ----------
function yen(n){ return "¥"+(Number(n)||0).toLocaleString("ja-JP"); }
const $=s=>document.querySelector(s); const list=$('#list');

function cardTemplate(s, favOn){
  const L = getLang();
  // 言語別の tags / points を素直に使う
  const tags = (L === 'en' ? (s.tagsEn   || s.tags)   : (s.tagsJa   || s.tags));
  let   pts  = (L === 'en' ? (s.pointsEn || s.points) : (s.pointsJa || s.points));
  // 英語側が空のときだけ日本語→英語の簡易変換にフォールバック
  if (L==='en' && (!pts || !pts.trim())) pts = enPoints(s.points||'');

  // 画像の重複候補をまとめてユニーク化
  const photos = (s.photos||[]).concat((s.photos||[]).map(src=>src.replace('/assets/img/','/assets/images/')));
  const uniqPhotos = [...new Set(photos)];

  const priceStr = fmtCurrencyFromJPY(s.price, getCurrency());

  return `<article class="card" data-id="${s.id}" data-lat="${s.lat}" data-lng="${s.lng}">
    <div class="media">
      <div class="carousel">${uniqPhotos.map((src,i)=>`<img src="${src}" alt="${s.name} photo ${i+1}">`).join('')}</div>
      <div class="nav"><button class="prev">‹</button><button class="next">›</button></div>
    </div>
    <div class="body">
      <h3 class="title">${s.name}</h3>
      <div class="rowmeta">
        <div>${t('price_hint')} <b data-jpy="${s.price}">${priceStr}</b></div>
        <div class="star">★ ${Number(s.rating||0).toFixed(1)}${s._rcnt>0?`<span class="small"> (${s._rcnt})</span>`:''}</div>
      </div>
      <div class="tags">${(tags||[]).map(tg=>`<a class="tag" href="details.html?salonId=${encodeURIComponent(s.id)}">${tg}</a>`).join('')}</div>
      <div class="points">${t('recommend_points')}${pts}</div>
      <div class="foot">
        <button class="btn small reserve-btn" onclick="location.href='details.html?salonId=${encodeURIComponent(s.id)}'">${t('details')}</button>
        <div class="actions">
          <button class="heart ${favOn?'active':''}" title="Favorite" data-fav="${s.id}" aria-pressed="${favOn?'true':'false'}"><span class="ico">${favOn?'❤':'♡'}</span></button>
          <button class="btn small primary reserve-btn" data-reserve="${s.id}" data-name="${s.name}">${t('book')}</button>
        </div>
      </div>
    </div>
    <div class="map-toggle"><button class="btn reserve-btn" data-map="toggle">${t('view_map')}</button> <span class="small">${t('only_this_store')}</span></div>
    <div class="mapwrap"><div class="map">
      <iframe loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      <div class="overlay"><button class="map-btn reserve-btn" data-dir>Directions on Google</button></div>
    </div></div>
  </article>`;
}

function readJSON(k, def){ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(def)); }catch(e){ return def; } }
function writeJSON(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
function favIds(){ const a1=readJSON('bl_favs', []); const a2=readJSON('favorites', []); return Array.from(new Set(a1.concat(a2))); }
function render(items){
  const favset = new Set(favIds());
  list.innerHTML = items.map(s => cardTemplate(s, favset.has(s.id))).join('');
  attachHandlers();
  updateCardCurrencies();
}
/* --- Force LKR display globally (keep old code intact) --- */
try{
  // LKRレートだけ必要。下の値は例（適宜GAS側と合わせる運用でOK）
  if (typeof RATES === 'object') { RATES.LKR = RATES.LKR || 2.05; }
  localStorage.setItem('bl_currency','LKR');
  window.getCurrency = function(){ return 'LKR'; };
  // 既に描画済みカードの価格も再描画
  if (typeof updateCardCurrencies === 'function') {
    updateCardCurrencies();
  }
}catch(e){}

function updateCardCurrencies(){
  document.querySelectorAll('b[data-jpy]').forEach(el=>{
    const j = Number(el.getAttribute('data-jpy')||'0');
    el.textContent = fmtCurrencyFromJPY(j, getCurrency());
  });
}

function attachHandlers(){
  document.querySelectorAll('.card').forEach(card=>{
    const car=card.querySelector('.carousel'); const imgs=car.querySelectorAll('img');
    let idx=0; function go(i){ idx=(i+imgs.length)%imgs.length; car.scrollTo({left:car.clientWidth*idx,behavior:'smooth'}); }
    card.querySelector('.prev').onclick=()=>go(idx-1);
    card.querySelector('.next').onclick=()=>go(idx+1);
    const mapWrap=card.querySelector('.mapwrap'); const btn=card.querySelector('[data-map="toggle"]');
    const lat=card.dataset.lat, lng=card.dataset.lng;
    btn.onclick=()=>{
      mapWrap.classList.toggle('show');
      const article = card.closest('article.card');
      if(mapWrap.classList.contains('show')){
        const iframe=mapWrap.querySelector('iframe');
        iframe.src = `https://www.google.com/maps?q=${lat},${lng}&z=15&hl=${getLang()}&output=embed`;
        article && article.classList.add('show-map');
      }else{
        article && article.classList.remove('show-map');
      }
    };
    card.querySelector('[data-dir]').onclick=()=>window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving&hl=${getLang()}`,'_blank');
  });
  // fav
  document.querySelectorAll('[data-fav]').forEach(btn=>{
    const ico=btn.querySelector('.ico'); if(ico){ ico.textContent = btn.classList.contains('active') ? '❤' : '♡'; }
    btn.onclick = ()=>{
      if(!requireAuth(location.href)) return;
      const id = btn.getAttribute('data-fav');
      let ids = favIds();
      const set = new Set(ids);
      const meta = readJSON('bl_fav_meta', {});
      const salon = DATA_FALLBACK.find(x=>x.id===id) || _DATA_CURRENT.find(x=>x.id===id);
      if(btn.classList.contains('active')){
        set.delete(id); delete meta[id]; btn.classList.remove('active'); btn.setAttribute('aria-pressed','false'); if(ico) ico.textContent='♡';
      }else{
        set.add(id); meta[id] = { name: salon?.name || ('Salon #'+id), photo: (salon?.photos && salon.photos[0]) || "" };
        btn.classList.add('active'); btn.setAttribute('aria-pressed','true'); if(ico) ico.textContent='❤';
      }
      ids = Array.from(set);
      writeJSON('bl_favs', ids); writeJSON('favorites', ids); writeJSON('bl_fav_meta', meta);
    };
  });
  // reserve buttons (gate)
  document.querySelectorAll('[data-reserve]').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.reserve, name = btn.dataset.name;
      const url = `reservation.html?salonId=${encodeURIComponent(id)}&salonName=${encodeURIComponent(name)}`;
      if(!requireAuth(url)) return;
      location.href = url;
    };
  });
}

// ==== GAS catalog + review summary ====
const GAS_URL = 'https://script.google.com/macros/s/AKfycbwJz67fvPpB1tJ7IWggPFWJ-2tBydVOHikzFvviS36_8LOD8YW7jn3vWjWF9f3ngomH/exec';
const GAS_KEY = 'bl_gas_key_bR6ZXWwu6kM_nrK25geP97Cs5qCX3auxugX_IUGlg90';

async function loadCatalog(){
  const url = GAS_URL + '?kind=catalog&key=' + encodeURIComponent(GAS_KEY);
  const res = await fetch(url, { method:'GET' });
  const j = await res.json();
  if(!j.ok) throw new Error(j.error||'catalog error');
  return j.items || [];
}
async function fetchReviewSummary(){
  const url = GAS_URL + '?kind=reviews&key=' + encodeURIComponent(GAS_KEY);
  const r   = await fetch(url); const j=await r.json();
  if(!j.ok) return {};
  return j.summary || {};
}
function normalizeForUI(raw, L){
  const tagsEn = String(raw.tags_en||'').split('|').map(s=>s.trim()).filter(Boolean);
  const tagsJa = String(raw.tags_ja||'').split('|').map(s=>s.trim()).filter(Boolean);
  const pointsEn = raw.points_en || '';
  const pointsJa = raw.points_ja || '';

  const points = (L==='en' ? pointsEn : pointsJa);
  const tags   = (L==='en' ? tagsEn   : tagsJa);

  return {
    id: raw.id,
    name: (L==='en' ? (raw.name_en||raw.name_ja) : (raw.name_ja||raw.name_en)),
    type: (L==='en' ? (raw.type_en||raw.type_ja) : (raw.type_ja||raw.type_en)),
    place:(L==='en' ? (raw.place_en||raw.place_ja): (raw.place_ja||raw.place_en)),
    typeJa:(raw.type_ja||raw.type_en||''),
    placeJa:(raw.place_ja||raw.place_en||''),
    lat: raw.lat, lng: raw.lng,
    price: raw.price_jpy,
    rating: raw.rating || 0,
    tags,            // 画面用
    tagsEn,          // 言語別を持たせておく
    tagsJa,
    points,          // 画面用
    pointsEn,
    pointsJa,
    photos: Array.isArray(raw.photos) ? raw.photos : []
  };
}

let _DATA_CURRENT = [];
async function initCatalog(){
  const L = getLang();
  try{
    const rows = await loadCatalog();
    const summary = await fetchReviewSummary();
    _DATA_CURRENT = rows.map(r=>{
      const x = normalizeForUI(r, L);
      const s = summary[r.id] || null;
      if (s && s.count>0){
        x.rating = s.avg;
        x._rcnt  = s.count;
      }
      return x;
    });
    render(_DATA_CURRENT);
    updateCardCurrencies();
  }catch(e){
    console.warn('catalog load failed, falling back to bundled DATA', e);
    render(DATA_FALLBACK);
    updateCardCurrencies();
  }
}

// ==== Fallback DATA ====
const DATA_FALLBACK=[
  {id:"S1", name:"Silky Lashes Colombo", type:"マツエク", place:"コロンボ", lat:6.933, lng:79.85, price:4250, rating:4.6, tags:["マツエク","日本語対応"], points:"自然で長持ち。丁寧なカウンセリング。", photos:["/assets/img/lashes_a.webp","/assets/img/lashes_b.webp","/assets/img/lashes_c.webp"]},
  {id:"S2", name:"Ayur Luxe Spa", type:"スパ", place:"ゴール", lat:6.025, lng:80.217, price:6630, rating:4.7, tags:["アーユルヴェーダ","リラク"], points:"本格アーユルヴェーダと静かな個室。", photos:["/assets/img/spa_massage.webp","/assets/img/herbs_flatlay.webp","/assets/img/lashes_a.webp"]},
  {id:"S3", name:"Cinnamon Grow", type:"ハーブ", place:"キャンディ", lat:7.293, lng:80.641, price:5610, rating:4.5, tags:["ハーブ","リラク"], points:"自社ブレンドのハーブでリラックス。", photos:["/assets/img/herbs_flatlay.webp","/assets/img/spa_massage.webp","/assets/img/lashes_b.webp"]}
];
  
DATA_FALLBACK.forEach(s=>{
  s.typeJa  = s.type;
  s.placeJa = s.place;
  // 追加：英語タグを持たせる（既存の簡易マップを活用）
  s.tagsEn  = (s.tags || []).map(enTag);
});

// ==== Filters ====
function initFilters(dataSource){
  const major = ["コロンボ","ゴール","キャンディ","ヌワラエリヤ","ジャフナ","アルガンベイ","ミリッサ","ウナワトゥナ","トリンコマリー"];
  const types  = Array.from(new Set(dataSource.map(x=>x.type))).sort();
  const placeSel = document.getElementById('place');
  const typeSel  = document.getElementById('type');
  placeSel.insertAdjacentHTML('beforeend', major.map(p=>`<option>${p}</option>`).join(''));
  typeSel.insertAdjacentHTML('beforeend', types.map(t=>`<option>${t}</option>`).join(''));
  document.getElementById('searchForm').addEventListener('submit', (ev)=>{
    ev.preventDefault();
    const kw = (document.getElementById('kw').value||'').toLowerCase();
    const place = placeSel.value;
    const type  = typeSel.value;
    const src = (_DATA_CURRENT && _DATA_CURRENT.length>0) ? _DATA_CURRENT : DATA_FALLBACK;
    const items = src.filter(s=>
  (!place || s.placeJa===place) &&
  (!type  || s.typeJa===type) &&
  (!kw || (String(s.name).toLowerCase().includes(kw)
        || String(s.points||'').toLowerCase().includes(kw)
        || (s.tags||[]).join(',').toLowerCase().includes(kw)))
);

    render(items);
    const hist = readJSON('bl_search_history', []);
    hist.unshift({ place, type, date:'', guests:'', ts: Date.now() });
    writeJSON('bl_search_history', hist.slice(0,50));
  });
}

/// --- robust splash boot: full-screen overlay, center line art, scroll lock ---
(function(){
  try{
    const wrap = document.getElementById('splash');
    if(!wrap) return;

    // すでに見た or クエリで明示回避（?nosplash=1）の場合は即撤去
    if (sessionStorage.getItem('bl_intro_seen') === '1' ||
        new URLSearchParams(location.search).get('nosplash') === '1') {
      wrap.remove();
      return;
    }

    const vid  = document.getElementById('splashVid');
    const src  = document.getElementById('splashSrc');
    const skip = document.getElementById('skipSplash');

    // 表示＆スクロールロック
    wrap.classList.add('show');
    document.body.classList.add('no-scroll');

    // 1stソースが失敗したらローカル代替に切替（多重切替防止フラグ）
    let triedLocal = false;
    vid.addEventListener('error', ()=>{
      if (!triedLocal) {
        triedLocal = true;
        // 初期は /assets/video/hero.mp4 を使っているので、代替は同梱の ./hero.mp4 に切替（無ければ無視されるだけ）
        src.src = './hero.mp4';
        vid.load();
        vid.play().catch(()=>{});
      }
    }, { once: true });

    // 終了共通処理
    function end(){
      sessionStorage.setItem('bl_intro_seen','1');
      wrap.classList.remove('show');
      document.body.classList.remove('no-scroll');
      setTimeout(()=>wrap.remove(), 200);
    }

    // 安全タイムアウト（10秒で強制終了）
    const hardTimeout = setTimeout(end, 10000);

    // 読み込み開始が取れたら5秒で自動終了（= 長尺でも引っ張りすぎない）
    vid.addEventListener('loadeddata', ()=>{
      clearTimeout(hardTimeout);
      setTimeout(end, 5000);
    }, { once: true });

    // 動画自然終了・スキップ押下でも閉じる（多重発火防止のためonce）
    vid.addEventListener('ended', end,  { once: true });
    skip.addEventListener('click', end, { once: true });

    // iOS対策含めとりあえず再生トライ（失敗しても問題なし）
    vid.play().catch(()=>{});
  }catch(e){
    console.warn('splash init failed', e);
  }
})();


// Card click → details
document.addEventListener('click', function(e){
  const card = e.target.closest('.card');
  if(!card) return;
  if(e.target.closest('button') || e.target.closest('a') || e.target.closest('.actions') || e.target.closest('.heart')) return;
  const pref=(localStorage.getItem('bl_lang')||'').toLowerCase();
  const q=new URLSearchParams({salonId:card.dataset.id});
  if(pref==='en') q.set('lang','en');
  location.href='details.html?'+q.toString();
});

// i18n-aware Area/Category injection
const MAJOR_JA = ['コロンボ','ゴール','キャンディ','ヌワラエリヤ','ジャフナ','アルガンベイ','ミリッサ','ウナワトゥナ','トリンコマリー'];
const AREA_MAP = {
  'コロンボ':'Colombo','ゴール':'Galle','キャンディ':'Kandy','ヌワラエリヤ':'Nuwara Eliya',
  'ジャフナ':'Jaffna','アルガンベイ':'Arugam Bay','ミリッサ':'Mirissa','ウナワトゥナ':'Unawatuna','トリンコマリー':'Trincomalee'
};
const CATS_JA = ['ヘア','ネイル','まつ毛','アーユルヴェーダ','マッサージ/スパ'];
const CAT_MAP = {
  'ヘア':'Hair','ネイル':'Nails','まつ毛':'Lashes','アーユルヴェーダ':'Ayurveda','マッサージ/スパ':'Massage/Spa'
};
function fillSelect(sel, list, placeholderJa, placeholderEn){
  if(!sel) return;
  const L = getLang();
  const placeholder = (L==='en' ? placeholderEn : placeholderJa);
  const prev = sel.value;
  sel.innerHTML = '';
  const opt0 = document.createElement('option');
  opt0.value = ''; opt0.textContent = placeholder; sel.appendChild(opt0);
  (list||[]).forEach(v=>{
    const o = document.createElement('option');
    o.value = v; // 値は日本語のまま（既存フィルタ互換）
    o.textContent = (L==='en'
      ? (sel.id==='place' ? (AREA_MAP[v]||v) : (CAT_MAP[v]||v))
      : v);
    sel.appendChild(o);
  });
  if(prev && Array.from(sel.options).some(o=>o.value===prev)) sel.value = prev;
}
function refreshFiltersFrom(){
  try{
    fillSelect(document.getElementById('place'), MAJOR_JA, '場所', 'Area');
    fillSelect(document.getElementById('type'),  CATS_JA,  '種類', 'Category');
  }catch(e){ console.warn('refreshFiltersFrom failed', e); }
}
if(typeof render==='function'){
  const __renderOrig = render;
  render = function(items){ __renderOrig(items); try{ refreshFiltersFrom(items); }catch(e){} };
}
(function attachI18nSubmit(){
  try{
    const form = document.getElementById('searchForm');
    form.addEventListener('submit', function(){
      const kw = (document.getElementById('kw').value||'').toLowerCase();
      const placeSel = document.getElementById('place').value;
      const typeSel  = document.getElementById('type').value;
      const src = (typeof _DATA_CURRENT!=='undefined' && Array.isArray(_DATA_CURRENT) && _DATA_CURRENT.length>0) ? _DATA_CURRENT : DATA_FALLBACK;
      const items = src.filter(s=>
  (!placeSel || s.placeJa===placeSel) &&
  (!typeSel  || s.typeJa===typeSel) &&
  (!kw || (String(s.name).toLowerCase().includes(kw)
        || String(s.points||'').toLowerCase().includes(kw)
        || (s.tags||[]).join(',').toLowerCase().includes(kw)))
);

      render(items);
    });
  }catch(e){ console.warn('attachI18nSubmit failed', e); }
})();

// Skeletons while loading
function showSkeletons(n=6){
  const nodes = Array.from({length:n}).map(()=>`<div class="skeleton-card"><div class="skel-media"></div><div class="skel-lines"><div class="skel-line w80"></div><div class="skel-line w60"></div><div class="skel-line w40"></div></div></div>`).join('');
  document.getElementById('list').innerHTML = nodes;
}

// Init filters & initial UI then fetch data
initFilters(DATA_FALLBACK);
showSkeletons(6);
initCatalog();

// Back to top button
(function(){
  const btn = document.getElementById('toTop');
  const onScroll = ()=>{ if(window.scrollY>300) btn.classList.add('show'); else btn.classList.remove('show'); };
  window.addEventListener('scroll', onScroll, {passive:true});
  btn.addEventListener('click', ()=>window.scrollTo({top:0, behavior:'smooth'}));
  onScroll();
})();
</script>
<script>
/* === Chip <-> select (#type) binding + i18n labels === */
(function initChips(){
  const el = document.getElementById('chipbar');
  if(!el) return;
  const typeSel = document.getElementById('type');

  // 表示文字列（英語UI時の見た目だけ英語化。値は常に日本語で持つ）
  const LABEL_MAP_EN = {
    'アーユルヴェーダ':'Ayurveda',
    'マッサージ/スパ':'Massage/Spa',
    'ヘア':'Hair',
    'まつ毛':'Lashes',
    'ネイル':'Nails'
  };

  function refreshChipLabels(){
    const L = getLang();
    el.querySelectorAll('.chip').forEach(ch=>{
      const ja = ch.getAttribute('data-cat-ja');
      ch.textContent = (L==='en') ? (LABEL_MAP_EN[ja]||ja) : ja;
    });
  }
  refreshChipLabels();
　  // 追加：セレクト変更→チップのactive状態を同期
  typeSel.addEventListener('change', ()=>{
    const val = typeSel.value || '';
    el.querySelectorAll('.chip').forEach(ch=>{
      const ja = ch.getAttribute('data-cat-ja')||'';
      ch.classList.toggle('active', val && ja===val);
    });
  });

  // クリックで#type選択 → すぐ検索。再クリックで解除。
  el.addEventListener('click', (e)=>{
    const btn = e.target.closest('.chip');
    if(!btn) return;
    const jaVal = btn.getAttribute('data-cat-ja') || '';
    const active = btn.classList.contains('active');

    // すべてのチップからactive外し、今回押したものだけ付与（トグルで解除も可）
    el.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    if(!active){
      btn.classList.add('active');
      typeSel.value = jaVal;
    }else{
      typeSel.value = '';
    }

    // 既存のsubmitロジックを活用して検索
    document.getElementById('searchForm').dispatchEvent(new Event('submit',{cancelable:true}));
  });

  // 言語切替でラベル更新（既存のBL_I18N呼び出し後でも見た目を同期）
  document.addEventListener('DOMContentLoaded', refreshChipLabels);
})();
</script>
<script>

(function(){
  const bar = document.getElementById('chipbar');
  if(!bar) return;
  const form = document.getElementById('searchForm');
  const selType = document.getElementById('type');

  // 英語UI時の見た目ラベル（値は data-cat-ja を使用）
  const LABEL_EN = {
    'アーユルヴェーダ':'Ayurveda',
    'マッサージ/スパ':'Massage/Spa',
    'ヘア':'Hair','まつ毛':'Lashes','ネイル':'Nails'
  };
  const getLang = ()=> (localStorage.getItem('bl_lang')||'auto')==='ja' ? 'ja'
                          : ((navigator.language||'en').toLowerCase().startsWith('ja')?'ja':'en');

  function refreshChipLabels(){
    const L = getLang();
    bar.querySelectorAll('.chip').forEach(ch=>{
      const ja = ch.getAttribute('data-cat-ja')||'';
      ch.textContent = (L==='en' ? (LABEL_EN[ja]||ja) : ja);
    });
  }
  refreshChipLabels();

  bar.addEventListener('click', (e)=>{
    const btn = e.target.closest('.chip');
    if(!btn) return;
    const jaVal = btn.getAttribute('data-cat-ja')||'';
    const active = btn.classList.contains('active');
    bar.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    if(!active){
      btn.classList.add('active');
      selType.value = jaVal;         // 値は日本語
    }else{
      selType.value = '';
    }
    // 既存の検索ロジックを呼ぶ
    if(form.requestSubmit) form.requestSubmit();
    else form.dispatchEvent(new Event('submit',{cancelable:true}));
  });
})();
// ====== 検索履歴（保存＆インライン表示） ======
(function(){
  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

  const KEY = 'bl_search_history';

  function readHist(){
    try{ return JSON.parse(localStorage.getItem(KEY) || '[]'); }catch(e){ return []; }
  }
  function writeHist(arr){
    localStorage.setItem(KEY, JSON.stringify(arr));
  }
  function saveHistory(entry){
    const hist = readHist();
    const sig = JSON.stringify({
      place: entry.place||'',
      type: entry.type||'',
      date: entry.date||'',
      budget: entry.budget||'',
      kw: entry.kw||''
    });
    const filtered = hist.filter(r =>
      JSON.stringify({
        place: r.place||'',
        type: r.type||'',
        date: r.date||'',
        budget: r.budget||'',
        kw: r.kw||''
      }) !== sig
    );
    filtered.unshift(entry);
    writeHist(filtered.slice(0, 50));
  }

  // ---- i18n helpers for the history row ----
  function getLangSafe(){
    try{ return (typeof getLang==='function' ? getLang() : (localStorage.getItem('bl_lang')||'auto')); }catch(e){ return 'auto'; }
  }
  function i18nDefaults(){
    const L = getLangSafe();
    const isJa = (L==='ja') || (L==='auto' && (navigator.language||'en').toLowerCase().startsWith('ja'));
    return isJa
      ? { place:'場所未指定', type:'種類未指定', date:'日付なし', budget:'金額', kw:'キーワード' }
      : { place:'Area not set', type:'Category not set', date:'No date', budget:'Budget', kw:'Keywords' };
  }

  const box    = $('#searchHistoryInline');
  const place  = $('#place');
  const type   = $('#type');
  const date   = $('#date');
  const budget = $('#budget');
  const kw     = $('#kw');
  const form   = $('#searchForm');

  if(box && form && place && type && date && budget && kw){
    function fmtRow(r){
      const D = i18nDefaults();
      const p = r.place  || D.place;
      const t = r.type   || D.type;
      const d = r.date   || D.date;
      const b = r.budget ? ` / ${r.budget}` : '';
      const k = r.kw     ? ` / ${r.kw}`     : '';
      return `${p} / ${t} / ${d}${b}${k}`;
    }
/* ...前半の関数/定数は既存のまま... */

function renderInline(){
  const list = readHist().slice(0,5); // 最新5件
  if(!list.length){
    box.removeAttribute('data-open');
    box.innerHTML = '';
    return;
  }
  const items = list.map((r,i)=>(
    `<button type="button" class="hitem" data-i="${i}">
       <div>
         <div class="title">${fmtRow(r)}</div>
         <div class="meta">${new Date(r.ts||Date.now()).toLocaleString()}</div>
       </div>
       <button type="button" class="del" aria-label="Delete this search" data-del="${i}">×</button>
     </button>`
  )).join('');

  box.setAttribute('data-open','1');
  box.innerHTML = `<div class="hlist" role="listbox" aria-label="Recent searches">${items}</div>`;

  // クリックで各フィールドへ反映
  $$('.hitem', box).forEach(btn=>{
    btn.addEventListener('click', (ev)=>{
      // ×クリックは反映させない
      if(ev.target.closest('.del')) return;

      const i = Number(btn.getAttribute('data-i')||0);
      const r = readHist()[i];
      if(!r) return;
      place.value  = r.place  || '';
      type.value   = r.type   || '';
      date.value   = r.date   || '';
      budget.value = r.budget || '';
      kw.value     = r.kw     || '';

      box.removeAttribute('data-open');
      box.innerHTML = '';
    });
  });

  // ×で対象行だけ削除 → 再描画
  $$('.del', box).forEach(x=>{
    x.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      const i = Number(x.getAttribute('data-del')||0);
      const hist = readHist();
      hist.splice(i,1);
      writeHist(hist);
      renderInline(); // 再描画
    });
  });
}
</script>

<footer>Build v2025-09-18i • Visual refresh add‑on v1</footer>
</body>
</html>
