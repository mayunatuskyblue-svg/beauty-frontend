<!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BeautyLanka | 検索</title>
<link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@600;700&family=Zen+Kaku+Gothic+New:wght@400;500;700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@800&family=Zen+Kaku+Gothic+New:wght@700;900&family=RocknRoll+One&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --base:#F7F1E1; --ink:#2E1A16; --stroke:#eadfca; --teal:#246A73; --muted:#6f5a54; --blue:#0A66FF;
  --chip:#fff8ef; --danger:#74070E;
  --space-1:8px; --space-2:12px; --space-3:16px; --space-4:20px; --space-5:24px;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--base);color:var(--ink);
  font-family:"Inter","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
.container{max-width:1200px;margin:0 auto;padding:0 16px}
a{color:inherit;text-decoration:none}

/* header */
header{position:sticky;top:0;z-index:40;background:rgba(247,241,225,.92);backdrop-filter:blur(6px);border-bottom:1px solid var(--stroke)}
.hwrap{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:10px 0}
.brand-left{display:flex;align-items:center;gap:10px;text-decoration:none}
.logo-img{width:140px;height:auto;border-radius:14px;box-shadow:0 10px 24px rgba(36,106,115,.18)}
.nav-right{display:flex;gap:8px;align-items:center}
.btn{height:38px;border-radius:12px;border:1px solid var(--stroke);background:#fff;padding:0 12px;font-weight:700;cursor:pointer}
.btn.primary{background:var(--teal);border-color:var(--teal);color:#fff;box-shadow:0 6px 14px rgba(36,106,115,.18)}
.sel{height:38px;border-radius:12px;border:1px solid var(--stroke);padding:0 10px;background:#fff;font-weight:700}

/* hero header (gradient + headline) */
.hero-visual{position:relative;margin:0 0 8px}
.hero-head{background:linear-gradient(180deg,#b8e7e0, #e1f3f0 60%, transparent); padding:48px 0 24px; position:relative; overflow:hidden}
.hero-head h1{font-family:"Shippori Mincho'",sans-serif;font-weight:800;font-size:44px;letter-spacing:.02em;text-align:center;margin:0 0 6px;color:#17353a;text-shadow:0 1px 0 rgba(255,255,255,.6)}
.hero-head p{opacity:.9;text-align:center;margin:18px 0 0}
@media(max-width:820px){ .hero-head h1{font-size:32px} }

/* search bar */
.searchbar{margin:-18px auto 8px;background:#fff;border:1px solid var(--stroke);border-radius:14px;box-shadow:0 10px 24px rgba(49,14,16,.08);padding:12px;max-width:960px}
.searchbar form{display:grid;grid-template-columns:2fr 1.3fr 1.3fr auto;gap:8px;align-items:center}
.searchbar input,.searchbar select{height:40px;border-radius:10px;border:1px solid var(--stroke);padding:0 10px;font:inherit;background:#fff}
@media(max-width:980px){.searchbar form{grid-template-columns:1fr 1fr 1fr} .searchbar button{grid-column:span 3;}}
@media(max-width:640px){.searchbar form{grid-template-columns:1fr 1fr} .searchbar button{grid-column:span 2;}}

/* grid cards */
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:22px;margin:12px 0 26px}
@media(max-width:1020px){ .grid{grid-template-columns:repeat(2,1fr)} }
@media(max-width:680px){ .grid{grid-template-columns:1fr} }
.card{background:#fff;border:1px solid var(--stroke);border-radius:18px;overflow:visible;box-shadow:0 10px 24px rgba(49,14,16,.08);display:flex;flex-direction:column;transition:transform .3s ease, box-shadow .3s ease}
.card:hover{transform:translateY(-6px) scale(1.02);box-shadow:0 10px 20px rgba(0,0,0,.15)}
.media{position:relative;border-top-left-radius:18px;border-top-right-radius:18px;overflow:hidden;background:#000}
.media .carousel{display:flex;overflow-x:hidden;scroll-snap-type:x mandatory}
.media .carousel img{height:220px;width:100%;object-fit:cover;flex:0 0 100%;scroll-snap-align:center}
.media .nav{position:absolute;inset:0;display:flex;justify-content:space-between;align-items:center;pointer-events:none}
.media .nav button{pointer-events:auto;border:none;background:rgba(0,0,0,.35);width:40px;height:40px;border-radius:999px;color:#fff;font-size:18px;cursor:pointer}
.body{padding:12px 18px 14px}
.title{font-weight:900;font-size:18px;margin:0 0 4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rowmeta{display:flex;align-items:center;gap:8px;color:#6b5e55;font-size:13px;flex-wrap:wrap}
.star{color:#C08B1B;font-weight:900}
.tags{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
.tag{padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);font-size:12px;background:#fff;cursor:pointer; transition: transform .06s ease, background-color .2s ease, box-shadow .2s ease; }
.tag.pressed { transform: translateY(1px) scale(0.98); box-shadow: inset 0 2px 6px rgba(0,0,0,.08); }
.points{color:#3f342f;font-size:13px;line-height:1.6;margin:6px 0;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.foot{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
.actions{display:flex;gap:10px;align-items:center}
.heart{width:40px;height:40px;border:1px solid var(--stroke);border-radius:999px;background:#fff;display:grid;place-items:center;cursor:pointer;margin-right:4px}
.heart .ico{font-size:18px;line-height:1}
.heart.active{outline:3px solid color-mix(in oklab, var(--teal) 45%, white)}

/* map preview */
.mapwrap{display:none}
.mapwrap.show{display:block}
.map{position:relative;height:180px;border-top:1px solid var(--stroke);background:#eef2f3}
.map iframe{width:100%;height:100%;border:0;border-bottom-left-radius:18px;border-bottom-right-radius:18px}
.map .overlay{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%)}
.map .map-btn{background:var(--blue);color:#fff;border:none;border-radius:12px;padding:12px 18px;font-weight:900;cursor:pointer;box-shadow:0 10px 18px rgba(10,102,255,.22)}
.map-toggle{margin:0 14px 10px 14px}
.small{font-size:12px;color:var(--muted)}
footer{color:#6b5e55;text-align:center;font-size:12px;margin:12px 0}

/* fullscreen intro splash */
.splash{position:fixed;inset:0;background:#000;display:none;align-items:center;justify-content:center;z-index:9999;color:#fff}
.splash.show{display:flex}
.splash video{position:absolute;inset:0;width:100vw;height:100vh;object-fit:cover;filter:brightness(.55)}
.splash .skip{position:absolute;right:16px;bottom:16px;background:rgba(255,255,255,.92);border:0;border-radius:999px;padding:10px 14px;font-weight:900;cursor:pointer;color:#17353a}
.splash .headline{position:relative;text-align:center}
.splash .headline h1{font-family:"Shippori Mincho",serif;font-size:64px;letter-spacing:.02em;margin:0 0 12px}
.splash .headline .cap{opacity:.9}
.splash .headline .sri-inline{display:none}
.splash .sri-between-splash{display:flex;justify-content:center;margin:10px 0 12px}
.splash .sri-between-splash img{width:120px;opacity:.9;filter:drop-shadow(0 4px 8px rgba(0,0,0,.4))}
@media(max-width:820px){.splash .sri-between-splash img{width:72px}}
@media(max-width:820px){ .splash .headline h1{font-size:40px} .splash .headline .sri-inline{width:56px} }

/* second Sri outline (page decoration) */
.sri2{position:fixed;left:3%;bottom:3%;width:140px;opacity:.12;pointer-events:none;filter:drop-shadow(0 6px 10px rgba(0,0,0,.2))}
.card{transition:transform 0.3s ease, box-shadow 0.3s ease;}
.card:hover{transform:translateY(-6px) scale(1.02);box-shadow:0 10px 20px rgba(0,0,0,0.15);}

/* breadcrumbs & header controls */
.breadcrumbs { display:flex; gap:.5rem; align-items:center; font-size:.9rem; color: var(--muted); margin: .5rem 0 1rem; }
.breadcrumbs a { color: inherit; text-decoration: none; }
.breadcrumbs a[aria-current="page"] { color: var(--ink); font-weight: 600; }
.breadcrumbs .sep { opacity:.6; }
.header-controls { display:flex; gap:.5rem; align-items:center; }
.header-controls select { border:1px solid var(--stroke); background:white; padding:.4rem .6rem; border-radius:10px; font-size:.95rem; }

/* Keep button content centered robustly */
.btn, button, a.btn, input[type="button"].btn, input[type="submit"].btn {
  display:inline-flex; align-items:center; justify-content:center; line-height:1; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.btn .ico, button .ico { display:inline-flex; align-items:center; gap:.4em; }

/* === Uniform card & button sizing === */
.card{display:flex;flex-direction:column; height:100%;}
.card .body{flex:1; display:flex; flex-direction:column;}
.card .foot{margin-top:auto;}
.grid{align-items:stretch;}
.btn.primary, .btn.reserve-btn, .btn.small{min-height:40px; padding:0 16px; font-weight:700; display:inline-flex; align-items:center; justify-content:center;}
.btn.primary.reserve-btn{min-width:90px;}


/* === Fixed card height === */
.card{ height: 520px; overflow: hidden; }
.card.show-map{ height: auto; } /* when map is opened, allow expansion */
.media .carousel img{ height: 240px; } /* a bit taller hero image for balance */
.points{ -webkit-line-clamp: 3; } /* ensure text truncation stays tidy */


/* --- Splash overlay hardening --- */
.splash{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:#000; z-index:999999; color:#fff}
.splash.show{display:flex}
.splash video{position:absolute; inset:0; width:100vw; height:100vh; object-fit:cover; filter:brightness(.55)}
.splash .skip{position:absolute; right:16px; bottom:16px; background:rgba(255,255,255,.92); border:0; border-radius:999px; padding:10px 14px; font-weight:900; cursor:pointer; color:#17353a}
.splash .headline{position:relative; text-align:center; display:flex; flex-direction:column; align-items:center; gap:10px}
.splash .sri-center{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(30vw, 220px); opacity:.9; filter:drop-shadow(0 6px 20px rgba(0,0,0,.45)); pointer-events:none}
body.no-scroll{overflow:hidden}

</style>
</head>
<body>
<header>
  <div class="container hwrap">
    <a class="brand-left" href="./index.html" aria-label="BeautyLanka">
      <img class="logo-img" src="/assets/img/logo_mark.png" alt="BeautyLanka logo">
    </a>
    <nav class="nav-right">
      <select id="langSelect" class="sel" title="Language"><option value="auto">Auto</option><option value="ja">日本語</option><option value="en">English</option></select>
      <button class="btn reserve-btn" id="navLogin">ログイン</button>
      <button class="btn primary reserve-btn" id="navSignup">新規登録</button>
      <button class="btn reserve-btn" id="navMypage">マイページ</button>
    </nav>
  </div>
  <div class="header-controls container">
    <label class="small" style="opacity:.7">Currency</label>
    <select id="currencySelect">
      <option value="USD">USD</option>
      <option value="JPY">JPY</option>
      <option value="LKR">LKR</option>
      <option value="EUR">EUR</option>
    </select>
  </div>
</header>

<div class="container"><nav class="breadcrumbs" aria-label="Breadcrumb"></nav></div>

<section class="hero-visual">
  <div class="hero-head">
    <div class="container">
      <h1 data-i18n="hero_title">スリランカで叶える、私だけの美しさ。</h1>
      <p data-i18n="hero_sub">ヘア・ネイル・まつ毛・アーユルヴェーダ・マッサージ/スパ。口コミと予約。</p>
    </div>
  </div>
</section>

<div class="container">
  <section class="searchbar" aria-label="検索">
    <form id="searchForm">
      <input id="kw" type="search" data-ph="ph_kw" placeholder="キーワード（例：まつ毛、スパ）">
      <select id="place"><option value="">場所</option></select>
      <select id="type"><option value="">種類</option></select>
      <button class="btn primary reserve-btn" type="submit" data-i18n="search_btn">検索</button>
    </form>
  </section>
  <div class="grid" id="list"></div>
</div>

<!-- fullscreen intro splash (first visit per session) -->
<div id="splash" class="splash" role="dialog" aria-label="Intro video">
  <video id="splashVid" playsinline autoplay muted>
    <source id="splashSrc" src="/assets/video/hero.mp4" type="video/mp4" />
  </video>
  <div class="headline">
    <img class="sri-center" src="/assets/img/sri-outline.svg" alt="Sri Lanka line art">
    <h1>Beauty Lanka</h1>
    <div class="cap">Salons &amp; Spas in Sri Lanka</div>
  </div>
  <button class="skip" id="skipSplash">Skip</button>
</div>
<img class="sri2" src="/assets/img/sri-outline.svg" alt="">

<script>
// ---------- auth helpers ----------
function getAuth(){ try{ return JSON.parse(localStorage.getItem('bl_auth')||'null'); }catch(e){ return null; } }
function requireAuth(redirectUrl){
  const auth = getAuth();
  if(auth) return true;
  if(confirm('お気に入りや予約を行うにはログインが必要です。ログインしますか？')){
    const url = 'login.html?redirect=' + encodeURIComponent(redirectUrl||location.href);
    location.href = url;
  }
  return false;
}

// ---------- i18n ----------
function enPoints(s){
  if(!s) return '';
  let x = String(s);
  x = x.replace(/自然で長持ち。?丁寧なカウンセリング。?/g, 'Naturally long‑lasting with attentive consultation.');
  x = x.replace(/本格アーユルヴェーダと静かな個室。?/g, 'Authentic Ayurveda in a tranquil private room.');
  x = x.replace(/自社?ブレンドのハーブでリラックス。?/g, 'Relax with our original blended herbs.');
  x = x.replace(/日本語対応/g, 'Japanese support available');
  x = x.replace(/落ち着いた(雰囲気|空間)。?/g, 'Calm, relaxing atmosphere.');
  x = x.replace(/丁寧(な)?施術。?/g, 'Meticulous, high‑care treatment.');
  x = x.replace(/。/g, '. ').replace(/\\s+/g,' ').trim();
  if(x) x = x.charAt(0).toUpperCase() + x.slice(1);
  return x;
}
function enTag(t){const map={'マツエク':'Lashes','スパ':'Spa','ハーブ':'Herbs','日本語対応':'Japanese support'};return map[t]||t;}
function getLang(){
  const pref = localStorage.getItem('bl_lang') || 'auto';
  if(pref==='auto'){
    const ja = (navigator.language||'en').toLowerCase().startsWith('ja');
    return ja ? 'ja' : 'en';
  }
  return pref;
}

// ---------- Currency helpers (JPY -> target) ----------
const RATES = { JPY:1, USD:0.0067, EUR:0.0061, LKR:2.05 };
function getCurrency(){ return (localStorage.getItem('bl_currency') || 'JPY'); }
function fmtCurrencyFromJPY(jpy, cur){
  const n = Math.max(0, Number(jpy)||0);
  const rate = RATES[cur] || 1;
  const converted = Math.round(n * rate);
  try{
    return new Intl.NumberFormat((getLang()==='ja'?'ja-JP':'en-US'), {
      style:'currency', currency: cur, maximumFractionDigits:0
    }).format(converted);
  }catch(e){
    const symbols = {JPY:'¥', USD:'$', EUR:'€', LKR:'Rs '};
    return (symbols[cur]||'') + converted.toLocaleString();
  }
}
const T = {
  ja: {
    hero_title: 'スリランカで叶える、私だけの美しさ。',
    hero_sub: 'ヘア・ネイル・まつ毛・アーユルヴェーダ・マッサージ/スパ。口コミと予約。',
    ph_kw: 'キーワード（例：まつ毛、スパ）',
    search_btn: '検索',
    login: 'ログイン', signup:'新規登録', mypage:'マイページ',
    place: '場所', type: '種類',
    price_hint: '料金目安', details:'詳細', book:'予約へ進む', view_map:'地図で見る', only_this_store:'（この店舗だけ）', recommend_points:'おすすめポイント：'
  },
  en: {
    hero_title: 'Unveiling My True Beauty in Sri Lanka',
    hero_sub: 'Hair, nails, lashes, Ayurveda, massage/spa. Reviews and booking.',
    ph_kw: 'Keywords (e.g., lashes, spa)',
    search_btn: 'Search',
    login:'Log in', signup:'Sign up', mypage:'My Page',
    place: 'Area', type: 'Category',
    price_hint: 'From', details:'Details', book:'Book', view_map:'View map', only_this_store:'(this shop only)', recommend_points:'Highlights: '
  }
};
function t(k){ const L=getLang(); return (T[L]&&T[L][k])||k; }
function applyI18N(){
  const L = getLang();
  document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.dataset.i18n; if(T[L][k]) el.textContent=T[L][k]; });
  document.querySelectorAll('[data-ph]').forEach(el=>{ const k=el.dataset.ph; if(T[L][k]) el.setAttribute('placeholder', T[L][k]); });
  document.getElementById('navLogin').textContent = T[L].login;
  document.getElementById('navSignup').textContent= T[L].signup;
  document.getElementById('navMypage').textContent= T[L].mypage;
  const placeOpt=document.querySelector('#place option[value=""]'); if(placeOpt) placeOpt.textContent=T[L].place;
  const typeOpt=document.querySelector('#type option[value=""]'); if(typeOpt) typeOpt.textContent=T[L].type;
}
(function(){
  const sel = document.getElementById('langSelect');
  const pref = localStorage.getItem('bl_lang') || 'auto';
  sel.value = pref;
  sel.onchange = ()=>{ localStorage.setItem('bl_lang', sel.value); location.reload(); };
  applyI18N();
})();

// header nav + user pill
(function navInit(){
  const auth = getAuth();
  const loginBtn = document.getElementById('navLogin');
  const signupBtn= document.getElementById('navSignup');
  const myBtn    = document.getElementById('navMypage');
  if(auth && auth.email){
    loginBtn.style.display='none'; signupBtn.style.display='none';
    const pill = document.createElement('span');
    pill.className='btn'; pill.style.background='#fff'; pill.style.cursor='default';
    pill.textContent = auth.email;
    const logout = document.createElement('button'); logout.className='btn'; logout.textContent=(getLang()==='ja'?'ログアウト':'Logout');
    logout.onclick=()=>{ localStorage.removeItem('bl_auth'); location.reload(); };
    myBtn.parentNode.insertBefore(pill, myBtn);
    myBtn.onclick=()=>location.href='mypage.html';
    myBtn.parentNode.insertBefore(logout, myBtn.nextSibling);
  }else{
    loginBtn.onclick=()=>location.href='login.html?redirect='+encodeURIComponent(location.href);
    signupBtn.onclick=()=>location.href='signup.html?redirect='+encodeURIComponent(location.href);
    myBtn.onclick=()=>location.href='mypage.html';
  }
})();

// ---------- Currency (list-level conversion live) ----------
(function(){ const sel=document.getElementById('currencySelect'); sel.value=(localStorage.getItem('bl_currency')||'JPY'); sel.onchange=()=>{ localStorage.setItem('bl_currency', sel.value); updateCardCurrencies(); }; })();

// ---------- Card rendering ----------
function yen(n){ return "¥"+(Number(n)||0).toLocaleString("ja-JP"); }
const $=s=>document.querySelector(s); const list=$('#list');
function cardTemplate(s, favOn){
  const L = getLang();
  let tags = (L==='en' && s.tagsEn ? s.tagsEn : s.tags);
  if(L==='en' && (!s.tagsEn || !s.tagsEn.length)){ tags = (s.tags||[]).map(enTag); }
  let pts  = (L==='en' ? (s.pointsEn || enPoints(s.points||'')) : s.points);
  const photos = (s.photos||[]).concat((s.photos||[]).map(src=>src.replace('/assets/img/','/assets/images/')));
  const uniqPhotos = [...new Set(photos)];
  const priceStr = fmtCurrencyFromJPY(s.price, getCurrency());
  return `<article class="card" data-id="${s.id}" data-lat="${s.lat}" data-lng="${s.lng}">
    <div class="media">
      <div class="carousel">${uniqPhotos.map((src,i)=>`<img src="${src}" alt="${s.name} photo ${i+1}">`).join('')}</div>
      <div class="nav"><button class="prev">‹</button><button class="next">›</button></div>
    </div>
    <div class="body">
      <h3 class="title">${s.name}</h3>
      <div class="rowmeta">
        <div>${t('price_hint')} <b data-jpy="${s.price}">${priceStr}</b></div>
        <div class="star">★ ${Number(s.rating||0).toFixed(1)}${s._rcnt>0?`<span class="small"> (${s._rcnt})</span>`:''}</div>
      </div>
      <div class="tags">${(tags||[]).map(tg=>`<a class="tag" href="details.html?salonId=${encodeURIComponent(s.id)}">${tg}</a>`).join('')}</div>
      <div class="points">${t('recommend_points')}${pts}</div>
      <div class="foot">
        <button class="btn small reserve-btn" onclick="location.href='details.html?salonId=${encodeURIComponent(s.id)}'">${t('details')}</button>
        <div class="actions">
          <button class="heart ${favOn?'active':''}" title="Favorite" data-fav="${s.id}" aria-pressed="${favOn?'true':'false'}"><span class="ico">${favOn?'❤':'♡'}</span></button>
          <button class="btn small primary reserve-btn" data-reserve="${s.id}" data-name="${s.name}">${t('book')}</button>
        </div>
      </div>
    </div>
    <div class="map-toggle"><button class="btn reserve-btn" data-map="toggle">${t('view_map')}</button> <span class="small">${t('only_this_store')}</span></div>
    <div class="mapwrap"><div class="map">
      <iframe loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      <div class="overlay"><button class="map-btn reserve-btn" data-dir>Directions on Google</button></div>
    </div></div>
  </article>`;
}
function readJSON(k, def){ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(def)); }catch(e){ return def; } }
function writeJSON(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
function favIds(){ const a1=readJSON('bl_favs', []); const a2=readJSON('favorites', []); return Array.from(new Set(a1.concat(a2))); }
function render(items){
  const favset = new Set(favIds());
  list.innerHTML = items.map(s => cardTemplate(s, favset.has(s.id))).join('');
  attachHandlers();
  updateCardCurrencies();
}

function updateCardCurrencies(){
  document.querySelectorAll('b[data-jpy]').forEach(el=>{
    const j = Number(el.getAttribute('data-jpy')||'0');
    el.textContent = fmtCurrencyFromJPY(j, getCurrency());
  });
}

function attachHandlers(){
  document.querySelectorAll('.card').forEach(card=>{
    const car=card.querySelector('.carousel'); const imgs=car.querySelectorAll('img');
    let idx=0; function go(i){ idx=(i+imgs.length)%imgs.length; car.scrollTo({left:car.clientWidth*idx,behavior:'smooth'}); }
    card.querySelector('.prev').onclick=()=>go(idx-1);
    card.querySelector('.next').onclick=()=>go(idx+1);
    const mapWrap=card.querySelector('.mapwrap'); const btn=card.querySelector('[data-map="toggle"]');
    const lat=card.dataset.lat, lng=card.dataset.lng;
    
btn.onclick=()=>{
  mapWrap.classList.toggle('show');
  const article = card.closest('article.card');
  if(mapWrap.classList.contains('show')){
    const iframe=mapWrap.querySelector('iframe');
    iframe.src = `https://www.google.com/maps?q=${lat},${lng}&z=15&hl=${getLang()}&output=embed`;
    article && article.classList.add('show-map');
  }else{
    article && article.classList.remove('show-map');
  }
};

    card.querySelector('[data-dir]').onclick=()=>window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving&hl=${getLang()}`,'_blank');
  });
  // fav
  document.querySelectorAll('[data-fav]').forEach(btn=>{
    const ico=btn.querySelector('.ico'); if(ico){ ico.textContent = btn.classList.contains('active') ? '❤' : '♡'; }
    btn.onclick = ()=>{
      if(!requireAuth(location.href)) return;
      const id = btn.getAttribute('data-fav');
      let ids = favIds();
      const set = new Set(ids);
      const meta = readJSON('bl_fav_meta', {});
      const salon = DATA_FALLBACK.find(x=>x.id===id) || _DATA_CURRENT.find(x=>x.id===id);
      if(btn.classList.contains('active')){
        set.delete(id); delete meta[id]; btn.classList.remove('active'); btn.setAttribute('aria-pressed','false'); if(ico) ico.textContent='♡';
      }else{
        set.add(id); meta[id] = { name: salon?.name || ('Salon #'+id), photo: (salon?.photos && salon.photos[0]) || "" };
        btn.classList.add('active'); btn.setAttribute('aria-pressed','true'); if(ico) ico.textContent='❤';
      }
      ids = Array.from(set);
      writeJSON('bl_favs', ids); writeJSON('favorites', ids); writeJSON('bl_fav_meta', meta);
    };
  });
  // reserve buttons (gate)
  document.querySelectorAll('[data-reserve]').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.dataset.reserve, name = btn.dataset.name;
      const url = `reservation.html?salonId=${encodeURIComponent(id)}&salonName=${encodeURIComponent(name)}`;
      if(!requireAuth(url)) return;
      location.href = url;
    };
  });
}

// ==== GAS catalog + review summary (best from index 2) ====
const GAS_URL = 'https://script.google.com/macros/s/AKfycbzEb8ji5P7OwietqSWWp0kfl_yXB1ZkRbQt8aVDxwXqkVuqCmdLQvSV-6Q9rLfms7Vf/exec';
const GAS_KEY = 'bl_gas_key_crUS1RnVC07WqAkdtzLfemDla3MBNxvTKsiJFOh5';

async function loadCatalog(){
  const url = GAS_URL + '?kind=catalog&key=' + encodeURIComponent(GAS_KEY);
  const res = await fetch(url, { method:'GET' });
  const j = await res.json();
  if(!j.ok) throw new Error(j.error||'catalog error');
  return j.items || [];
}
async function fetchReviewSummary(){
  const url = GAS_URL + '?kind=reviews&key=' + encodeURIComponent(GAS_KEY);
  const r   = await fetch(url); const j=await r.json();
  if(!j.ok) return {};
  return j.summary || {};
}
function normalizeForUI(raw, L){
  const tags = (L==='en'
    ? String(raw.tags_en||'').split('|')
    : String(raw.tags_ja||'').split('|')
  ).map(s=>s.trim()).filter(Boolean);
  const points = (L==='en' ? raw.points_en : raw.points_ja) || '';
  return {
    id:     raw.id,
    name:   (L==='en' ? (raw.name_en||raw.name_ja) : (raw.name_ja||raw.name_en)),
    type:   (L==='en' ? (raw.type_en||raw.type_ja) : (raw.type_ja||raw.type_en)),
    place:  (L==='en' ? (raw.place_en||raw.place_ja) : (raw.place_ja||raw.place_en)),
    lat:    raw.lat, lng: raw.lng,
    price:  raw.price_jpy,
    rating: raw.rating || 0,
    tags,
    points,
    photos: Array.isArray(raw.photos) ? raw.photos : []
  };
}
let _DATA_CURRENT = [];
async function initCatalog(){
  const L = getLang();
  try{
    const rows = await loadCatalog();
    const summary = await fetchReviewSummary();
    _DATA_CURRENT = rows.map(r=>{
      const x = normalizeForUI(r, L);
      const s = summary[r.id] || null;
      if (s && s.count>0){
        x.rating = s.avg;
        x._rcnt  = s.count;
      }
      return x;
    });
    render(_DATA_CURRENT);
    updateCardCurrencies();
  }catch(e){
    console.warn('catalog load failed, falling back to bundled DATA', e);
    render(DATA_FALLBACK);
updateCardCurrencies();
  }
}

// ==== Fallback DATA (from index 3) ====
const DATA_FALLBACK=[
  {id:"S1", name:"Silky Lashes Colombo", type:"マツエク", place:"コロンボ", lat:6.933, lng:79.85, price:4250, rating:4.6, tags:["マツエク","日本語対応"], points:"自然で長持ち。丁寧なカウンセリング。", photos:["/assets/img/lashes_a.webp","/assets/img/lashes_b.webp","/assets/img/lashes_c.webp"]},
  {id:"S2", name:"Ayur Luxe Spa", type:"スパ", place:"ゴール", lat:6.025, lng:80.217, price:6630, rating:4.7, tags:["アーユルヴェーダ","リラク"], points:"本格アーユルヴェーダと静かな個室。", photos:["/assets/img/spa_massage.webp","/assets/img/herbs_flatlay.webp","/assets/img/lashes_a.webp"]},
  {id:"S3", name:"Cinnamon Grow", type:"ハーブ", place:"キャンディ", lat:7.293, lng:80.641, price:5610, rating:4.5, tags:["ハーブ","リラク"], points:"自社ブレンドのハーブでリラックス。", photos:["/assets/img/herbs_flatlay.webp","/assets/img/spa_massage.webp","/assets/img/lashes_b.webp"]}
];

// ==== Filters ====
function initFilters(dataSource){
  const major = ["コロンボ","ゴール","キャンディ","ヌワラエリヤ","ジャフナ","アルガンベイ","ミリッサ","ウナワトゥナ","トリンコマリー"];
  const types  = Array.from(new Set(dataSource.map(x=>x.type))).sort();
  const placeSel = document.getElementById('place');
  const typeSel  = document.getElementById('type');
  placeSel.insertAdjacentHTML('beforeend', major.map(p=>`<option>${p}</option>`).join(''));
  typeSel.insertAdjacentHTML('beforeend', types.map(t=>`<option>${t}</option>`).join(''));
  document.getElementById('searchForm').addEventListener('submit', (ev)=>{
    ev.preventDefault();
    const kw = (document.getElementById('kw').value||'').toLowerCase();
    const place = placeSel.value;
    const type  = typeSel.value;
    const src = (_DATA_CURRENT && _DATA_CURRENT.length>0) ? _DATA_CURRENT : DATA_FALLBACK;
    const items = src.filter(s=>
      (!place || s.place===place) &&
      (!type  || s.type===type) &&
      (!kw || (String(s.name).toLowerCase().includes(kw) || String(s.points||'').toLowerCase().includes(kw) || (s.tags||[]).join(',').toLowerCase().includes(kw)))
    );
    render(items);
    const hist = readJSON('bl_search_history', []);
    hist.unshift({ place, type, date:'', guests:'', ts: Date.now() });
    writeJSON('bl_search_history', hist.slice(0,50));
  });
}

// ==== Splash (safer) ====
(function splash(){
  try{
    if(sessionStorage.getItem('bl_intro_seen')==='1') return;
    const wrap = document.getElementById('splash');
    const vid  = document.getElementById('splashVid');
    const src  = document.getElementById('splashSrc');
    const skip = document.getElementById('skipSplash');
    wrap.classList.add('show');
    vid.addEventListener('error', ()=>{ src.src='assets/video/hero.mp4'; vid.load(); vid.play().catch(()=>{}); }, {once:true});
    vid.play().catch(()=>{});
    function end(){ wrap.classList.remove('show'); document.body.classList.remove('no-scroll'); sessionStorage.setItem('bl_intro_seen','1'); }
    vid.addEventListener('ended', end);
    skip.addEventListener('click', end);
  }catch(e){}
})();


// Card click → details
document.addEventListener('click', function(e){
  const card = e.target.closest('.card');
  if(!card) return;
  if(e.target.closest('button') || e.target.closest('a') || e.target.closest('.actions') || e.target.closest('.heart')) return;
  const pref=(localStorage.getItem('bl_lang')||'').toLowerCase();
  const q=new URLSearchParams({salonId:card.dataset.id});
  if(pref==='en') q.set('lang','en');
  location.href='details.html?'+q.toString();
});

// Init filters with fallback, then fetch GAS catalog (will re-render on success)
initFilters(DATA_FALLBACK);
render(DATA_FALLBACK);
updateCardCurrencies();
initCatalog();

// --- Robust splash boot: full-screen overlay, center line art, scroll lock ---
(function(){
  try{
    const wrap = document.getElementById('splash');
    if(!wrap) return;
    if (sessionStorage.getItem('bl_intro_seen')==='1' ||
        new URLSearchParams(location.search).get('nosplash')==='1'){
      wrap.remove(); return;
    }
    const vid  = document.getElementById('splashVid');
    const src  = document.getElementById('splashSrc');
    const skip = document.getElementById('skipSplash');
    // show & lock scroll
    wrap.classList.add('show'); document.body.classList.add('no-scroll');
    // fallback source if first fails
    let triedLocal = false;
    vid.addEventListener('error', ()=>{
      if(!triedLocal){
        triedLocal = true;
        src.src = './hero.mp4';
        vid.load(); vid.play().catch(()=>{});
      }
    }, {once:true});
    function end(){
      sessionStorage.setItem('bl_intro_seen','1');
      wrap.classList.remove('show');
      document.body.classList.remove('no-scroll');
      setTimeout(()=>wrap.remove(), 200);
    }
    const hardTimeout = setTimeout(end, 10000); // safety
    vid.addEventListener('loadeddata', ()=>{ clearTimeout(hardTimeout); setTimeout(end, 5000); }, {once:true});
    vid.addEventListener('ended', end,  {once:true});
    skip.addEventListener('click', end, {once:true});
    vid.play().catch(()=>{});
  }catch(e){ console.warn('splash init failed', e); }
})();

</script>

<footer>Build v2025-09-18i</footer>
</body>
</html>
