<!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>予約の確認</title>
<link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:wght@500;600&family=Playfair+Display:wght@500;600&display=swap" rel="stylesheet">

<!-- Google Apps Script WebApp URL をここに（なければ URL 引数 ?gas=...&key=... を使用） -->
<meta name="bl-sheet-hook" content="https://script.google.com/macros/s/AKfycbwWRpfcZMsGxNqGJ5aNjRT1Y1PChDTqtQE3e0S7sUDAMei8s1wOr6lpKMnOaI1Z-6o/exec">
<style>
/* Elegant timetable typography */
#hpWeekTitle{font-family:'Playfair Display','Shippori Mincho',serif;font-weight:600;letter-spacing:.02em}
#hpGrid th{font-family:'Playfair Display','Bodoni Moda',serif;font-weight:600;letter-spacing:.02em}
#hpGrid th:first-child{font-weight:600}
#hpGrid td .timebtn{font-family:'Bodoni Moda','Playfair Display',serif;font-weight:600;letter-spacing:.01em}

:root{--base:#F7F1E1;--ink:#2E1A16;--teal:#246A73;--muted:#6f5a54}
*{box-sizing:border-box}
body{margin:0;background:var(--base);color:var(--ink);font-family:"Inter","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.container{max-width:980px;margin:20px auto;padding:0 16px}
.card{background:#fff;border:1px solid var(--stroke);border-radius:16px;box-shadow:0 10px 24px rgba(36,106,115,.08);padding:16px;margin:10px 0}
h1{font-size:26px;margin:6px 0 10px}
.row{display:grid;grid-template-columns:160px 1fr;gap:6px 14px}
dt{color:var(--muted);font-size:13px}
dd{margin:0 0 6px 0}
input[type="email"]{height:40px;border-radius:12px;border:1px solid var(--stroke);padding:0 12px;width:100%}
.btn{height:44px;border-radius:999px;padding:0 18px;font-weight:800;cursor:pointer;border:1px solid transparent}
.btn.primary{background:var(--teal);color:#fff;border-color:var(--teal);box-shadow:0 6px 16px rgba(36,106,115,.18)}
.btn.ghost{background:#fff;border-color:var(--stroke)}
.toolbar{display:flex;gap:10px;align-items:center;margin:12px 0;flex-wrap:wrap}
#msg{white-space:pre-line}
footer{margin:12px 0 30px;color:var(--muted);font-size:12px}
/* weekly timetable */
/* disabled slot */
.timebtn[aria-disabled="true"]{
  color:#bbb; border-color:#eee; background:#f7f7f7;
  cursor:not-allowed; box-shadow:none;
}
#hpGridWrap{max-width:860px;margin:16px auto;background:#fff;border:1px solid var(--stroke);border-radius:14px;box-shadow:0 10px 24px rgba(49,14,16,.08);padding:14px 16px}
#hpGrid{overflow:auto}
#hpGrid table{width:auto;border-collapse:separate;border-spacing:0;display:table;margin:0 auto}
#hpGrid th,#hpGrid td{border-bottom:1px solid var(--stroke);border-right:1px solid var(--stroke)}
#hpGrid th{background:#fff;font-weight:700}
#hpGrid td{padding:6px 4px;text-align:center;vertical-align:middle}
.timebtn{display:inline-grid;place-items:center;width:36px;height:28px;border-radius:8px;border:1px solid var(--stroke);background:#fff;cursor:pointer}
.timebtn:hover{box-shadow:0 6px 14px rgba(0,0,0,.08)}
.headerbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.headerbar .btn{height:36px;padding:0 12px;font-weight:700}
.small{font-size:12px;color:var(--muted)}
  /* === modal (footer links) === */
#blModal::backdrop{ background: rgba(0,0,0,.35); }
#blModal{
  border:none; padding:0; width: min(920px, 92vw); height: min(80vh, 720px);
  border-radius:16px; overflow:hidden; box-shadow: 0 20px 50px rgba(0,0,0,.25);
}
#blModal header{
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 14px; background:#fff; border-bottom:1px solid var(--stroke);
  font-weight:800;
}
#blModal header .title{ font-size:14px }
#blModal button.close{
  border:none; background:#fff; cursor:pointer; font-weight:800; padding:6px 10px; border-radius:10px;
}
#blModal iframe{ width:100%; height: calc(100% - 48px); border:0; display:block; background:#fff }

</style>
  <script src="lang.js" defer></script>
  <script>
// --- Force English site-wide & hide any language UI ---
window.BL_I18N = window.BL_I18N || {};
BL_I18N.getLang = () => 'en';
try{ document.documentElement.setAttribute('lang','en'); }catch(e){}

// If the user visits /ja/*, send them to the root (bookmark safety)
(function(){ try{
  var p = location.pathname || '';
  if (p.startsWith('/ja/')) location.replace('/');
}catch(e){} })();
</script>
<style>
/* Hide any language selectors, including native selects or custom pills */
#langSelect, .langSel, .lang-pill { display:none !important; visibility:hidden !important; pointer-events:none !important; }
</style>

<script>document.addEventListener('DOMContentLoaded',()=>BL_I18N.i18nApply());</script>
  <style>
/* --- BeautyLanka UI Booster (non-breaking) --- */
:root{
  --base:#F7F1E1; --ink:#2E1A16; --stroke:#eadfca; --teal:#246A73; --muted:#6f5a54; --blue:#0A66FF;
  --accent-1:#8AD5CD; --accent-2:#F9C6B8; --accent-3:#E9D7A5; --accent-4:#B6E3FF;
  --glass-bg:rgba(255,255,255,.72); --glass-brd:rgba(0,0,0,.06);
}
body{background:var(--base);color:var(--ink)}
/* 背景の装飾（描画のみ。レイアウトに影響なし） */
.bg-radials:before,.bg-radials:after{content:"";position:fixed;inset:auto;z-index:-2;pointer-events:none;filter:blur(40px);opacity:.38}
.bg-radials:before{left:-120px;top:-120px;width:420px;height:420px;background:
  radial-gradient(120px 120px at 40% 40%, var(--accent-1), transparent 70%),
  radial-gradient(160px 160px at 70% 60%, var(--accent-2), transparent 72%)}
.bg-radials:after{right:-120px;bottom:-120px;width:460px;height:460px;background:
  radial-gradient(140px 140px at 30% 40%, var(--accent-4), transparent 70%),
  radial-gradient(180px 180px at 70% 60%, var(--accent-3), transparent 72%)}
.grain{position:fixed;inset:0;z-index:-1;pointer-events:none;opacity:.07;mix-blend-mode:multiply;
  background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140" viewBox="0 0 140 140"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/><feColorMatrix type="saturate" values="0"/><feComponentTransfer><feFuncA type="table" tableValues="0 0 0 .55 .15 0"/></feComponentTransfer></filter><rect width="100%" height="100%" filter="url(%23n)"/></svg>');
  background-size:160px 160px}

/* ボタン/入力：既存 .btn や button に上書き“しすぎない”控えめ装飾 */
.btn, button, a.btn, input[type="button"].btn, input[type="submit"].btn{
  display:inline-flex;align-items:center;justify-content:center;gap:.4em;
  height:40px;border-radius:12px;border:1px solid var(--stroke);
  background:#fff;padding:0 12px;font-weight:800;cursor:pointer;
  box-shadow:0 6px 14px rgba(0,0,0,.06); transition:.15s ease-in-out;
}
.btn.primary{background:var(--teal);border-color:var(--teal);color:#fff;box-shadow:0 10px 24px rgba(36,106,115,.18)}
.btn:hover{transform:translateY(-1px)}
/* カード風の箱（既存の .card があるページはそちら優先。無いページ用の汎用クラス） */
.bl-card{background:#fff;border:1px solid var(--stroke);border-radius:16px;box-shadow:0 12px 28px rgba(0,0,0,.08);padding:16px}

/* 入力類の小綺麗化（既存の幅やIDは触らない） */
input[type="text"],input[type="email"],input[type="tel"],input[type="password"],select,textarea{
  border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;background:#fff;font:inherit
}
input:focus,select:focus,textarea:focus{outline:none;border-color:color-mix(in oklab,var(--teal) 55%,white);
  box-shadow:0 0 0 3px color-mix(in oklab,var(--teal) 20%, transparent)}

/* テーブルの視認性（ゼブラは .zebra を付けた時だけ有効） */
table.zebra tbody tr:nth-child(even){background:#faf6ef}
table.zebra th, table.zebra td{border-bottom:1px solid var(--stroke)}

/* 小さめのタグチップ（表示用。機能なし） */
.tag{padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);font-size:12px;background:#fff}

/* ステップ風パンくず（必要なページだけHTMLを足せば見栄えUP） */
.bl-steps{display:flex;gap:8px;align-items:center;color:var(--muted);font-weight:700}
.bl-steps .dot{width:8px;height:8px;border-radius:50%;background:var(--teal);opacity:.35}
.bl-steps .on{opacity:1}

/* 選択済みスロットの見た目 */
.timebtn.selected{
  border-color: var(--teal);
  background: color-mix(in oklab, var(--teal) 10%, white);
  box-shadow: 0 0 0 2px color-mix(in oklab, var(--teal) 20%, transparent);
}
</style>

</head>
<body>
<div class="container">
  <a href="index.html" class="btn ghost" data-i18n="ui.back">← 戻る</a>
  <h1 data-i18n="reserve.title">予約の確認</h1>
  <div class="bl-steps" aria-hidden="true" style="margin:6px 0 10px">
  <span>1. 検索</span><span class="dot"></span>
  <span class="on">2. 予約内容</span><span class="dot"></span>
  <span>3. 支払い</span>
</div>


  <div class="card">
    <dl class="row">
      <dt data-i18n="reserve.salon">サロン</dt><dd id="v_salon">-</dd>
      <dt data-i18n="reserve.menu">メニュー</dt><dd id="v_menu">-</dd>
      <dt data-i18n="reserve.staff">施術者</dt><dd id="v_staff">-</dd>
      <dt data-i18n="reserve.datetime">日時</dt><dd id="v_date">-</dd>
      <dt data-i18n="reserve.estimate">目安金額</dt><dd id="v_price">-</dd>
    </dl>
  </div>

  <div class="card">
    <label data-i18n="reserve.contactEmail">予約連絡用メール</label>
    <input id="email" type="email" data-i18n-ph="ui.email" placeholder="you@example.com"/>
    <p class="small" data-i18n="reserve.note">※空でも予約はできます。メールを入れると <code>bookings</code> シートに反映されます。</p>
  </div>

  <div class="card" id="hpGridWrap">
    <h2 data-i18n="reserve.select_dt" style="margin:0 0 8px;font-size:18px">Select date &amp; time</h2>
    <div class="headerbar">
      <button id="hpPrev" class="btn ghost" type="button" data-i18n="reserve.prev">‹ Prev</button>
      <div id="hpWeekTitle" style="font-weight:800"></div>
      <button id="hpNext" class="btn ghost" type="button" data-i18n="reserve.next">Next ›</button>
    </div>
    <div id="hpGrid"></div>
    <div class="small" data-i18n="reserve.legend">◯ Available　× Unavailable</div>
  </div>

  <div class="toolbar">
    <button id="btnConfirm" class="btn primary" data-i18n="reserve.submit" disabled>この内容で予約する</button>
    <button id="btnCancel" class="btn ghost" onclick="history.back()" data-i18n="reserve.backOnce">一度戻る</button>
    <span id="spin" style="display:none" data-i18n="reserve.process">処理中…</span>
  </div>

  <div id="msg" aria-live="polite"></div>

  <footer>
    <a href="terms.html">Terms</a> ・ <a href="privacy.html">Privacy</a> ・ <a href="cancel.html">Cancel Policy</a> ・ <a href="contact.html">Contact</a>
 <!-- Footer Modal -->
<dialog id="blModal">
  <header>
    <span class="title">Loading…</span>
    <button class="close" type="button" aria-label="Close">✕</button>
  </header>
  <iframe id="blModalFrame" src="about:blank" loading="lazy"></iframe>
</dialog>

  </footer>
</div>

<script>
// ===== LKR専用ユーティリティ =====
const JPY_TO_LKR = 2.05; // 実運用のレートに合わせて調整可
function fmtLKR(v){
  const n = Math.max(0, Number(v)||0);
  return n ? ('Rs ' + Math.round(n).toLocaleString('en-US')) : '-';
}
// ===== URL パラメータから表示を構成 =====
const p = new URLSearchParams(location.search);
const salonId   = p.get('salonId') || p.get('salon') || '';
const salonName = p.get('salonName') || p.get('salon_name') || 'Salon';
const itemName  = p.get('item') || p.get('menu') || 'Menu';
const staffName = p.get('staffName') || p.get('staff') || '指名なし';
const dateTextParam  = p.get('date') || p.get('dt') || '';
const priceLKR  = Number(p.get('price_lkr') || 0)
              || Math.round(Number(p.get('price_jpy')||0) * JPY_TO_LKR); // 後方互換
document.getElementById('v_salon').textContent = salonName || salonId || '-';
document.getElementById('v_menu').textContent  = itemName;
document.getElementById('v_staff').textContent = staffName || '指名なし';
document.getElementById('v_date').textContent  = dateTextParam || '-';
document.getElementById('v_price').textContent = fmtLKR(priceLKR);
// ▼ これを直後に（移動）
const vprice = document.getElementById('v_price');
vprice.dataset.lkr = String(priceLKR || '');
vprice.dataset.jpy = String(Math.round((priceLKR || 0) / JPY_TO_LKR) || '');

// ===== GAS 設定（meta / localStorage / URL の順で解決） =====
const GAS_URL = document.querySelector('meta[name=bl-sheet-hook]')?.content || p.get('gas') || '';
const GAS_KEY = p.get('key') || localStorage.getItem('bl_gas_key') || '';

// ===== シート反映（bookings 追記） =====
async function recordBookingToSheet({ bookingId, email }){
  if(!GAS_URL){ console.warn('GAS_URL not set'); return; }
  const res = await fetch(GAS_URL, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      key: GAS_KEY,
      kind: 'booking',
      data: {bookingId,email}
    })
  });
  const j = await res.json().catch(()=>({}));
  if(!j || !j.ok) throw new Error((j&&j.error)||'booking failed');
}

// ===== UI 操作 =====
function setMsg(t, isErr=false){ const el=document.getElementById('msg'); el.textContent=t||''; el.style.color=isErr?'#74070E':'#2E1A16'; }
function uid(n=8){ const s='23456789ABCDEFGHJKLMNPQRSTUVWXYZ'; return Array.from(crypto.getRandomValues(new Uint8Array(n))).map(b=>s[b%s.length]).join(''); }

function updateConfirmButtonEnabled(){
  const has = !!(localStorage.getItem('reserve_selected') || '').trim();
  const btn = document.getElementById('btnConfirm');
  if(btn) btn.disabled = !has;
}

document.getElementById('btnConfirm').addEventListener('click', ()=>{
  const dtIso = (localStorage.getItem('reserve_selected') || '').trim();
  if(!dtIso){
    alert('日時を選択してください');
    return;
  }
  const dt = new Date(dtIso);
  const dateText = dt.toLocaleString();

  // すでにURLに載っている値も拾う（salon/menu/staff/price/coupon 等）
  const p = new URLSearchParams(location.search);
  const minutes = p.get('minutes') || p.get('duration_min') || '';
  const salonId    = p.get('salonId')   || p.get('salon')     || '';
  const salonName  = p.get('salonName') || p.get('salon_name')|| (document.getElementById('v_salon')?.textContent?.trim() || 'Salon');
  const itemName   = p.get('item')      || p.get('menu')      || (document.getElementById('v_menu')?.textContent?.trim()  || 'Menu');
  const staffName  = p.get('staffName') || p.get('staff')     || (document.getElementById('v_staff')?.textContent?.trim() || '指名なし');
  const couponName = p.get('coupon')    || (document.getElementById('v_coupon')?.textContent?.trim() || '');
  const priceLKR   = p.get('price_lkr') || (document.getElementById('v_price')?.dataset?.lkr || '');
  const priceJPY   = p.get('price_jpy') || (document.getElementById('v_price')?.dataset?.jpy || '');

  const qs = new URLSearchParams({
    salonId, salonName,
    item: itemName,
    staffName,
    coupon: couponName,
    dt: dtIso,
    dateText,
    price_lkr: String(priceLKR||''),
    price_jpy: String(priceJPY||''),
    minutes: String(minutes||'')
  });

  // 保険：confirm.htmlが読み取れるようlocalStorageにも残す
  try{ localStorage.setItem('reserve_selected', dtIso); }catch(_){}

  window.location.href = 'confirm.html?' + qs.toString();

});

</script>



  <script>

(function(){
  const grid = document.getElementById('hpGrid');
  const title = document.getElementById('hpWeekTitle');
  const btnPrev = document.getElementById('hpPrev');
  const btnNext = document.getElementById('hpNext');
  let startHour = 9, endHour = 18;
  const stepMin = 30;
  const urlP = new URLSearchParams(location.search);
  const LEAD_MIN = Number(urlP.get('lead') || 120); // 120=2時間
    // 予約ウィンドウ（週数）を全体共有
  const DEFAULT_MAX_WEEKS = 8;            // meta.maxWeeks が無い場合の既定
  let   maxOffset = DEFAULT_MAX_WEEKS - 1; // 0始まり（今日=0 → n週先=n）
  let   lastBookableDate = null;           // 「この日まで予約可」（当日0時基準）

/// ===== GAS 設定（meta / localStorage / URL の順で解決） =====
const GAS_URL = document.querySelector('meta[name=bl-sheet-hook]')?.content || p.get('gas') || '';
const GAS_KEY = p.get('key') || localStorage.getItem('bl_gas_key') || '';

// ▼ ここを置き換え：taken スロット取得を GAS に接続
let latestMeta = null;
async function fetchTakenSlots(salonId, ymd){
  try{
    if(!GAS_URL || !GAS_KEY || !salonId || !ymd) return new Set();
    const url = `${GAS_URL}?key=${encodeURIComponent(GAS_KEY)}&kind=taken&salonId=${encodeURIComponent(salonId)}&ymd=${encodeURIComponent(ymd)}`;
    const j = await fetch(url, { method:'GET' }).then(r=>r.json());
    if (!j || !j.ok) return new Set();
    if (j.meta) {
  latestMeta = j.meta;

  const mw = Number(j.meta.maxWeeks);
  if (Number.isFinite(mw) && mw > 0) {
    maxOffset = Math.max(0, mw - 1);
    const t0 = today0();
    lastBookableDate = new Date(t0.getTime() + (mw*7 - 1) * 24*60*60*1000);
  } else {
    // meta に maxWeeks が無い場合はデフォルト
    const t0 = today0();
    lastBookableDate = new Date(t0.getTime() + (DEFAULT_MAX_WEEKS*7 - 1) * 24*60*60*1000);
  }
}

    return new Set((j.items||[]).map(s => String(s).slice(0,5)));
  }catch(_e){
    return new Set(); // 失敗時は全枠◯（UI死なせない）
  }
}


  // 例）GASに作った /?kind=taken&salonId=S1&ymd=2025-09-22 を叩く想定
  // const url = `${GAS_URL}?key=${encodeURIComponent(GAS_KEY)}&kind=taken&salonId=${encodeURIComponent(salonId)}&ymd=${encodeURIComponent(ymd)}`;
  // const j = await fetch(url).then(r=>r.json()).catch(()=>({ok:false,items:[]}));
  // if(!j.ok) return new Set();
  // return new Set(j.items); // ["09:00","09:30",...]

  // === 予約済みスロットの取得（GAS 連動） ===
function getGasUrlAndKey(){
  const p = new URLSearchParams(location.search);
  const url = document.querySelector('meta[name="bl-sheet-hook"]')?.content || p.get('gas') || '';
  const key = p.get('key') || localStorage.getItem('bl_gas_key') || '';
  return { url, key };
}

function hhmm(h,m){ return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0'); }
function ymdOf(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}
// 追加：'YYYY-MM-DD' と 'HH:mm' からローカル時刻の Date を作る
function localDateFromYmdHm(y, hm){
  const [Y, M, D] = String(y).split('-').map(Number);
  const [H, I]    = String(hm).split(':').map(Number);
  return new Date(Y, (M||1)-1, D||1, H||0, I||0, 0, 0);
}

function fmtYmd(d){ return d.toISOString().slice(0,10); }
function hhmmOf(h,m){ return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0'); }

  let weekOffset = 0;

  function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function today0() { const t = new Date();
                      t.setHours(0,0,0,0);
                      return t;
                    }
  function fmtHm(h,m){ return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0'); }

  async function buildWeek(offset){
    const base = new Date(today0().getTime() + offset * 7 * 24*60*60*1000);
    const end = new Date(base.getTime() + 6 * 24*60*60*1000);
    const days = Array.from({length:7}, (_,i)=> new Date(base.getTime() + i*24*60*60*1000));
    title.textContent = base.toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'})
                       + ' — ' +
                     end.toLocaleDateString(undefined,{month:'long',day:'numeric'});
        // 既存: const ws = getWeekStart(addDays(today, offset*7)); のすぐ下などに
       const savedIso = (localStorage.getItem('reserve_selected') || '').trim();
const savedDt  = savedIso ? new Date(savedIso) : null;
// ローカル日付ベースで ymd を作成（UTC由来のズレを防止）
const savedYmd = savedDt ? ymdOf(savedDt) : '';
const savedHm  = savedDt ? (String(savedDt.getHours()).padStart(2,'0') + ':' + String(savedDt.getMinutes()).padStart(2,'0')) : '';
 // メタが取れたら「今の buildWeek では表示を作らず」再ビルド
let appliedMeta = false;
if (latestMeta && latestMeta.openStart && latestMeta.openEnd){
  const [sh] = String(latestMeta.openStart).split(':').map(Number);
  const [eh] = String(latestMeta.openEnd).split(':').map(Number);
  if (isFinite(sh) && sh !== startHour){ startHour = sh; appliedMeta = true; }
  if (isFinite(eh) && eh !== endHour){   endHour   = eh; appliedMeta = true; }
}

if (appliedMeta){
  // 営業時間を反映した再ビルド（このbuildは一旦中止）
  await buildWeek(offset);
  return;
}

    const times=[];
    for(let h=startHour; h<=endHour; h++){
      for(let m=0; m<60; m+=stepMin){
        if(h===endHour && m>0) break;
        times.push([h,m]);
      }
    }
        // 各日の満枠セットをまとめて取得
const takenMap = {};
for (const d of days) takenMap[ymdOf(d)] = await fetchTakenSlots(salonId, ymdOf(d));
  //メタが取れたら営業時間を反映(次回buildから効く)
  if (latestMeta && latestMeta.openStart && latestMeta.openEnd){
    const [sh, sm] = String(latestMeta.openStart).split(':').map(n=>parseInt(n||'0',10));
    const [eh, em] = String(latestMeta.openEnd).split(':').map(n=>parseInt(n||'0',10));
    // 分はステップ表示に反映しづらいので「時間」だけ合わせる（必要なら分も考慮）
    startHour = isFinite(sh) ? sh : startHour;
    endHour   = isFinite(eh) ? eh : endHour;
 }
    const table = document.createElement('table');
    const thead=document.createElement('thead'), tbody=document.createElement('tbody');

    const hr=document.createElement('tr');
    const corner=document.createElement('th'); corner.style.width='70px'; hr.appendChild(corner);
    days.forEach(d=>{
      const th=document.createElement('th');
      th.style.padding='8px'; th.textContent = d.toLocaleDateString(undefined,{month:'short',day:'numeric',weekday:'short'});
      hr.appendChild(th);
    });
    thead.appendChild(hr);

    // 既に: const table, thead, tbody, hr はできている前提

// ▼ ここから置き換え（times.forEach の中身全体）
times.forEach(([h,m])=>{
  const tr = document.createElement('tr');

  // 左端の時刻見出し
  const th = document.createElement('th');
  th.textContent = fmtHm(h,m);
  th.style.padding = '6px 8px';
  tr.appendChild(th);

  // 各日のセル
  days.forEach(d=>{
    const td  = document.createElement('td');
    const btn = document.createElement('button');
    btn.className = 'timebtn';

    const slot = hhmm(h,m);          // '09:30'
    const y    = ymdOf(d);           // '2025-09-24'
    
       const isTaken = takenMap[y] && takenMap[y].has(slot);

    // 2時間前ロック（日ごとに判定／ローカル時刻）
    let isTooSoon = false;
    try{
      const now = new Date();
      const cutoff = new Date(now.getTime() + LEAD_MIN*60*1000);
      const dt = localDateFromYmdHm(y, slot);
      if (dt.getTime() <= cutoff.getTime()) isTooSoon = true;
    }catch(_){}

    // 予約ウィンドウ外（maxWeeks を越えたら ×）
    let isBeyondWindow = false;
    if (lastBookableDate) {
      const day0 = new Date(d); day0.setHours(0,0,0,0);
      if (day0.getTime() > lastBookableDate.getTime()) isBeyondWindow = true;
    }

    // ここを唯一の分岐に
    if (isTaken || isTooSoon || isBeyondWindow) {
      btn.textContent = '×';
      btn.disabled = true;
      btn.setAttribute('aria-disabled','true');
    } else {
      btn.textContent = '◯';
      btn.addEventListener('click', ()=>{
        const dt = new Date(d);
        dt.setHours(h, m, 0, 0);
        const iso = dt.toISOString();
        try { localStorage.setItem('reserve_selected', iso); } catch(_){}
        document.getElementById('v_date').textContent = dt.toLocaleString();

        grid.querySelectorAll('.timebtn.selected').forEach(b=>{
          b.classList.remove('selected');
          if (!b.hasAttribute('aria-disabled')) b.textContent = '◯';
        });
        btn.classList.add('selected');
        btn.textContent = '✓';
        updateConfirmButtonEnabled();
      });
    }
    // 事前選択の復元（保存済みISOと一致したら✓＆selected）
    if (savedYmd && savedHm && !btn.disabled) {
      const cur = localDateFromYmdHm(y, slot);
      const curY = y;
      const curHm = String(cur.getHours()).padStart(2,'0') + ':' + String(cur.getMinutes()).padStart(2,'0');
      if (curY === savedYmd && curHm === savedHm) {
        btn.textContent = '✓';
        btn.classList.add('selected');
        document.getElementById('v_date').textContent = cur.toLocaleString();
        updateConfirmButtonEnabled();
      }
    }

    td.appendChild(btn);
    tr.appendChild(td);
  });

  tbody.appendChild(tr);
});



table.appendChild(thead);
table.appendChild(tbody);
grid.innerHTML = '';
grid.appendChild(table);

    btnPrev.disabled = (weekOffset <= 0);
btnNext.disabled = (weekOffset >= maxOffset);

  }

  buildWeek(weekOffset);
  updateConfirmButtonEnabled(); 
  btnPrev.addEventListener('click', ()=>{
  if (weekOffset <= 0) return;      // 過去へ戻さない
  weekOffset--;
  buildWeek(weekOffset);
});
btnNext.addEventListener('click', ()=>{
  if (weekOffset >= maxOffset) return; // 上限超えない
  weekOffset++;
  buildWeek(weekOffset);
});
})();
</script>
 <script>
(function(){
  const footer = document.querySelector('footer');
  if(!footer) return;

  const dlg   = document.getElementById('blModal');
  const frame = document.getElementById('blModalFrame');
  const title = dlg?.querySelector('.title');
  const btnX  = dlg?.querySelector('button.close');

  // フッター内リンクのクリックを横取りしてモーダルで表示
  footer.addEventListener('click', (ev)=>{
    const a = ev.target.closest('a');
    if(!a) return;
    // 同一ページ内のフッターリンクのみを対象
    const href = a.getAttribute('href');
    if(!href || !/\.html?$/i.test(href)) return; // 外部や#などはスルー
    ev.preventDefault();

    if(title) title.textContent = a.textContent.trim() || 'Info';
    if(frame) frame.src = href;

    // 表示
    if(typeof dlg?.showModal === 'function') dlg.showModal();

    // 読み込み後にタイトルをページタイトルへ更新（任意）
    frame?.addEventListener('load', ()=>{
      try{
        const doc = frame.contentDocument || frame.contentWindow?.document;
        const t = doc?.title?.trim();
        if(t && title) title.textContent = t;
      }catch(_e){}
    }, { once:true });
  });

  // 閉じる
  btnX?.addEventListener('click', ()=> dlg?.close());
  dlg?.addEventListener('close', ()=> { if(frame) frame.src='about:blank'; });
})();
</script>
 <!-- decorative background (purely visual) -->
<div class="bg-radials"></div>
<div class="grain"></div>
<script>
(function(){
  const footer = document.querySelector('footer');
  if(!footer) return;

  const dlg   = document.getElementById('blModal');
  const frame = document.getElementById('blModalFrame');
  const title = dlg?.querySelector('.title');
  const btnX  = dlg?.querySelector('button.close');

  // フッターの a をモーダルで開く
  footer.addEventListener('click', (ev)=>{
    const a = ev.target.closest('a');
    if(!a) return;
    const href = a.getAttribute('href');
    if(!href || !/\.html?$/i.test(href)) return; // 外部/＃は無視
    ev.preventDefault();

    if(title) title.textContent = (a.textContent||'').trim() || 'Info';
    if(frame) frame.src = href;

    if(typeof dlg?.showModal === 'function') dlg.showModal();

    // 読み込み後、iframe内<title>で見出し更新（同一オリジン想定）
    const onLoad = ()=>{
      try{
        const doc = frame.contentDocument || frame.contentWindow?.document;
        const t = doc?.title?.trim();
        if(t && title) title.textContent = t;
      }catch(_){}
      frame.removeEventListener('load', onLoad);
    };
    frame.addEventListener('load', onLoad);
  });

  btnX?.addEventListener('click', ()=> dlg.close());
})();
</script>


</body>
</html>
