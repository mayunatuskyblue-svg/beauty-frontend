<!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>予約の確認</title>
<link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:wght@500;600&family=Playfair+Display:wght@500;600&display=swap" rel="stylesheet">

<!-- Google Apps Script WebApp URL をここに（なければ URL 引数 ?gas=...&key=... を使用） -->
<meta name="bl-sheet-hook" content="">
<style>
/* Elegant timetable typography */
#hpWeekTitle{font-family:'Playfair Display','Shippori Mincho',serif;font-weight:600;letter-spacing:.02em}
#hpGrid th{font-family:'Playfair Display','Bodoni Moda',serif;font-weight:600;letter-spacing:.02em}
#hpGrid th:first-child{font-weight:600}
#hpGrid td .timebtn{font-family:'Bodoni Moda','Playfair Display',serif;font-weight:600;letter-spacing:.01em}

:root{--base:#F7F1E1;--ink:#2E1A16;--stroke:#eadfca;--teal:#246A73;--muted:#6f5a54}
*{box-sizing:border-box}
body{margin:0;background:var(--base);color:var(--ink);font-family:"Inter","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
.container{max-width:980px;margin:20px auto;padding:0 16px}
.card{background:#fff;border:1px solid var(--stroke);border-radius:16px;box-shadow:0 10px 24px rgba(36,106,115,.08);padding:16px;margin:10px 0}
h1{font-size:26px;margin:6px 0 10px}
.row{display:grid;grid-template-columns:160px 1fr;gap:6px 14px}
dt{color:var(--muted);font-size:13px}
dd{margin:0 0 6px 0}
input[type="email"]{height:40px;border-radius:12px;border:1px solid var(--stroke);padding:0 12px;width:100%}
.btn{height:44px;border-radius:999px;padding:0 18px;font-weight:800;cursor:pointer;border:1px solid transparent}
.btn.primary{background:var(--teal);color:#fff;border-color:var(--teal);box-shadow:0 6px 16px rgba(36,106,115,.18)}
.btn.ghost{background:#fff;border-color:var(--stroke)}
.toolbar{display:flex;gap:10px;align-items:center;margin:12px 0;flex-wrap:wrap}
#msg{white-space:pre-line}
footer{margin:12px 0 30px;color:var(--muted);font-size:12px}
/* weekly timetable */
#hpGridWrap{max-width:860px;margin:16px auto;background:#fff;border:1px solid var(--stroke);border-radius:14px;box-shadow:0 10px 24px rgba(49,14,16,.08);padding:14px 16px}
#hpGrid{overflow:auto}
#hpGrid table{width:auto;border-collapse:separate;border-spacing:0;display:table;margin:0 auto}
#hpGrid th,#hpGrid td{border-bottom:1px solid var(--stroke);border-right:1px solid var(--stroke)}
#hpGrid th{background:#fff;font-weight:700}
#hpGrid td{padding:6px 4px;text-align:center;vertical-align:middle}
.timebtn{display:inline-grid;place-items:center;width:36px;height:28px;border-radius:8px;border:1px solid var(--stroke);background:#fff;cursor:pointer}
.timebtn:hover{box-shadow:0 6px 14px rgba(0,0,0,.08)}
.headerbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.headerbar .btn{height:36px;padding:0 12px;font-weight:700}
.small{font-size:12px;color:var(--muted)}
</style>
  <script src="lang.js" defer></script>
<script>document.addEventListener('DOMContentLoaded',()=>BL_I18N.i18nApply());</script>
</head>
<body>
<div class="container">
  <a href="index.html" class="btn ghost" data-i18n="ui.back">← 戻る</a>
  <h1 data-i18n="reserve.title">予約の確認</h1>

  <div class="card">
    <dl class="row">
      <dt data-i18n="reserve.salon">サロン</dt><dd id="v_salon">-</dd>
      <dt data-i18n="reserve.menu">メニュー</dt><dd id="v_menu">-</dd>
      <dt data-i18n="reserve.staff">施術者</dt><dd id="v_staff">-</dd>
      <dt data-i18n="reserve.datetime">日時</dt><dd id="v_date">-</dd>
      <dt data-i18n="reserve.estimate">目安金額</dt><dd id="v_price">-</dd>
    </dl>
  </div>

  <div class="card">
    <label data-i18n="reserve.contactEmail">予約連絡用メール</label>
    <input id="email" type="email" data-i18n-ph="ui.email" placeholder="you@example.com"/>
    <p class="small" data-i18n="reserve.note">※空でも予約はできます。メールを入れると <code>bookings</code> シートに反映されます。</p>
  </div>

  <div class="card" id="hpGridWrap">
    <h2 data-i18n="reserve.select_dt" style="margin:0 0 8px;font-size:18px">Select date &amp; time</h2>
    <div class="headerbar">
      <button id="hpPrev" class="btn ghost" type="button" data-i18n="reserve.prev">‹ Prev</button>
      <div id="hpWeekTitle" style="font-weight:800"></div>
      <button id="hpNext" class="btn ghost" type="button" data-i18n="reserve.next">Next ›</button>
    </div>
    <div id="hpGrid"></div>
    <div class="small" data-i18n="reserve.legend">◯ Available　× Unavailable</div>
  </div>

  <div class="toolbar">
    <button id="btnConfirm" class="btn primary" data-i18n="reserve.submit">この内容で予約する</button>
    <button id="btnCancel" class="btn ghost" onclick="history.back()" data-i18n="reserve.backOnce">一度戻る</button>
    <span id="spin" style="display:none" data-i18n="reserve.process">処理中…</span>
  </div>

  <div id="msg"></div>

  <footer>
    <a href="terms.html">Terms</a> ・ <a href="privacy.html">Privacy</a> ・ <a href="cancel_policy.html">Cancel Policy</a> ・ <a href="contact.html">Contact</a>
  </footer>
</div>

<script>
// ===== 通貨ユーティリティ（price_jpy を元に表示） =====
const RATES = { JPY:1, USD:0.0067, EUR:0.0061, LKR:2.05 }; // 必要に応じて更新
function getLang(){ try{ return (localStorage.getItem('lang')||'auto')==='ja' ? 'ja' : 'en'; }catch(e){ return 'en'; } }
function getCurrency(){ try{ return localStorage.getItem('bl_currency') || 'JPY'; }catch(e){ return 'JPY'; } }
function fmtCurrencyFromJPY(jpy, cur){
  const n = Math.max(0, Number(jpy)||0);
  const converted = Math.round(n * (RATES[cur] || 1));
  try{
    return new Intl.NumberFormat(getLang()==='ja'?'ja-JP':'en-US',
      { style:'currency', currency: cur, maximumFractionDigits:0 }).format(converted);
  }catch(e){
    const symbols = {JPY:'¥', USD:'$', EUR:'€', LKR:'Rs '};
    return (symbols[cur]||'') + converted.toLocaleString();
  }
}

// ===== URL パラメータから表示を構成 =====
const p = new URLSearchParams(location.search);
const salonId   = p.get('salonId') || p.get('salon') || '';
const salonName = p.get('salonName') || p.get('salon_name') || 'Salon';
const itemName  = p.get('item') || p.get('menu') || 'Menu';
const staffName = p.get('staffName') || p.get('staff') || '指名なし';
const dateTextParam  = p.get('date') || p.get('dt') || '';
const priceJPY  = Number(p.get('price_jpy') || 0);

document.getElementById('v_salon').textContent = salonName || salonId || '-';
document.getElementById('v_menu').textContent  = itemName;
document.getElementById('v_staff').textContent = staffName || '指名なし';
document.getElementById('v_date').textContent  = dateTextParam || '-';
document.getElementById('v_price').textContent = priceJPY ? fmtCurrencyFromJPY(priceJPY, getCurrency()) : '-';

// ===== GAS 設定（meta / localStorage / URL の順で解決） =====
const GAS_URL = document.querySelector('meta[name=bl-sheet-hook]')?.content || p.get('gas') || '';
const GAS_KEY = p.get('key') || localStorage.getItem('bl_gas_key') || '';

<script>
// ===== シート反映（bookings 追記） =====
async function recordBookingToSheet({ bookingId, email, dateText }) {
  if(!GAS_URL){ console.warn('GAS_URL not set'); return; }
  const payload = {
    key: GAS_KEY,
    kind: 'booking',               // ← 既存の doPost に合わせて 'booking' を使う
    data: {
      bookingId,                   // 予約ID
      date: dateText || '',        // 予約日時（文字列）
      menu:  itemName || '',       // ← 画面上のメニュー名
      minutes: 0,                  // （必要なら予約時間を入れる）
      amountJPY: priceJPY || 0,    // 目安金額（数値）
      email: email || '',
      name:  '',                   // 予約者名（未入力なら空）
      customerId: '',              // 後から埋まる想定なら空でOK
      status: 'reserved'           // 初期ステータス
    }
  };
  const res = await fetch(GAS_URL, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const j = await res.json().catch(()=>({}));
  if(!j || !j.ok) throw new Error((j&&j.error)||'booking failed');
}
</script>


// ===== UI 操作 =====
function setMsg(t, isErr=false){ const el=document.getElementById('msg'); el.textContent=t||''; el.style.color=isErr?'#74070E':'#2E1A16'; }
function uid(n=8){ const s='23456789ABCDEFGHJKLMNPQRSTUVWXYZ'; return Array.from(crypto.getRandomValues(new Uint8Array(n))).map(b=>s[b%s.length]).join(''); }

<script>
const FRONT_MAX_JPY = 20000;  // ← 好きな上限に

document.getElementById('btnConfirm').addEventListener('click', async ()=>{
  const email = (document.getElementById('email').value||'').trim();

  // ← ここで上限チェック
  if (priceJPY && Number(priceJPY) > FRONT_MAX_JPY) {
    alert(`金額が上限 (${FRONT_MAX_JPY.toLocaleString()} JPY) を超えています。別メニューをご検討ください。`);
    return;
  }

  const dtIso = localStorage.getItem('reserve_selected') || '';
  const dateText = dtIso ? new Date(dtIso).toLocaleString() : (dateTextParam || '');
  ...
  // シート送信も上で置き換えた関数に合わせ、第三引数 dateText を渡す
  await recordBookingToSheet({ bookingId: bid, email, dateText });
  ...
});
</script>

document.getElementById('btnConfirm').addEventListener('click', async ()=>{
  const email = (document.getElementById('email').value||'').trim();
  const dtIso = localStorage.getItem('reserve_selected') || '';
  const dateText = dtIso ? new Date(dtIso).toLocaleString() : (dateTextParam || '');
  if(dateText) document.getElementById('v_date').textContent = dateText;

  // 予約ID（元の仕様を踏襲）
  const bid = [salonId||'S', (dateText||'').replace(/[^0-9]/g,''), uid(4)].filter(Boolean).join('-');

  document.getElementById('btnConfirm').disabled = true;
  document.getElementById('spin').style.display = 'inline';
  setMsg('');

  try{
    // 既存のシート反映処理はそのまま
    await recordBookingToSheet({ bookingId: bid, email });
    if(email) try{ localStorage.setItem('bl_email', email); }catch(e){}
    setMsg('予約を受け付けました。ご来店をお待ちしています！\n予約ID: '+bid);

  }catch(e){
    setMsg('予約は完了しましたが、シート反映に失敗しました。後で自動再送します。\n'+(e.message||e), true);

  }finally{
    document.getElementById('btnConfirm').disabled = false;
    document.getElementById('spin').style.display = 'none';

    // 追記：カード登録画面に渡す最低限の情報を保存して遷移
    const payload = {
      email: (document.getElementById('email').value||'').trim(),
      salon:  document.getElementById('v_salon')?.textContent?.trim() || '',
      menu:   document.getElementById('v_menu')?.textContent?.trim()  || '',
      staff:  document.getElementById('v_staff')?.textContent?.trim() || '',
      date:   document.getElementById('v_date')?.textContent?.trim()  || dateText || '',
      price:  document.getElementById('v_price')?.textContent?.trim() || '',
      bookingId: bid || ''
    };
    try { sessionStorage.setItem('pendingReservation', JSON.stringify(payload)); } catch(_e) {}

    // カード情報登録ページへ
    window.location.href = 'card_save.html';
  }
});
</script>



  <script>

(function(){
  const grid = document.getElementById('hpGrid');
  const title = document.getElementById('hpWeekTitle');
  const btnPrev = document.getElementById('hpPrev');
  const btnNext = document.getElementById('hpNext');
  const startHour = 9, endHour = 18, stepMin = 30;
  let weekOffset = 0;

  function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function getWeekStart(d){ const dt = new Date(d); const day=(dt.getDay()+6)%7; dt.setDate(dt.getDate()-day); dt.setHours(0,0,0,0); return dt; }
  function fmtHm(h,m){ return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0'); }

  function buildWeek(offset){
    const today = new Date();
    const ws = getWeekStart(addDays(today, offset*7));
    const we = addDays(ws, 6);
    title.textContent = ws.toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'}) + ' — ' + we.toLocaleDateString(undefined,{month:'long',day:'numeric'});

    const times=[];
    for(let h=startHour; h<=endHour; h++){
      for(let m=0; m<60; m+=stepMin){
        if(h===endHour && m>0) break;
        times.push([h,m]);
      }
    }
    const days = Array.from({length:7},(_,i)=>addDays(ws,i));

    const table = document.createElement('table');
    const thead=document.createElement('thead'), tbody=document.createElement('tbody');

    const hr=document.createElement('tr');
    const corner=document.createElement('th'); corner.style.width='70px'; hr.appendChild(corner);
    days.forEach(d=>{
      const th=document.createElement('th');
      th.style.padding='8px'; th.textContent = d.toLocaleDateString(undefined,{month:'short',day:'numeric',weekday:'short'});
      hr.appendChild(th);
    });
    thead.appendChild(hr);

    times.forEach(([h,m])=>{
      const tr=document.createElement('tr');
      const th=document.createElement('th'); th.textContent = fmtHm(h,m); th.style.padding='6px 8px'; tr.appendChild(th);
      days.forEach(d=>{
        const td=document.createElement('td');
        const btn=document.createElement('button');
        btn.className='timebtn';
        btn.textContent='◯';
        btn.addEventListener('click', ()=>{
          const dt = new Date(d); dt.setHours(h,m,0,0);
          const iso = dt.toISOString();
          localStorage.setItem('reserve_selected', iso);
          document.getElementById('v_date').textContent = dt.toLocaleString();
          // 軽いフィードバック
          btn.textContent='✓';
          setTimeout(()=>btn.textContent='◯',600);
        });
        td.appendChild(btn);
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    table.appendChild(thead); table.appendChild(tbody);
    grid.innerHTML=''; grid.appendChild(table);
  }

  buildWeek(weekOffset);
  btnPrev.addEventListener('click', ()=>{ weekOffset--; buildWeek(weekOffset); });
  btnNext.addEventListener('click', ()=>{ weekOffset++; buildWeek(weekOffset); });
})();
</script>
  
<script src="lang.js"></script>
<script>document.addEventListener('DOMContentLoaded',()=>BL_I18N.i18nApply());</script>


</body>
</html>
